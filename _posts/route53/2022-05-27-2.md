---
title:  "[Route53] nginx + https ì ìš©í•˜ê¸° (+ ì¸ì¦ì„œ ìë™ ê°±ì‹ ) "

categories:
  - Route53
tags:
  - [AWS, Route53]

toc: true
toc_sticky: true
 
date: 2022-05-27 15:47:24
last_modified_at: 2022-05-27 17:00:10
---

# 1. nginx ì„¤ì¹˜í•˜ê¸°
ec2 ì¸ìŠ¤í„´ìŠ¤(ubuntu)ì— ì ‘ì†í•œ ë’¤ì—<br>
```
sudo apt-get install nginx
```

# 2. letsencrypt
letsencryptë¥¼ í†µí•´ 3ê°œì›”ì§œë¦¬ ë¬´ë£Œ ì¸ì¦ì„œë¥¼ ë°œê¸‰í•  ìˆ˜ ìˆë‹¤.
## certbot ì„¤ì¹˜
certbot-autoê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•„ì„œ ì•„ë˜ì™€ ê°™ì€ ëª…ë ¹ìœ¼ë¡œ ì„¤ì¹˜í–ˆë‹¤.
```
sudo snap install certbot --classic
sudo certbot certonly --nginx 
```
### ë§Œì•½, ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ë©´<br>
<img width="720" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-05-26 á„‹á…©á„’á…® 5 26 31" src="https://user-images.githubusercontent.com/59405576/170449732-61298463-6741-45a3-bc48-734225577b6b.png"> <br>

#### í¬íŠ¸ í™•ì¸
```
sudo lsof -i tcp:80
```
ì´ë•Œ ë‚˜íƒ€ë‚˜ëŠ” PIDë¥¼ ì´ìš©í•´ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ë¥¼ killí•œë‹¤.
#### process kill
```
sudo kill -9 (PID)
```

# 3. nginx ì„¤ì •í•˜ê¸°
## /etc/nginx/sites-enabled/default
`sudo su`ë¥¼ í†µí•´ rootë¡œ ì „í™˜í•œ ë’¤ ì§„í–‰í•œë‹¤.
```
vim /etc/nginx/sites-enabled/default
```
ì•„ë˜ëŠ” `/etc/nginx/sites-enabled/default`ì˜ ë‚´ìš©ì´ë‹¤.<br>
```
server {
        server_name api.test.tk;
        return 301 https://api.test.tk$request_uri;
}
server {
        listen 443 ssl;
        server_name api.test.tk;
        ssl_certificate /etc/letsencrypt/live/api.test.tk/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/api.test.tk/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        location / {
                proxy_set_header Host $host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header X-Real-IP $remote_addr;
                proxy_pass http://127.0.0.1:3060;
                proxy_redirect off;
       }
}
```
ì›ë˜ `# managed by Certbot` ë¶€ë¶„ì€ certbotì—ì„œ ìë™ìœ¼ë¡œ ì¶”ê°€í•´ì¤€ë‹¤ê³  í•˜ëŠ”ë° ë‚˜ëŠ” `certonly` ëª…ë ¹ ë•Œë¬¸ì¸ì§€ëŠ” ëª°ë¼ë„ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì§€ ì•Šê¸¸ë˜ ë‚´ê°€ ì§ì ‘ ì¶”ê°€í–ˆë‹¤.
## /etc/nginx/nginx.conf
```
vim /etc/nginx/nginx.conf
```
ì•„ë˜ëŠ” `/etc/nginx/nginx.conf`ì˜ ë‚´ìš©ì´ë‹¤.<br>
(ì°¸ê³ ë¡œ ì²¨ë¶€í•œ ê²ƒì´ë©° ë‚˜ëŠ” ë”°ë¡œ ë³€ê²½í•˜ì§€ëŠ” ì•Šì•˜ë‹¤.)
```
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}

http {

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        gzip on;

        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
} 
```
## ì„¤ì • íŒŒì¼ ë³€ê²½ í›„
```
sudo service nginx restart
```
ìœ„ ëª…ë ¹ì–´ë¡œ nginxë¥¼ ì¬ì‹œì‘ í•´ì•¼í•œë‹¤.

# 4. ì¸ì¦ì„œ ìë™ ê°±ì‹ 
cronì„ ì‚¬ìš©í•˜ì—¬ ìë™ê°±ì‹ í•œë‹¤.
## /etc/cron.d/certbot
```
vim /etc/cron.d/certbot
```
ì•„ë˜ëŠ” `/etc/cron.d/certbot`ì˜ ë‚´ìš©ì´ë‹¤.<br>
(ë‚˜ëŠ” íŒŒì¼ì´ ì—†ì–´ì„œ ìƒˆë¡œ ìƒì„±í–ˆë‹¤.)
```
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
0 */12 * * * root certbot -q renew --nginx --renew-hook 'service nginx reload'
```
ì´ë ‡ê²Œ í•˜ë©´ ë§¤ì¼ ë‘ ë²ˆì”© ê°±ì‹ ì„ ì‹œë„í•œë‹¤.


# +) ê³ ìƒí–ˆë˜ ë¶€ë¶„ ğŸ¥µ
2ë²ˆ ë‹¨ê³„ì—ì„œ, ì²˜ìŒì—ëŠ” `sudo certbot certonly --nginx ` ëŒ€ì‹  `sudo certbot --nginx` ëª…ë ¹ì„ ì‹¤í–‰í–ˆëŠ”ë°, ê³„ì†í•´ì„œ ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤.<br>
```
Certbot failed to authenticate some domains (authenticator: nginx). The Certificate Authority reported these problems:
  Domain: [ë„ë©”ì¸ì´ë¦„]
  Type: unauthorized
  Detail: [IP]: Invalid response from http://[ë„ë©”ì¸ì´ë¦„]/.well-known/acme-challenge/...: 404

. . .

Some challenges have failed.
```
<img width="1425" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-05-26 á„‹á…©á„’á…® 9 58 07" src="https://user-images.githubusercontent.com/59405576/170656814-f3bb0086-66c8-46d9-8e7d-5cf35a3be241.png"><br>

## í•´ê²°ë°©ë²•
ìš°ì„  [ì—¬ê¸°](https://lemontia.tistory.com/865) ë‚˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•œ ë¶„ì˜ ë¸”ë¡œê·¸ë¥¼ ë³´ê³  ë”°ë¼í•´ë´¤ìœ¼ë‚˜, ë‚˜ëŠ” í•´ê²°ë˜ì§€ ì•Šì•˜ë‹¤.<br>
ì•„ë˜ëŠ” ë‚´ê°€ í•´ê²°í•œ ë°©ë²•ì´ë‹¤.<br>
`sudo certbot certonly --nginx` ëª…ë ¹ìœ¼ë¡œ ë‹¨ìˆœíˆ ì¸ì¦ì„œë§Œ ë°›ì•„ì™”ë‹¤.<br>
<img width="732" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-05-27 á„‹á…©á„’á…® 2 51 14" src="https://user-images.githubusercontent.com/59405576/170640736-eb28baa0-00d2-4cdb-a204-60ffe011fc45.png"> <br>
ìœ„ ì‚¬ì§„ì—ì„œ ë³´ë©´, fullchain.pemì˜ ê²½ë¡œì™€ privkey.pemì˜ ê²½ë¡œê°€ ë‚˜ì˜¨ë‹¤. <br>
`sudo su` ëª…ë ¹ìœ¼ë¡œ rootë¡œ ì „í™˜í•œ ë’¤ì— í•´ë‹¹ ê²½ë¡œë“¤ì„ `vim /etc/nginx/sites-enabled/default`ì—ì„œ ì¶”ê°€í•œë‹¤.<br>
(ìì„¸íˆëŠ” ìœ„ì— ë‚˜íƒ€ë‚˜ìˆë‹¤.)


# ì°¸ê³ 
[ZeroCho](https://www.zerocho.com/category/NodeJS/post/5ef450a5701d8a001f84baeb)<br>
[darrent, dev blog](https://darrengwon.tistory.com/547)

***
<br>

    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}