---
title:  "[S3] s3ì— ì´ë¯¸ì§€ ì—…ë¡œë“œí•˜ê¸° "
# excerpt: "sprintfì— ëŒ€í•´ ì•Œì•„ë³´ì"

categories:
  - S3
tags:
  - [AWS, S3]

toc: true
toc_sticky: true
 
date: 2022-08-23 23:46:00
last_modified_at: 2022-08-23 23:46:03
---
# S3ì— ì´ë¯¸ì§€ ì—…ë¡œë“œí•˜ê¸°
## 1. `gradle`ì— dependency ì¶”ê°€
```
implementation 'org.springframework.cloud:spring-cloud-starter-aws:2.2.6.RELEASE'
```

## 2. `application.yml`ì— aws S3 ì ‘ê·¼ ê´€ë ¨ ë‚´ìš© ì„¤ì •
```yml
cloud:
  aws:
    credentials:
      access-key: IAM ì‚¬ìš©ì ì—‘ì„¸ìŠ¤ í‚¤
      secret-key: IAM ì‚¬ìš©ì ë¹„ë°€ ì—‘ì„¸ìŠ¤ í‚¤
    s3:
      bucket: ë²„í‚· ì´ë¦„
    region:
      static: ap-northeast-2
    stack:
      auto: false
```
ì´ë•Œ IAM ì‚¬ìš©ì ì—‘ì„¸ìŠ¤ í‚¤ì™€ ë¹„ë°€ ì—‘ì„¸ìŠ¤í‚¤ëŠ” IAM ì‚¬ìš©ìë¥¼ ìƒì„±í•  ë•Œ ë°›ëŠ” csv íŒŒì¼ì—ì„œ ë³µë¶™í•˜ë©´ ëœë‹¤.

## 3. AmazonS3Client ê°ì²´ë¥¼ beanìœ¼ë¡œ ë“±ë¡í•  configuration íŒŒì¼ ìƒì„±
`config/AmazonS3Config.java`
```java
@Configuration
public class AmazonS3Config {

    @Value("${cloud.aws.credentials.access-key}")
    private String accessKey;

    @Value("${cloud.aws.credentials.secret-key}")
    private String secretKey;

    @Value("${cloud.aws.region.static}")
    private String region;

    @Bean
    public AmazonS3Client amazonS3Client() {
        BasicAWSCredentials awsCreds = new BasicAWSCredentials(accessKey, secretKey);
        return (AmazonS3Client) AmazonS3ClientBuilder.standard()
            .withRegion(region)
            .withCredentials(new AWSStaticCredentialsProvider(awsCreds))
            .build();
    }
}
```
í•´ë‹¹ í´ë˜ìŠ¤ì—ì„œëŠ” `@Value` ì• ë…¸í…Œì´ì…˜ì„ í†µí•´ `application.yml`ì—ì„œ ê°’ì„ ì½ì–´ì˜¨ë‹¤.

## 4. `S3Uploader` í´ë˜ìŠ¤ ìƒì„±
`service/util/S3Uploader.java`
```java
@Slf4j
@RequiredArgsConstructor
@Component
public class S3Uploader {

    private final AmazonS3Client amazonS3Client;

    @Value("${cloud.aws.s3.bucket}")
    public String bucket;  // S3 ë²„í‚· ì´ë¦„

    public String upload(MultipartFile multipartFile, String dirName) throws IOException {
        File uploadFile = convert(multipartFile)  // íŒŒì¼ ë³€í™˜í•  ìˆ˜ ì—†ìœ¼ë©´ ì—ëŸ¬
            .orElseThrow(() -> new IllegalArgumentException("error: MultipartFile -> File convert fail"));

        return upload(uploadFile, dirName, multipartFile.getOriginalFilename()); //ğŸ“Œ íŒŒì¼ì˜ originalNameì„ ë°”ë¡œ ë„˜ê¸°ë„ë¡ ì„¤ì •
    }

    // S3ë¡œ íŒŒì¼ ì—…ë¡œë“œí•˜ê¸°
    private String upload(File uploadFile, String dirName, String originalName) { //ğŸ“Œì…ë ¥ íŒŒë¼ë¯¸í„°ì— originalName ì¶”ê°€
        String fileName = dirName + "/" + UUID.randomUUID()
            + originalName;   // S3ì— ì €ì¥ëœ íŒŒì¼ ì´ë¦„ ğŸ“Œrandom ê°’ + ê¸°ì¡´ì˜ íŒŒì¼ëª… ìœ¼ë¡œ ì„¤ì •. ê¸°ì¡´ì˜ íŒŒì¼ëª…ì€ upload ë©”ì„œë“œ ë‹¹ì‹œ multipartFile ì—ì„œ ë°”ë¡œ getOriginalFileNameìœ¼ë¡œ ê°€ì ¸ì™€ì„œ ì…ë ¥ íŒŒë¼ë¯¸í„°ë¡œ ë°›ê¸°
        String uploadImageUrl = putS3(uploadFile, fileName); // s3ë¡œ ì—…ë¡œë“œ
        removeNewFile(uploadFile);
        return uploadImageUrl;
    }

    // S3ë¡œ ì—…ë¡œë“œ
    private String putS3(File uploadFile, String fileName) {
        amazonS3Client.putObject(
            new PutObjectRequest(bucket, fileName, uploadFile).withCannedAcl(CannedAccessControlList.PublicRead));
        return amazonS3Client.getUrl(bucket, fileName).toString();
    }

    // ë¡œì»¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ ì§€ìš°ê¸°
    private void removeNewFile(File targetFile) {
        if (targetFile.delete()) {
            log.info("File delete success");
            return;
        }
        log.info("File delete fail");
    }

    // ë¡œì»¬ì— íŒŒì¼ ì—…ë¡œë“œ í•˜ê¸°
    private Optional<File> convert(MultipartFile file) throws IOException {
        File convertFile = new File(
            System.getProperty("user.dir") + "/" + UUID.randomUUID()); //ğŸ“Œ localì— ì €ì¥í• ë•Œë„ randomUUIDë¥¼ ì“°ë„ë¡ ì„¤ì •
        if (convertFile.createNewFile()) { // ë°”ë¡œ ìœ„ì—ì„œ ì§€ì •í•œ ê²½ë¡œì— Fileì´ ìƒì„±ë¨ (ê²½ë¡œê°€ ì˜ëª»ë˜ì—ˆë‹¤ë©´ ìƒì„± ë¶ˆê°€ëŠ¥)
            try (FileOutputStream fos = new FileOutputStream(
                convertFile)) { // FileOutputStream ë°ì´í„°ë¥¼ íŒŒì¼ì— ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•¨
                fos.write(file.getBytes());
            }
            return Optional.of(convertFile);
        }

        return Optional.empty();
    }
}
```

# DBì— S3 ì´ë¯¸ì§€ ê²½ë¡œ ì €ì¥í•˜ê¸°

## 5. Image Entity ë§Œë“¤ê¸°
`domain/post/Image.java`
```java
@Entity
@Getter
@Setter
@NoArgsConstructor
public class Image {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "image_id")
    private Long id;

    String imgurl;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "post_id")
    private Post post;

}
```

## 6. Post Entity ìˆ˜ì •
`domain/post/Post.java`
```java
@OneToMany(mappedBy = "post", cascade = CascadeType.ALL)
private List<Image> img = new ArrayList<>();
```
Image EntityëŠ” postì— ì¢…ì†ë˜ëŠ” entityì´ê¸° ë•Œë¬¸ì— Post Entity í´ë˜ìŠ¤ì—ì„œ CASCADEë¥¼ ì‚¬ìš©í•˜ì—¬ OneToMany ë§¤í•‘ì„ í•œë‹¤.

## 7. Image Repository
`repository/ImageRepository.java`
```java
@Repository
public interface ImageRepository extends JpaRepository<Image,Long> {
}
```
RepositoryëŠ” ë‹¨ìˆœí•œ ê¸°ëŠ¥ë§Œ í™œìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í–ˆë‹¤.

## 8. Image Service êµ¬í˜„
`service/ImageService.java`
```java
@Service
public class ImageService extends S3Uploader {

    private final ImageRepository imageRepository;

    public ImageService(AmazonS3Client amazonS3Client, ImageRepository imageRepository) {
        super(amazonS3Client);
        this.imageRepository = imageRepository;
    }

    public String saveImage(MultipartFile multipartFile, String dirName, Post post) throws IOException {

        String uri = super.upload(multipartFile, dirName);

        Image img = new Image();
        img.setImgurl(uri);
        img.setPost(post);

        imageRepository.save(img);
        return uri;
    }
}
```

## 9 `PostServiceImpl` í´ë˜ìŠ¤ì˜ save ë©”ì„œë“œ ìˆ˜ì •
`service/PostServiceImpl.java`
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class PostServiceImpl implements PostService {

    private final PostRepository postRepository;
    private final MemberRepository memberRepository;

    @Override
    @Transactional
    public Post save(PostSaveReqDto requestDto) {

        Optional<Member> oMember = memberRepository.findByUsername(SecurityUtil.getLoginUsername());
        List<Tag> tags = new ArrayList<>(requestDto.getTag());
        PostTag postTag = null;
        List<PostTag> postTags = new ArrayList<>();
        int tagListSize = 3;

        if (oMember.isPresent()) {

            if (tags.size() > tagListSize) {
                throw new CustomException(TAG_LIST_SIZE_ERROR);
            }

            Member member = oMember.get();

            for (Tag tag : tags) {
                // í¬ìŠ¤íŠ¸íƒœê·¸ ìƒì„±
                postTag = PostTag.createPostTag(tag);
                postTags.add(postTag);
            }
            // ê²Œì‹œê¸€ ìƒì„±
            Post post = Post.createPost(member, requestDto.getTitle(), requestDto.getContent(), postTags);

            postRepository.save(post);

            return post;

        } else {
            throw new CustomException(MEMBER_NOT_FOUND);
        }
    }
}
```
ê¸°ì¡´ì˜ ë¦¬í„´ ê°’ì´ voidì˜€ë˜ `save` ë©”ì„œë“œì˜ ë¦¬í„´ ê°’ì„ `Post`ë¡œ ìˆ˜ì •í–ˆë‹¤.<br>
ë§ˆì°¬ê°€ì§€ë¡œ `PostService` í´ë˜ìŠ¤ì˜ ë¦¬í„´ ê°’ë„ ìˆ˜ì •í•˜ì˜€ë‹¤.

## 10. ì»¨íŠ¸ë¡¤ëŸ¬ ì‘ì„±
`web/BoardController.java`
```java
@RequiredArgsConstructor
@RestController
@RequestMapping
    ("/board")
@Slf4j
public class BoardController {

    private final PostService postService;
    private final ImageService imageService;

    // ì´ë¯¸ì§€ í¬í•¨ ê²Œì‹œê¸€ ë“±ë¡
    @PostMapping(value = "/save/image", consumes = {MediaType.APPLICATION_JSON_VALUE,
        MediaType.MULTIPART_FORM_DATA_VALUE})
    public Response savePost(@RequestPart @Valid PostSaveReqDto requestDto, @RequestPart MultipartFile image) throws
        IOException {

        Post post = postService.save(requestDto);
        imageService.saveImage(image, "test", post);

        return new Response("OK", "ê²Œì‹œê¸€ ë“±ë¡ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤");
    }
}
```
íŒŒì¼ì„ ì—…ë¡œë“œ í•  ë•Œ api í†µì‹ ì„ í†µí•´ ë°›ì•„ì˜¬ ê°ì²´ì˜ íƒ€ì…ì€ `MultipartFile`ì´ë‹¤.<br>
saveImage ë©”ì†Œë“œì˜ ë‘ë²ˆì§¸ íŒŒë¼ë¯¸í„° (ìœ„ì˜ ì˜ˆì‹œì—ì„œëŠ” `test`)ì˜ ì´ë¦„ì— ë”°ë¼ S3 bucket ë‚´ë¶€ì— ì´ë¯¸ì§€ë¥¼ ë‹´ì„ í•´ë‹¹ ì´ë¦„ì˜ directoryê°€ ìƒì„±ëœë‹¤.<br>

ğŸŒŸ ì¤‘ìš”í•œ ê²ƒì€ Multipartfileì€ DTO ì•ˆì— ê°™ì´ í•„ë“œë¡œ ë“¤ì–´ê°€ ìˆìœ¼ë©´ ì•ˆë˜ê³  ë”°ë¡œ RequestPart ë¡œ ë‚˜ëˆ ì„œ api í†µì‹ ì‹œ ë°›ì•„ì™€ì•¼ í•œë‹¤.<br>
ê·¸ë¦¬ê³  ì´ë ‡ê²Œ í•˜ë ¤ë©´ `@PostMapping(consumes={})` í˜•íƒœë¡œ ìœ„ì™€ ê°™ì´ ê° requestpartì˜ content typeì´ ë¬´ì—‡ì¸ì§€ ì •ì˜ë¥¼ í•´ ì£¼ì–´ì•¼ í•œë‹¤!

# í¬ìŠ¤íŠ¸ë§¨ í…ŒìŠ¤íŠ¸
<img width="1243" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-24 á„‹á…©á„’á…® 6 06 47" src="https://user-images.githubusercontent.com/59405576/186378904-393c99aa-637a-4537-a5ad-f0c5b3416a09.png"><br>

`KEY`ì—ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì˜ `savePost`ì˜ íŒŒë¼ë¯¸í„° ì´ë¦„ì„ ì‘ì„±í•´ì£¼ê³ ,<br> 
`VALUE`ì—ëŠ” ê²Œì‹œê¸€ ë‚´ìš©(`TEXT`)ê³¼ ì´ë¯¸ì§€ íŒŒì¼(`FILE`)ì„ ì²¨ë¶€í•œ ë’¤,<br>
ë°˜ë“œì‹œ `CONTENT TYPE`ì„ ëª…ì‹œí•´ì£¼ì–´ì•¼ í•œë‹¤! <br>
(`CONTENT TYPE` í•„ë“œê°€ ì•ˆë³´ì¸ë‹¤ë©´ ìœ„ ì‚¬ì§„ì— í‘œì‹œí•œ ë¶€ë¶„ì„ í´ë¦­í•˜ì—¬ Content Typeì„ ì„ íƒí•œë‹¤.)<br><br>
ë‚˜ì¤‘ì— ì•ˆë“œë¡œì´ë“œì—ì„œ ë³´ë‚¼ ë•Œë„ `CONTENT TYPE`ì„ ëª…í™•í•˜ê²Œ í•´ì•¼í•  ê²ƒ ê°™ë‹¤..


# Ref.
- [https://velog.io/@eeheaven/SpringBoot-AndroidStudio-KnockKnock-%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80-0227-%EA%B2%8C%EC%8B%9C%EA%B8%80-%EC%9E%91%EC%84%B1-%EC%8B%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%84%A3%EA%B8%B0-Server-%EA%B0%9C%EB%B0%9C](https://velog.io/@eeheaven/SpringBoot-AndroidStudio-KnockKnock-%EA%B0%9C%EB%B0%9C%EC%9D%BC%EC%A7%80-0227-%EA%B2%8C%EC%8B%9C%EA%B8%80-%EC%9E%91%EC%84%B1-%EC%8B%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%84%A3%EA%B8%B0-Server-%EA%B0%9C%EB%B0%9C) 
- [https://devlog-wjdrbs96.tistory.com/323](https://devlog-wjdrbs96.tistory.com/323)
- [https://ttl-blog.tistory.com/320](https://ttl-blog.tistory.com/320)

***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}