---
title:  "[E-commerce App] Prometheus와 Grafana "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-15 00:55:42
last_modified_at: 2022-10-15 00:55:45
---
이번에는 Prometheus와 Grafana를 연동해 Micrometer의 정보를 시각화해보자.

# 개요
## Prometheus
- Metrics를 수집하고 모니터링 및 알람에 사용되는 오픈소스 애플리케이션
- 2016년부터 CNCF에서 관리되는 2번째 공식 프로젝트<br>- Level DB -> Time Series Database(TSDB)
- Pull 방식의 구조와 다양한 Metric Exporter 제공
- 시계열 DB에 Metrics 저장 -> 조회 가능 (Query)

## Grafana
- 데이터 시각화, 모니터링 및 분석을 위한 오픈소스 애플리케이션
- 시계열 데이터를 시각화하기 위한 대시보드 제공

# 설치 및 실행
## Prometheus
### 설치
> [https://prometheus.io/download/](https://prometheus.io/download/)<br>
(mac OS는 darwin을 다운받으면 된다.)

![스크린샷 2022-10-15 오전 1 24 46](https://user-images.githubusercontent.com/59405576/195895127-7701e8ef-ae9f-45d9-a84e-a36807531df7.png){: width="700" height="700"}<br><br>

위 사이트에서 최신 버전을 다운 받은 뒤에 압축을 해제하자.<br>
압축은 마우스 더블 클릭으로 해제해도 되고, 터미널로는 아래 명령어로 해제할 수 있다.
```bash
$ tar xvzf prometheus-2.39.1.darwin-amd64.tar.gz
```
압축을 해제해보면 아래와 같은 파일로 구성되어 있다.<br>
<img width="454" alt="스크린샷 2022-10-15 오전 1 36 35" src="https://user-images.githubusercontent.com/59405576/195897073-d69bc7d1-7da2-4113-bf57-864b0bf135a6.png"><br><br>
이어서 `code` 혹은 `vi`로 `application.yml` 파일을 열어, 아래 설정을 진행하자.<br><br>
기본은 아래처럼 되어있는데, 여기에 job을 추가하자.<br>
<img width="636" alt="스크린샷 2022-10-15 오전 1 40 36" src="https://user-images.githubusercontent.com/59405576/195898283-c5f452e8-2b42-4d94-8c63-3b5df75619cd.png"><br><br>

`prometheus.yml`<br>
정보를 수집하고자 하는 target을 지정한다.<br>
맨 마지막 부분만 수정하면 된다.
```yml
# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "user-service"
    scrape_interval: 15s
    metrics_path: "/user-service/actuator/prometheus"
    static_configs:
      - targets: ["localhost:8000"]

  - job_name: "order-service"
    scrape_interval: 15s
    metrics_path: "/order-service/actuator/prometheus"
    static_configs:
      - targets: ["localhost:8000"]

  - job_name: "gateway-service"
    scrape_interval: 15s
    metrics_path: "/actuator/prometheus"
    static_configs:
      - targets: ["localhost:8000"]
```
target에는 api gateway 주소와 포트 번호를 적으면 된다.<br>

> 🚨 그런데!<br>
이전에 오더 서비스 actuator 설정을 해주지 않았었다.<br>
`gateway-service`에 들어가서, <br>
`application.yml` 파일의 맨 아래에 오더 서비스 actuator 설정을 추가하자.<br>
```yml
- id: order-service
  uri: lb://ORDER-SERVICE
  predicates:
    - Path=/order-service/actuator/**
    - Method=GET
  filters:
    - RemoveRequestHeader=Cookie
    - RewritePath=/order-service/(?<segment>.*), /$\{segment}
```

### 실행
```bash
$ ./prometheus --config.file=prometheus.yml
```
정상적으로 기동했다면, `http://127.0.0.1:9090`에서 대시보드에 접근할 수 있다.<br>
![스크린샷 2022-10-15 오전 1 59 11](https://user-images.githubusercontent.com/59405576/195901752-e3d613e5-17bd-4f03-bb60-60ef191db980.png){: width="700" height="700"}<br><br>
혹시 아래와 같은 에러가 발생한다면?<br>
<img width="253" alt="스크린샷 2022-10-15 오전 1 54 26" src="https://user-images.githubusercontent.com/59405576/195900834-8eb6ea58-81fb-4152-8e11-f2b19b3c8e91.png"><br><br>
이는 MacOS에서 발생할 수 있는 에러이다.<br>
[환경설정 > 보안 및 개인 정보 보호]에서 "확인 없이 허용" 버튼을 클기하면 된다.<br> 
<img width="661" alt="스크린샷 2022-10-15 오전 1 56 18" src="https://user-images.githubusercontent.com/59405576/195901222-e0e9953e-a367-4424-8233-06d65e94b1a2.png">{: width="500" height="500"}<br><br>
다시 시도해보면 다른 메시지가 뜰텐데,"열기"를 클릭하자.<br>
<img width="256" alt="스크린샷 2022-10-15 오전 1 57 33" src="https://user-images.githubusercontent.com/59405576/195901366-fea0d48b-0735-42a1-84b7-13860bcb13f2.png">

### 테스트
프로메테우스 대시보드에서 지표값을 입력해보자.<br>
어떤 지표값을 입력할 지는 `http://127.0.0.1:8000/user-service/actuator/prometheus`에 접속해 확인하자.<br>
(8000번은 api gateway의 포트번호이다.)<br><br>
접속한 뒤, `http_server_request`라고 검색해보면, 아래와 같이 뜨는데,<br>
![스크린샷 2022-10-15 오전 2 03 58](https://user-images.githubusercontent.com/59405576/195902453-8563c8b2-ee1e-4bdc-835f-a6a946f29bf0.png)<br>
그 중에서 `http_server_requests_count`가 무슨의미인지 프로메테우스에서 검색해보자.<br><br>
![스크린샷 2022-10-15 오전 2 07 51](https://user-images.githubusercontent.com/59405576/195903091-1af5f9c2-ed10-4a6a-8338-4dee83c9f1d1.png){: width="700" height="700"}<br><br>
Table 옆에 Graph를 클릭해보면, 그래프로 시각화하여 볼 수 있다.<br>
![스크린샷 2022-10-15 오전 2 06 59](https://user-images.githubusercontent.com/59405576/195902945-0460c925-11c6-4d74-aeed-42d3553e9185.png){: width="500" height="500"}

## Grafana
### 설치
> [https://grafana.com/](https://grafana.com/)<br>
위 사이트에서 Downloads > Self-managed > Grafana Download > Mac 을 선택하면, 아래 커맨드를 확인할 수 있다.

![스크린샷 2022-10-15 오전 1 25 12](https://user-images.githubusercontent.com/59405576/195895136-0f255cdc-b712-4995-8535-dcc2301f3118.png){: width="700" height="700"}

```bash
$ curl -O https://dl.grafana.com/enterprise/release/grafana-enterprise-9.2.0.darwin-amd64.tar.gz

$ tar -zxvf grafana-enterprise-9.2.0.darwin-amd64.tar.gz
```

압축을 해제해보면 아래와 같은 파일로 구성되어 있다.<br>
<img width="451" alt="스크린샷 2022-10-15 오전 1 36 50" src="https://user-images.githubusercontent.com/59405576/195897227-4aa56a1e-f78c-49d6-8042-398b4927a6a7.png">

### 실행
```bash
$ ./bin/grafana-server
```
정상적으로 기동했다면, `http://127.0.0.1:3000`에서 대시보드에 접근할 수 있다.<br>
![스크린샷 2022-10-15 오전 2 11 55](https://user-images.githubusercontent.com/59405576/195903790-1284e19f-728d-4882-b520-26265bc657aa.png){: width="700" height="700"}<br><br>
초기 username과 password는 모두 `admin` 이다.<br>
(패스워드를 변경하도록 유도하는데, 변경해도 되고 변경하지 않아도 된다.)

# Grafana와 Prometheus 연동
프로메테우스에서 가져온 정보를 그라파나가 시각화하는 것이기 때문에, 둘을 연동해야 한다.






***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}