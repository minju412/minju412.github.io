---
title:  "[E-commerce App] Prometheusì™€ Grafana "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-15 00:55:42
last_modified_at: 2022-10-15 00:55:45
---
ì´ë²ˆì—ëŠ” Prometheusì™€ Grafanaë¥¼ ì—°ë™í•´ Micrometerì˜ ì •ë³´ë¥¼ ì‹œê°í™”í•´ë³´ì.

# ê°œìš”
## Prometheus
- Metricsë¥¼ ìˆ˜ì§‘í•˜ê³  ëª¨ë‹ˆí„°ë§ ë° ì•ŒëŒì— ì‚¬ìš©ë˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜
- 2016ë…„ë¶€í„° CNCFì—ì„œ ê´€ë¦¬ë˜ëŠ” 2ë²ˆì§¸ ê³µì‹ í”„ë¡œì íŠ¸<br>- Level DB -> Time Series Database(TSDB)
- Pull ë°©ì‹ì˜ êµ¬ì¡°ì™€ ë‹¤ì–‘í•œ Metric Exporter ì œê³µ
- ì‹œê³„ì—´ DBì— Metrics ì €ì¥ -> ì¡°íšŒ ê°€ëŠ¥ (Query)

## Grafana
- ë°ì´í„° ì‹œê°í™”, ëª¨ë‹ˆí„°ë§ ë° ë¶„ì„ì„ ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ ì• í”Œë¦¬ì¼€ì´ì…˜
- ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ê¸° ìœ„í•œ ëŒ€ì‹œë³´ë“œ ì œê³µ

# ì„¤ì¹˜ ë° ì‹¤í–‰
## Prometheus
### ì„¤ì¹˜
> [https://prometheus.io/download/](https://prometheus.io/download/)<br>
(mac OSëŠ” darwinì„ ë‹¤ìš´ë°›ìœ¼ë©´ ëœë‹¤.)

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 24 46](https://user-images.githubusercontent.com/59405576/195895127-7701e8ef-ae9f-45d9-a84e-a36807531df7.png){: width="700" height="700"}<br><br>

ìœ„ ì‚¬ì´íŠ¸ì—ì„œ ìµœì‹  ë²„ì „ì„ ë‹¤ìš´ ë°›ì€ ë’¤ì— ì••ì¶•ì„ í•´ì œí•˜ì.<br>
ì••ì¶•ì€ ë§ˆìš°ìŠ¤ ë”ë¸” í´ë¦­ìœ¼ë¡œ í•´ì œí•´ë„ ë˜ê³ , í„°ë¯¸ë„ë¡œëŠ” ì•„ë˜ ëª…ë ¹ì–´ë¡œ í•´ì œí•  ìˆ˜ ìˆë‹¤.
```bash
$ tar xvzf prometheus-2.39.1.darwin-amd64.tar.gz
```
ì••ì¶•ì„ í•´ì œí•´ë³´ë©´ ì•„ë˜ì™€ ê°™ì€ íŒŒì¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤.<br>
<img width="454" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 36 35" src="https://user-images.githubusercontent.com/59405576/195897073-d69bc7d1-7da2-4113-bf57-864b0bf135a6.png"><br><br>
ì´ì–´ì„œ `code` í˜¹ì€ `vi`ë¡œ `application.yml` íŒŒì¼ì„ ì—´ì–´, ì•„ë˜ ì„¤ì •ì„ ì§„í–‰í•˜ì.<br><br>
ê¸°ë³¸ì€ ì•„ë˜ì²˜ëŸ¼ ë˜ì–´ìˆëŠ”ë°, ì—¬ê¸°ì— jobì„ ì¶”ê°€í•˜ì.<br>
<img width="636" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 40 36" src="https://user-images.githubusercontent.com/59405576/195898283-c5f452e8-2b42-4d94-8c63-3b5df75619cd.png"><br><br>

`prometheus.yml`<br>
ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³ ì í•˜ëŠ” targetì„ ì§€ì •í•œë‹¤.<br>
ë§¨ ë§ˆì§€ë§‰ ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤.
```yml
# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "user-service"
    scrape_interval: 15s
    metrics_path: "/user-service/actuator/prometheus"
    static_configs:
      - targets: ["localhost:8000"]

  - job_name: "order-service"
    scrape_interval: 15s
    metrics_path: "/order-service/actuator/prometheus"
    static_configs:
      - targets: ["localhost:8000"]

  - job_name: "gateway-service"
    scrape_interval: 15s
    metrics_path: "/actuator/prometheus"
    static_configs:
      - targets: ["localhost:8000"]
```
targetì—ëŠ” api gateway ì£¼ì†Œì™€ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ì ìœ¼ë©´ ëœë‹¤.<br>

> ğŸš¨ ê·¸ëŸ°ë°!<br>
ì´ì „ì— ì˜¤ë” ì„œë¹„ìŠ¤ actuator ì„¤ì •ì„ í•´ì£¼ì§€ ì•Šì•˜ì—ˆë‹¤.<br>
`gateway-service`ì— ë“¤ì–´ê°€ì„œ, <br>
`application.yml` íŒŒì¼ì˜ ë§¨ ì•„ë˜ì— ì˜¤ë” ì„œë¹„ìŠ¤ actuator ì„¤ì •ì„ ì¶”ê°€í•˜ì.<br>
```yml
- id: order-service
  uri: lb://ORDER-SERVICE
  predicates:
    - Path=/order-service/actuator/**
    - Method=GET
  filters:
    - RemoveRequestHeader=Cookie
    - RewritePath=/order-service/(?<segment>.*), /$\{segment}
```

### ì‹¤í–‰
```bash
$ ./prometheus --config.file=prometheus.yml
```
ì •ìƒì ìœ¼ë¡œ ê¸°ë™í–ˆë‹¤ë©´, `http://127.0.0.1:9090`ì—ì„œ ëŒ€ì‹œë³´ë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 59 11](https://user-images.githubusercontent.com/59405576/195901752-e3d613e5-17bd-4f03-bb60-60ef191db980.png){: width="700" height="700"}<br><br>
í˜¹ì‹œ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ë©´?<br>
<img width="253" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 54 26" src="https://user-images.githubusercontent.com/59405576/195900834-8eb6ea58-81fb-4152-8e11-f2b19b3c8e91.png"><br><br>
ì´ëŠ” MacOSì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì—ëŸ¬ì´ë‹¤.<br>
[í™˜ê²½ì„¤ì • > ë³´ì•ˆ ë° ê°œì¸ ì •ë³´ ë³´í˜¸]ì—ì„œ "í™•ì¸ ì—†ì´ í—ˆìš©" ë²„íŠ¼ì„ í´ê¸°í•˜ë©´ ëœë‹¤.<br> 
<img width="661" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 56 18" src="https://user-images.githubusercontent.com/59405576/195901222-e0e9953e-a367-4424-8233-06d65e94b1a2.png">{: width="500" height="500"}<br><br>
ë‹¤ì‹œ ì‹œë„í•´ë³´ë©´ ë‹¤ë¥¸ ë©”ì‹œì§€ê°€ ëœ°í…ë°,"ì—´ê¸°"ë¥¼ í´ë¦­í•˜ì.<br>
<img width="256" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 57 33" src="https://user-images.githubusercontent.com/59405576/195901366-fea0d48b-0735-42a1-84b7-13860bcb13f2.png">

### í…ŒìŠ¤íŠ¸
í”„ë¡œë©”í…Œìš°ìŠ¤ ëŒ€ì‹œë³´ë“œì—ì„œ ì§€í‘œê°’ì„ ì…ë ¥í•´ë³´ì.<br>
ì–´ë–¤ ì§€í‘œê°’ì„ ì…ë ¥í•  ì§€ëŠ” `http://127.0.0.1:8000/user-service/actuator/prometheus`ì— ì ‘ì†í•´ í™•ì¸í•˜ì.<br>
(8000ë²ˆì€ api gatewayì˜ í¬íŠ¸ë²ˆí˜¸ì´ë‹¤.)<br><br>
ì ‘ì†í•œ ë’¤, `http_server_request`ë¼ê³  ê²€ìƒ‰í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ ëœ¨ëŠ”ë°,<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 2 03 58](https://user-images.githubusercontent.com/59405576/195902453-8563c8b2-ee1e-4bdc-835f-a6a946f29bf0.png)<br>
ê·¸ ì¤‘ì—ì„œ `http_server_requests_count`ê°€ ë¬´ìŠ¨ì˜ë¯¸ì¸ì§€ í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ ê²€ìƒ‰í•´ë³´ì.<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 2 07 51](https://user-images.githubusercontent.com/59405576/195903091-1af5f9c2-ed10-4a6a-8338-4dee83c9f1d1.png){: width="700" height="700"}<br><br>
Table ì˜†ì— Graphë¥¼ í´ë¦­í•´ë³´ë©´, ê·¸ë˜í”„ë¡œ ì‹œê°í™”í•˜ì—¬ ë³¼ ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 2 06 59](https://user-images.githubusercontent.com/59405576/195902945-0460c925-11c6-4d74-aeed-42d3553e9185.png){: width="500" height="500"}

## Grafana
### ì„¤ì¹˜
> [https://grafana.com/](https://grafana.com/)<br>
ìœ„ ì‚¬ì´íŠ¸ì—ì„œ Downloads > Self-managed > Grafana Download > Mac ì„ ì„ íƒí•˜ë©´, ì•„ë˜ ì»¤ë§¨ë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 25 12](https://user-images.githubusercontent.com/59405576/195895136-0f255cdc-b712-4995-8535-dcc2301f3118.png){: width="700" height="700"}

```bash
$ curl -O https://dl.grafana.com/enterprise/release/grafana-enterprise-9.2.0.darwin-amd64.tar.gz

$ tar -zxvf grafana-enterprise-9.2.0.darwin-amd64.tar.gz
```

ì••ì¶•ì„ í•´ì œí•´ë³´ë©´ ì•„ë˜ì™€ ê°™ì€ íŒŒì¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤.<br>
<img width="451" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 1 36 50" src="https://user-images.githubusercontent.com/59405576/195897227-4aa56a1e-f78c-49d6-8042-398b4927a6a7.png">

### ì‹¤í–‰
```bash
$ ./bin/grafana-server
```
ì •ìƒì ìœ¼ë¡œ ê¸°ë™í–ˆë‹¤ë©´, `http://127.0.0.1:3000`ì—ì„œ ëŒ€ì‹œë³´ë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-15 á„‹á…©á„Œá…¥á†« 2 11 55](https://user-images.githubusercontent.com/59405576/195903790-1284e19f-728d-4882-b520-26265bc657aa.png){: width="700" height="700"}<br><br>
ì´ˆê¸° usernameê³¼ passwordëŠ” ëª¨ë‘ `admin` ì´ë‹¤.<br>
(íŒ¨ìŠ¤ì›Œë“œë¥¼ ë³€ê²½í•˜ë„ë¡ ìœ ë„í•˜ëŠ”ë°, ë³€ê²½í•´ë„ ë˜ê³  ë³€ê²½í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.)

# Grafanaì™€ Prometheus ì—°ë™
í”„ë¡œë©”í…Œìš°ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ë¥¼ ê·¸ë¼íŒŒë‚˜ê°€ ì‹œê°í™”í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì—, ë‘˜ì„ ì—°ë™í•´ì•¼ í•œë‹¤.






***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}