---
title:  "[E-commerce App] μ„¤μ • μ •λ³΄μ μ•”νΈν™” μ²λ¦¬ "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-06 09:35:46
last_modified_at: 2022-10-06 09:35:50
---

<br>
`application.yml` νΉμ€ `bootstrap.yml`μ— μλ” plain text κ°’λ“¤μ„ μ•”νΈν™”μ²λ¦¬ν•λ” λ°©λ²•μ— λ€ν•΄ μ•μ•„λ³΄μ.

# κ°μ”
## λ€μΉ­ν‚¤ (Shared)
- μ•”/λ³µνΈν™” μ‹μ— κ°™μ€ ν‚¤λ¥Ό μ‚¬μ©ν•λ‹¤.

## λΉ„λ€μΉ­ν‚¤ (RSA Keypair)
- μ•”νΈν™” ν•  λ• μ‚¬μ©λλ” ν‚¤μ™€ λ³µνΈν™” ν•  λ• μ‚¬μ©λλ” ν‚¤κ°€ λ‹¤λ¥΄λ‹¤.
- κ³µκ°ν‚¤μ™€ μ‚¬μ„¤ν‚¤λ¥Ό μ‚¬μ©ν•λ‹¤.
- ν‚¤ κ°’μ„ μƒμ„±ν•κΈ° μ„ν•΄ Java keytoolμ„ μ‚¬μ©ν•λ‹¤.

## νλ¦„
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 9 44 10](https://user-images.githubusercontent.com/59405576/194188883-2cde97ae-d121-4eeb-9808-7f46f40afd43.png){: width="500" height="500"}<br>
λ―Όκ°ν• ν™κ²½ λ³€μκ°€ λ‹΄κΈ΄ `application.yml` νμΌμ„ κ·Έλ€λ΅ git repositoryμ— μ¬λ¦¬κ²λλ©΄, λ³΄μ•μ μΈ μ΄μκ°€ λ°μƒν•  μ μμΌλ―€λ΅ μ•”νΈν™”λ¥Ό μ§„ν–‰ν•  κ²ƒμ΄λ‹¤.<br><br>
μ΄ λ• ν…μ¤νΈκ°€ μ•”νΈν™” λμ–΄μλ‹¤λ” ν‘μ‹λ΅, ν…μ¤νΈ μ•μ— `{cipher}`λ¥Ό λ¶™μΈλ‹¤.<br>
μ•”νΈν™” λ κ°’μ΄ Spring Cloud Coonfig Serverμ—μ„ μ½ν€μ§€κ³ , <br>
κ°κ°μ λ§μ΄ν¬λ΅ μ„λΉ„μ¤λ“¤μ—κ² μ „λ‹¬λλ” μ‹μ μ—, keyλ¥Ό μ΄μ©ν•΄ cipher textλ¥Ό λ³µνΈν™” ν• λ’¤μ— μ‚¬μ©ν•λ‹¤.<br><br>
μ΄λ ‡κ² repository νΉμ€ νμΌμ‹μ¤ν…μ— λ―Όκ°ν• λ°μ΄ν„° νΉμ€ secret κ°’μ„ μ €μ¥μ‹μΌ λ†“λ”λ‹¤κ³  ν•λ”λΌλ„ μ™Έλ¶€μ— λ…Έμ¶λ  μ μλ” μ„ν—μ„ μµμ†ν™” ν•  μ μλ‹¤.

## JCE (Java Cryptography Extension)
java8(jdk8)μ„ μ‚¬μ©ν•λ‹¤λ©΄ JCEλ¥Ό μ¶”κ°€μ μΌλ΅ μ‚¬μ©ν•΄μ•Όν•λ‹¤.
> π¨ μ£Όμ
- java8(jdk8)μ„ μ‚¬μ©ν•λ‹¤λ©΄, encryption νΉμ€ decryption ν•  λ• μ•„λμ™€ κ°™μ€ λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤.<br>- Illegal key size or default parameters<br>- Unsupported keysize of algorithm parameters
- μ΄ κ²½μ°μ—λ” μ•„λ μ‚¬μ΄νΈμ—μ„ ν•„μ”ν• νμΌμ„ μ¶”κ°€λ΅ μ„¤μΉν•΄μ•Ό ν•λ‹¤.<br>- [https://www.oracle.com/java/technologies/javase-jce-all-downloads.html](https://www.oracle.com/java/technologies/javase-jce-all-downloads.html)<br>![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 9 56 52](https://user-images.githubusercontent.com/59405576/194189980-2f778c8c-8a87-4838-b9e1-ee624f3c4722.png)
- μ΄ κ³Όμ •μ€ java11(jdk11) μ΄μƒμ„ μ‚¬μ©ν•  λ•μ—λ” μƒλµν•  μ μλ‹¤.

JCEλ¥Ό μ‚¬μ©ν•΄μ•Όν•λ‹¤κ³  ν•λ©΄, μ„μ—μ„ λ§ν• νμΌμ„ λ‹¤μ΄λ΅λ“ λ°›μ€ ν›„μ— μ•„λ κ³Όμ •μ„ λ”°λΌν•μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 9 59 47](https://user-images.githubusercontent.com/59405576/194190340-92d8cb1c-991d-4f4a-8961-d4e022b042e4.png){: width="700" height="700"}

# λ€μΉ­ν‚¤λ¥Ό μ΄μ©ν• μ•”νΈν™”
## π `config-service`
### `pom.xml`
bootstrapμ΄ μ΄λ―Έ μ¶”κ°€λμ–΄μλ‹¤λ©΄ μ¶”κ°€ν•μ§€ μ•μ•„λ„ λλ‹¤.
```xml
<!-- Bootstrap -->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

### `bootstrap.yml`
κΈ°μ΅΄μ— `bootstrap.yml` νμΌμ΄ μ—†μ—κΈ° λ•λ¬Έμ— μƒλ΅ μƒμ„±ν•λ‹¤.<br>
λ€μΉ­ν‚¤ λ°©μ‹μ€ μ•”/λ³µνΈν™” μ‹ κ°™μ€ ν‚¤λ¥Ό μ‚¬μ©ν•λ‹¤.<br>
μ΄λ• μ‚¬μ©λ  ν‚¤λ¥Ό `bootstrap.yml`μ— μ •μν•μ. (ν‚¤λ” λ§μλ€λ΅ μ •μν•λ©΄ λλ‹¤.)
```yml
encrypt:
  key: abcdefghijklmnopqrstuvwxyz0123456789
```

> ν…μ¤νΈ<br>
μ•”νΈν™”κ°€ μ λλ”μ§€ ν…μ¤νΈλ¥Ό ν•΄λ³΄μ.<br>
`service-discovery`μ™€ λ°©κΈ μ„¤μ •ν• `config-service` λ‘ μ„λ²„λ¥Ό κΈ°λ™ν• λ’¤μ—,<br>
ν¬μ¤νΈλ§¨μ—μ„ `http://localhost:8888/encrypt`μ— λ‹¤μ μ”μ²­μ„ ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 10 28 58](https://user-images.githubusercontent.com/59405576/194193666-3bcc448f-3fe1-4257-ac1e-5d2a25616ae1.png){: width="500" height="500"}<br>
μ•”νΈν™”κ°€ λμ—λ‹¤.<br><br>
μ΄λ²μ—λ” cipher textλ¥Ό κ°€μ§€κ³  λ³µνΈν™” ν…μ¤νΈλ¥Ό ν•΄λ³΄μ.<br>
`http://localhost:8888/decrypt`μ— λ‹¤μ μ”μ²­μ„ ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 10 31 29](https://user-images.githubusercontent.com/59405576/194193947-7dba8727-344a-4574-a42d-d66c9558353b.png){: width="500" height="500"}<br>
λ³µνΈν™”λ„ μ λλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

## π `user-service`
### `application.yml`
`application.yml`μ— μλ db μ—°λ™ μ‹ ν•„μ”ν• μ„¤μ • μ •λ³΄λ¥Ό λ³„λ„μ νμΌλ΅ λ”°λ΅ λ¶„λ¦¬μ‹ν‚¤μ.<br>
μ΄λ” `config-service`μ `user-service.yml`λ΅ μ΄λ™μ‹ν‚¬ κ²ƒμ΄λ‹¤.<br>
μ•„λμ—μ„λ” μ–΄λ–¤ μ •λ³΄κ°€ μ‚¬λ¦¬μ΅λ”μ§€ λ‚νƒ€λ‚΄κΈ° μ„ν•΄ μ£Όμ„μΌλ΅ ν‘μ‹ν–μ§€λ§, μ‹¤μ λ΅λ” μ‚­μ ν•λ‹¤.
```yml
# datasource:
#  driver-class-name: org.h2.Driver
#  url: jdbc:h2:mem:testdb
#  username: sa
#  password: 1234
```

### `bootstrap.yml`
μ½μ–΄μ¤κ³ μ ν•λ” μ„¤μ • νμΌμ μ •λ³΄λ¥Ό λ…μ‹ν•λ‹¤.<br>
μ΄ λ• `name`μ— `config-service`λΌλ” Configuration Serverμ μ΄λ¦„μ„ μ κ²λλ©΄ `application.yml` νμΌμ„ μ½μ–΄μ¤κ³ ,<br>
`user-service`μ™€ κ°™μ€ νΉμ • μ΄λ¦„μ„ λ…μ‹ν•λ©΄ `user-service.yml`μ„ μ½μ–΄μ¨λ‹¤.
```yml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: user-service # π native-file-repo μ•μ— μλ” user-service.yml νμΌμ„ μ½μ–΄μ¨λ‹¤.
```

## π `native-file-repo`
### `user-service.yml`
μ•„κΉ `user-service`μ—μ„ μλΌλ‚Έ db μ—°κ²° μ •λ³΄λ¥Ό `user-service.yml`λ΅ λ¶™μ—¬λ„£λ”λ‹¤.<br>
μ΄ λ•, h2 databaseμ password(= `1234`)λ¥Ό μ•”νΈν™”ν•΄μ„ λ„£μ–΄μ¤€λ‹¤. <br>
```yml
spring:
  datasource:
  driver-class-name: org.h2.Driver
  url: jdbc:h2:mem:testdb
  username: sa
  password: '{cipher}c0c61dbe3eb9ef876f5b1810bd510a49d2ee8aa679956f68d9d1d4ff3b661108'
...
```
νμΌμ„ μ €μ¥ν• λ’¤μ— `config-service`λ¥Ό μ¬κΈ°λ™ν•΄μ¤€λ‹¤.

> μ°Έκ³ <br>
μ•”νΈν™”λ” μ„μ—μ„ ν–λ κ²ƒμ²λΌ ν¬μ¤νΈλ§¨μ„ μ΄μ©ν•λ©΄ λλ‹¤.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 10 44 16](https://user-images.githubusercontent.com/59405576/194195739-ec330646-ad70-4492-a2c8-06e3b10c2338.png){: width="500" height="500"}

## ν…μ¤νΈ
ν…μ¤νΈλ¥Ό μ„ν•΄ `gateway-service`λ„ κΈ°λ™ν•΄μ¤€λ‹¤. (ν„μ¬ `service-discovery` -> `config-service` -> `gateway-service` -> `user-service`κ°€ κΈ°λ™λμ–΄μλ‹¤.)<br>
`http://localhost:8888/user-service/default`μ— μ ‘μ†ν•΄λ³΄μ.<br>
μ•„λ μ‚¬μ§„μ—μ„ μ›Ή λΈλΌμ°μ €λ¥Ό ν†µν•΄ λ³΄μ΄λ” λ‹¨κ³„κ°€ `user`λΌλ” λ§μ΄ν¬λ΅ μ„λΉ„μ¤κ°€ μ‚¬μ©ν•λ” μ‹μ μ΄λΌκ³  λ³Ό μ μλ‹¤.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 10 51 40](https://user-images.githubusercontent.com/59405576/194196535-328bf776-ce78-4235-bcbe-ddedc790e9b1.png){: width="500" height="500"}<br>
`spring.password`λ¥Ό λ³΄λ©΄, μ •μƒμ μΌλ΅ `1234`λΌλ” plain textλ¥Ό μ½μ–΄μ¤λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.<br>
λ”°λΌμ„ μ €μ¥ν•  λ•μ—λ” μ•”νΈν™”λ cypher textλ¥Ό μ €μ¥ν•κ³ , μ‚¬μ©ν•  λ•μ—λ” μ„ μ‚¬μ§„μ—μ„ μ²λΌ decrypted λ plain textλ¥Ό μ‚¬μ©ν•¨μ„ μ• μ μλ‹¤.

> λ§μ•½ ν¨μ¤μ›λ“μ— μλ»λ μ•”νΈλ¬Έμ„ λ„£λ”λ‹¤λ©΄?<br><br>
`native-file-repo/user-service.yml`μ—μ„ passwordμ—<br>
`'{cipher}c0c61dbe3eb9ef876f5b1810bd510a49d2ee8aa679956f68d9d1d4ff3b661108_wrong'`κ³Ό κ°™μ΄ μΌλ¶€λ¬ μλ»λ μ•”νΈλ¬Έμ„ λ„£μ–΄λ³΄μ.<br><br>
`http://localhost:8888/user-service/default` νμ΄μ§€λ¥Ό μƒλ΅κ³ μΉ¨ ν•κ² λλ©΄, μ•„λμ™€ κ°™μ΄ `<n/a>`λ΅ ν‘μ‹λ¨μ„ μ• μ μλ‹¤.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 10 58 56](https://user-images.githubusercontent.com/59405576/194197403-fc8c676e-6281-4f5f-a178-d3c56a249dcc.png)

### h2-console μ ‘μ† ν…μ¤νΈ
`localhost:8761`μΌλ΅ μ λ μΉ΄ ν™μ— λ“¤μ–΄κ°€μ„ `user-service`μ ν¬νΈλ²νΈλ¥Ό ν™•μΈν• λ’¤, μ£Όμ† λ§μ§€λ§‰μ„ `/h2-console`λ΅ λ³€κ²½ν•΄ h2 μ½μ†”λ΅ μ ‘μ†ν•λ‹¤.<br>
μ΄μ „μ— ν–λ κ²ƒμ²λΌ ν¨μ¤μ›λ“ μ—†μ΄ test connectionμ„ μ‹λ„ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 11 12 02](https://user-images.githubusercontent.com/59405576/194198814-21323fdb-3edd-487f-bc54-649d72dc5193.png)<br>
ν¨μ¤μ›λ“ μ—†μ΄λ” μ ‘μ†λμ§€ μ•λ” κ²ƒμ„ ν™•μΈν–λ‹¤.<br>
μ΄λ²μ—λ” ν¨μ¤μ›λ“μ— `1234`λ¥Ό μ…λ ¥ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 11 12 31](https://user-images.githubusercontent.com/59405576/194198869-ae241add-0390-4d05-a2c1-d7cd3e2e0db8.png)<br>
μ°λ¦¬κ°€ μ•”νΈλ¬ΈμΌλ΅ μ„¤μ •ν•λ€λ΅ `1234`λ¥Ό μ…λ ¥ν•΄μ•Ό μ ‘μ†μ΄ λλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤. 

# λΉ„λ€μΉ­ν‚¤λ¥Ό μ΄μ©ν• μ•”νΈν™”
## ν‚¤ μƒμ„±
- public, private key μƒμ„± -> JDK keytool μ΄μ©
- λ³΄ν†µμ€ μ•”νΈν™”μ— private keyλ¥Ό μ‚¬μ©ν•κ³  λ³µνΈν™”μ— public keyλ¥Ό μ‚¬μ©ν•μ§€λ§ λ°λ€κ°€ λμ–΄λ„ μƒκ΄€μ—†λ‹¤. (μ•”/λ³µνΈν™” ν‚¤κ°€ μ„λ΅ λ‹¤λ¥΄κΈ°λ§ ν•λ©΄)

```bash
# keyκ°€ μ €μ¥λ  λ””λ ‰ν† λ¦¬ μƒμ„±
$ mkdir ${user.home}/study/msa/keystore

# keystore λ””λ ‰ν† λ¦¬λ΅ μ΄λ™
$ cd keystore

# key μƒμ„±
$ keytool -genkeypair -alias apiEncryptionKey -keyalg RSA \
-dname "CN=Ann, OU=API Development, O=test.co.kr, L=Seoul, C=KR" \
-keypass "test1234" -keystore apiEncryptionKey.jks -storepass "test1234"
```
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 11 43 50](https://user-images.githubusercontent.com/59405576/194202447-434c25e4-5ae1-46f3-936b-f8352332ad25.png)
- `-alias`: μƒμ„±λ ν‚¤μ— λ€ν• λ³„μΉ­, aliasλ¥Ό ν†µν•΄ νΈμ¶ν•κ³  μ‚¬μ© (μ—¬κΈ°μ„λ” μƒμ„±ν•κ³ μ ν•λ” ν‚¤ νμΌκ³Ό κ°™μ€ ν•μ‹μΌλ΅ μ§€μ •)
- `-keyalg`: ν‚¤ μƒμ„± μ‹, μ‚¬μ©λλ” μ•κ³ λ¦¬μ¦
- `-dname`: ν‚¤ μƒμ„± μ‹, μ…€ν”„ μΈμ¦μ— μ‚¬μ©λλ” λ¶€κ°€ μ •λ³΄<br>- CN: Company Name<br>- OU: Organization Unit<br>- O: Organization<br>- L: Location<br>- C: Country
- `-keypass`: ν‚¤ μƒμ„± μ‹, ν¨μ¤μ›λ“ (μ„μλ΅ μƒμ„±)
- `-keystore`: ν‚¤μ μ‹¤μ  νμΌ μ΄λ¦„ (`.jks`)
- `-storepass`: μ €μ¥λλ” ν‚¤ νμΌμ ν¨μ¤μ›λ“ (μ„μλ΅ μƒμ„±)

μƒμ„±λ ν‚¤ μ •λ³΄λ¥Ό μμ„Έν ν™•μΈν•΄λ³΄κ³  μ‹¶λ‹¤λ©΄, μ•„λ μ»¤λ§¨λ“λ¥Ό μ…λ ¥ν•λ‹¤.
```bash
$ keytool -list -keystore apiEncryptionKey.jks -v
```
ν¨μ¤μ›λ“λ¥Ό λ¬Όμ–΄λ³΄λ©΄, μ•„κΉ μ§€μ •ν• `test1234`λ¥Ό μ…λ ¥ν•λ‹¤.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 11 47 43](https://user-images.githubusercontent.com/59405576/194202915-777789fb-14ae-4d15-965c-e51bdcad6152.png)<br>
κ·ΈλΌ μ„ μ‚¬μ§„κ³Ό κ°™μ€ κ²°κ³Όκ°€ λ‚μ¤λ”λ°, `PrivateKeyEntry`λ¥Ό λ³΄λ©΄, μ΄ ν‚¤λ” private key μ„μ„ μ• μ μλ‹¤.<br><br>
κ·Έλ ‡λ‹¤λ©΄ μ΄ private keyμ—μ„ public keyλ¥Ό λ„μ§‘μ–΄λ‚΄λ³΄μ.
```bash
$ keytool -export -alias apiEncryptionKey -keystore apiEncryptionKey.jks -rfc -file trustServer.cer
```
ν¨μ¤μ›λ“λ¥Ό λ¬Όμ–΄λ³΄λ©΄, λ§μ°¬κ°€μ§€λ΅ `test1234`λ¥Ό μ…λ ¥ν•λ‹¤.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 11 52 00](https://user-images.githubusercontent.com/59405576/194203339-fa49a03a-b1ea-4704-b04f-3fd98ead62f7.png)<br>
μ„±κ³µμ μΌλ΅ κ³µκ°ν‚¤λ„ λ°κΈ‰λ°›μ•λ‹¤.<br><br>
κ·Έλ°λ° `.cer` ν™•μ¥μλ” μΈμ¦μ„ νμΌμ΄λ‹¤.<br>
μΈμ¦μ„ νμΌμ„ `jks` νμΌλ΅ λ³€ν™ν•μ—¬ μ‚¬μ©ν•  μλ„ μλ‹¤.
```bash
$ keytool -import -alias trustServer -file trustServer.cer -keystore publicKey.jks
```
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„α…¥α†« 11 56 10](https://user-images.githubusercontent.com/59405576/194203916-e1ab6385-c6cd-46a2-9570-6ffe03794c69.png)<br>
μ„ λ°•μ¤μ—λ” ν‚¤μ μ •λ³΄κ°€ ν‘μ‹λκ³ , λ§μ§€λ§‰μ— `μ`λ¥Ό μ…λ ¥ν•λ©΄ jks νμΌλ΅ λ³€ν™ν•  μ μλ‹¤.<br><br>
μ΄ ν‚¤ μ •λ³΄λ¥Ό μ•„κΉμ²λΌ μμ„Έν ν™•μΈν•΄λ³΄μ.
```bash
$ keytool -list -keystore publicKey.jks -v
```
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 00 19](https://user-images.githubusercontent.com/59405576/194204268-8e9db848-3cc6-4cc2-8b1f-c0d9987144df.png)<br>
`trustedCertEntry`λ¥Ό λ³΄λ©΄, μ΄ ν‚¤λ” public key μ„μ„ μ• μ μλ‹¤.

> μ°Έκ³ <br>
μ‚¬μ‹¤ Spring Cloud Config Serverμ—μ„λ” λΉ„λ°€ν‚¤(`apiEncryptionKey.jks`)λ§ μ‚¬μ©ν•  κ²ƒμ΄λ‹¤.<br>
λ‚λ¨Έμ§€λ” λ‚μ¤‘μ— κ³µκ°ν‚¤κ°€ ν•„μ”ν• μƒν™©μ΄ μƒκΈ΄λ‹¤λ©΄, μ‚¬μ©ν•΄λ³Ό μ μμ„ κ²ƒμ΄λ‹¤.

## π `config-service`
μ΄μ  μƒμ„±ν• λΉ„λ°€ν‚¤μ μ„μΉμ™€ νμΌλ…μ„ Configuration Serverμ— λ…μ‹ν•μ.
### `bootstrap.yml`
```yml
encrypt:
  key-store:
    location: file://${user.home}/study/msa/keystore/apiEncryptionKey.jks
    password: test1234
    alias: apiEncryptionKey
```
μ΄μ  `config-service`λ¥Ό μ¬κΈ°λ™ν•μ.

> μ°Έκ³ <br>
μ–΄λ””κΉμ§€κ°€ `${user.home}` μΌκΉ?<br>
keystore λ””λ ‰ν† λ¦¬μ—μ„ `pwd`λ¥Ό μ…λ ¥ν•κ²λλ©΄ μ•„λμ™€ κ°™μ΄ λ‚μ¤λ”λ°,<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 10 15](https://user-images.githubusercontent.com/59405576/194205443-5ee147f2-927b-4754-8605-007879660717.png)<br>
μ—¬κΈ°μ„ `/Users/μ‚¬μ©μλ…`κΉμ§€κ°€ `${user.home}` μ΄λ‹¤.

> ν¬μ¤νΈλ§¨ μ•”νΈν™” ν…μ¤νΈ<br>
λ€μΉ­ν‚¤ λ•μ™€ κ°™μ€ λ°©λ²•μΌλ΅ ν…μ¤νΈν•λ‹¤.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 13 33](https://user-images.githubusercontent.com/59405576/194205847-f2987919-3f36-4e0d-9870-b4f5994e9ea8.png){: width="500" height="500"}<br>
λ€μΉ­ν‚¤ λ•λ³΄λ‹¤ λ” λ³µμ΅ν•κ² μ•”νΈν™”κ°€ λμ—λ‹¤.<br><br>
μ΄λ²μ—λ” cipher textλ¥Ό κ°€μ§€κ³  λ³µνΈν™” ν…μ¤νΈλ¥Ό ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 16 34](https://user-images.githubusercontent.com/59405576/194206169-25cbaaa5-7933-4b68-a59b-1722fb3732fe.png){: width="500" height="500"}<br>
λ³µνΈν™”λ„ μ λλ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

## π `native-file-repo`
### `user-service.yml`
μ•„κΉ `user-service`μ—μ„ μλΌλ‚Έ db μ—°κ²° μ •λ³΄λ¥Ό `user-service.yml`λ΅ λ¶™μ—¬λ„£λ”λ‹¤.<br>
μ΄ λ•, h2 databaseμ password(= `1234`)λ¥Ό μ•”νΈν™”ν•΄μ„ λ„£μ–΄μ¤€λ‹¤. <br>
```yml
spring:
  datasource:
  driver-class-name: org.h2.Driver
  url: jdbc:h2:mem:testdb
  username: sa
  password: '{cipher}AAQCgo+KT8kG9ISz3Rr0FEG2uoOR9jJXhjMzbTWgcDQtTh4rShUrj3KtiOfFaN8Gk/MoJeyszPKouvCrQihy1SyVjNiZuGaIXkk2bf4HTMayE4IP1xvLF7nOEHbvxuZR6dv2UUVK2eJcQ+bskIk9+fBjVL9C4t1Gw/VDA9rMVzu55VYcsdsRSEnIfSCUlOzaWaH0XsuiDbZ5UI1LxqEB3hXLkazCWkahj2jFoKElzZ1kZ/QRnOFQTtXrv3jtf0P0ytwTVBqEa5Gjz4JJLr3tybc7i0avs+tqXjWKj35C/3Aq+sDH1L3sl+JNns4QiDclTpHTt+wDg/pqlg2MhZ0HAOIJNBtuP5P/qk6Pwk0fCUyWhuifmOMo9OuBBZowXsMk0Hqg=' # π λΉ„λ€μΉ­ν‚¤ μ•”νΈν™” λ°©μ‹ μ‚¬μ©
...
```
μ„ μ•”νΈλ¬Έμ€ κΈ°μ΅΄ λΉ„λ°€λ²νΈμΈ `1234`λ¥Ό λΉ„λ€μΉ­ν‚¤ μ•”νΈν™” ν• κ²ƒμ΄λ‹¤.<br>
νμΌμ„ μ €μ¥ν• λ’¤μ— μ›Ή λΈλΌμ–΄μ €μ—μ„ κ°’μ„ ν™•μΈν•΄λ³΄μ.

## ν…μ¤νΈ
`http://localhost:8888/user-service/default`μ— μ ‘μ†ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 36 51](https://user-images.githubusercontent.com/59405576/194208537-553343ae-0659-4315-99ef-767d5333e83e.png)<br>
μ•„κΉμ™€ λ§μ°¬κ°€μ§€λ΅ μ •μƒμ μΌλ΅ `1234`λΌλ” plain textλ¥Ό μ½μ–΄μ¤λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

## π `gateway-service`
μ§€κΈκΉμ§€λ” db μ •λ³΄λ¥Ό μ•”νΈν™”ν•΄μ„ μ‚¬μ©ν–λ‹¤λ©΄, μ΄λ²μ—λ” ν† ν°μ secret μ •λ³΄λ¥Ό μ•”νΈν™”ν•΄μ„ μ‚¬μ©ν•΄λ³΄μ.

### `bootstrap.yml`
ν„μ¬ `gateway-service`λ” native-file-repo μ•μ— μλ” ecommerce.yml νμΌμ—μ„ κµ¬μ„± μ •λ³΄λ¥Ό μ½μ–΄μ¤λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.
```yml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: ecommerce # π native-file-repo μ•μ— μλ” ecommerce.yml νμΌμ„ μ½μ–΄μ¨λ‹¤.
```

## π `native-file-repo`
### `ecommerce.yml`
κΈ°μ΅΄ `token.secret`μ—λ” μ•„λμ™€ κ°™μ΄ plain textκ°€ λ…Έμ¶λμ–΄ μμ—λ‹¤.
```yml
token:
  expiration_time: 864000000
  secret: user_token_native_ecommerce

gateway:
  ip: 127.0.0.1
```
μ΄λ¥Ό μ•„λμ²λΌ μ•”νΈλ¬ΈμΌλ΅ λ³€κ²½ν•μ.
```yml
token:
  expiration_time: 864000000
  secret: '{cipher}AQA4EotojUaSDNpQ5raB7YyPaZ+kOFdojsDz4UCo/cjHnAjQgZDrZFFvJxFPvYgNAUzQb2RJENdTsMai3WOhWxSJPWaWG/0l4qD3El0/eslslIfuvGMyrwTBaE97M05q/wRmjfBL/uW0pKmjAzNXX3NkGlVezq5HoNr+k9f4FEhz6CEdSnRsOndLkMr9AwOZFFzp1E/jCHdrQ80AZKdMPpCZLR8sSU/NZa28jL9odkKKGggJ6IFKTEBAIRbUwuHZX1jS+j9ugv+U6sD+QtzGEiNl0yoqoAeC52kfLJRsWS9JpA1HEJ0m+J2Bk4v7M37TtOXtPXJmsqEPuBNhLLuK48zN1nz9HKIqlMCc6J6Lr4v479l9c/73dtXNZNCgV609uzwWqTqa6/p1TiuH4NJszJyp'

gateway:
  ip: 127.0.0.1
```

> μ°Έκ³ <br>
μ•”νΈν™”λ” μ„μ—μ„ ν–λ κ²ƒμ²λΌ ν¬μ¤νΈλ§¨μ„ μ΄μ©ν•λ©΄ λλ‹¤.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 44 27](https://user-images.githubusercontent.com/59405576/194209491-61a0d427-c771-4c45-9cc6-464a4f677fc2.png){: width="500" height="500"}

## ν…μ¤νΈ
### μ•”/λ³µνΈν™” ν…μ¤νΈ
`http://localhost:8888/ecommerce/default`μ— μ ‘μ†ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 46 52](https://user-images.githubusercontent.com/59405576/194209745-37ad9214-9cde-4741-9646-91e325d7103f.png)<br>
μ •μƒμ μΌλ΅ `user_token_native_ecommerce`λΌλ” plain textλ¥Ό μ½μ–΄μ¤λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.

### `gateway-service` κΈ°λ™ ν›„ λ°›μ•„μ¤λ” ν† ν° κ°’ ν™•μΈ
κΈ°μ΅΄ `application.yml` νμΌμ— μλ ν† ν° μ •λ³΄λ¥Ό μ£Όμ„μ²λ¦¬ ν•λ‹¤.
```yml
#token:
#  secret: user_token
```

<br>
κ·Έλ¦¬κ³  ν† ν° μ •λ³΄λ¥Ό λ°›μ•„μ¤λ” κ³³μ— break pointλ¥Ό μ°κ³  λ””λ²„κΉ… λ¨λ“λ΅ μ‹¤ν–‰ν•λ‹¤.<br>
μ–΄λ– ν• `user-service`λ¥Ό νΈμ¶ν•΄λ„ κ²μ΄νΈμ›¨μ΄λ¥Ό κ±°μΉκΈ° λ•λ¬Έμ—,
`http://localhost:8000/user-service/health-check`λ¥Ό νΈμ¶ν•΄λ³΄μ.<br>
![α„‰α…³α„α…³α„…α…µα†«α„‰α…£α†Ί 2022-10-06 α„‹α…©α„’α…® 12 56 31](https://user-images.githubusercontent.com/59405576/194210729-04b1cfe2-2088-4b19-b643-d0744dd3ed58.png)<br>
μ•”νΈλ¬ΈμΌλ΅ λ“±λ΅ν• `token.secret`μ μ •λ³΄λ¥Ό μ •μƒμ μΌλ΅ λ³µνΈν™”ν•μ—¬ μ‚¬μ©ν•λ” κ²ƒμ„ ν™•μΈν•  μ μλ‹¤.<br>

κ·Έλ°λ°, μ¤‘μ”ν• κ²ƒμ€ `user-service`μ—μ„ μ‚¬μ©ν•λ” κµ¬μ„±νμΌ(`native-repo-repository/user-service.yml`)μ— μλ” ν† ν° κ°’κ³Ό `gateway-service`μ—μ„ μ‚¬μ©ν•λ” κµ¬μ„±νμΌ(`native-repo-repository/ecommerce.yml`)μ— μλ” ν† ν° κ°’μ΄ κ°™μ•„μ•Ό ν•λ‹¤λ” κ²ƒμ΄λ‹¤.<br>
λ”°λΌμ„ `user-service.yml`μ— μλ” ν† ν° μ •λ³΄λ¥Ό `ecommerce.yml`μ— μλ” ν† ν° μ •λ³΄μ™€ μΌμΉμ‹ν‚¨λ‹¤.<br><br>
`user-service.yml` λ³€κ²½ μ „
```yml
spring:
  datasource:
  driver-class-name: org.h2.Driver
  url: jdbc:h2:mem:testdb
  username: sa
  password: '{cipher}AQCgo+KT8kG9ISz3Rr0FEG2uoOR9jJXhjMzbTWgcDQtTh4rShUrj3KtiOfFaN8Gk/MoJeyszPKouvCrQihy1SyVjNiZuGaIXkk2bf4HTMayE4IP1xvLF7nOEHbvxuZR6dv2UUVK2eJcQ+bskIk9+fBjVL9C4t1Gw/VDA9rMVzu55VYcsdsRSEnIfSCUlOzaWaH0XsuiDbZ5UI1LxqEB3hXLkazCWkahj2jFoKElzZ1kZ/QRnOFQTtXrv3jtf0P0ytwTVBqEa5Gjz4JJLr3tybc7i0avs+tqXjWKj35C/3Aq+sDH1L3sl+JNns4QiDclTpHTt+wDg/pqlg2MhZ0HAOIJNBtuP5P/qk6Pwk0fCUyWhuifmOMo9OuBBZowXsMk0Hqg='

token:
  expiration_time: 864000000
  secret: user_token_native_user_service # ν† ν° μ •λ³΄ ν‰λ¬Έ

gateway:
  ip: 127.0.0.1
```

<br>

`user-service.yml` λ³€κ²½ ν›„
```yml
spring:
  datasource:
  driver-class-name: org.h2.Driver
  url: jdbc:h2:mem:testdb
  username: sa
  password: '{cipher}AQCgo+KT8kG9ISz3Rr0FEG2uoOR9jJXhjMzbTWgcDQtTh4rShUrj3KtiOfFaN8Gk/MoJeyszPKouvCrQihy1SyVjNiZuGaIXkk2bf4HTMayE4IP1xvLF7nOEHbvxuZR6dv2UUVK2eJcQ+bskIk9+fBjVL9C4t1Gw/VDA9rMVzu55VYcsdsRSEnIfSCUlOzaWaH0XsuiDbZ5UI1LxqEB3hXLkazCWkahj2jFoKElzZ1kZ/QRnOFQTtXrv3jtf0P0ytwTVBqEa5Gjz4JJLr3tybc7i0avs+tqXjWKj35C/3Aq+sDH1L3sl+JNns4QiDclTpHTt+wDg/pqlg2MhZ0HAOIJNBtuP5P/qk6Pwk0fCUyWhuifmOMo9OuBBZowXsMk0Hqg='

token:
  expiration_time: 864000000
  secret: '{cipher}AQA4EotojUaSDNpQ5raB7YyPaZ+kOFdojsDz4UCo/cjHnAjQgZDrZFFvJxFPvYgNAUzQb2RJENdTsMai3WOhWxSJPWaWG/0l4qD3El0/eslslIfuvGMyrwTBaE97M05q/wRmjfBL/uW0pKmjAzNXX3NkGlVezq5HoNr+k9f4FEhz6CEdSnRsOndLkMr9AwOZFFzp1E/jCHdrQ80AZKdMPpCZLR8sSU/NZa28jL9odkKKGggJ6IFKTEBAIRbUwuHZX1jS+j9ugv+U6sD+QtzGEiNl0yoqoAeC52kfLJRsWS9JpA1HEJ0m+J2Bk4v7M37TtOXtPXJmsqEPuBNhLLuK48zN1nz9HKIqlMCc6J6Lr4v479l9c/73dtXNZNCgV609uzwWqTqa6/p1TiuH4NJszJyp' # π ν† ν° μ •λ³΄ μ•”νΈλ¬Έ

gateway:
  ip: 127.0.0.1
```

> π μ°Έκ³ <br>
μ΄λ ‡κ² λ‘ ν† ν° μ •λ³΄λ¥Ό μ–‘μ½μ— λ‘κ°™μ΄ λ§μ¶”λ” λ°©λ²•λ„ μμ§€λ§, ν•λ‚λ΅ λ¨μ„ μλ„ μλ‹¤.<br><br>
ν•λ‚λ΅ λ¨μ€λ‹¤λ” κ²ƒμ€, <br>
`ecommerce.yml`μ΄λ“  `user-service.yml`μ΄λ“  μƒμ„ κ°λ…μΌλ΅ `application.yml`μ„ κ°€μ§€κΈ° λ•λ¬Έμ—,<br>
`ecommerce.yml`κ³Ό `user-service.yml` λ¨λ‘ `token.secret` μ •λ³΄λ¥Ό μ§€μ°κ³ , `application.yml`μ— μ •μν•κ² λλ©΄,<br>
λ‘ μ„λΉ„μ¤ λ¨λ‘ `application.yml`μ— μλ” `token.secret` μ •λ³΄λ¥Ό κ³µν†µμΌλ΅ κ°€μ§€κ³  μ¨λ‹¤.


***
<br>


    π’› κ°μΈ κ³µλ¶€ κΈ°λ΅μ© λΈ”λ΅κ·Έμ…λ‹λ‹¤. π‘»

[λ§¨ μ„λ΅ μ΄λ™ν•κΈ°](#){: .btn .btn--primary }{: .align-right}