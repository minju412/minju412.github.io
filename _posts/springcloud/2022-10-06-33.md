---
title:  "[E-commerce App] 설정 정보의 암호화 처리 "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-06 09:35:46
last_modified_at: 2022-10-06 09:35:50
---

<br>
`application.yml` 혹은 `bootstrap.yml`에 있는 plain text 값들을 암호화처리하는 방법에 대해 알아보자.

# 개요
## 대칭키 (Shared)
- 암/복호화 시에 같은 키를 사용한다.

## 비대칭키 (RSA Keypair)
- 암호화 할 때 사용되는 키와 복호화 할 때 사용되는 키가 다르다.
- 공개키와 사설키를 사용한다.
- 키 값을 생성하기 위해 Java keytool을 사용한다.

## 흐름
![스크린샷 2022-10-06 오전 9 44 10](https://user-images.githubusercontent.com/59405576/194188883-2cde97ae-d121-4eeb-9808-7f46f40afd43.png){: width="500" height="500"}<br>
민감한 환경 변수가 담긴 `application.yml` 파일을 그대로 git repository에 올리게되면, 보안적인 이슈가 발생할 수 있으므로 암호화를 진행할 것이다.<br><br>
이 때 텍스트가 암호화 되어있다는 표시로, 텍스트 앞에 `{cipher}`를 붙인다.<br>
암호화 된 값이 Spring Cloud Coonfig Server에서 읽혀지고, <br>
각각의 마이크로 서비스들에게 전달되는 시점에, key를 이용해 cipher text를 복호화 한 뒤에 사용한다.<br><br>
이렇게 repository 혹은 파일시스템에 민감한 데이터 혹은 secret 값을 저장시켜 놓는다고 하더라도 외부에 노출될 수 있는 위험을 최소화 할 수 있다.

## JCE (Java Cryptography Extension)
java8(jdk8)을 사용한다면 JCE를 추가적으로 사용해야한다.
> 🚨 주의
- java8(jdk8)을 사용한다면, encryption 혹은 decryption 할 때 아래와 같은 문제가 발생할 수 있다.<br>- Illegal key size or default parameters<br>- Unsupported keysize of algorithm parameters
- 이 경우에는 아래 사이트에서 필요한 파일을 추가로 설치해야 한다.<br>- [https://www.oracle.com/java/technologies/javase-jce-all-downloads.html](https://www.oracle.com/java/technologies/javase-jce-all-downloads.html)<br>![스크린샷 2022-10-06 오전 9 56 52](https://user-images.githubusercontent.com/59405576/194189980-2f778c8c-8a87-4838-b9e1-ee624f3c4722.png)
- 이 과정은 java11(jdk11) 이상을 사용할 때에는 생략할 수 있다.

JCE를 사용해야한다고 하면, 위에서 말한 파일을 다운로드 받은 후에 아래 과정을 따라하자.<br>
![스크린샷 2022-10-06 오전 9 59 47](https://user-images.githubusercontent.com/59405576/194190340-92d8cb1c-991d-4f4a-8961-d4e022b042e4.png){: width="700" height="700"}

# 대칭키를 이용한 암호화
## 🍊 `config-service`
### `pom.xml`
bootstrap이 이미 추가되어있다면 추가하지 않아도 된다.
```xml
<!-- Bootstrap -->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

### `bootstrap.yml`
기존에 `bootstrap.yml` 파일이 없었기 때문에 새로 생성한다.<br>
대칭키 방식은 암/복호화 시 같은 키를 사용한다.<br>
이때 사용될 키를 `bootstrap.yml`에 정의하자. (키는 마음대로 정의하면 된다.)
```yml
encrypt:
  key: abcdefghijklmnopqrstuvwxyz0123456789
```

> 테스트<br>
암호화가 잘 되는지 테스트를 해보자.<br>
`service-discovery`와 방금 설정한 `config-service` 두 서버를 기동한 뒤에,<br>
포스트맨에서 `http://localhost:8888/encrypt`에 다음 요청을 해보자.<br>
![스크린샷 2022-10-06 오전 10 28 58](https://user-images.githubusercontent.com/59405576/194193666-3bcc448f-3fe1-4257-ac1e-5d2a25616ae1.png){: width="500" height="500"}<br>
암호화가 되었다.<br><br>
이번에는 cipher text를 가지고 복호화 테스트를 해보자.<br>
`http://localhost:8888/decrypt`에 다음 요청을 해보자.<br>
![스크린샷 2022-10-06 오전 10 31 29](https://user-images.githubusercontent.com/59405576/194193947-7dba8727-344a-4574-a42d-d66c9558353b.png){: width="500" height="500"}<br>
복호화도 잘 되는 것을 확인할 수 있다.

## 🍊 `user-service`
### `application.yml`
`application.yml`에 있던 db 연동 시 필요한 설정 정보를 별도의 파일로 따로 분리시키자.<br>
이는 `config-service`의 `user-service.yml`로 이동시킬 것이다.<br>
아래에서는 어떤 정보가 사리졌는지 나타내기 위해 주석으로 표시했지만, 실제로는 삭제한다.
```yml
# datasource:
#  driver-class-name: org.h2.Driver
#  url: jdbc:h2:mem:testdb
#  username: sa
#  password: 1234
```

### `bootstrap.yml`
읽어오고자 하는 설정 파일의 정보를 명시한다.<br>
이 때 `name`에 `config-service`라는 Configuration Server의 이름을 적게되면 `application.yml` 파일을 읽어오고,<br>
`user-service`와 같은 특정 이름을 명시하면 `user-service.yml`을 읽어온다.
```yml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: user-service # 🌟 native-file-repo 안에 있는 user-service.yml 파일을 읽어온다.
```

## 🍊 `native-file-repo`
### `user-service.yml`
아까 `user-service`에서 잘라낸 db 연결 정보를 `user-service.yml`로 붙여넣는다.<br>
이 때, h2 database의 password(= `1234`)를 암호화해서 넣어준다. <br>
```yml
spring:
  datasource:
  driver-class-name: org.h2.Driver
  url: jdbc:h2:mem:testdb
  username: sa
  password: '{cipher}c0c61dbe3eb9ef876f5b1810bd510a49d2ee8aa679956f68d9d1d4ff3b661108'
...
```
파일을 저장한 뒤에 `config-service`를 재기동해준다.

> 참고<br>
암호화는 위에서 했던 것처럼 포스트맨을 이용하면 된다.<br>
![스크린샷 2022-10-06 오전 10 44 16](https://user-images.githubusercontent.com/59405576/194195739-ec330646-ad70-4492-a2c8-06e3b10c2338.png){: width="500" height="500"}

## 테스트
테스트를 위해 `gateway-service`도 기동해준다. (현재 `service-discovery` -> `config-service` -> `gateway-service` -> `user-service`가 기동되어있다.)<br>
아래 사진에서 웹 브라우저를 통해 보이는 단계가 `user`라는 마이크로 서비스가 사용하는 시점이라고 볼 수 있다.<br>
![스크린샷 2022-10-06 오전 10 51 40](https://user-images.githubusercontent.com/59405576/194196535-328bf776-ce78-4235-bcbe-ddedc790e9b1.png){: width="500" height="500"}<br>
`spring.password`를 보면, 정상적으로 `1234`라는 plain text를 읽어오는 것을 확인할 수 있다.<br>
따라서 저장할 때에는 암호화된 cypher text를 저장하고, 사용할 때에는 위 사진에서 처럼 decrypted 된 plain text를 사용함을 알 수 있다.

> 만약 패스워드에 잘못된 암호문을 넣는다면?<br><br>
`native-file-repo/user-service.yml`에서 password에<br>
`'{cipher}c0c61dbe3eb9ef876f5b1810bd510a49d2ee8aa679956f68d9d1d4ff3b661108_wrong'`과 같이 일부러 잘못된 암호문을 넣어보자.<br><br>
`http://localhost:8888/user-service/default` 페이지를 새로고침 하게 되면, 아래와 같이 `<n/a>`로 표시됨을 알 수 있다.<br>
![스크린샷 2022-10-06 오전 10 58 56](https://user-images.githubusercontent.com/59405576/194197403-fc8c676e-6281-4f5f-a178-d3c56a249dcc.png)

### h2-console 접속 테스트
`localhost:8761`으로 유레카 홈에 들어가서 `user-service`의 포트번호를 확인한 뒤, 주소 마지막을 `/h2-console`로 변경해 h2 콘솔로 접속한다.<br>
이전에 했던 것처럼 패스워드 없이 test connection을 시도해보자.<br>
![스크린샷 2022-10-06 오전 11 12 02](https://user-images.githubusercontent.com/59405576/194198814-21323fdb-3edd-487f-bc54-649d72dc5193.png)<br>
패스워드 없이는 접속되지 않는 것을 확인했다.<br>
이번에는 패스워드에 `1234`를 입력해보자.<br>
![스크린샷 2022-10-06 오전 11 12 31](https://user-images.githubusercontent.com/59405576/194198869-ae241add-0390-4d05-a2c1-d7cd3e2e0db8.png)<br>
우리가 암호문으로 설정한대로 `1234`를 입력해야 접속이 되는 것을 확인할 수 있다. 

# 비대칭키를 이용한 암호화


















***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}