---
title:  "[Spring Cloud Gateway] Filter ì ìš© "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-09-26 23:00:35
last_modified_at: 2022-09-26 23:00:38
---

Spring Cloud Gatewayì—ì„œ í•„í„°ê°€ ì–´ë–¤í•œ ë™ì‘ì— ì˜í•´ ì‘ë™í•˜ëŠ”ì§€, í”„ë¡œì„¸ìŠ¤ë¥¼ ì‚´í´ë³´ì.

# Filterì˜ í”„ë¡œì„¸ìŠ¤
í´ë¼ì´ì–¸íŠ¸ê°€ First Service í˜¹ì€ Second Serviceë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ê³  í•  ë•Œ, Spring Cloud gatewayê°€ ì¤‘ê°„ì— ìë¦¬ì¡ê³  ìˆë‹¤.<br>
í´ë¼ì´ì–¸íŠ¸ê°€ ê²Œì´íŠ¸ì›¨ì´ì— ì–´ë– í•œ ìš”ì²­ì„ ì „ë‹¬í•˜ë©´, ê²Œì´íŠ¸ì›¨ì´ì—ì„œ First Serviceë¡œ ê°ˆ ì§€ Second Serviceë¡œ ê°ˆ ì§€ íŒë‹¨ í›„ì— ì„œë¹„ìŠ¤ì— ìš”ì²­ì„ ë¶„ê¸°í•œë‹¤.<br>
ì´ ë•Œ, Spring Cloud gatewayì—ì„œ ì¼ì–´ë‚˜ëŠ” ì‘ì—…ì— ëŒ€í•´ ë” ìì„¸íˆ ì•Œì•„ë³´ì.<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-27 á„‹á…©á„Œá…¥á†« 12 04 43](https://user-images.githubusercontent.com/59405576/192312475-ef61649e-b5bc-4b77-9667-3f525d5ceac3.png){: width="800" height="800"}<br>
ì²« ë²ˆì§¸ë¡œ, `Gateway Handler Mapping`ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì–´ë–¤ ìš”ì²­ ì •ë³´ê°€ ë“¤ì–´ì™”ëŠ”ì§€, ìš”ì²­ ì •ë³´ë¥¼ ë°›ëŠ”ë‹¤.<br>
ê·¸ë¦¬ê³  ê·¸ ìš”ì²­ì´ ì–´ë– í•œ ì´ë¦„ìœ¼ë¡œ ë“¤ì–´ì™”ëŠ”ì§€, `Predicate`ë¥¼ í†µí•´ ìš”ì²­ì„ ë¶„ê¸°í•´ì¤€ë‹¤.<br><br>
ê·¸ë¦¬ê³  ì–´ë–¤ ì‘ì—…ì´ ì¼ì–´ë‚˜ê¸° ì „ì—, ì‚¬ì „ í•„í„°(`Pre Filter`)ê°€ ì ìš©ë˜ê³ ,<br>
ì–´ë–¤ ì‘ì—…ì´ ì¼ì–´ë‚œ ë’¤ì— ì‚¬í›„ í•„í„°(`Post Filter`)ê°€ ì ìš©ëœë‹¤.

# ë¼ìš°íŒ… + Filter ì ìš©
## 1. java ì½”ë“œë¥¼ ì´ìš©í•œ ë°©ì‹
ë¼ìš°íŒ… ì„¤ì •ì„ í•˜ë©´ì„œ filterë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤.<br>
ì´ ì „ì—ëŠ” ì•„ë˜ì²˜ëŸ¼ `application.yml` ì„¤ì •ì„ í†µí•´ ë¼ìš°íŒ… ì„¤ì •ì„ í–ˆë‹¤ë©´, ì´ë²ˆì—ëŠ” java ì½”ë“œë¥¼ í†µí•´ ì§ì ‘ ë¼ìš°íŒ… ì„¤ì •ì„ í•´ë³´ì.<br>
ì¶”ê°€ë¡œ, í•„í„°ê¹Œì§€ ì„¤ì •í•´ ë³¼ ê²ƒì´ë‹¤.
```yml
spring:
  application:
    name: apigateway-service
  cloud:
    gateway:
      routes:
        - id: first-service
          uri: http://localhost:8081/
          predicates:
            - Path=/first-service/**
        - id: second-service
          uri: http://localhost:8082/
          predicates:
            - Path=/second-service/**
```
### 1) apigateway-service
`config/FilterConfig.java`
```java
@Configuration
public class FilterConfig {

    @Bean
    public RouteLocator gatewayRoutes(RouteLocatorBuilder builder) {
        return builder.routes()
            .route(r -> r.path("/first-service/**")
                .filters(f -> f.addRequestHeader("first-req", "first-req-header")
                               .addResponseHeader("first-res", "first-res-header"))
                .uri("http://localhost:8081")
            )
            .route(r -> r.path("/second-service/**")
                .filters(f -> f.addRequestHeader("second-req", "second-req-header")
                               .addResponseHeader("second-res", "second-res-header"))
                .uri("http://localhost:8082")
            )
            .build();
    }
}
```
ì´ëŠ” ìœ„ì— ë³´ì´ëŠ” `application.yml`ê³¼ ê°™ì€ ì—­í• ì„ í•˜ë©°, ì‘ì„±í•˜ëŠ” ë°©ì‹ë§Œ ë‹¤ë¥¸ ê²ƒì´ë‹¤.

### 2) first-service
`FirstServiceController.java`
```java
@RestController
@RequestMapping("/first-service")
@Slf4j
public class FirstServiceController {

    @GetMapping("/message")
    public String message(@RequestHeader("first-req") String header) {
        log.info("header={}", header);
        return "Hello First Service";
    }
}
```
`first-req`ì— ë“¤ì–´ìˆëŠ” ê°’ì„ ë¡œê·¸ë¡œ ë‚¨ê²¨ë³´ì.

### 3) second-service
`SecondServiceController.java`
```java
@RestController
@RequestMapping("/second-service")
@Slf4j
public class SecondServiceController {

    @GetMapping("/message")
    public String message(@RequestHeader("second-req") String header) {
        log.info("header={}", header);
        return "Hello Second Service";
    }
}
```
ë§ˆì°¬ê°€ì§€ë¡œ `second-req`ì— ë“¤ì–´ìˆëŠ” ê°’ì„ ë¡œê·¸ë¡œ ë‚¨ê²¨ë³´ì.

### ê²°ê³¼ í™•ì¸
`http://localhost:8000/first-service/message`ê³¼ `http://localhost:8000/second-service/message`ì— ì ‘ì†í•´ë³´ì.

#### request header í™•ì¸
requestëŠ” ì¸í…”ë¦¬ì œì´ì˜ ì½˜ì†” ë¡œê·¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-27 á„‹á…©á„Œá…¥á†« 12 33 05](https://user-images.githubusercontent.com/59405576/192318927-84cbfb32-25f4-4297-a799-7e90db6e202e.png){: width="700" height="700"}<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-27 á„‹á…©á„Œá…¥á†« 12 33 24](https://user-images.githubusercontent.com/59405576/192318935-e2af83a3-150e-4469-81fb-b2a56eb292b0.png){: width="700" height="700"}<br>

#### response header í™•ì¸
responseëŠ” `cmd` + `option` + `i` ë‹¨ì¶•í‚¤ë¥¼ ì´ìš©í•´ ê°œë°œì ë„êµ¬ë¥¼ ì¼œì„œ í™•ì¸í•œë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-27 á„‹á…©á„Œá…¥á†« 12 30 46](https://user-images.githubusercontent.com/59405576/192318519-9f472e56-738f-41fe-a471-894f71bf8d01.png){: width="600" height="600"}<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-27 á„‹á…©á„Œá…¥á†« 12 31 30](https://user-images.githubusercontent.com/59405576/192318526-d11be706-a358-48d1-a7a4-e2d275b7c261.png){: width="600" height="600"}<br><br>
ì´ë ‡ê²Œ ê²Œì´íŠ¸ì›¨ì´ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì¤‘ê°„ì— ê°€ë¡œì±„ì„œ, ì¶”ê°€ì ì¸ request ê°’ì´ë¼ë˜ê°€ response ê°’ì„ ë„£ê³  ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.<br>
ë˜í•œ, `application.yml` íŒŒì¼ ë¿ë§Œ ì•„ë‹ˆë¼ java ì½”ë“œë¡œ ì§ì ‘ ë¼ìš°íŒ… í•  ìˆ˜ ìˆë‹¤.

## 2. `application.yml`ë¥¼ ì´ìš©í•œ ë°©ì‹
ì´ë²ˆì—ëŠ” `application.yml`ì„ í†µí•´ í•„í„°ë¥¼ ì ìš©í•˜ëŠ” ë²•ì„ ìµíˆê¸° ìœ„í•´,<br>
ì´ì „ì— ì‚¬ìš©í–ˆë˜ `FilterConfig` í´ë˜ìŠ¤ì˜ ë‚´ìš©ì„ ëª¨ë‘ ì£¼ì„ì²˜ë¦¬í•˜ê³  ì§„í–‰í•˜ì.<br>

### 1) apigateway-service
`application.yml`
```yml
spring:
  application:
    name: apigateway-service
  cloud:
    gateway:
      routes:
        - id: first-service
          uri: http://localhost:8081/ # 2. ì´ë™ ë  ì£¼ì†Œ
          predicates:
            - Path=/first-service/** # 1. ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¡°ê±´ ê°’
          filters: # í•„í„° ì¶”ê°€
            - AddRequestHeader=first-req, first-req-header2 # AddRequestHeader=key, value í˜•íƒœ
            - AddResponseHeader=first-res, first-res-header2 # AddResponseHeader=key, value í˜•íƒœ
        - id: second-service
          uri: http://localhost:8082/
          predicates:
            - Path=/second-service/**
          filters: # í•„í„° ì¶”ê°€
            - AddRequestHeader=second-req, second-req-header2
            - AddResponseHeader=second-res, second-res-header2
```

### ê²°ê³¼
request headerëŠ” ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì¸í…”ë¦¬ì œì´ì˜ ì½˜ì†” ë¡œê·¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
#### response header í™•ì¸
ì´ë²ˆì—ëŠ” í¬ìŠ¤íŠ¸ë§¨ì„ ì´ìš©í•´ í…ŒìŠ¤íŠ¸í•´ë³´ì.<br>
í¬ìŠ¤íŠ¸ë§¨ì—ì„œ `http://localhost:8000/first-service/message`ê³¼ `http://localhost:8000/second-service/message`ì— ì ‘ì†í•´ë³´ì.
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-27 á„‹á…©á„Œá…¥á†« 1 11 04](https://user-images.githubusercontent.com/59405576/192327300-ae6b1dbd-8a11-44dc-b13b-e8aa3b17eb6f.png){: width="600" height="600"}<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-27 á„‹á…©á„Œá…¥á†« 1 11 38](https://user-images.githubusercontent.com/59405576/192327307-45a6a4e4-65cc-4d58-ba31-e14445984a9a.png){: width="600" height="600"}<br>
ë§ˆì°¬ê°€ì§€ë¡œ í•„í„°ë¥¼ í†µí•´ í—¤ë”ì— ê°’ì´ ì˜ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.






***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}