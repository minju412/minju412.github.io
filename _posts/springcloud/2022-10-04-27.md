---
title:  "[E-commerce App] Configuration Service & Spring Boot Actuator "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-04 13:35:27
last_modified_at: 2022-10-04 13:35:30
---
ì§€ê¸ˆê¹Œì§€ `user-service`, `order-service`, `catalog-service`ë¥¼ ê°œë°œí–ˆë‹¤.<br><br>
ì§€ê¸ˆê¹Œì§€ëŠ” êµ¬ì„±ì •ë³´ íŒŒì¼ì„ `application.yml` íŒŒì¼ì„ ì‚¬ìš©í–ˆì—ˆëŠ”ë°, ë¬¸ì œëŠ” êµ¬ì„± ì •ë³´ê°€ ë³€ê²½ë˜ë©´ ì„œë¹„ìŠ¤ ìì²´ë¥¼ ë‹¤ì‹œ ë¹Œë“œí•œ ë’¤ì— ë°°í¬í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.<br>
ì´ëŸ¬í•œ ì ì„ ê°œì„ í•˜ê¸° ìœ„í•´ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‚´ë¶€ì— êµ¬ì„±íŒŒì¼ì„ ê°€ì§€ê³  ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì™¸ë¶€ì— ìˆëŠ” ì‹œìŠ¤í…œì„ í†µí•´ êµ¬ì„±íŒŒì¼ ì •ë³´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì— ëŒ€í•´ ì‚´í´ë³´ì.

# 1. Spring Cloud Config
- ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì„œë²„, í´ë¼ì´ì–¸íŠ¸ êµ¬ì„±ì— í•„ìš”í•œ ì„¤ì • ì •ë³´(`application.yml`)ë¥¼ "ì™¸ë¶€" ì‹œìŠ¤í…œì—ì„œ ê´€ë¦¬
- í•˜ë‚˜ì˜ ì¤‘ì•™í™” ëœ ì €ì¥ì†Œì—ì„œ êµ¬ì„±ìš”ì†Œ ê´€ë¦¬ ê°€ëŠ¥
- êµ¬ì„± ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ, ê° ì„œë¹„ìŠ¤ë¥¼ ë‹¤ì‹œ ë¹Œë“œí•˜ì§€ ì•Šê³  ë°”ë¡œ ì ìš© ê°€ëŠ¥
- ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ íŒŒì´í”„ë¼ì¸ì„ í†µí•´ DEV(ê°œë°œ) - UAT(í…ŒìŠ¤íŠ¸) - PROD(ë°°í¬) í™˜ê²½ì— ë§ëŠ” êµ¬ì„± ì •ë³´ ì‚¬ìš©

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-04 á„‹á…©á„’á…® 1 43 27](https://user-images.githubusercontent.com/59405576/193736058-38fc60dc-c059-4374-8028-309dada8b516.png){: width="700" height="700"}

## 1) Local Git Repository
### `ecommerce.yml` íŒŒì¼ ìƒì„±
ë¡œì»¬ì— `git-local-repo` ë¼ëŠ” ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•œ í›„, ê·¸ ì•ˆì— `ecommerce.yml` íŒŒì¼ì„ ìƒì„±í•œë‹¤.
```yml
token:
  expiration_time: 86400000
  secret: user_token

gateway:
  ip: 192.168.2.1 # ë³¸ì¸ IP
```

> ğŸš¨ ì£¼ì˜<br>
ì•„ë˜ì—ì„œ local git repositoryì— ë“±ë¡í• ê±´ë°,<br>
ê·¸ ì´í›„ì— `ecommerce.yml` íŒŒì¼ì˜ ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´, add - commit ì„ í•´ì£¼ì–´ì•¼ ë³€ê²½ì‚¬í•­ì´ ì ìš©ëœë‹¤!<br>
(pushëŠ” ì•„ì§ ì§„í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.)

### Local Git Repositoryì— ë“±ë¡
í„°ë¯¸ë„ì„ ì¼œì„œ ì´ì „ì— ìƒì„±í•œ `git-local-repo` ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•œë‹¤.
```
$ git init
$ git add ecommerce.yml
$ git commit -m "update an application yaml file"
```
ì´ë ‡ê²Œ í•˜ë©´, ì•„ì§ remote repositoryì—ëŠ” ì˜¬ë¼ê°€ì§€ ì•Šê³ , local repositoryì—ë§Œ ì˜¬ë¦° ê²ƒì´ë‹¤.<br>
ì•„ì§ê¹Œì§€ëŠ” localì—ì„œë§Œ ê´€ë¦¬í•œë‹¤.
(`push` ì´í›„ì— remote repositoryì— ì˜¬ë¼ê°„ë‹¤.)

> ğŸŒŸ ì°¸ê³ ) ìš°ì„ ìˆœìœ„<br>
ì§€ê¸ˆê¹Œì§€ ë§Œë“  ë„¤ ê°œì˜ ì„œë¹„ìŠ¤(`user-service`, `order-service`, `catalog-service`, `gateway-service`) ëª¨ë‘ `application.yml` íŒŒì¼ì„ ê°€ì§€ê³  ìˆë‹¤.<br>
ìš°ì„ ìˆœìœ„ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.
1. `application.yml`
2. `application-name.yml` <br>- ì˜ˆ) `user-service.yml`, `order-service.yml`
3. `application-name-<profile>.yml` <br>- ì˜ˆ) `user-service-dev.yml`, `order-service-prod.yml`

## 2) `config-service` í”„ë¡œì íŠ¸ ìƒì„±
- Spring Boot: 2.7.4
- dependencies<br>- `Config Server`

### `application.yml`
```yml
server:
  port: 8888

spring:
  application:
    name: config-service
  cloud:
    config:
      server:
        git:
          uri: file:///Users/minju/study/msa/git-local-repo
```
`spring.cloud.config.server.git.uri`ë¥¼ ë³´ë©´,<br>
íŒŒì¼ í”„ë¡œí† ì½œ(`file://`) ì„ ì´ìš©í•´ ë¶ˆëŸ¬ì˜¤ê³ ìí•˜ëŠ” íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤.<br><br>
íŒŒì¼ì˜ ê²½ë¡œëŠ”, í„°ë¯¸ë„ì—ì„œ `git-local-repo` ë””ë ‰í† ë¦¬ë¡œ ì´ë™ í•œ ë’¤, `pwd` ì»¤ë§¨ë“œë¡œ ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤.<br>
<img width="318" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-04 á„‹á…©á„’á…® 2 48 50" src="https://user-images.githubusercontent.com/59405576/193744133-08630e10-5269-4b0c-bce3-1addc271bb9f.png">

### ì„œë²„ ê¸°ë™
ì„œë²„ë¥¼ ê¸°ë™í•œ ë’¤, `http://127.0.0.1:8888/ecommerce/default`ë¡œ ì ‘ì†í•˜ë©´, ì•„ë˜ì™€ ê°™ì´ `ecommerce.yml` íŒŒì¼ì— ì‘ì„±í•œ ì„¤ì •ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-04 á„‹á…©á„’á…® 2 51 27](https://user-images.githubusercontent.com/59405576/193744478-fc9915a4-46ae-433f-97e2-5eecf4a9fa49.png)<br><br>
ì´ë•Œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚´í´ë³´ë©´, `/ecommerce/default`ì¸ë°, <br>
`/ecommerce`ëŠ” `git-local-repo` ì•ˆì— ìˆëŠ” ì„¤ì •íŒŒì¼(`ecommerce.yml`)ì˜ ì´ë¦„ì´ê³ ,<br>
`/default`ëŠ” ì„¤ì •íŒŒì¼ì˜ profilesë¡œ, ì•„ë¬´ê²ƒë„ ì„¤ì •í•˜ì§€ ì•Šì•˜ìœ¼ë‹ˆ `/default` ì´ê³ , ë§Œì•½ `ecommerce-dev.yml`ë¡œ ì„¤ì •í–ˆë‹¤ë©´ `/dev`ê°€ ë˜ëŠ” ê²ƒì´ë‹¤.

## 3) `user-service`
### `pom.xml`
`pom.xml`ì— ì•„ë˜ dependencyë¥¼ ì¶”ê°€í•œë‹¤.
```xml
<!-- spring-cloud-config ì„¤ì • -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

### `bootstrap.yml` ì¶”ê°€
`bootstrap.yml`ì€ ì™¸ë¶€ì— ìˆëŠ” Spring Cloud Configì— ëŒ€í•œ ì •ë³´ë¥¼ ë“±ë¡í•´ì£¼ëŠ” ì—­í• ë¡œ, <br>
`application.yml` ë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë†’ë‹¤.
```yml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: ecommerce
```
ì´ ë•Œ, `spring.cloud.config.uri`ì— ìˆëŠ” `:8888`ì€ `config-service`ì˜ port ë²ˆí˜¸ì´ë‹¤.<br>
`spring.cloud.config.name`ì—ëŠ” ì½ì–´ì˜¤ê³ ìí•˜ëŠ” yaml íŒŒì¼ì˜ ì´ë¦„ì„ ì ëŠ”ë‹¤. <br>
(ë‚˜ëŠ” `git-local-repo` ë””ë ‰í† ë¦¬ ì•ˆì— `ecommerce.yml` ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì´ê¸° ë•Œë¬¸ì— `ecommerce`ë¥¼ ì…ë ¥í–ˆë‹¤.) <br><br>
ì‚¬ì‹¤ `bootstrap.yml`ì— ì ì€ ë‚´ìš©ì„ `application.yml`ì— ì ì–´ë„ ìƒê´€ ì—†ë‹¤.<br>
í•˜ì§€ë§Œ ì§€ê¸ˆ í•˜ê³ ì í•˜ëŠ” ì‘ì—…ì˜ í•µì‹¬ì€,<br>
ì›ë˜ ê°€ì§€ê³  ìˆë˜ `application.yml`ì˜ íŠ¹ì • ë¶€ë¶„ì„ ë–¼ì–´ì„œ, ë³„ë„ì˜ ê³µìš©ì„œë²„ ì—­í• ì„ í•˜ëŠ” Spring Cloud Config(=`config-service`)ë¥¼ ì´ìš©í•´ë³´ëŠ” ê²ƒì´ë‹¤.

### ê¸°ì¡´ `application.yml` ë³€ê²½
`ecommerce.yml`ì— í† í° ì •ë³´ë¥¼ ë„£ì–´ë†¨ìœ¼ë‹ˆ `config-service`ë¡œ ë¶€í„° í•´ë‹¹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì´ê¸° ë•Œë¬¸ì—, `application.yml`ì—ì„œëŠ” ì œê±°í•˜ì.
```yml
# token:
#  expiration_time: 86400000 # 60 * 60 * 24 * 1000 # í•˜ë£¨ì§œë¦¬ í† í°
#  secret: user_token
```

### `UserController.java`
`config-service`ë¡œë¶€í„° êµ¬ì„± ì •ë³´ë¥¼ ì˜ ê°€ì ¸ì™”ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ `health-check` ì½”ë“œë¥¼ ë³€ê²½í•´ë³´ì.
```java
@RestController
@RequestMapping("/") 
public class UserController {
    ...
    @GetMapping("/health-check")
    public String status() {
        return String.format("It's Working in User Service"
            + ", port(local.server.port) = " + env.getProperty("local.server.port")
            + ", port(server.port) = " + env.getProperty("server.port")
            + ", token secret = " + env.getProperty("token.secret")
            + ", token expiration time = " + env.getProperty("token.expiration_time")
        );
    }
}
```

### ì„œë²„ ê¸°ë™
`service-discovery`(=ìœ ë ˆì¹´ ì„œë²„), `gateway-service`, `config-service`ë¥¼ ë¨¼ì € ê¸°ë™í•œ ë’¤,<br>
`user-service`ë¥¼ ê¸°ë™í•œë‹¤.<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-04 á„‹á…©á„’á…® 3 40 39](https://user-images.githubusercontent.com/59405576/193751526-467fc276-a4da-414d-b414-9ec5c3648c61.png)<br>
ì„œë²„ë¥¼ ê¸°ë™í•˜ê²Œ ë˜ë©´ ìœ„ ì‚¬ì§„ì²˜ëŸ¼ ë‚˜ì˜¤ëŠ”ë°, ì—¬ê¸°ì„œ ì„¸ ê°€ì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 
- Configuration Server(=`config-service`)ì˜ ìœ„ì¹˜ì •ë³´ê°€ ì˜ í‘œì‹œë˜ì–´ìˆë‹¤.
- ì½ì–´ì˜¨ êµ¬ì„±ì •ë³´ íŒŒì¼ì˜ ì´ë¦„ì´ `ecommerce`ì´ê³  profilesëŠ” `default`ì´ë‹¤.
- ì½ì–´ì˜¤ê³ ìí•˜ëŠ” bootstrapì˜ ìœ„ì¹˜ ì •ë³´ëŠ” `git-local-repo`ì— ìˆëŠ” `ecommerce.yml`ë¡œë¶€í„° ê°€ì ¸ì˜¨ ê²ƒì´ë‹¤.

<br>

ì´ì œ `health-check`ì— ì ‘ì†í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-04 á„‹á…©á„’á…® 3 50 43](https://user-images.githubusercontent.com/59405576/193752960-e802b6d7-07df-4d41-8829-c66261cd78ef.png)
> ğŸš¨ ì£¼ì˜<br>
ë§Œì•½, `ecommerce.yml`ì˜ ë‚´ìš©ì´ ë³€ê²½ë˜ì—ˆë‹¤ë©´, `user-service`ë„ ì¬ê¸°ë™ í•´ì£¼ì–´ì•¼í•œë‹¤.<br>
í•˜ì§€ë§Œ Configuration Serverì˜ êµ¬ì„± ì •ë³´ë¥¼ ë³€ê²½í•  ë•Œë§ˆë‹¤ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì¬ê¸°ë™ í•´ì•¼í•˜ëŠ” ê²ƒì€ ë²ˆê±°ë¡œìš´ ì¼ì´ë‹¤..ğŸ¤”

# 2. Changed configuration values
ë³€ê²½ëœ configuration ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë°©ë²•ì—ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆì„ê¹Œ?
- (ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤) ì„œë²„ ì¬ê¸°ë™
- Actuator refresh
- Spring cloud bus ì‚¬ìš© ğŸŒŸ

ì„œë²„ ì¬ê¸°ë™ì€ ì´ì „ì— ë§í–ˆë“¯ì´ ë²ˆê±°ë¡œìš´ ë°©ë²•ì´ë‹¤.<br>
ì´ë²ˆ ê¸€ì—ì„œëŠ” Actuatorì— ëŒ€í•´ ë¨¼ì € ì•Œì•„ë³´ê³ , ë‹¤ìŒ ê¸€ì—ì„œ Spring cloud busì— ëŒ€í•´ ì•Œì•„ë³´ì.














***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}