---
title:  "[E-commerce App] Users Microservice "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-09-29 00:25:29
last_modified_at: 2022-09-29 00:25:33
---

# ê°œìš”
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 12 01 54](https://user-images.githubusercontent.com/59405576/192814194-cb5977c6-04a5-4d24-9d1b-680805ef3f7e.png){: width="800" height="800"}<br>
`user-microservice`ëŠ” UIëŠ” ì—†ì´ REST API í˜•ì‹ìœ¼ë¡œ êµ¬í˜„í•  ê²ƒì´ë‹¤.<br>
ê·¸ë¦¬ê³  ìœ„ ì‚¬ì§„ì—ì„œ ë³´ì´ëŠ” ê¸°ëŠ¥ë“¤ì„ ê°œë°œí•  ê²ƒì´ë‹¤.

## APIs
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 12 04 31](https://user-images.githubusercontent.com/59405576/192814869-ed4ee880-fd85-4627-a3fc-d3e82d96269d.png){: width="800" height="800"}<br>
API Gateway ì‚¬ìš© ì‹œì—ëŠ” uriì— `/user-service`ë¼ëŠ” prefixê°€ ë¶™ì–´ì•¼í•˜ë©°, ëª¨ë“  ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì— ëŒ€í•´ ê°™ì€ í¬íŠ¸(ex.`8000`)ë¡œ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.<br>
ë¯¸ì‚¬ìš© ì‹œ prefix ì—†ì´ í˜¸ì¶œí•˜ê³ ìí•˜ëŠ” end pointë§Œ ì…ë ¥í•˜ë©´ ë˜ê³ , í•´ë‹¹í•˜ëŠ” ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì˜ í¬íŠ¸(ex.`8081`)ë¡œ í˜¸ì¶œí•´ì•¼ í•œë‹¤.<br><br>


# Users Microservice - ê¸°ë³¸ì ì¸ ì‚¬ìš©ì ê°€ì…ê³¼ ì „ì²´ íšŒì› ëª©ë¡ ì¡°íšŒ
## 1. í”„ë¡œì íŠ¸ ìƒì„±
- Dependencies<br>- DevTools, Lombok, Spring Web, Eureka Discovery Client

## ì‹¤í–‰
### ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬(= ìœ ë ˆì¹´ ì„œë²„) ì‹¤í–‰
ì¸í…”ë¦¬ì œì´ì—ì„œ ì‹¤í–‰í•˜ëŠ” ê²ƒ ìì²´ê°€ ë¶€í•˜ê°€ í¬ê¸° ë•Œë¬¸ì— í„°ë¯¸ë„ë¡œ ì‹¤í–‰í•˜ì.<br>
ë¨¼ì €, í„°ë¯¸ë„ ìƒì—ì„œ ìœ ë ˆì¹´ ì„œë²„ê°€ ìˆëŠ” ê³³ìœ¼ë¡œ ì´ë™í•˜ì.
```
$ cd service-discovery
$ mvn spring-boot:run # ìœ ë ˆì¹´ ì„œë²„ ì‹¤í–‰
```
<br>

### `user-service` ì‹¤í–‰
í„°ë¯¸ë„ì„ ì´ìš©í•´ ìœ ë ˆì¹´ ì„œë²„ë¥¼ ë¨¼ì € ì‹¤í–‰í•œ ë’¤,<br>
ì¸í…”ë¦¬ì œì´ì—ì„œ `user-service`ë¥¼ ì‹¤í–‰í•œë‹¤.<br>
ê·¸ ë‹¤ìŒ, `http://localhost:8761`ì— ì ‘ì†í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ì— `user-service`ê°€ ë“±ë¡ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br>
<img width="1061" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 12 54 09" src="https://user-images.githubusercontent.com/59405576/192827115-b66337be-6943-4119-bfbb-d42a9d50a9bb.png"><br><br>
í•´ë‹¹ urlì„ í´ë¦­í•˜ì—¬ í¬íŠ¸ë²ˆí˜¸ë¥¼ í™•ì¸í•œ ë’¤, end pointë¥¼ `/health-check`ë¡œ ë°”ê¾¼ë‹¤.<br>
ì°¸ê³ ë¡œ, ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì¬ì‹œë™ í•  ë•Œ ë§ˆë‹¤ í¬íŠ¸ë²ˆí˜¸ëŠ” ë°”ë€ë‹¤.<br><br>

## 2. `welcome()` ë©”ì„œë“œ ìƒì„±
ì´ë²ˆì—ëŠ” í™”ë©´ì— ê°„ë‹¨í•œ ì¸ì‚¬ë§ì„ ë„ì›Œë³¼ ê²ƒì´ë‹¤.<br>
`application.yml`ì— ì¸ì‚¬ë§ì„ ì •ì˜í• ê±´ë°, ì´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì—ëŠ” ë‘ ê°€ì§€ê°€ ìˆë‹¤.<br>
ìš°ì„  `application.yml`ì˜ ë§¨ ì•„ë˜ì— ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì.
```yml
greeting:
  message: Welcome to the Simple E-commerce.
```

### ë°©ë²• 1. Environment ì´ìš©
`controller/UserController.java`
```java
@RestController
@RequestMapping("/")
public class UserController {

    private Environment env;

    @Autowired
    public UserController(Environment env) {
        this.env = env;
    }

    @GetMapping("welcome")
    public String welcome() {
        return env.getProperty("greeting.message");
    }
}
```

### ë°©ë²• 2. `@Value` ì´ìš©
`vo/Greeting.java`
```java
@Component
@Data
public class Greeting {

    @Value("${greeting.message}")
    private String message;
}
```

`controller/UserController.java`
```java
@RestController
@RequestMapping("/")
public class UserController {

    @Autowired // ì´ì²˜ëŸ¼ ì§ì ‘ ì£¼ì… ë°›ëŠ” ê²ƒì€ ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
    private Greeting greeting;

    @GetMapping("welcome")
    public String welcome() {
        return greeting.getMessage();
    }
}
```

## 3. H2 Database ì—°ë™
### `pom.xml`
> dependencyì˜ ì •í™•í•œ ì´ë¦„ì„ ëª¨ë¥¸ë‹¤ë©´ `mvnrepository.com`ì— ì ‘ì†í•˜ì—¬ ê²€ìƒ‰í•˜ì.

```xml
 <!-- https://mvnrepository.com/artifact/com.h2database/h2 -->
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <version>1.3.176</version>
    <scope>runtime</scope>
</dependency>
```
`scope`ì„ testë¡œ í•˜ë©´ ì‹¤í–‰í–ˆì„ ë•Œ ê²°ê³¼ë¥¼ ì•Œ ìˆ˜ ì—†ê¸°ë•Œë¬¸ì— runtimeìœ¼ë¡œ ë³€ê²½í–ˆë‹¤.<br><br>

### `application.yml`
ì•„ë˜ì™€ ê°™ì´ `spring` í•˜ìœ„ì— `h2` ê´€ë ¨ ë‚´ìš©ì„ ì¶”ê°€í•œë‹¤.
```yml
spring:
  application:
    name: user-service
  h2:
    console:
      enabled: true
      settings:
        web-allow-others: true
      path: /h2-console
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb
#    username: sa
#    password: 1234
```
<br><br>

### h2 console ì ‘ì†
ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ ì‹¤í–‰í•œ ë’¤, `user-service`ë¥¼ ì‹¤í–‰í•œë‹¤.<br>
`http://localhost:8761`ì— ì ‘ì†í•˜ì—¬ ê¸°ë™ë˜ê³  `user-service`ì˜ ì£¼ì†Œì— ì ‘ì†í•˜ë©´ `Whitelabel Error Page`ê°€ ëœ°í…ë°,<br>
ì´ ë•Œ ì ‘ì†ëœ urlì˜ í¬íŠ¸ë²ˆí˜¸ ì´í›„ ì—”íŠ¸í¬ì¸íŠ¸ë¥¼ `/h2-console`ë¡œ ë³€ê²½í•˜ë©´ ì ‘ì† ê°€ëŠ¥í•˜ë‹¤.<br>
`JDBC URL`ì—ëŠ” `jdbc:h2:mem:testdb`ë¥¼ ì…ë ¥í•œë‹¤.<br><br>
`Test Connection`ì„ ëˆŒë €ì„ ë•Œ ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤ë©´?<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 9 06 34](https://user-images.githubusercontent.com/59405576/192909691-69b8687a-c4c1-4d2c-98cc-436085a51ed0.png)<br>
h2ì˜ ë²„ì „ì„ 1.3.x ìœ¼ë¡œ ë³€ê²½í•œë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 9 09 26](https://user-images.githubusercontent.com/59405576/192909966-5a4ce915-ccf1-4c45-9283-21e09fcf93f4.png)<br>
í…ŒìŠ¤íŠ¸ì— ì„±ê³µí–ˆë‹¤. ì´ì œ Connectë¥¼ í´ë¦­í•´ ì ‘ì†í•  ìˆ˜ ìˆë‹¤.

## 4. íšŒì› ê°€ì…
- `RequestUser`: ì‚¬ìš©ìê°€ ì…ë ¥í•œ JSON ë°ì´í„°ë¥¼ ë°›ëŠ”ë‹¤.
- `UserDto` : ë°ì´í„°ê°€ ë‹¤ë¥¸ìª½ì— ìˆëŠ” ì„œë¹„ìŠ¤ í˜¹ì€ ë©”ì„œë“œë¡œ ì „ë‹¬ë˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.
- `UserEntity` : jpaì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ë§¤í•‘ë  ìˆ˜ ìˆëŠ” ê°ì²´ì´ë‹¤.

íšŒì›ê°€ì…ì—ì„œëŠ” ì•„ë˜ ì‚¬ì§„ì—ì„œì²˜ëŸ¼ `RequestUser` -> `UserDto` -> `UserEntity` ìˆœì„œë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•  ê²ƒì´ë‹¤.
<img width="1074" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 10 13 38" src="https://user-images.githubusercontent.com/59405576/192916253-2fadce41-3dd1-4a8f-828c-fef1f70ded22.png">{: width="800" height="800"}

### ğŸ—‚ vo
`vo/RequestUser.java`
ì‚¬ìš©ìê°€ íšŒì›ê°€ì… í•  ë•Œ ì „ë‹¬í•˜ëŠ” ì •ë³´ê°€ ì €ì¥ë˜ëŠ” í´ë˜ìŠ¤ì´ë‹¤.
```java
@Data
public class RequestUser {

    @NotNull(message = "Email cannot be null")
    @Size(min = 2, message = "Email not be less than two characters")
    private String email;

    @NotNull(message = "Name cannot be null")
    @Size(min = 2, message = "Name not be less than two characters")
    private String name;

    @NotNull(message = "Password cannot be null")
    @Size(min = 8, message = "Password must be equal or greater than 8 characters")
    private String pwd;
}
```

### ğŸ—‚ dto
`dto/UserDto.java`
ë„˜ê²¨ë°›ì€ RequestUser ê°’ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³  ë‹¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™í•˜ê¸° ìœ„í•œ ìš©ë„ë¡œ dto í´ë˜ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.<br>
UserDtoì—ëŠ” ì‚¬ìš©ìê°€ íšŒì›ê°€ì… í•  ë•Œ ì…ë ¥í•œ ì •ë³´ ë¿ë§Œ ì•„ë‹ˆë¼ ëœë¤ìœ¼ë¡œ ìƒì„±ëœ `userId`ì™€ ìƒì„± ë‚ ì§œì¸ `createdAt` ê·¸ë¦¬ê³  ì•”í˜¸í™” ëœ íŒ¨ìŠ¤ì›Œë“œì¸ `encryptedPwd`ê°€ ì¶”ê°€ë˜ì—ˆë‹¤.
```java
@Data
public class UserDto {

    private String email;
    private String name;
    private String pwd;
    private String userId;
    private Date createdAt;
    private String encryptedPwd;
}
```

### ğŸ—‚ jpa
`jpa/UserEntity.java`
entityì—ëŠ” validationì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.
```java
@Data
@Entity
@Table(name = "users")
public class UserEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, length = 50, unique = true)
    private String email;

    @Column(nullable = false, length = 50)
    private String name;

    @Column(nullable = false, unique = true)
    private String userId;

    @Column(nullable = false, unique = true)
    private String encryptedPwd;
}
```

`jpa/UserRepository.java`<br>
```java
public interface UserRepository extends CrudRepository<UserEntity, Long> {
}
```

### ğŸ—‚ service
`service/UserService.java`
```java
public interface UserService {

    UserDto createUser(UserDto userDto);
}
```

`service/UserServiceImpl.java`<br>
UserServiceImpl í´ë˜ìŠ¤ì—ì„œëŠ” `ModelMapper`ë¥¼ ì´ìš©í•´ í•˜ë‚˜ì˜ ê°ì²´ë¥¼ ë‹¤ë¥¸ ê°ì²´ë¡œ ë³€í™˜í•œë‹¤.
```java
@Service
public class UserServiceImpl implements UserService {

    @Autowired
    UserRepository userRepository;

    @Override
    public UserDto createUser(UserDto userDto) {

        userDto.setUserId(UUID.randomUUID().toString());

        ModelMapper mapper = new ModelMapper();
        mapper.getConfiguration().setMatchingStrategy(MatchingStrategies.STRICT);
        UserEntity userEntity = mapper.map(userDto, UserEntity.class); // ModelMapperë¥¼ ì´ìš©í•œ ê°ì²´ ë³€í™˜

        userEntity.setEncryptedPwd("encrypted_password");

        userRepository.save(userEntity);

        UserDto returnUserDto = mapper.map(userEntity, UserDto.class); // ModelMapperë¥¼ ì´ìš©í•œ ê°ì²´ ë³€í™˜

        return returnUserDto;
    }
}
```

### ğŸ—‚ controller
`controller/UserController.java`
```java
@RestController
@RequestMapping("/")
public class UserController {

    private UserService userService;

    @Autowired
    public UserController(UserService userService) {
        this.userService = userService;
    }

    @PostMapping("/users")
    public ResponseEntity<ResponseUser> createUser(@RequestBody RequestUser requestUser) {
        ModelMapper mapper = new ModelMapper();
        mapper.getConfiguration().setMatchingStrategy(MatchingStrategies.STRICT);

        UserDto userDto = mapper.map(requestUser, UserDto.class);
        userService.createUser(userDto);

        ResponseUser responseUser = mapper.map(userDto, ResponseUser.class);

        return ResponseEntity.status(HttpStatus.CREATED).body(responseUser);
    }
}
```

### í…ŒìŠ¤íŠ¸
#### í¬ìŠ¤íŠ¸ë§¨
ìœ ë ˆì¹´ ì„œë²„ì—ì„œ ê¸°ë™ë˜ê³  ìˆëŠ” ì„œë¹„ìŠ¤ì˜ í¬íŠ¸ ë²ˆí˜¸ë¥¼ í™•ì¸í•œ ë’¤ ì§„í–‰í•œë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 10 03 26](https://user-images.githubusercontent.com/59405576/192915184-11638036-981f-459b-a1af-04abe453e09a.png)

#### h2 console ì ‘ì†
ìœ ë ˆì¹´ ì„œë²„ì—ì„œ ê¸°ë™ë˜ê³  ìˆëŠ” ì„œë¹„ìŠ¤ì˜ urlì„ í´ë¦­í•œ ë’¤ ì—”ë“œí¬ì¸íŠ¸ë¥¼ `/h2-console`ë¡œ ë³€ê²½í•´ ì½˜ì†”ì— ì ‘ì†í•  ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-29 á„‹á…©á„Œá…¥á†« 10 04 26](https://user-images.githubusercontent.com/59405576/192915270-26a5101e-1009-4221-a8f7-ed9845ec1727.png)















***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}