---
title:  "[E-commerce App] Apache Kafka 사용(Kafka Connect) "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-09 17:26:13
last_modified_at: 2022-10-09 17:26:16
---

이 전 글에는 Kafka를 이용해 Producer와 Consumer를 사용해보았다.<br>
이번에는 이어서 Kafka Connect를 사용해보자.<br><br>
데이터베이스에 저장된 값을 또다른 데이터베이스에 이동하는 예제를 테스트해보기 위해, MariaDB부터 설치하자.

# MariaDB 
## 설치 및 테이블 생성
위 명령어로 mariadb 설치 후 시작해보자.
```bash
# mariadb 설치
$ brew install mariadb

# 시작
$ mysql.server start

# 종료
$ mysql.server stop

# 상태 확인
$ mysql.server status
```
이제 mysql 접속해보자.<br>
접속할 때 username은 내가 따로 변경했기 때문에 `admin`으로 지정한 것이다. 보통은 `root`일 것이다.
```bash
# 접속
$ mysql -u admin -p

# 현재 어떤 데이터베이스(스키마)들이 있는지 확인
$ show databases;
```
접속했으면, `mydb`라는 이름의 데이터베이스를 새로 생성하자.<br>
`mydb`가 가지고 있는 테이블들을 확인해보면, 아직 아무것도 없을 것이다.
```bash
# 데이터베이스 생성
mysql> create database mydb;

# 방금 생성한 mydb 사용
mysql> use mydb;

# 현재 사용 중인 데이터베이스가 가지고 있는 테이블들 확인
mysql> show tables;
```
![스크린샷 2022-10-09 오후 6 05 45](https://user-images.githubusercontent.com/59405576/194748017-11968149-52a3-4807-85b5-2a7cc5f0843f.png)

## `order-service`
`order-service`에서 기존에 사용하던 h2 데이터베이스 대신, MariaDB를 연동해보자.

### `pom.xml`
```xml
<!-- MariaDB -->
<dependency>
    <groupId>org.mariadb.jdbc</groupId>
    <artifactId>mariadb-java-client</artifactId>
    <version>2.7.2</version>
</dependency>
```

이제 `user-service`를 기동해보자. <br>
(유레카 서버->`config-service`->`gateway-service`->`order-service` 순으로 기동되어 있어야 한다.)

## h2-console 접속
유레카 서버에 들어가서 `order-service`의 포트 번호 뒤를 `/h2-console`로 바꿔 h2 콘솔에 접속해보자.<br>
그럼 기존에 아래 사진처럼 되어있을텐데, 그 아래 사진처럼 변경하자.<br><br>
변경 전<br>
![스크린샷 2022-10-09 오후 6 17 09](https://user-images.githubusercontent.com/59405576/194748550-facbddad-40d0-4efb-9e45-5e2d8a18241d.png)<br><br>
변경 후<br>
![스크린샷 2022-10-09 오후 6 22 06](https://user-images.githubusercontent.com/59405576/194748767-5812aa4b-d27f-46bf-b74b-0938a59258a9.png)
```
Saved Settings: Generic MySQL
Setting Name: Generic MySQL

Driver Class: org.mariadb.jdbc.Driver
JDVC URL: jdbc:mysql://localhost:3306/mydb
User Name: admin    # 본인이 설정한 username
Password: ***    # 본인이 설정한 password
```

### 테이블 생성
아래 쿼리문으로 `users` 테이블을 생성해보자.
```
create table users(
    id int auto_increment primary key,
    user_id varchar(20),
    pwd varchar(20),
    name varchar(20),
    created_at datetime default NOW()
);
```
우리가 Kafka Connect를 통해 하고싶은 작업은,<br>
`users` 테이블에 새로운 데이터가 insert 될 때,<br>
그 데이터를 감지했다가, 고스란히 새로운 데이터베이스에 옮기는 것이다.<br><br>
이어서 `orders` 테이블을 생성해보자.
```
create table orders (
    id int auto_increment primary key,
    product_id varchar(20) not null,
    qty int default 0,
    unit_price int default 0,
    total_price int default 0,
    user_id varchar(50) not null,
    order_id varchar(50) not null,
    created_at datetime default NOW()
);
```



# Apache Kafka 사용
## Ecosystem - 2. Kafka Connect
- Kafka Connect를 통해 Data를 Import/Export 가능
- 프로기래밍 없이 Configuration 파일만으로 받아온 데이터를 다른쪽으로 이동 가능
- Standalone mode, Distribution mode 지원<br>- RESTful API를 통해 지원<br>- Stream 또는 Batch 형태로 데이터 전송 가능<br>- 커스텀 Connector를 통한 다양한 Plugin 제공 (File, S3, Hive, Mysql, etc ...)
- 데이터를 가져오는 쪽을 Connect Source라 하고, 데이터를 받는 쪽을 Connect Sink라 한다.

![스크린샷 2022-10-09 오후 5 24 09](https://user-images.githubusercontent.com/59405576/194746060-af7bd461-a1e0-4d15-a4ec-668d55a930de.png){: width="700" height="700"}















***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}