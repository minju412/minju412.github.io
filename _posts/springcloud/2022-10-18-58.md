---
title:  "[E-commerce App] Docker Containerë¥¼ ì´ìš©í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ - 6. User Microservice "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-18 19:24:40
last_modified_at: 2022-10-18 19:24:43
---

ì´ì „ ê¸€ì— ì´ì–´ì„œ ì§„í–‰í•´ë³´ì.<br>
ìš°ì„ , ì§€ê¸ˆê¹Œì§€ ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ì´ìš©í•´ ë°°í¬í•œ ì„œë¹„ìŠ¤ë“¤ì€ ì•„ë˜ì™€ ê°™ë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 7 33 51](https://user-images.githubusercontent.com/59405576/196407449-d30945c3-4e3c-419b-b6ef-acc8919a9417.png){: width="600" height="600"}

# Docker Container
## 10. `user-service`
### 1) êµ¬ì„± ì •ë³´ íŒŒì¼(`.yml`) ë³€ê²½
> review<br>
ì´ì „ì— `config-service`ë¥¼ ë„ì»¤ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰í•  ë•Œ ì»¤ë§¨ë“œëŠ” ì•„ë˜ì™€ ê°™ì•˜ë‹¤.
```bash
$ docker run -d -p 8888:8888 --network ecommerce-network \
-e "spring.rabbitmq.host=rabbitmq" \
-e "spring.profiles.active=default" \
--name config-service ln8847/config-service:1.0
```
ì´ ë•Œ, `-e` ì˜µì…˜ì„ ì´ìš©í•´ `spring.profiles.active`ë¥¼ `native`ê°€ ì•„ë‹Œ `default`ë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì—<br>
í˜„ì¬ êµ¬ì„± ì •ë³´ëŠ” remote repository(ê¹ƒí—ˆë¸Œ)ì—ì„œ ì½ì–´ì˜¤ê³  ìˆë‹¤.

ê·¸ëŸ¼ ì´ì œ `user-service`ë¥¼ ì¸í…”ë¦¬ì œì´ë¡œ ì—´ì–´ `application.yml`ê³¼ `bootstrap.yml` íŒŒì¼ì„ í™•ì¸í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 9 22 02](https://user-images.githubusercontent.com/59405576/196428031-77422192-bf1f-4ae5-874e-59bf57ae25c8.png)<br>
ë”°ë¼ì„œ í˜„ì¬ êµ¬ì„± ì •ë³´ëŠ” remote repository(ê¹ƒí—ˆë¸Œ)ì— ìˆëŠ” `user-service.yml` íŒŒì¼ì—ì„œ ì½ì–´ì˜¤ê³  ìˆë‹¤.<br><br>
ì´ë¥¼ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸í•´ë³´ë©´,<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 9 23 34](https://user-images.githubusercontent.com/59405576/196428456-f22b348b-dcaa-4079-a0cf-49b92e9dbb0b.png)<br>
ìœ„ ì‚¬ì§„ì²˜ëŸ¼ í•´ë‹¹ ê¹ƒ ë ˆí¬ì§€í† ë¦¬ì— ìˆëŠ” `user-service.yml`ì—ì„œ ì½ì–´ì˜¤ê³  ìˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.<br><br>
ê·¸ëŸ°ë°, ìœ„ ì‚¬ì§„ì—ì„œ ë³´ë©´ `gateway.ip`ê°€ `127.0.0.1`ì´ë‹¤.<br>
ğŸŒŸ ì´ë¥¼ `gateway-service` ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•˜ê³  ìˆëŠ” IP Addressë¡œ ë°”ê¿”ì•¼ í•œë‹¤!<br><br>
`gateway-service` ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš© ì¤‘ì¸ IP AddressëŠ” ì•„ë˜ ì»¤ë§¨ë“œë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```bash
$ docker network inspect ecommerce-network
```
<img width="617" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 9 11 49" src="https://user-images.githubusercontent.com/59405576/196425918-d5ece971-15d1-4cad-a7b2-ec4cb4ebcf0f.png">

ì´ì œ `user-service.yml` íŒŒì¼ì˜ `gateway.ip`ë¥¼ ì•„ë˜ì²˜ëŸ¼ `172.18.05`ë¡œ ë³€ê²½í•œ ë’¤ì— ê¹ƒ ë ˆí¬ì§€í† ë¦¬ì— push í•˜ì.<br><br>
`user-service.yml`
```yml
spring:
  datasource:
  driver-class-name: org.h2.Driver
  url: jdbc:h2:mem:testdb
  username: sa
  password: '{cipher}AQCgo+KT8kG9ISz3Rr0FEG2uoOR9jJXhjMzbTWgcDQtTh4rShUrj3KtiOfFaN8Gk/MoJeyszPKouvCrQihy1SyVjNiZuGaIXkk2bf4HTMayE4IP1xvLF7nOEHbvxuZR6dv2UUVK2eJcQ+bskIk9+fBjVL9C4t1Gw/VDA9rMVzu55VYcsdsRSEnIfSCUlOzaWaH0XsuiDbZ5UI1LxqEB3hXLkazCWkahj2jFoKElzZ1kZ/QRnOFQTtXrv3jtf0P0ytwTVBqEa5Gjz4JJLr3tybc7i0avs+tqXjWKj35C/3Aq+sDH1L3sl+JNns4QiDclTpHTt+wDg/pqlg2MhZ0HAOIJNBtuP5P/qk6Pwk0fCUyWhuifmOMo9OuBBZowXsMk0Hqg='

token:
  expiration_time: 864000000
  secret: '{cipher}AQA4EotojUaSDNpQ5raB7YyPaZ+kOFdojsDz4UCo/cjHnAjQgZDrZFFvJxFPvYgNAUzQb2RJENdTsMai3WOhWxSJPWaWG/0l4qD3El0/eslslIfuvGMyrwTBaE97M05q/wRmjfBL/uW0pKmjAzNXX3NkGlVezq5HoNr+k9f4FEhz6CEdSnRsOndLkMr9AwOZFFzp1E/jCHdrQ80AZKdMPpCZLR8sSU/NZa28jL9odkKKGggJ6IFKTEBAIRbUwuHZX1jS+j9ugv+U6sD+QtzGEiNl0yoqoAeC52kfLJRsWS9JpA1HEJ0m+J2Bk4v7M37TtOXtPXJmsqEPuBNhLLuK48zN1nz9HKIqlMCc6J6Lr4v479l9c/73dtXNZNCgV609uzwWqTqa6/p1TiuH4NJszJyp'

gateway:
  ip: 172.18.0.5 # ğŸŒŸ 127.0.0.1 -> 172.18.0.5 ë³€ê²½

order-service:
  url: http://ORDER-SERVICE/order-service/%s/orders
  exception:
    order-is-empty: User's order is empty.
```
ë³€ê²½ í›„ add - commit - push ê¹Œì§€ ë§ˆì³¤ë‹¤.<br><br>
ë‹¤ì‹œ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸í•´ë³´ë©´, ì•„ë˜ì™€ ê°™ì´ ë³€ê²½ë˜ì–´ ìˆì„ ê²ƒì´ë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 9 32 12](https://user-images.githubusercontent.com/59405576/196430122-752d1bf6-486a-40f0-801c-3863d61d31b7.png)


### 2) Dockerfileì„ í†µí•´ ì´ë¯¸ì§€ ë§Œë“¤ê¸°
```Dockerfile
FROM openjdk:17-ea-11-jdk-slim

VOLUME /tmp

COPY target/user-service-0.0.1-SNAPSHOT.jar UserService.jar

ENTRYPOINT ["java","-jar","UserService.jar"]
```

### 3) ì´ë¯¸ì§€ ë¹Œë“œ ë° ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
```bash
# ìµœì‹  ë²„ì „ìœ¼ë¡œ ì»´íŒŒì¼
$ mvn clean compile package -DskipTests=true
# cleanì€ ê¸°ì¡´ íŒŒì¼ì„ ì§€ìš´ë‹¤.
# package ì˜µì…˜ìœ¼ë¡œ jar íŒŒì¼ê¹Œì§€ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
# í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” skip

# ì´ë¯¸ì§€ íŒŒì¼ ë¹Œë“œ
$ docker build -t ln8847/user-service:1.0  .

# ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸
$ docker images | grep user-service

# ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
$ docker push ln8847/user-service:1.0
```

### 4) ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
ê¸°ì¡´ì˜ `application.yml`ì—ì„œ `127.0.0.1` í˜¹ì€ `localhost`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ë¶€ë¶„ì„ `-e` ì˜µì…˜ì„ í†µí•´ ë„ì»¤ ì»¨í…Œì´ë„ˆì˜ ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ì„œ ì‹¤í–‰í•˜ì.
```bash
$ docker run -d --network ecommerce-network \
-e "spring.cloud.config.uri=http://config-service:8888" \
-e "spring.rabbitmq.host=rabbitmq" \
-e "spring.zipkin.base-url=http://zipkin:9411" \
-e "eureka.client.serviceUrl.defaultZone=http://service-discovery:8761/eureka/" \
-e "logging.file=/api-logs/users-ws.log" \
--name user-service \
ln8847/user-service:1.0
```
<img width="1419" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 9 49 30" src="https://user-images.githubusercontent.com/59405576/196433997-c55dcefa-0ffd-46a3-8074-7bc6c82414b4.png"><br><br>
`logging.file`ì„ ì§€ì •í•¨ìœ¼ë¡œì¨, `user-service` ë„ì»¤ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— `/api-logs/users-ws.log` ìœ„ì¹˜ì— ë¡œê·¸ë¥¼ ì €ì¥í•  ìˆ˜ ìˆë‹¤.<br>

ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ë³´ì.
```bash
$ docker network inspect ecommerce-network
```
<img width="621" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 9 50 51" src="https://user-images.githubusercontent.com/59405576/196434302-6e324c24-c600-4eac-b2cd-99bf14062fb4.png"><br>

ë¡œê·¸ë¥¼ í™•ì¸í•´ë³´ì.
```bash
$ docker logs user-service
```
<img width="1422" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 9 54 48" src="https://user-images.githubusercontent.com/59405576/196435642-44e4676a-729a-41a0-bffa-0053c4553c4c.png"><br>
`bootstrap` ì •ë³´ë„ ì˜ ê°€ì§€ê³  ì˜¤ê³  ë³„ë‹¤ë¥¸ ì—ëŸ¬ë„ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

> ì°¸ê³ <br>
ë¡œê·¸ë¥¼ í™•ì¸í•  ë•Œ `-f` ì˜µì…˜ì„ ë¶™ì´ê²Œ ë˜ë©´, ë¡œê·¸ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì½˜ì†”ì— ì°íŒë‹¤.<br>
(ì¢…ë£Œí•  ë•Œì—ëŠ” `ctrl`+`c`)
```bash
$ docker logs -f user-service
```

`http://127.0.0.1:8761`ì— ì ‘ì†í•´ `user-service`ê°€ ì˜ ê¸°ë™ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 10 00 12](https://user-images.githubusercontent.com/59405576/196436541-c2369ada-2de3-4aad-b05e-5b98001b12f5.png)

> ğŸŒŸ ì°¸ê³ <br>
ë§Œì•½, ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ì´ìš©í•´ `user-service` ê¸°ë™í•œ í›„ì— êµ¬ì„± ì •ë³´(`user-service.yml`)ë¥¼ ë³€ê²½í–ˆë‹¤ë©´,<br>
Spring Cloud Busë¥¼ ì´ìš©í•´ ë³€ê²½ ì‚¬í•­ì„ ì¼ê´„ ì ìš©í•  ìˆ˜ ìˆë‹¤.<br>






***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}