---
title:  "[E-commerce App] Spring Cloud Config - Spring Cloud Gateway ì—°ë™ "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-04 18:05:15
last_modified_at: 2022-10-04 18:05:19
---

ì´ë²ˆì—ëŠ” `gateway-service`ì™€ `config-service`ë¥¼ ì—°ë™í•´ë³´ì.<br>
ì´ì „ ê¸€ì—ì„œ `user-service`ì™€ `config-service`ë¥¼ ì—°ë™í•  ë•Œì™€ ë¹„ìŠ·í•˜ë‹¤.

# `gateway-service`
## `pom.xml`
```xml
<!-- spring-cloud-config ì„¤ì • -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>

<!-- Spring Boot Actuator -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

## `bootstrap.yml`
```yml
spring:
  cloud:
    config:
      uri: http://127.0.0.1:8888
      name: ecommerce
```

## `application.yml`
ì´ì „ì— `user-service`ì™€ ë‹¤ë¥¸ ì ì€, httptraceê°€ ì¶”ê°€ë˜ì—ˆë‹¤ëŠ” ì ì´ë‹¤.
```yml
management:
  endpoints:
    web:
      exposure:
        include: refresh, health, beans, httptrace
```
ê·¸ë¦¬ê³  USER-SERVICEì˜ Actuator ë¼ìš°í„° ì •ë³´ë„ ì¶”ê°€í•´ì¤€ë‹¤.<br>
(ì°¸ê³ ë¡œ, Actuator ë¼ìš°í„° ì •ë³´ ì¶”ê°€ëŠ” ì´ ì „ ê¸€ì—ì„œ ë¯¸ë¦¬ ì§„í–‰í–ˆë‹¤.)
```yml
 - id: user-service
    uri: lb://USER-SERVICE
    predicates:
      - Path=/user-service/actuator/**
      - Method=GET, POST
    filters:
      - RemoveRequestHeader=Cookie
      - RewritePath=/user-service/(?<segment>.*), /$\{segment}
```

## `GatewayServiceApplication.java`
httptrace ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ê¸° ìœ„í•´ ì•„ë˜ì²˜ëŸ¼ ì„¤ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.
```java
@SpringBootApplication
public class GatewayServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(GatewayServiceApplication.class, args);
    }

    // ğŸŒŸ httptrace ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ bean ë“±ë¡ 
    @Bean
    public HttpTraceRepository httpTraceRepository() {
        return new InMemoryHttpTraceRepository();
    }

}
```

# í…ŒìŠ¤íŠ¸
`service-discovery` -> `config-service` -> `gateway-service` -> `user-service` ìˆœìœ¼ë¡œ ì„œë²„ë¥¼ ê¸°ë™í•œë‹¤.<br><br>
`ecommerce.yml`ì˜ íŒŒì¼ ë‚´ìš©ì„ ë³€ê²½í•œ ë’¤ì— add - commit ê¹Œì§€ ì§„í–‰í•œë‹¤.<br><br>
`/user-service/actuator/refresh`ë¥¼ í˜¸ì¶œí•´ ë¦¬í”„ë ˆì‹œ í•˜ë©´ `user-service`ì—ì„œëŠ” ë³€ê²½ëœ êµ¬ì„± ì •ë³´ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°,<br>
`gateway-service`ì—ì„œëŠ” ë³€ê²½ë˜ê¸° ì´ì „ì˜ êµ¬ì„± ì •ë³´ë¥¼ ì‚¬ìš©í•œë‹¤.<br><br>
`gateway-service`ì—ì„œë„ ë³€ê²½ëœ ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ `/actuator/refresh`ë¥¼ í˜¸ì¶œí•˜ë©´,<br>
ê²Œì´íŠ¸ì›¨ì´ ì„œë¹„ìŠ¤ë„ ë³€ê²½ëœ êµ¬ì„± ì •ë³´ë¥¼ ì‚¬ìš©í•œë‹¤.

> `http://localhost:8000/actuator/refresh` â¡ï¸ `gateway-service` ë¦¬í”„ë ˆì‹œ<br>
`http://localhost:8000/user-service/actuator/refresh` â¡ï¸ `user-service` ë¦¬í”„ë ˆì‹œ

í•˜ì§€ë§Œ, ì´ë ‡ê²Œ ê°ê° refresh í•´ì£¼ì–´ì•¼ í•˜ëŠ” ë°©ë²•ì´ íš¨ìœ¨ì ì¸ ë°©ë²•ì€ ì•„ë‹ˆë‹¤.<br>
ë”°ë¼ì„œ ì´í›„ì—ëŠ” ğŸŒŸ Spring Cloud Busë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤.







***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}