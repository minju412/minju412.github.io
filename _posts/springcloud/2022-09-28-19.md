---
title:  "[Spring Cloud Gateway] Load Balancer "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-09-28 01:34:36
last_modified_at: 2022-09-28 01:34:40
---
ì´ë²ˆì—ëŠ” Spring Cloud Gatewayì™€ Eureka ì„œë²„ë¥¼ ì—°ë™í•´ë³´ì.<br>
ìœ ë ˆì¹´ë¼ëŠ” ë„¤ì´ë° ì„œë¹„ìŠ¤ì— ìŠ¤í”„ë§ ê²Œì´íŠ¸ì›¨ì´ë¥¼ ë“±ë¡í•˜ê³ ,<br>
`first-service`ì™€ `second-service`ê¹Œì§€ ë“±ë¡í•´ë³´ì.

# ğŸ™‚ `Spring Cloud Gateway` - `Eureka` ì—°ë™
## ê°œìš”
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„Œá…¥á†« 1 52 16](https://user-images.githubusercontent.com/59405576/192588129-93709ad2-9b04-434f-8cfd-9eac43d69eb8.png){: width="800" height="800"}

1. ì˜ˆë¥¼ ë“¤ì–´, í´ë¼ì´ì–¸íŠ¸ê°€ `http://localhost:8000/first-service/**`ì— ìš”ì²­í•  ë•Œ
2. ì´ ìš”ì²­ì •ë³´ê°€ ìœ ë ˆì¹´ ì„œë²„ì— ì „ë‹¬ë˜ê³ 
3. ìœ ë ˆì¹´ë¡œë¶€í„° ê·¸ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ ì „ë‹¬ ë°›ê³ 
4. ê²Œì´íŠ¸ì›¨ì´ ì„œë¹„ìŠ¤ê°€ í•´ë‹¹ ìš”ì²­ì„ í•´ë‹¹ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¡œ í¬ì›Œë”©í•œë‹¤.


## ì½”ë“œ
### 1) apigateway-service
#### `pom.xml`
ìœ ë ˆì¹´ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë“±ë¡í•˜ì.
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```
ìœ ë ˆì¹´ í´ë¼ì´ì–¸íŠ¸ëŠ” `first-service`ì™€ `second-service` ëª¨ë‘ ì¶”ê°€í•´ì¤€ë‹¤.

#### `application.yml`
ìœ ë ˆì¹´ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •ì„ `true`ë¡œ ë³€ê²½í•˜ì.<br>
ì´ëŠ” "8761ë²ˆ í¬íŠ¸(`discovery-service`)ì— ìœ ë ˆì¹´ í´ë¼ì´ì–¸íŠ¸ë¡œ ë“±ë¡í•˜ê² ë‹¤"ëŠ” ì˜ë¯¸ì´ë‹¤.
```yml
...
eureka:
  client:
    register-with-eureka: true # ğŸŒŸ ë³€ê²½
    fetch-registry: true # ğŸŒŸ ë³€ê²½
    service-url:
      defaultZone: http://localhost:8761/eureka

spring:
  application:
    name: apigateway-service
  cloud:
    gateway:
      default-filters:
        - name: GlobalFilter
          args:
            baseMessage: Spring Cloud Gateway Global Filter
            preLogger: true
            postLogger: true
      routes:
        - id: first-service
          uri: lb://MY-FIRST-SERVICE # ğŸŒŸ uri ë³€ê²½
          predicates:
            - Path=/first-service/** 
          filters:
            - CustomFilter
        - id: second-service
          uri: lb://MY-SECOND-SERVICE # ğŸŒŸ uri ë³€ê²½
          predicates:
            - Path=/second-service/**
          filters:
            - name: CustomFilter
            - name: LoggingFilter
              args:
                baseMessage: Hi, there.
                preLogger: true
                postLogger: true
```
`spring.cloud.gateway.routes`ì—ì„œ,<br>
`first-service`ì˜ `uri`ëŠ” ì›ë˜ `http://localhost:8081/` ì´ì—ˆê³ ,<br>
`second-service`ì˜ `uri`ëŠ” ì›ë˜ `http://localhost:8082/` ì´ì—ˆë‹¤.<br><br>
ì´ê²ƒì„ `lb://MY-FIRST-SERVICE`ì™€ `lb://MY-SECOND-SERVICE`ë¡œ ë°”ê¿ˆìœ¼ë¡œì¨,<br>
ê¸°ì¡´ì²˜ëŸ¼ http í”„ë¡œí† ì½œì„ ì´ìš©í•´ `localhost:8081` í˜¹ì€ `localhost:8082`ë¡œ ê°€ëŠ”ê²Œ ì•„ë‹ˆë¼,<br>
í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ ì •ë³´ë¥¼ ìœ ë ˆì¹´ ì„œë²„ì—ê²Œ ì „ë‹¬í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.<br><br>

### 2) first-service
#### `pom.xml`
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

#### `application.yml`
```yml
...
eureka:
  client:
    register-with-eureka: true # ğŸŒŸ ë³€ê²½
    fetch-registry: true # ğŸŒŸ ë³€ê²½
    service-url:
      defaultZone: http://localhost:8761/eureka
```


### 3) second-service
#### `pom.xml`
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

#### `application.yml`
```yml
...
eureka:
  client:
    register-with-eureka: true # ğŸŒŸ ë³€ê²½
    fetch-registry: true # ğŸŒŸ ë³€ê²½
    service-url:
      defaultZone: http://localhost:8761/eureka
```
ì´ë¡œì¨ ì´ 3ê°œì˜ ì„œë¹„ìŠ¤ê°€ ìœ ë ˆì¹´ ì„œë²„(`discovery-service`)ì— ë“±ë¡ëœ ê²ƒì´ë‹¤.<br>
- `apigateway-service`: 8000ë²ˆ í¬íŠ¸
- `first-service`: 8001ë²ˆ í¬íŠ¸
- `second-service`: 8002ë²ˆ í¬íŠ¸

## ì„œë²„ ê¸°ë™
ìœ ë ˆì¹´ ì„œë²„(`discovery-service`)ë¥¼ ë¨¼ì € ê¸°ë™ì‹œí‚¨ í›„,<br>
ê²Œì´íŠ¸ì›¨ì´(`apigateway-service`), `first-service`, `second-service` ìˆœìœ¼ë¡œ ê¸°ë™ì‹œí‚¤ì.<br><br>
ì´ì œ `http://localhost:8761`(= ìœ ë ˆì¹´ ì„œë²„)ì— ì ‘ì†í•˜ë©´ 3ê°œì˜ ì„œë¹„ìŠ¤ê°€ ë“±ë¡ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„Œá…¥á†« 2 14 06](https://user-images.githubusercontent.com/59405576/192592524-6b693496-7258-40d0-a1b3-24d7bf627807.png){: width="800" height="800"}

## í¬ìŠ¤íŠ¸ë§¨ ê²°ê³¼
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„Œá…¥á†« 2 26 39](https://user-images.githubusercontent.com/59405576/192594993-598edd8f-759c-477c-b884-56786594772d.png){: width="400" height="400"}<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„Œá…¥á†« 2 26 26](https://user-images.githubusercontent.com/59405576/192594958-5e522a9f-66e9-403e-9bad-468caeb44454.png){: width="400" height="400"}<br>
ì´ë¥¼ í†µí•´, ê¸°ì¡´ì— `http://localhost:8081` í˜¹ì€ `http://localhost:8082`ë¡œ í˜¸ì¶œí–ˆë˜ ì •ë³´ë“¤ì„<br>
ìœ ë ˆì¹´ ì„œë²„ì— ìˆëŠ” ìœ„ì¹˜ë¡œ ì •ë³´ë¥¼ ë³€ê²½í•˜ë”ë¼ë„ (`lb://MY-FIRST-SEVICE`, `lb://MY-SECOND-SEVICE`)<br>
ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br><br>
ì—¬ê¸°ê¹Œì§€ í•˜ë©´, ì´ì œ í•˜ë‚˜ ì´ìƒì˜ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ê¸°ë™í•´ì„œ ë¡œë“œ ë°¸ëŸ°ì„œì˜ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤.<br>
ì´ì œ ì´ê²ƒì„ í…ŒìŠ¤íŠ¸í•´ë³´ì.

# ğŸ™‚ `first-service`ì™€ `second-service`ë¥¼ ê°ê° 2ê°œì”© ê¸°ë™
- ë°©ë²• 1<br>- ì¸í…”ë¦¬ì œì´ì—ì„œ `Edit Configurations` -> VM optionsì— `-Dserver.port=9003` ì…ë ¥
- ë°©ë²• 2<br>- í„°ë¯¸ë„ì— `mvn spring-boot:run -Dspring-boot.run.jvmArguments='-Dserver.port=9003'` ì»¤ë§¨ë“œ ì…ë ¥
- ë°©ë²• 3<br>- íŒ¨í‚¤ì§€ íŒŒì¼ ìƒì„± í›„ java ëª…ë ¹ì–´ë¡œ í•´ë‹¹ íŒ¨í‚¤ì§€ íŒŒì¼ ì‹¤í–‰
```
mvn clean compile package  # maven ë¹Œë“œ
java -jar -Dserver.port=9003 ./target/uesr-service-0.0.1-SNAPSHOT.jar
```

ì—°ìŠµì„ ìœ„í•´ `first-service`ì™€ `second-service`ë¥¼ ê°ê° ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ 2ê°œì”© ê¸°ë™í•´ë³´ì.<br>
`first-service`ëŠ” ë°©ë²• 1ì„ ì´ìš©í–ˆê³ , `second-service`ëŠ” ë°©ë²• 3ì„ ì´ìš©í–ˆë‹¤.<br><br>
`first-service`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 02 20](https://user-images.githubusercontent.com/59405576/192763090-80dc224c-b4cf-4c4b-b772-8471e27e019a.png){: width="800" height="800"}<br><br>
`second-service`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 09 07](https://user-images.githubusercontent.com/59405576/192764382-4d9a542f-b9d0-42a5-9068-0237a01732a5.png)
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 08 49](https://user-images.githubusercontent.com/59405576/192764323-2dac13d1-518d-4e37-b6fd-560e6c1c3fb3.png)
<br>

ì´ë¡œì¨ ìœ ë ˆì¹´ ì„œë²„(`discoveryservice`)ì—ëŠ” ì•„ë˜ ì‚¬ì§„ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´,<br>
ê²Œì´íŠ¸ì›¨ì´ ì„œë¹„ìŠ¤(`apigateway-service`)ì™€ 4ê°œì˜ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤(`first-service` 2ëŒ€, `second-service` 2ëŒ€)ê°€ ë“±ë¡ëœ ìƒíƒœì´ë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 11 43](https://user-images.githubusercontent.com/59405576/192764837-366504bd-17db-4d66-a95a-549c029efce5.png)
<br>

ê·¸ëŸ°ë°, `apigateway-service`ì˜ `application.yml`ì„ ë³´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 17 47](https://user-images.githubusercontent.com/59405576/192765858-29b9cd60-15fe-448d-b710-9455e3b7b13b.png){: width="400" height="400"}<br>
ìœ„ ì‚¬ì§„ì—ì„œ `lb://MY-FIRST-SERVICE`ëŠ” <br>
`/first-service/**`ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ë””ìŠ¤ì»¤ë²„ë¦¬ ì„œë¹„ìŠ¤(= ë„¤ì´ë° ì„œë¹„ìŠ¤) ì•ˆì— ë“±ë¡ë˜ì–´ìˆëŠ” ì„œë¹„ìŠ¤ë“¤ ì¤‘,<br>
ì´ë¦„ì´ `MY-FIRST-SERVICE`ì¸ ì„œë¹„ìŠ¤ë¡œ ë³´ë‚´ê² ë‹¤ëŠ” ì˜ë¯¸ì¸ë°, `MY-FIRST-SERVICE` ì„œë¹„ìŠ¤ ì•ˆì—ëŠ” 2ê°œì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤.<br>
ì´ ë•Œ, `9091`ë¡œ ê°”ëŠ”ì§€ `8081`ë¡œ ê°”ëŠ”ì§€ ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆì„ê¹Œ?

## ëœë¤í¬íŠ¸ ì‚¬ìš©
### `first-service`
copy í•œ `FirstServiceApplication(1)`ì€ ì‚­ì œí•˜ê³  `application.yml`ì„ ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í•œë‹¤.
```yml
server:
  port: 0 # ğŸŒŸ 8081ì—ì„œ 0ìœ¼ë¡œ ë³€ê²½

spring:
  application:
    name: my-first-service

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:8761/eureka
  instance: # ğŸŒŸ ì¶”ê°€
    instance-id: ${spring.application.name}:${spring.application.instance_id:${random.value}}
```

### `first-service` í•˜ë‚˜ ë” ê¸°ë™
í„°ë¯¸ë„ì„ ì´ìš©í•´ `first-service`ë¥¼ í•˜ë‚˜ ë” ê¸°ë™í•´ë³´ì.
```
mvn spring-boot:run
```
ëœë¤í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë’¤ì— ì˜µì…˜ìœ¼ë¡œ í¬íŠ¸ë²ˆí˜¸ë¥¼ ì§€ì •í•  í•„ìš”ê°€ ì—†ë‹¤.<br><br>
ê²°ê³¼<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 33 14](https://user-images.githubusercontent.com/59405576/192768680-04b7e038-f422-41a8-9bbd-71b3b2f5594c.png)

## ì–´ë–¤ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  ë•Œ ëª‡ ë²ˆ í¬íŠ¸ê°€ ì‚¬ìš©ë˜ì—ˆëŠ”ì§€ ì¶œë ¥
### `first-service`
`FirstServiceController.java`
```java
@RestController
@RequestMapping("/first-service")
@Slf4j
public class FirstServiceController {

    Environment env;

    @Autowired
    public FirstServiceController(Environment env) {
        this.env = env;
    }

    @GetMapping("/check")
    public String check(HttpServletRequest request) {
        log.info("server port={}", request.getServerPort());
        return String.format("Check First Service on PORT %s", env.getProperty("local.server.port"));
    }
}
```
ìŠ¤í”„ë§ì—ì„œëŠ” `@Autowired Environment env;`ìœ¼ë¡œ ë³€ìˆ˜ì— ì§ì ‘ ì£¼ì…ë°›ëŠ” ê²ƒë³´ë‹¤ëŠ”,<br>
ìœ„ ì½”ë“œì—ì„œì²˜ëŸ¼ ìƒì„±ìë¥¼ í†µí•´ ì£¼ì…ë°›ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.<br><br>
`request`ì—ì„œ í¬íŠ¸ ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ë„ ìˆê³ , í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ë„ ìˆë‹¤.

### í¬ìŠ¤íŠ¸ë§¨ í…ŒìŠ¤íŠ¸
ì¸í…”ë¦¬ì œì´ì—ì„œ `run` ë²„íŠ¼ì„ í´ë¦­í•˜ê³ , í„°ë¯¸ë„ì—ì„œ `mvn spring-boot:run` ì»¤ë§¨ë“œë¥¼ ì…ë ¥í•´<br>
`first-service`ë¥¼ ì´ 2ëŒ€ ê¸°ë™í•œ í›„ì— í¬ìŠ¤íŠ¸ë§¨ì—ì„œ í…ŒìŠ¤íŠ¸ í•´ë³´ì.<br><br>
í¬ìŠ¤íŠ¸ë§¨ì—ì„œ `http://localhost:8000/first-service/check`ì— ì ‘ì†í•´ë³´ì.<br><br>
ì²« ë²ˆì§¸ í˜¸ì¶œ<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 53 07](https://user-images.githubusercontent.com/59405576/192772305-f35545ad-b8fe-4d1b-a531-1e6e42ae860d.png)
<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 50 32](https://user-images.githubusercontent.com/59405576/192771820-9aa67a6e-eefe-4e31-a3f9-4783cb4b224b.png)<br><br>

ë‘ ë²ˆì§¸ í˜¸ì¶œ<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 52 45](https://user-images.githubusercontent.com/59405576/192772290-c180f3b1-488f-4fd4-9a1a-5a90d9d52bdb.png)
<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-28 á„‹á…©á„’á…® 8 49 53](https://user-images.githubusercontent.com/59405576/192771931-ed9452c1-d5ac-481b-8c77-df7016e7ed12.png)<br><br>
ì´ì™€ ê°™ì´, Round Robin ë°©ì‹ìœ¼ë¡œ, <br>
í•œ ë²ˆì€ ì¸í…”ë¦¬ì œì´ì˜ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¡œ, ë˜ í•œ ë²ˆì€ í„°ë¯¸ë„ì˜ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¡œ ë²ˆê°ˆì•„ê°€ë©° í˜¸ì¶œì„ í•´ì¤€ë‹¤.<br>
ë”°ë¼ì„œ ê²Œì´íŠ¸ì›¨ì´ë¥¼ ì‚¬ìš©í•˜ë©´, ë¼ìš°íŒ… ê¸°ëŠ¥ê³¼ ë¡œë“œ ë°¸ëŸ°ì‹± ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.







***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}