---
title:  "[E-commerce App] Spring Cloud Bus "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-05 16:23:54
last_modified_at: 2022-10-05 16:23:57
---

<br>
Actuator를 사용했을 때는, 구성 정보가 변경되었을 때 <br>
각각의 서비스(어플리케이션)에 대해서 매번 `/actuator/refresh`를 호출해야하는 불편함이 있었다.<br><br>
이번에는 Spring Cloud Bus라는 기능을 이용해 일괄적으로 업데이트 해보자.

# 개요
configuration 서버에 어떠한 값을 변경시켰을 때 각각의 마이크로 서비스들이 그 내용을 가져가는 방법에는 세 가지가 있다고 했다.
- 서버 재기동
- Actuator refresh
- Spring cloud bus 사용

이 중 서버를 재기동하는 방식은 좋지 않은 선택이고,<br>
Actuator의 refresh를 사용하면 서버를 재기동하지는 않아도 되지만, 각각의 마이크로 서비스에서 수동으로 refresh 해주어야한다는 단점이 있었다.<br>
이러한 번거로움을 해결해 줄 수 있는게 Spring cloud bus 이다.

## Spring Cloud Bus란?
- 분산 시스템의 노드(= 마이크로 서비스)를 경량 "메시지 브로커"와 연결<br>- 이번에는 메세지 브로커로 RabbitMQ를 사용할 것이다.
- 상태 및 구성에 대한 변경 사항을 연결된 노드에게 전달 (Broadcast)

기존에 사용하고 있던 Spring Cloud Config Server는 그대로 사용하고, <br>
여기에 Spring Cloud Bus를 더해 Configuration Server를 완벽하게 구축할 것이다.<br><br>
우선, Spring Cloud Config Server에 각각의 마이크로 서비스들이 연결되어 있을 것이다.<br>
데이터의 변경이 생길 때, Spring Cloud Config Server에 연결된 Spring Cloud Bus가 각각의 마이크로 서비스들에게 push 방식으로 알릴건데,<br>
이 때 AMQP(Advanced Message Queuing Protocol)라는 프로토콜을 이용할 것이다.

## AMQP(Advanced Message Queuing Protocol)
AMQP란 메시지 지향 미들웨어를 위한 개방형 표준 응용 계층 프로토콜이다.
- 메시지 지향, 큐잉, 라우팅(P2P, Publisher-Subscriber), 신뢰성, 보안
- Erlang, RabbitMQ에서 사용

## Kafka 프로젝트
- Apache Software Foundation이 Scalar 언어로 개발한 오픈 소스 메시지 브로커 프로젝트
- 분산형 스트리밍 플랫폼
- 대용량의 데이터를 처리 가능한 메시징 시스템

## RabbitMQ vs Kafka
- RabbitMQ<br>- 메시지 브로커<br>- 초당 20+ 메시지를 소비자(= 메시지를 받는 시스템)에게 전달<br>- 메시지 전달 보장, 시스템 간 메시지 전달<br>- 브로커, 소비자 중심
- Kafka<br>- 초당 100k+ 이상의 이벤트 처리<br>- Pub/Sub, Topic에 메시지 전달<br>- Ack을 기다리지 않고 전달 가능 -> 속도가 빠르다<br>- 생상자 중심

![스크린샷 2022-10-05 오후 4 53 38](https://user-images.githubusercontent.com/59405576/194009060-27839d2c-9ba2-489d-8dd3-8c126656a5c2.png){: width="700" height="700"}<br>
간단히 말해, Kafka는 대용량의 데이터를 빠른 시간에 처리하고자 할 때 많이 선택되는 솔루션이고,<br>
RabbitMQ는 비교적 적은 데이터를 안전하게 전달하는 것을 보장해주는 메시지 브로커이다.

## Spring Cloud Bus는 어떤 방식으로 작동할까?
외부에서 클라이언트가 POST 방식으로 `/busrefresh`를 호출한다.<br>
이는 Spring Cloud Bus와 연결된 어떤 마이크로 서비스에 호출하던지 상관 없다.<br><br>
예를 들어 `user-service`에 요청을 했다면, `user-service`가 변경사항을 Cloud Bus에게 전달하고,<br>
Cloud Bus가 다른 마이크로 서비스들에게 변경 사항을 전달하기 때문이다.<br><br>
이러한 작업을 하기 위해 RabbitMQ를 설치해보자.

# RabbitMQ 
## 설치 (MacOS)
```bash
$ brew update
$ brew install rabbitmq
```
> 참고<br>
혹시 아래와 같은 에러가 발생한다면, `xcode-select --install` 커맨드를 추가로 입력하자.<br>
![스크린샷 2022-10-05 오후 5 11 23](https://user-images.githubusercontent.com/59405576/194012486-a513d3cb-311a-4e45-8b13-e323cf1fd8a2.png)<br>

## RabbitMQ 서버 기동
```bash
$ export PATH=$PATH:/usr/local/sbin
$ rabbitmq-server
```
![스크린샷 2022-10-05 오후 5 29 50](https://user-images.githubusercontent.com/59405576/194016336-5bb6a20b-9b9f-410a-b27d-849332f57ab4.png)<br>
이런식으로 나오면 정상적으로 실행된 것이다. (백그라운드로 실행하고 싶으면 `rabbitmq-server -detached` 커맨드를 이용하자.)<br><br>
서버가 기동되었다면 `localhost:15672`로 접속할 수 있다.<br>
![스크린샷 2022-10-05 오후 5 31 11](https://user-images.githubusercontent.com/59405576/194016606-bcde2796-9afc-4065-8e20-64a7772ac864.png)<br>
이 때, default로 설정된 username과 password는 모두 `guest`이다.<br>
입력하고 나면 아래와 같은 대시보드 화면을 볼 수 있다.<br> 
![스크린샷 2022-10-05 오후 5 32 28](https://user-images.githubusercontent.com/59405576/194016848-d2cf47e5-1f64-480d-8fef-4b3fb189dded.png)



















***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}