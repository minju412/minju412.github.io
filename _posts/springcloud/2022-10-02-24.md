---
title:  "[E-commerce App] Users Microservice - ì¸ì¦ "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-02 11:02:30
last_modified_at: 2022-10-02 11:02:33
---

ì €ë²ˆì— ë§Œë“¤ì—ˆë˜ `user-service`ì— ì¸ì¦ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ë³´ì.

# `user-service`
## AuthenticationFilter ì¶”ê°€
ì•„ë˜ ë‘ ê°€ì§€ ë©”ì„œë“œë¥¼ ì¬ì •ì˜(override) í•  ê²ƒì´ë‹¤.
- `attemptAuthentication()`
- `successfulAuthentication()`

```java
public class AuthenticationFilter extends UsernamePasswordAuthenticationFilter {

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws
        AuthenticationException {

        try {
            RequestLogin creds = new ObjectMapper().readValue(request.getInputStream(), RequestLogin.class);

            UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken =
                new UsernamePasswordAuthenticationToken(
                    creds.getEmail(),
                    creds.getPassword(),
                    new ArrayList<>()
                );

            return getAuthenticationManager().authenticate(usernamePasswordAuthenticationToken);

        } catch (IOException ex) {
            throw new RuntimeException(ex);
        }
    }

    @Override
    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain,
        Authentication authResult) throws IOException, ServletException {
    }
}

```

### `attemptAuthentication`
`request.getInputStream()`ìœ¼ë¡œ ë°›ì€ ì´ìœ ëŠ” <br>
ì „ë‹¬í•˜ê³ ìí•˜ëŠ” ë¡œê·¸ì¸ì˜ ê°’ì€ POST í˜•íƒœë¡œ ì „ë‹¬ë˜ëŠ”ë°, POST í˜•íƒœë¡œ ì „ë‹¬ë˜ëŠ” ê°’ì€ request parameterë¡œ ë°›ì„ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— <br>
inputStreamì„ ì‚¬ìš©í•˜ë©´ ìˆ˜ì‘ì—…ìœ¼ë¡œ ì–´ë–¤ ë°ì´í„°ê°€ ë“¤ì–´ì™”ëŠ”ì§€ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

### `successfulAuthentication()`
ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì•„ì´ë””ì™€ íŒ¨ìŠ¤ì›Œë“œ ê°’ì´ ì¼ì¹˜í–ˆì„ ë•Œ, ì–´ë–¤ ì²˜ë¦¬ë¥¼ í•´ì¤„ ê²ƒì¸ì§€, (ex. í† í° ìƒì„±)<br>
í† í°ì˜ ë§Œë£Œì‹œê°„ì„ ì–´ë–»ê²Œ ì„¤ì •í• ê±´ì§€,<br>
ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í–ˆì„ ë•Œ ë°˜í™˜ê°’ìœ¼ë¡œ ì–´ë–¤ê±¸ ì¤„ê±´ì§€... ë“±ì„ ì •ì˜í•œë‹¤.

## WebSecurity ë³€ê²½
```java
@Configuration
@EnableWebSecurity
public class WebSecurity extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable();
        http.authorizeRequests()
            .antMatchers("/**")
            .hasIpAddress("192.168.x.x") // ğŸŒŸ ë³¸ì¸ IP ë³€ê²½
            .and()
            .addFilter(getAuthenticationFilter());

        http.headers().frameOptions().disable();
    }

    private AuthenticationFilter getAuthenticationFilter() throws Exception {
        AuthenticationFilter authenticationFilter = new AuthenticationFilter();
        authenticationFilter.setAuthenticationManager(authenticationManager());

        return authenticationFilter;
    }
}
```

## loadUserByUsername() êµ¬í˜„
`UserService`ë¥¼ ë¨¼ì € ë³€ê²½í•œ ë’¤, `UserServiceImpl`ì— `loadUserByUsername()`ì„ êµ¬í˜„í•œë‹¤.

### `UserService`
```java
public interface UserService extends UserDetailsService { // ğŸŒŸ UserDetailsService ìƒì†
    ...
}
```

### `UserServiceImpl`
```java
@Service
public class UserServiceImpl implements UserService {
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        UserEntity userEntity = userRepository.findByEmail(username);
        if (userEntity == null) {
            throw new UsernameNotFoundException(username);
        }
        return new User(
            userEntity.getEmail(),
            userEntity.getEncryptedPwd(),
            true,
            true,
            true,
            true,
            new ArrayList<>()
        );
    }
    ...
}
```

# `gateway-service`
## `application.yml`
```yml
server:
  port: 8000

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:8761/eureka

spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/user-service/login # ğŸŒŸ ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸ ë“±ë¡
            - Method=POST
          filters:
            - RemoveRequestHeader=Cookie
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}

        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/user-service/users # ğŸŒŸ íšŒì›ê°€ì… ì—”ë“œí¬ì¸íŠ¸ ë“±ë¡
            - Method=POST
          filters:
            - RemoveRequestHeader=Cookie
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}

        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/user-service/** # ğŸŒŸ /user-service/** ë“±ë¡
            - Method=GET
          filters:
            - RemoveRequestHeader=Cookie
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}

        - id: catalog-service
          uri: lb://CATALOG-SERVICE
          predicates:
            - Path=/catalog-service/**

        - id: order-service
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/order-service/**

```

# í…ŒìŠ¤íŠ¸
í•´ë‹¹ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì— í• ë‹¹ëœ í¬íŠ¸ë²ˆí˜¸ë¡œ ì§ì ‘ ìš”ì²­í•˜ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ ìš”ì²­í•˜ë©´ ëœë‹¤.<br>
`http://localhost:60910/login`<br>
ì´ ë•Œ, `localhost:` ë’¤ì—ëŠ” í• ë‹¹ëœ ëœë¤ í”„íŠ¸ë¥¼ ì ìœ¼ë©´ ë˜ê³ , prefixëŠ” í•„ìš”ì—†ë‹¤.<br><br>
api gatewayë¥¼ í†µí•´ ìš”ì²­í•˜ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ ìš”ì²­í•˜ë©´ ëœë‹¤.<br>
`http://localhost:8000/user-serivce/login`<br>
ì´ë•ŒëŠ” `/user-service`ë¼ëŠ” prefixë¥¼ ë¶™ì—¬ì•¼ í•œë‹¤.

> ğŸ¤” ìƒê°í•´ë³´ë‹ˆ `/login` ì—”ë“œí¬ì¸íŠ¸ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì— ë”°ë¡œ ì •ì˜í•˜ì§€ ì•Šì•˜ëŠ”ë° ì–´ë–»ê²Œ ê°€ëŠ¥í• ê¹Œ?<br>
`/login` ì—”ë“œí¬ì¸íŠ¸ëŠ” Spring Securityë¥¼ ì‚¬ìš©í•˜ê²Œë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ì´ë‹¤.<br>
í•˜ì§€ë§Œ `/login` ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì§ì ‘ ì •ì˜í•´ ì¶”ê°€ì ì¸ ì„¤ì •ì„ í•  ìˆ˜ë„ ìˆë‹¤.











***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}