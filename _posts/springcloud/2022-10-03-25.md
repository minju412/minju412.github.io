---
title:  "[E-commerce App] Users Microservice - ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬ (JWT ìƒì„±) "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-03 14:46:43
last_modified_at: 2022-10-03 14:46:47
---

ì €ë²ˆì— ë§Œë“¤ì—ˆë˜ `user-service`ì— ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬ ë¡œì§ì„ ì¶”ê°€í•´ë³´ì.

# ê°œìš”
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-03 á„‹á…©á„’á…® 2 21 30](https://user-images.githubusercontent.com/59405576/193506573-dcc20a54-eb3e-4800-8c4e-a731cdbfb9fa.png)

1. ì‚¬ìš©ìê°€ ì…ë ¥í•œ `email`ê³¼ `password`ê°€ `AuthenticationFilter`ì— ì „ë‹¬ë˜ë©´, `attemptAuthentication()` ë©”ì„œë“œê°€ ê°€ì¥ ë¨¼ì € ì²˜ë¦¬í•œë‹¤.
2. ê·¸ ë‹¤ìŒìœ¼ë¡œ, ì‚¬ìš©ìê°€ ì…ë ¥í•œ `email`ê³¼ `password`ë¥¼ `UsernamePasswordAuthenticationToken`ì˜ í˜•íƒœë¡œ ë°”ê¿”ì„œ ì‚¬ìš©í•œë‹¤.
3. ê·¸ë¦¬ê³  `UserDetailService`ë¥¼ êµ¬í˜„í•˜ê³  ìˆëŠ” í´ë˜ìŠ¤ì—ì„œ `loadUserByUsername()` ë©”ì„œë“œê°€ ì‹¤í–‰ëœë‹¤.
4. `loadUserByUsername()` ë©”ì„œë“œ ì•ˆì—ì„œ `findByEnail()`ì„ í†µí•´ dbì—ì„œ `UserEntity`ë¥¼ ê°€ì ¸ì˜¤ê³ , ì´ë¥¼ Spring Securityì— ìˆëŠ” `User` ê°ì²´ë¡œ ë³€ê²½í•´ì„œ ì‚¬ìš©í•œë‹¤.
5. ë§ˆì§€ë§‰ìœ¼ë¡œ, ëª¨ë“  ê³¼ì •ì´ ëë‚˜ê³  ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ë˜ì—ˆë‹¤ë©´ `AuthenticationFilter`ì—ì„œ `successfulAuthentication()` ë©”ì„œë“œ ë‚´ì—ì„œ í† í°ì„ ë°œí–‰í•œë‹¤.
6. ê·¸ëŸ°ë°, ì‚¬ìš©ì `email`ìœ¼ë¡œ í† í°ì„ ë§Œë“¤ê²Œ ì•„ë‹ˆë¼, `userId`(=`UUID`)ë¡œ í† í°ì„ ë§Œë“¤ê³  ì‹¶ê¸° ë•Œë¬¸ì—,<br>
`successfulAuthentication()` ë©”ì„œë“œ ì•ˆì—ì„œ `getUserDetailsByEmail()`ì„ í˜¸ì¶œí•´ ì‚¬ìš©ì ì •ë³´(`UserDto`)ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
7. 6ë²ˆì—ì„œ ë°˜í™˜ë˜ì–´ì§„ `UserDto` ì•ˆì— í¬í•¨ëœ `userId`(=`UUID`)ë¥¼ ì´ìš©í•´ í† í°(jwt)ì„ ë°œí–‰í•´ responseì˜ í—¤ë”ì— ì¶”ê°€í•œë‹¤.

# `user-service`
## `pom.xml`
í† í°ì„ ìƒì„±í•˜ê¸° ìœ„í•´ dependencyì— jwtë¥¼ ì¶”ê°€í•œë‹¤.
```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>
```

## `application.yml`
```yml
token:
  expiration_time: 86400000 # 60 * 60 * 24 * 1000 # í•˜ë£¨ì§œë¦¬ í† í°
  secret: user_token
```
ë§Œë£Œì‹œê°„ ê³„ì‚°ì€ `millisecond`ë¡œ í•œë‹¤.(ì´ˆ ë‹¨ìœ„ * 1000) <br>
- í•˜ë£¨ì§œë¦¬ í† í° ìƒì„±<br>- 60(ì´ˆ) * 60(ë¶„) * 24(ì‹œê°„) = 60 * 60 * 24 (`second`)<br>- 60 * 60 * 24 * 1000 (`millisecond`)

## `AuthenticationFilter`
`AuthenticationFilter` ì•ˆì— ìˆëŠ” `successfulAuthentication()`ì„ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•œë‹¤.
```java
public class AuthenticationFilter extends UsernamePasswordAuthenticationFilter {

    private UserService userService;
    private Environment env;

    public AuthenticationFilter(AuthenticationManager authenticationManager,
                                UserService userService,
                                Environment env) {
        super.setAuthenticationManager(authenticationManager);
        this.userService = userService;
        this.env = env;
    }
    ...   
    /**
     * ë¡œê·¸ì¸ ì„±ê³µ í›„ í† í°(jwt)ì„ ìƒì„±í•œë‹¤.
     */
    @Override
    protected void successfulAuthentication(HttpServletRequest request,
                                            HttpServletResponse response,
                                            FilterChain chain,
                                            Authentication authResult) throws IOException, ServletException {
        String username = ((User)authResult.getPrincipal()).getUsername(); // ì´ë•Œ username ëŠ” ì‚¬ìš©ì email ì´ë‹¤. 
        UserDto userDto = userService.getUserDetailsByEmail(username); // ğŸŒŸ email ì´ ì•„ë‹Œ userId(=UUID)ë¥¼ ì´ìš©í•´ í† í°ì„ ìƒì„±í•˜ê¸° ìœ„í•´ì„œ userDto ë¥¼ ë°›ì•„ì˜¨ë‹¤.

        String token = Jwts.builder() // ğŸŒŸ í† í° ìƒì„±
            .setSubject(userDto.getUserId())
            .setExpiration(new Date(System.currentTimeMillis() + // ğŸŒŸ ë§Œë£Œì‹œê°„ ì„¤ì •
                Long.parseLong(env.getProperty("token.expiration_time"))))
            .signWith(SignatureAlgorithm.HS512, env.getProperty("token.secret")) // ğŸŒŸ ì•”í˜¸í™”
            .compact();

        response.addHeader("token", token); // ğŸŒŸ responseì˜ í—¤ë”ì— í† í° ì¶”ê°€
        response.addHeader("userId", userDto.getUserId()); // ğŸŒŸ í† í°ì˜ ìœ„ë³€ì¡° í™•ì¸ì„ ìœ„í•´ userIdë„ ì¶”ê°€
    }
}
```

## `UserService`
`UserService.java`
```java
public interface UserService extends UserDetailsService {
    ...
    UserDto getUserDetailsByEmail(String email);
}
```

`UserServiceImpl.java`
```java
@Service
public class UserServiceImpl implements UserService {

    UserRepository userRepository;
    BCryptPasswordEncoder passwordEncoder;

    @Autowired
    public UserServiceImpl(UserRepository userRepository, BCryptPasswordEncoder passwordEncoder) { // BCryptPasswordEncoder -> UserServiceApplication ì— ë¹ˆ ë“±ë¡
        this.userRepository = userRepository;
        this.passwordEncoder = passwordEncoder;
    }
    ...
    @Override
    public UserDto getUserDetailsByEmail(String email) {
        UserEntity userEntity = userRepository.findByEmail(email);

        if (userEntity == null) {
            throw new UsernameNotFoundException("email ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }

        return new ModelMapper().map(userEntity, UserDto.class); // ğŸŒŸ userEntity ë¥¼ UserDto í˜•íƒœë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜í•œë‹¤.
    }
}
```

## `WebSecurity`
```java
@Configuration
@EnableWebSecurity
public class WebSecurity extends WebSecurityConfigurerAdapter {

    private final UserService userService;
    private final BCryptPasswordEncoder bCryptPasswordEncoder;
    private Environment env;
    ...
    private AuthenticationFilter getAuthenticationFilter() throws Exception {
        AuthenticationFilter authenticationFilter
            = new AuthenticationFilter(authenticationManager(), userService, env);

        return authenticationFilter;
    }
}
```

# í…ŒìŠ¤íŠ¸
ì•„ë˜ ì‚¬ì§„ì²˜ëŸ¼, `200 OK`ë¥¼ ë°˜í™˜í•˜ê³ , í—¤ë”ì— `token`ê³¼ `userId` ê°’ì´ ë‹´ê²¨ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br>
<img width="1006" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-03 á„‹á…©á„’á…® 3 29 20" src="https://user-images.githubusercontent.com/59405576/193513948-ac0a7fbc-2931-4531-a602-1ef4042b9e3f.png">

# `gateway-service`
## `pom.xml`
```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>

<!-- API, java.xml.bind module -->
<dependency>
    <groupId>jakarta.xml.bind</groupId>
    <artifactId>jakarta.xml.bind-api</artifactId>
    <version>2.3.2</version>
</dependency>

<!-- Runtime, com.sun.xml.bind module -->
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
    <version>2.3.2</version>
</dependency>
```

## `application.yml`
ê²Œì´íŠ¸ì›¨ì´ì—ì„œëŠ” `expiration_time`ì€ í•„ìš”ì—†ë‹¤.
```yml
spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/user-service/login # ë¡œê·¸ì¸
            - Method=POST
          filters:
            - RemoveRequestHeader=Cookie
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}

        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/user-service/users # íšŒì›ê°€ì…
            - Method=POST
          filters:
            - RemoveRequestHeader=Cookie
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}

        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/user-service/**
            - Method=GET
          filters:
            - RemoveRequestHeader=Cookie
            - RewritePath=/user-service/(?<segment>.*), /$\{segment}
            - AuthorizationHeaderFilter # ğŸŒŸ ë¡œê·¸ì¸ê³¼ íšŒì›ê°€ì… apië¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ apiì— ì¸ì¦ í•„í„°ë¥¼ ì¶”ê°€í•œë‹¤.

...

token:
  secret: user_token # ğŸŒŸ í† í° secret ì¶”ê°€
```

## `AuthorizationHeaderFilter`
`filter/AuthorizationHeaderFilter.java`
```java
@Component
@Slf4j
public class AuthorizationHeaderFilter extends AbstractGatewayFilterFactory<AuthorizationHeaderFilter.Config> {

    Environment env;

    public AuthorizationHeaderFilter(Environment env) {
        super(Config.class); // ë¶€ëª¨ì˜ ìƒì„±ìë¥¼ í˜¸ì¶œí•´ í˜„ì¬ ê°€ì§€ê³  ìˆëŠ” Config ì •ë³´ë¥¼ ì „ë‹¬
        this.env = env;
    }

    public static class Config {
        // Put configuration properties here
    }

    @Override
    public GatewayFilter apply(Config config) {
        return ((exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();

            // í—¤ë”ì— í¬í•¨ëœ í† í° ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!request.getHeaders().containsKey(HttpHeaders.AUTHORIZATION)) {
                return onError(exchange, "no authorization header", HttpStatus.UNAUTHORIZED);
            }
            String authorizationHeader = request.getHeaders()
                .get(org.springframework.http.HttpHeaders.AUTHORIZATION)
                .get(0);
            String jwt = authorizationHeader.replace("Bearer", "");

            // í† í°ì´ ìœ íš¨í•œ í† í°ì¸ì§€ í™•ì¸
            if(!isJwtValid(jwt)) {
                return onError(exchange, "JWT token is not valid", HttpStatus.UNAUTHORIZED);
            }

            return chain.filter(exchange);
        });
    }

    private boolean isJwtValid(String jwt) {
        boolean returnValue = true;

        String subject = null;
        try {
            subject = Jwts.parser()
                .setSigningKey(env.getProperty("token.secret"))
                .parseClaimsJws(jwt).getBody() // ë³µí˜¸í™” í•  ëŒ€ìƒ ì§€ì •
                .getSubject(); // subject ì¶”ì¶œ
        } catch (Exception ex) {
            returnValue = false;
        }

        if (subject == null || subject.isEmpty()) {
            returnValue = false;
        }

        return returnValue;
    }

    // Mono, Flux -> Spring WebFlux
    private Mono<Void> onError(ServerWebExchange exchange, String err, HttpStatus httpStatus) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(httpStatus);

        log.error(err);
        return response.setComplete();
    }
}

```


# í…ŒìŠ¤íŠ¸
ì•„ë˜ì™€ ê°™ì´ í† í°ì„ ë„£ê³  ìš”ì²­í•˜ë‹ˆ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆë‹¤.<br>
<img width="1007" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-03 á„‹á…©á„’á…® 5 34 53" src="https://user-images.githubusercontent.com/59405576/193534581-38791e50-c126-4a41-af3e-3f7f5f698af5.png">

## `gateway-service`ì— ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ë©”ì‹œì§€ê°€ ëœ¬ë‹¤ë©´?
`javax/xml/bind/DatatypeConverter`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-03 á„‹á…©á„’á…® 5 13 27](https://user-images.githubusercontent.com/59405576/193530675-62bab1c3-f6e5-40fe-abca-fd564a1a3c53.png)<br>

êµ¬ê¸€ë§í•´ë³´ë‹ˆ ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•˜ë¼ê³  ë‚˜ì™€ìˆëŠ”ë°, ë‚˜ëŠ” ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•´ë„ í•´ê²°ë˜ì§€ ì•Šì•˜ë‹¤.
```xml
<dependency>
    <groupId>javax.xml.bind</groupId>
    <artifactId>jaxb-api</artifactId>
</dependency>
```

ìœ„ ì½”ë“œë¥¼ ì œê±°í•˜ê³  ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•˜ë‹ˆ í•´ê²°ë˜ì—ˆë‹¤.
```xml
<!-- API, java.xml.bind module -->
<dependency>
    <groupId>jakarta.xml.bind</groupId>
    <artifactId>jakarta.xml.bind-api</artifactId>
    <version>2.3.2</version>
</dependency>

<!-- Runtime, com.sun.xml.bind module -->
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
    <version>2.3.2</version>
</dependency>
```




***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}