---
title:  "[E-commerce App] CircuitBreakerì™€ Resilience4J ì‚¬ìš© "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-12 01:13:20
last_modified_at: 2022-10-12 01:13:23
---
ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ê°„ì˜ í†µì‹  ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ëŒ€í‘œì ì¸ ì˜¤ë¥˜ì™€ ê·¸ê²ƒì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì.

# Microservice í†µì‹  ì‹œ ì—°ì‡„ ì˜¤ë¥˜
ì•„ë˜ ì‚¬ì§„ì„ ë³´ë©´, `user-service`ë¥¼ í˜¸ì¶œí–ˆì„ ë•Œ, 500 Errorê°€ ë°œìƒí–ˆëŠ”ë°, <br>
`trace`ë¥¼ ë³´ê²Œ ë˜ë©´ ê·¸ ì›ì¸ì€ `order-service`ì— ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 2 09 28](https://user-images.githubusercontent.com/59405576/195156131-e90ceaf1-10f3-4ded-b1b3-0f83432922e5.png){: width="700" height="700"}<br><br>
`user-service`ì—ì„œ `order-service`ë¥¼ í˜¸ì¶œí•˜ê³ , `order-service`ì—ì„œ `catalog-service`ë¥¼ í˜¸ì¶œí•œë‹¤ê³  ê°€ì •í•˜ì.<br>
ë§Œì•½ `order-service`ë‚˜ `catalog-service`ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œ, <br>
í•´ë‹¹í•˜ëŠ” ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¡œ ë”ì´ìƒ ìš”ì²­ì„ ì „ë‹¬í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.<br><br>
ë”°ë¼ì„œ Feign Client ì¸¡ì—ì„œëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ, ì—ëŸ¬ë¥¼ ëŒ€ì‹ í•  ìˆ˜ ìˆëŠ” default ê°’ì´ë¼ë˜ê°€ ì •ìƒì ì¸ ë°ì´í„°ì²˜ëŸ¼ ë³´ì—¬ì§ˆ ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë°ì´í„° ê°’ì„ ì‘ë‹µí•  ì¤€ë¹„ê°€ ë˜ì–´ìˆì–´ì•¼ í•œë‹¤.<br>
ì¦‰, ì´ëŠ” `user-service`ì˜ ë¬¸ì œê°€ ì•„ë‹ˆë¯€ë¡œ `user-service`ì—ì„œëŠ” 500 Errorê°€ ì•„ë‹Œ 200 OKë¥¼ ë°˜í™˜í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 2 10 42](https://user-images.githubusercontent.com/59405576/195156360-06b92f1d-1949-406a-9caa-fd5f3332002e.png){: width="700" height="700"}<br><br>
CuircuitBreakerë€, ë¬¸ì œê°€ ìƒê¸´ ì„œë¹„ìŠ¤ë¥¼ ë”ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ë§‰ì•„ì£¼ê³ , <br>
ë¬¸ì œê°€ ìƒê¸´ ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ë³µêµ¬ ë˜ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ë˜ì—ˆì„ ë•Œ ë‹¤ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì •ìƒì ì¸ íë¦„ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” ì¥ì¹˜ì´ë‹¤.

# CuircuitBreaker
- ì¥ì• ê°€ ë°œìƒí•˜ëŠ” ì„œë¹„ìŠ¤ì— ë°˜ë³µì ì¸ í˜¸ì¶œì´ ë˜ì§€ ëª»í•˜ê²Œ ì°¨ë‹¨
- íŠ¹ì • ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•Šì„ ê²½ìš°ë‹¤ë¥¸ ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´ ìˆ˜í–‰ -> ì¥ì•  íšŒí”¼

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 2 19 48](https://user-images.githubusercontent.com/59405576/195157893-1ce936bc-f021-487d-88f8-44966854f1f0.png){: width="300" height="300"} ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 2 22 07](https://user-images.githubusercontent.com/59405576/195158320-fdf0a2f0-9934-4552-a89f-5ed5c49d7d79.png){: width="500" height="500"}<br>
ì •ìƒì ìœ¼ë¡œ ë‹¤ë¥¸ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ë•Œ, Circuit BreakerëŠ” closed ë˜ì–´ìˆê³ ,<br>
ì–´ë–¤ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ, Circuit Breakerê°€ open ìƒíƒœê°€ ë˜ê³ , <br>
ê·¸ëŸ¬ë©´ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ë”ì´ìƒ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì—ê²Œ ì „ë‹¬í•˜ì§€ ì•Šê³ , Circuit Breakerì—ì„œ ìì²´ì ìœ¼ë¡œ ê¸°ë³¸ ê°’ì´ë¼ë˜ê°€ ìš°íšŒí•  ìˆ˜ ìˆëŠ” ê°’ì„ ê°€ì§€ê³  ë¦¬í„´ ì‹œì¼œì¤€ë‹¤.<br><br>
ì§€ê¸ˆê¹Œì§€ ë§Œë“¤ì—ˆë˜ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì— ì´ëŸ¬í•œ Circuit Breakerë¥¼ ì¶”ê°€í•¨ìœ¼ë¡œì¨, <br>
í•˜ë‚˜ì˜ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì—ì„œ ë°œìƒí•œ ë¬¸ì œê°€ ì—°ì‡„ì ìœ¼ë¡œ ë‹¤ë¥¸ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì— ì „ë‹¬ë˜ëŠ” ê²ƒì„ ë§‰ì„ ìˆ˜ ìˆë‹¤. <br>
-> ë¬¸ì œê°€ ë°œìƒí•œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì œì™¸í•œ ì •ìƒì ì¸ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ëŠ”, ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•  ìˆ˜ ìˆë‹¤.

## Resilience4j
2019ë…„ë„ ì´ì „ê¹Œì§€ëŠ” CircuitBreakerë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ Spring Cloud Netflix Hystrix ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆì§€ë§Œ,<br>
Spring boot 2.4 ë²„ì „ì—ì„œëŠ” Hystrix ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë”ì´ìƒ ì œê³µë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ëŒ€ì²´ í•  ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë°”ê¿”ì•¼ í•œë‹¤.<br>
ê·¸ê²ƒì´ ë°”ë¡œ Resilience4jì´ë‹¤.

# ë¬¸ì œ í™•ì¸
ë¬¸ì œë¥¼ í™•ì¸í•´ë³´ê¸° ìœ„í•´ ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì„œë²„ë¥¼ ê¸°ë™í•˜ì
- eureka ì„œë²„
- rabbitmq ì„œë²„
- configuration ì„œë²„ (`config-service`)
- gateway ì„œë²„ (`gateway-service`)
- `user-service`

í¬ìŠ¤íŠ¸ë§¨ì—ì„œ íšŒì›ê°€ì… - ë¡œê·¸ì¸ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ì.<br>
ë¡œê·¸ì¸ í›„ ë°œê¸ˆë°›ì€ í† í°ê³¼ `userId`ë¥¼ ì´ìš©í•´ ì‚¬ìš©ìì˜ ìƒì„¸ì •ë³´ë¥¼ ìš”ì²­í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 9 48 56](https://user-images.githubusercontent.com/59405576/195473756-884dc65c-e900-46d9-9552-a021766e9798.png)<br>
ì´ëŠ” ì‚¬ìš©ì ë‹¨ê±´ ì¡°íšŒ ì‹œ, ì‚¬ìš©ìì˜ ì£¼ë¬¸ ëª©ë¡ë„ ê°€ì ¸ì˜¤ëŠ”ë°,<br>
í˜„ì¬ `order-service`ê°€ ê¸°ë™ì¤‘ì´ì§€ ì•Šì•„ ë°œìƒí•œ ì˜¤ë¥˜ì´ë‹¤.<br><br>
ì´ì œ CuircuitBreakerë¥¼ êµ¬í˜„í•´ë³´ì.

# `user-service`
## `pom.xml`
```xml
<!-- Resilience4j -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
</dependency>
```

## `UserServiceImpl.java`
```java
@Service
@Slf4j
public class UserServiceImpl implements UserService {
    ...
    @Override
    public UserDto getUserByUserId(String userId) {

        UserEntity userEntity = userRepository.findByUserId(userId);

        if (userEntity == null) {
            throw new UsernameNotFoundException("User not found");
        }

        UserDto userDto = new ModelMapper().map(userEntity, UserDto.class);

        // ì£¼ë¬¸ ìƒì„±
        /* ErrorDecoder */
        // List<ResponseOrder> orderList = orderServiceClient.getOrders(userId);

        /* ğŸŒŸ CircuitBreaker */
        CircuitBreaker circuitbreaker = circuitBreakerFactory.create("circuitbreaker");
        List<ResponseOrder> orderList = circuitbreaker.run(() -> orderServiceClient.getOrders(userId),
            throwable -> new ArrayList<>());

        userDto.setOrders(orderList);

        return userDto;
    }
}
```

## í…ŒìŠ¤íŠ¸
ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ `order-service`ë¥¼ ê¸°ë™í•˜ì§€ ì•Šì€ ì±„ë¡œ "ì‚¬ìš©ì ë‹¨ê±´ ì¡°íšŒ"ë¥¼ ìš”ì²­í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 10 06 57](https://user-images.githubusercontent.com/59405576/195475585-93dc2611-f8ea-4acc-8de5-58d2b7bc22a8.png)<br>
ì´ë²ˆì—ëŠ” 500 ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šê³  ì‚¬ìš©ìì˜ ê¸°ë³¸ ì •ë³´ëŠ” ê°€ì ¸ì˜¤ë˜, ì£¼ë¬¸ ë‚´ì—­ë§Œ ê°€ì§€ê³  ì˜¤ì§€ ëª»í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br><br>
ì°¸ê³ ë¡œ ì¸í…”ë¦¬ì œì´ì˜ ì½˜ì†”ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì—ëŸ¬ ë¡œê·¸ê°€ ì°íŒë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 10 09 16](https://user-images.githubusercontent.com/59405576/195475779-c6872127-273d-42e2-886e-388b4772bfd1.png)<br><br>
ë§Œì•½, `order-service`ë¥¼ ê¸°ë™í•œ ë’¤ì— ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ë³´ë©´, ê·¸ë•ŒëŠ” ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë‚´ì—­ê¹Œì§€ë„ ì •ìƒì ìœ¼ë¡œ ê°€ì ¸ì˜¬ ê²ƒì´ë‹¤.<br>
ì´ë²ˆì—ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œ ì–»ì–´ì˜¤ëŠ” ê²ƒ ë§ê³  circuitbreakerë¥¼ ìœ„í•œ ì„¤ì •íŒŒì¼ì„ ì¶”ê°€í•´ë³´ì.


## `Resilience4jConfig.java`
Circuit Breakerë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• í•˜ê¸° ìœ„í•´ì„œ í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.
```java
@Configuration
public class Resilience4jConfig {

    @Bean
    public Customizer<Resilience4JCircuitBreakerFactory> globalCustomConfiguration() {

        CircuitBreakerConfig circuitBreakerConfig = CircuitBreakerConfig.custom()
            .failureRateThreshold(4)
            .waitDurationInOpenState(Duration.ofMillis(1000))
            .slidingWindowType(CircuitBreakerConfig.SlidingWindowType.COUNT_BASED)
            .slidingWindowSize(2)
            .build();

        TimeLimiterConfig timeLimiterConfig = TimeLimiterConfig.custom()
            .timeoutDuration(Duration.ofSeconds(4))
            .build();

        return factory -> factory.configureDefault(id -> new Resilience4JConfigBuilder(id)
            .timeLimiterConfig(timeLimiterConfig)
            .circuitBreakerConfig(circuitBreakerConfig)
            .build()
        );
    }
}
```

<img width="1109" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 10 42 15" src="https://user-images.githubusercontent.com/59405576/195479156-e0376fb3-12fb-4e30-94fa-43c22070bdb7.png"><br><br>
<img width="1039" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 10 42 40" src="https://user-images.githubusercontent.com/59405576/195479218-f45f4c36-9012-4709-817b-071661f52a9c.png">





***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}