---
title:  "[E-commerce App] order-serviceì™€ catalog-serviceì— Kafka Topic ì ìš© "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-10 17:41:59
last_modified_at: 2022-10-10 17:42:01
---

# ë°ì´í„° ë™ê¸°í™”
## `order-service` -> `catalog-service`
- `order-service`ì— ìš”ì²­ ëœ ì£¼ë¬¸ì˜ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ `catalog-service`ì— ë°˜ì˜
- `order-service`ì—ì„œ Kafka Topicìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ -> `Producer` ì—­í• 
- `catalog-service`ì—ì„œ Kafka Topicì— ì „ì†¡ ëœ ë©”ì‹œì§€ ì·¨ë“ -> `Consumer` ì—­í• 

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-10 á„‹á…©á„’á…® 6 23 07](https://user-images.githubusercontent.com/59405576/194835162-7f08f5e6-972d-430d-8916-3851e2da559d.png){: width="700" height="700"}<br><br>
í† í”½ì— ê´€ì‹¬ ì •ë³´ê°€ ìˆë‹¤ê³  ë“±ë¡ì„ í•˜ëŠ” `Consumer`ë¥¼ ë¨¼ì € ì‘ì—…í•œ ë’¤ì—, <br>
í† í”½ì— ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” `Producer`ë¥¼ ë‚˜ì¤‘ì— ì‘ì—…í•˜ì.

## `catalog-service` ìˆ˜ì •
### `pom.xml`
```xml
<!-- Kafka -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

### `config/KafkaConsumerConfig.java`
```java
@EnableKafka
@Configuration
public class KafkaConsumerConfig {

    /* ì ‘ì† ì •ë³´ ë“±ë¡ */
    @Bean
    public ConsumerFactory<String, String> consumerFactory() {
        Map<String, Object> properties = new HashMap<>();
        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "127.0.0.1:9092");
        properties.put(ConsumerConfig.GROUP_ID_CONFIG, "consumerGroupId");
        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);

        return new DefaultKafkaConsumerFactory<>(properties);
    }

    /* ì ‘ì† ì •ë³´ë¥¼ ì´ìš©í•œ ë¦¬ìŠ¤ë„ˆ */
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory
            = new ConcurrentKafkaListenerContainerFactory<>();

        kafkaListenerContainerFactory.setConsumerFactory(consumerFactory());

        return kafkaListenerContainerFactory;
    }
}
```

### `service/KafkaConsumer.java`
ConsumerëŠ” í† í”½ì—ì„œ ë³€ê²½ë˜ì–´ì§„ ê°’ì„ ê°€ì§€ê³  ê°€ì„œ ì‹¤ì œ dbì— ë°˜ì˜í•´ì£¼ëŠ” ì‘ì—…ì„ í•  ê²ƒì´ë‹¤.
```java
@Service
@Slf4j
public class KafkaConsumer {

    CatalogRepository catalogRepository;

    @Autowired
    public KafkaConsumer(CatalogRepository catalogRepository) {
        this.catalogRepository = catalogRepository;
    }

    /*example-catalog-topic ì´ë¼ëŠ” í† í”½ì— ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì „ë‹¬ë˜ë©´, ê·¸ ë°ì´í„° ê°’ì„ ê°€ì ¸ì™€ ì•„ë˜ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•œë‹¤.*/
    @KafkaListener(topics = "example-catalog-topic")
    public void updateQty(String kafkaMessage) {
        log.info("Kafka Message: ->" + kafkaMessage);

        Map<Object, Object> map = new HashMap<>();
        ObjectMapper mapper = new ObjectMapper();
        try {
            // String íƒ€ì…ì˜ kafkaMessage ë¥¼ Json íƒ€ì…ìœ¼ë¡œ ë³€ê²½
            map = mapper.readValue(kafkaMessage, new TypeReference<Map<Object, Object>>() {});
        } catch (JsonProcessingException ex) {
            ex.printStackTrace();
        }

        CatalogEntity entity = catalogRepository.findByProductId((String)map.get("productId")); // productIdë¡œ ê°’ì„ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì—, ì˜ëª»ëœ productIdë¥¼ ì „ë‹¬í•˜ë©´ entityë ˆ nullì´ ë“¤ì–´ê°„ë‹¤.
        if (entity != null) {
            entity.setStock(entity.getStock() - (Integer)map.get("qty"));
            catalogRepository.save(entity);
        }
    }

}
```

## `order-service` ìˆ˜ì •
### `pom.xml`
```xml
<!-- Kafka -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

### `config/KafkaProducerConfig.java`
```java
@EnableKafka
@Configuration
public class KafkaProducerConfig {

    /* ì ‘ì† ì •ë³´ ë“±ë¡ */
    @Bean
    public ProducerFactory<String, String> producerFactory() {
        Map<String, Object> properties = new HashMap<>();
        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "127.0.0.1:9092");
        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);

        return new DefaultKafkaProducerFactory<>(properties);
    }

    /* ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” ìš©ë„ì˜ ì¸ìŠ¤í„´ìŠ¤ */
    @Bean
    public KafkaTemplate<String, String> kafkaTemplate() {
        return new KafkaTemplate<>(producerFactory());
    }
}
```

### `service/KafkaProducer.java`
ProducerëŠ” ë³€ê²½ëœ ê°’ì„ í† í”½ì— ë„£ëŠ” ì‘ì—…ì„ í•  ê²ƒì´ë‹¤.
```java
@Service
@Slf4j
public class KafkaProducer {
    private KafkaTemplate<String, String> kafkaTemplate;

    public KafkaProducer(KafkaTemplate<String, String> kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;
    }

    public OrderDto send(String topic, OrderDto orderDto) {
        ObjectMapper mapper = new ObjectMapper();
        String jsonInString = "";
        try {
            jsonInString = mapper.writeValueAsString(orderDto);
        } catch(JsonProcessingException ex) {
            ex.printStackTrace();
        }

        kafkaTemplate.send(topic, jsonInString);
        log.info("Kafka Producer sent data from the Order microservice: " + orderDto);

        return orderDto;
    }
}
```

### `controller/OrderController.java`
ì£¼ë¬¸ì´ ë“¤ì–´ì˜¤ë©´, ë³€ê²½ëœ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ í† í”½ì— ë„£ì.
```java
@RestController
@RequestMapping("/order-service")
public class OrderController {
    ...
    @PostMapping("/{userId}/orders")
    public ResponseEntity<ResponseOrder> createOrder(@PathVariable("userId") String userId, @RequestBody RequestOrder requestOrder) {
        ModelMapper mapper = new ModelMapper();
        mapper.getConfiguration().setMatchingStrategy(MatchingStrategies.STRICT);

        /* jpa */
        OrderDto orderDto = mapper.map(requestOrder, OrderDto.class);
        orderDto.setUserId(userId);

        OrderDto createdOrder = orderService.createOrder(orderDto);
        ResponseOrder responseOrder = mapper.map(createdOrder, ResponseOrder.class);

        /* ğŸŒŸ send this order to the kafka */
        kafkaProducer.send("example-catalog-topic", orderDto); // í† í”½ ì´ë¦„ì€ catalog-service ì˜ KafkaConsumer ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

        return ResponseEntity.status(HttpStatus.CREATED).body(responseOrder);
    }
}
```

# ë°ì´í„° ë™ê¸°í™” í…ŒìŠ¤íŠ¸
ì•„ë˜ ì„œë²„ë“¤ì„ ë¨¼ì € ê¸°ë™í•˜ì.
- zookeeper ì„œë²„
- kafka ì„œë²„
- eureka ì„œë²„
- `config-service`
- `gateway-service`

ê·¸ë¦¬ê³  `order-service`ì™€ `catalog-service`ë¥¼ ê¸°ë™í•œë‹¤.<br>
ì´ì œ ìƒí’ˆì„ ì£¼ë¬¸ í•œ ë’¤ì—, `order-service`ì™€ `catalog-service`ì˜ h2 ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™•ì¸í•´ë³´ì.
## ìƒí’ˆ ì£¼ë¬¸ ì „
ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì´ `order-service`ì˜ dbì—ëŠ” ì•„ë¬´ëŸ° ê°’ì´ ì—†ê³ , `catalog-service`ì˜ dbì—ëŠ” í˜„ì¬, `CATALOG-003` ë¬¼í’ˆì´ 120ê°œ ìˆë‹¤.<br><br>
`order-service`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-10 á„‹á…©á„’á…® 9 02 19](https://user-images.githubusercontent.com/59405576/194861979-c2049a8d-d5b9-484c-9136-08abb10e81df.png){: width="500" height="500"}<br><br>
`catalog-service`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-10 á„‹á…©á„’á…® 9 05 11](https://user-images.githubusercontent.com/59405576/194862549-ad62b3fa-b8f8-4a16-9b22-e1736047d788.png){: width="500" height="500"}

## ìƒí’ˆ ì£¼ë¬¸
ì´ì œ í¬ìŠ¤íŠ¸ë§¨ì„ í†µí•´ ìƒí’ˆ ì£¼ë¬¸ì„ í•´ë³´ì.<br>
(ì§€ê¸ˆ í…ŒìŠ¤íŠ¸ëŠ” `order-service`ì™€ `catalog-service`ì˜ ë°ì´í„°ê°€ ë™ê¸°í™” ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ê²ƒìœ¼ë¡œ, `userId`ì—ëŠ” ì•„ë¬´ê±°ë‚˜ ì…ë ¥í•œë‹¤.)<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-10 á„‹á…©á„’á…® 9 08 37](https://user-images.githubusercontent.com/59405576/194863160-9b0a32c5-0201-42e4-847d-6d7665fdffde.png){: width="500" height="500"}

## ìƒí’ˆ ì£¼ë¬¸ í›„
ì´ì œ ë‹¤ì‹œ `order-service`ì™€ `catalog-service`ì˜ h2 ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™•ì¸í•´ë³´ì.<br>
ì•„ë˜ ì‚¬ì§„ê³¼ ê°™ì´ `order-service`ì˜ dbì— ì£¼ë¬¸ ì •ë³´ê°€ ìƒê²¼ê³ , `catalog-service`ì˜ dbì—ëŠ” `CATALOG-003` ë¬¼í’ˆì´ 110ê°œ ìˆë‹¤.<br><br>
`order-service`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-10 á„‹á…©á„’á…® 9 06 41](https://user-images.githubusercontent.com/59405576/194862744-6449a157-0671-4f5e-a27f-c6d385ce2da9.png){: width="500" height="500"}<br><br>
`catalog-service`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-10 á„‹á…©á„’á…® 9 05 43](https://user-images.githubusercontent.com/59405576/194862621-021d716c-6530-48e5-af73-ed5544ad723c.png){: width="500" height="500"}<br><br>
`order-service`ì—ì„œ 10ê°œë¥¼ ì£¼ë¬¸í•˜ë‹ˆ, `catalog-service`ì—ì„œ ìˆ˜ëŸ‰ì´ 10ê°œ ì¤„ì–´ë“¤ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br><br>
ë‹¤ìŒ ê¸€ì—ì„œëŠ” í•˜ë‚˜ì˜ `order-service`ê°€ ì•„ë‹Œ ì—¬ëŸ¬ ê°œì˜ `order-service`ë¥¼ ê¸°ë™í–ˆì„ ë•Œ, <br>
Kafka Connectë¥¼ ì´ìš©í•´ ë‹¨ì¼ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì.














***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}