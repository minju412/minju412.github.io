---
title:  "[E-commerce App] order-service와 catalog-service에 Kafka Topic 적용 "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-10 17:41:59
last_modified_at: 2022-10-10 17:42:01
---

# 데이터 동기화
## `order-service` -> `catalog-service`
- `order-service`에 요청 된 주문의 수량 정보를 `catalog-service`에 반영
- `order-service`에서 Kafka Topic으로 메시지 전송 -> `Producer` 역할
- `catalog-service`에서 Kafka Topic에 전송 된 메시지 취득 -> `Consumer` 역할

![스크린샷 2022-10-10 오후 6 23 07](https://user-images.githubusercontent.com/59405576/194835162-7f08f5e6-972d-430d-8916-3851e2da559d.png){: width="700" height="700"}<br><br>
토픽에 관심 정보가 있다고 등록을 하는 `Consumer`를 먼저 작업한 뒤에, <br>
토픽에 데이터를 전달하는 `Producer`를 나중에 작업하자.

## `catalog-service` 수정
### `pom.xml`
```xml
<!-- Kafka -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

### `config/KafkaConsumerConfig.java`
```java
@EnableKafka
@Configuration
public class KafkaConsumerConfig {

    /* 접속 정보 등록 */
    @Bean
    public ConsumerFactory<String, String> consumerFactory() {
        Map<String, Object> properties = new HashMap<>();
        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "127.0.0.1:9092");
        properties.put(ConsumerConfig.GROUP_ID_CONFIG, "consumerGroupId");
        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);

        return new DefaultKafkaConsumerFactory<>(properties);
    }

    /* 접속 정보를 이용한 리스너 */
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory
            = new ConcurrentKafkaListenerContainerFactory<>();

        kafkaListenerContainerFactory.setConsumerFactory(consumerFactory());

        return kafkaListenerContainerFactory;
    }
}
```

### `service/KafkaConsumer.java`
Consumer는 토픽에서 변경되어진 값을 가지고 가서 실제 db에 반영해주는 작업을 할 것이다.
```java
@Service
@Slf4j
public class KafkaConsumer {

    CatalogRepository catalogRepository;

    @Autowired
    public KafkaConsumer(CatalogRepository catalogRepository) {
        this.catalogRepository = catalogRepository;
    }

    /*example-catalog-topic 이라는 토픽에 새로운 데이터가 전달되면, 그 데이터 값을 가져와 아래 메서드를 실행한다.*/
    @KafkaListener(topics = "example-catalog-topic")
    public void updateQty(String kafkaMessage) {
        log.info("Kafka Message: ->" + kafkaMessage);

        Map<Object, Object> map = new HashMap<>();
        ObjectMapper mapper = new ObjectMapper();
        try {
            // String 타입의 kafkaMessage 를 Json 타입으로 변경
            map = mapper.readValue(kafkaMessage, new TypeReference<Map<Object, Object>>() {});
        } catch (JsonProcessingException ex) {
            ex.printStackTrace();
        }

        CatalogEntity entity = catalogRepository.findByProductId((String)map.get("productId"));
        if (entity != null) {
            entity.setStock(entity.getStock() - (Integer)map.get("qty"));
            catalogRepository.save(entity);
        }
    }

}
```

## `order-service` 수정
### `config/KafkaProducerConfig.java`


### `service/KafkaProducer.java`
Producer는 변경된 값을 토픽에 넣는 작업을 할 것이다.


### `controller/OrderController.java`















***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}