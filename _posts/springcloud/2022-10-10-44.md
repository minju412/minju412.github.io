---
title:  "[E-commerce App] order-serviceì™€ catalog-serviceì— Kafka Topic ì ìš© "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-10 17:41:59
last_modified_at: 2022-10-10 17:42:01
---

# ë°ì´í„° ë™ê¸°í™”
## `order-service` -> `catalog-service`
- `order-service`ì— ìš”ì²­ ëœ ì£¼ë¬¸ì˜ ìˆ˜ëŸ‰ ì •ë³´ë¥¼ `catalog-service`ì— ë°˜ì˜
- `order-service`ì—ì„œ Kafka Topicìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ -> `Producer` ì—­í• 
- `catalog-service`ì—ì„œ Kafka Topicì— ì „ì†¡ ëœ ë©”ì‹œì§€ ì·¨ë“ -> `Consumer` ì—­í• 

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-10 á„‹á…©á„’á…® 6 23 07](https://user-images.githubusercontent.com/59405576/194835162-7f08f5e6-972d-430d-8916-3851e2da559d.png){: width="700" height="700"}<br><br>
í† í”½ì— ê´€ì‹¬ ì •ë³´ê°€ ìˆë‹¤ê³  ë“±ë¡ì„ í•˜ëŠ” `Consumer`ë¥¼ ë¨¼ì € ì‘ì—…í•œ ë’¤ì—, <br>
í† í”½ì— ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” `Producer`ë¥¼ ë‚˜ì¤‘ì— ì‘ì—…í•˜ì.

## `catalog-service` ìˆ˜ì •
### `pom.xml`
```xml
<!-- Kafka -->
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

### `config/KafkaConsumerConfig.java`
```java
@EnableKafka
@Configuration
public class KafkaConsumerConfig {

    /* ì ‘ì† ì •ë³´ ë“±ë¡ */
    @Bean
    public ConsumerFactory<String, String> consumerFactory() {
        Map<String, Object> properties = new HashMap<>();
        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "127.0.0.1:9092");
        properties.put(ConsumerConfig.GROUP_ID_CONFIG, "consumerGroupId");
        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);

        return new DefaultKafkaConsumerFactory<>(properties);
    }

    /* ì ‘ì† ì •ë³´ë¥¼ ì´ìš©í•œ ë¦¬ìŠ¤ë„ˆ */
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory
            = new ConcurrentKafkaListenerContainerFactory<>();

        kafkaListenerContainerFactory.setConsumerFactory(consumerFactory());

        return kafkaListenerContainerFactory;
    }
}
```

### `service/KafkaConsumer.java`
ConsumerëŠ” í† í”½ì—ì„œ ë³€ê²½ë˜ì–´ì§„ ê°’ì„ ê°€ì§€ê³  ê°€ì„œ ì‹¤ì œ dbì— ë°˜ì˜í•´ì£¼ëŠ” ì‘ì—…ì„ í•  ê²ƒì´ë‹¤.
```java
@Service
@Slf4j
public class KafkaConsumer {

    CatalogRepository catalogRepository;

    @Autowired
    public KafkaConsumer(CatalogRepository catalogRepository) {
        this.catalogRepository = catalogRepository;
    }

    /*example-catalog-topic ì´ë¼ëŠ” í† í”½ì— ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì „ë‹¬ë˜ë©´, ê·¸ ë°ì´í„° ê°’ì„ ê°€ì ¸ì™€ ì•„ë˜ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•œë‹¤.*/
    @KafkaListener(topics = "example-catalog-topic")
    public void updateQty(String kafkaMessage) {
        log.info("Kafka Message: ->" + kafkaMessage);

        Map<Object, Object> map = new HashMap<>();
        ObjectMapper mapper = new ObjectMapper();
        try {
            // String íƒ€ì…ì˜ kafkaMessage ë¥¼ Json íƒ€ì…ìœ¼ë¡œ ë³€ê²½
            map = mapper.readValue(kafkaMessage, new TypeReference<Map<Object, Object>>() {});
        } catch (JsonProcessingException ex) {
            ex.printStackTrace();
        }

        CatalogEntity entity = catalogRepository.findByProductId((String)map.get("productId"));
        if (entity != null) {
            entity.setStock(entity.getStock() - (Integer)map.get("qty"));
            catalogRepository.save(entity);
        }
    }

}
```

## `order-service` ìˆ˜ì •
### `config/KafkaProducerConfig.java`


### `service/KafkaProducer.java`
ProducerëŠ” ë³€ê²½ëœ ê°’ì„ í† í”½ì— ë„£ëŠ” ì‘ì—…ì„ í•  ê²ƒì´ë‹¤.


### `controller/OrderController.java`















***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}