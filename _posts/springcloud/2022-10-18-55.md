---
title:  "[E-commerce App] Docker Container를 이용한 애플리케이션 배포 - 3. MariaDB & Kafka & Zipkin "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-18 00:49:03
last_modified_at: 2022-10-18 00:49:05
---

이전 글에 이어서 진행해보자.

# Docker Container
## 5. MariaDB
`order-service`에서 사용할 MariaDB를 컨테이너화 시켜보자.
### 1) 로컬 mysql에서 생성한 테이블 데이터를 옮기기
로컬에서 사용하던 DATABASE가 저장되어있는 위치로 이동한 뒤, 해당 데이터 파일들을 `Dockerfile`을 생성할 위치에 미리 복사해 두자!

#### MySQL에서 저장된 DATABASE의 경로를 확인하는 방법
> [이 글](http://gnujava.com/board/article_view.jsp?board_no=16&article_no=1833)을 참고했다.<br>
(보통 `/usr/local/mysql/bin` 위치에 있다는데 나는 없었다..ㅜㅜ)

```bash
$ mysql -u admin -p

# DATABASE 경로 확인
mysql> show variables like 'datadir';
```
<img width="564" alt="스크린샷 2022-10-18 오전 12 37 09" src="https://user-images.githubusercontent.com/59405576/196221080-fc39987b-e6ef-490e-b68a-0ef81b722c6d.png"><br><br>
<img width="583" alt="스크린샷 2022-10-18 오전 12 34 19" src="https://user-images.githubusercontent.com/59405576/196220466-7d747c52-a519-4acd-90f8-0a0e4ea89d7c.png"><br><br>
<img width="477" alt="스크린샷 2022-10-18 오전 12 38 15" src="https://user-images.githubusercontent.com/59405576/196221232-d108aa93-457a-412b-a339-647fb909cc74.png"><br><br>

이제 이 데이터들을 우리가 원하는 폴더로 옮겨보자.
```bash
# 폴더 생성
$ mkdir docker-files
$ cd docker-files

$ mkdir mysql-data
$ cd mysql-data

# mysql 데이터 copy
$ cp -R /opt/homebrew/var/mysql .
```
<img width="631" alt="스크린샷 2022-10-18 오전 12 43 53" src="https://user-images.githubusercontent.com/59405576/196222530-541360cd-9f36-45d3-b1b8-45dc0b201b52.png">


### 2) Dockerfile을 통해 이미지 만들기
`Dockerfile`은 아까 복사해둔 `mysql-data` 디렉토리와 같은 위치에 생성하자.
```Dockerfile
FROM mariadb

ENV MYSQL_ROOT_PASSWORD test1234

ENV MYSQL_DATABASE mydb

COPY ./mysql-data/mysql /var/lib/mysql

EXPOSE 3306

ENTRYPOINT ["mysqld","--user=root"]

```
<img width="412" alt="스크린샷 2022-10-18 오전 1 35 31" src="https://user-images.githubusercontent.com/59405576/196233626-f50ff8f0-8363-4d4f-a1b5-e13b22b74aa7.png">

- `COPY ./mysql-data/mysql /var/lib/mysql`<br>- 데이터 베이스를 만들 때, 초기에 생성할 테이블 정보를 스크립트를 이용해 생성해도 괜찮지만, <br>지금은 로컬 db에서 만들어둔 테이블을 컨테이너 안으로 복사하여 사용해볼 것이다.<br>- 이 때, `COPY ./mysql-data/mysql` 자리에는 로컬에서 기동시킨 mariadb의 데이터들이 저장되어 있는 위치를 명시해주면 된다.

### 3) 이미지 빌드
```bash
# 이미지 파일 빌드
$ docker build -t ln8847/my_mariadb:1.0 .

# 생성된 이미지 확인
$ docker images | grep my_mariadb
```
<img width="1246" alt="스크린샷 2022-10-18 오전 1 49 32" src="https://user-images.githubusercontent.com/59405576/196236579-e1589398-967e-4ff1-a9d9-c6288eed29e1.png">

### 4) 도커 컨테이너 실행
실행 전에 기존에 로컬에서 기동 중인 mysql이 있다면 먼저 중지하자! (포트가 겹치면 에러가 발생한다.)
```bash
# mysql 정지 (기동 중이라면..)
$ brew services stop mysql

# 컨테이너 실행
$ docker run -d -p 3306:3306 --network ecommerce-network \
--name mariadb \
ln8847/my_mariadb:1.0

# 로그 확인
$ docker logs mariadb
```
<img width="475" alt="스크린샷 2022-10-18 오전 1 53 42" src="https://user-images.githubusercontent.com/59405576/196237367-6cb89f67-0e3a-4c4e-bf0e-c687b40fda0c.png"><br>

이전과 마찬가지로 네트워크를 확인해보자.
```bash
$ docker network inspect ecommerce-network
```

> 만약 Dockerfile을 수정하고 싶다면?
Dockerfile을 수정한 뒤에, <br>
아래 커맨드를 순서대로 입력해 다시 도커 컨테이너를 기동하자.

```bash
$ docker stop mariadb

$ docker system prune

$ docker build -t ln8847/my_mariadb:1.0 .

$ docker run -d -p 3306:3306 --network ecommerce-network \
--name mariadb \
ln8847/my_mariadb:1.0
```
실행을 확인해보고, 정상적으로 기동되지 않았다면 로그까지 확인해보자.
```bash
$ docker ps -a

$ docker logs mariadb
```













***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}