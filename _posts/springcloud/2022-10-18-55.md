---
title:  "[E-commerce App] Docker Containerë¥¼ ì´ìš©í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ - 3. MySQL "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-18 00:49:03
last_modified_at: 2022-10-18 00:49:05
---

ì´ì „ ê¸€ì— ì´ì–´ì„œ ì§„í–‰í•´ë³´ì.

# Docker Container
## 5. MySQL (MariaDB)
`order-service`ì—ì„œ ì‚¬ìš©í•  MariaDBë¥¼ ì»¨í…Œì´ë„ˆí™” ì‹œì¼œë³´ì.<br>
(ì›ë˜ëŠ” MariaDBë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ë‚˜ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•´ MySQLì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤.)

### 1) init ë°ì´í„° ìƒì„±
ë°©ë²• 1 ê³¼ ë°©ë²• 2 ì¤‘ ì•„ë¬´ë ‡ê²Œë‚˜ í•´ë„ ìƒê´€ì—†ë‹¤.<br>
(ë‚˜ëŠ” ë°©ë²• 2ë¥¼ ì„ íƒí–ˆë‹¤.)

#### [ë°©ë²• 1] ë¡œì»¬ mysqlì—ì„œ ìƒì„±í•œ í…Œì´ë¸” ë°ì´í„°ë¥¼ ì˜®ê¸°ê¸°
ë¡œì»¬ì—ì„œ ì‚¬ìš©í•˜ë˜ DATABASEê°€ ì €ì¥ë˜ì–´ìˆëŠ” ìœ„ì¹˜ë¡œ ì´ë™í•œ ë’¤, í•´ë‹¹ ë°ì´í„° íŒŒì¼ë“¤ì„ `Dockerfile`ì„ ìƒì„±í•  ìœ„ì¹˜ì— ë¯¸ë¦¬ ë³µì‚¬í•´ ë‘ì!

##### MySQLì—ì„œ ì €ì¥ëœ DATABASEì˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ëŠ” ë°©ë²•
> [ì´ ê¸€](http://gnujava.com/board/article_view.jsp?board_no=16&article_no=1833)ì„ ì°¸ê³ í–ˆë‹¤.<br>
(ë³´í†µ `/usr/local/mysql/bin` ìœ„ì¹˜ì— ìˆë‹¤ëŠ”ë° ë‚˜ëŠ” ì—†ì—ˆë‹¤..ã…œã…œ)

```bash
$ mysql -u admin -p

# DATABASE ê²½ë¡œ í™•ì¸
mysql> show variables like 'datadir';
```
<img width="564" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„Œá…¥á†« 12 37 09" src="https://user-images.githubusercontent.com/59405576/196221080-fc39987b-e6ef-490e-b68a-0ef81b722c6d.png"><br><br>
<img width="583" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„Œá…¥á†« 12 34 19" src="https://user-images.githubusercontent.com/59405576/196220466-7d747c52-a519-4acd-90f8-0a0e4ea89d7c.png"><br><br>
<img width="477" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„Œá…¥á†« 12 38 15" src="https://user-images.githubusercontent.com/59405576/196221232-d108aa93-457a-412b-a339-647fb909cc74.png"><br><br>

ì´ì œ ì´ ë°ì´í„°ë“¤ì„ ìš°ë¦¬ê°€ ì›í•˜ëŠ” í´ë”ë¡œ ì˜®ê²¨ë³´ì.
```bash
# í´ë” ìƒì„±
$ mkdir docker-files
$ cd docker-files

$ mkdir mysql-data
$ cd mysql-data

# mysql ë°ì´í„° copy
$ cp -R /opt/homebrew/var/mysql .
```
<img width="631" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„Œá…¥á†« 12 43 53" src="https://user-images.githubusercontent.com/59405576/196222530-541360cd-9f36-45d3-b1b8-45dc0b201b52.png">

#### [ë°©ë²• 2] init ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
> [ì´ ê¸€](https://kamang-it.tistory.com/m/entry/DockerMysqlInitSql)ì„ ì°¸ê³ í–ˆë‹¤.<br>
ê¹ƒ í—ˆë¸Œ ì£¼ì†ŒëŠ” [ì—¬ê¸°](https://github.com/kukaro/Eris-DockerExampleTemplate/tree/6bb64a5bed4f4a080553e3095642c4fe6bd19046/Mysql.Replication/mymaster)ì´ë‹¤.

Dockerfileì´ ìˆëŠ” ìœ„ì¹˜ì— `mysql-init-files` ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•œ ë’¤, ê·¸ ì•ˆì—ì„œ `create.sql` íŒŒì¼ì„ ìƒì„±í•œë‹¤.<br><br>
`create.sql`<br>
```sql
-- CREATE DATABASE mydb;

create table mydb.users(
    id int auto_increment primary key,
    user_id varchar(20),
    pwd varchar(20),
    name varchar(20),
    created_at datetime default NOW()
);

create table mydb.orders (
    id int auto_increment primary key,
    product_id varchar(20) not null,
    qty int default 0,
    unit_price int default 0,
    total_price int default 0,
    user_id varchar(50) not null,
    order_id varchar(50) not null,
    created_at datetime default NOW()
);

-- create masteruser and grant privileges
-- create user root'%' identified by '1234';
-- grant all privileges on *.* to root'%' identified by '1234';

```



### 2) Dockerfileì„ í†µí•´ ì´ë¯¸ì§€ ë§Œë“¤ê¸°
#### [ë°©ë²• 1] ì„ íƒ
init ë°ì´í„°ë¥¼ ìƒì„±í•  ë•Œ, [ë°©ë²• 1]ì„ ì„ íƒí–ˆë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ í•˜ì.<br>
`Dockerfile`ì€ ì•„ê¹Œ ë³µì‚¬í•´ë‘” `mysql-data` ë””ë ‰í† ë¦¬ì™€ ê°™ì€ ìœ„ì¹˜ì— ìƒì„±í•˜ì.
```Dockerfile
FROM mariadb

ENV MYSQL_ROOT_PASSWORD 1234

ENV MYSQL_DATABASE mydb

COPY ./mysql-data/mysql /var/lib/mysql

EXPOSE 3306

ENTRYPOINT ["mysqld","--user=root"]

```
<img width="412" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„Œá…¥á†« 1 35 31" src="https://user-images.githubusercontent.com/59405576/196233626-f50ff8f0-8363-4d4f-a1b5-e13b22b74aa7.png">

- `COPY ./mysql-data/mysql /var/lib/mysql`<br>- ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ë§Œë“¤ ë•Œ, ì´ˆê¸°ì— ìƒì„±í•  í…Œì´ë¸” ì •ë³´ë¥¼ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•´ ìƒì„±í•´ë„ ê´œì°®ì§€ë§Œ, <br>ì§€ê¸ˆì€ ë¡œì»¬ dbì—ì„œ ë§Œë“¤ì–´ë‘” í…Œì´ë¸”ì„ ì»¨í…Œì´ë„ˆ ì•ˆìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•´ë³¼ ê²ƒì´ë‹¤.<br>- ì´ ë•Œ, `COPY ./mysql-data/mysql` ìë¦¬ì—ëŠ” ë¡œì»¬ì—ì„œ ê¸°ë™ì‹œí‚¨ mariadbì˜ ë°ì´í„°ë“¤ì´ ì €ì¥ë˜ì–´ ìˆëŠ” ìœ„ì¹˜ë¥¼ ëª…ì‹œí•´ì£¼ë©´ ëœë‹¤.

#### [ë°©ë²• 2] ì„ íƒ
init ë°ì´í„°ë¥¼ ìƒì„±í•  ë•Œ, [ë°©ë²• 2]ë¥¼ ì„ íƒí–ˆë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ í•˜ì.<br>
`Dockerfile`ì€ ì•„ê¹Œ ìƒì„±í•œ `mysql-init-files` ë””ë ‰í† ë¦¬ì™€ ê°™ì€ ìœ„ì¹˜ì— ìƒì„±í•˜ì.
```Dockerfile
FROM mysql

MAINTAINER minju412 <mj441@naver.com>

ADD ./mysql-init-files /docker-entrypoint-initdb.d

ENV MYSQL_ROOT_PASSWORD 1234
ENV MYSQL_DATABASE mydb

EXPOSE 3306
```
<img width="454" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 2 56 33" src="https://user-images.githubusercontent.com/59405576/196347262-7af1fed9-d57a-475d-abdf-d3b177e59fa1.png"><br>
(`mysql-data` ë””ë ‰í† ë¦¬ëŠ” ì´ì „ì— ì‹œë„í•  ë•Œ ìƒì„±í–ˆë˜ ê²ƒì´ë¯€ë¡œ ì—†ì–´ë„ ëœë‹¤.)<br><br>
íŒ¨ìŠ¤ì›Œë“œëŠ” 1234ë¡œ ì§€ì •í•´ë³´ì. (ì§€ê¸ˆ ìƒˆë¡œ ë§Œë“œëŠ” ê²ƒ!)

### 3) ì´ë¯¸ì§€ ë¹Œë“œ
```bash
# ì´ë¯¸ì§€ íŒŒì¼ ë¹Œë“œ
$ docker build -t ln8847/my_mysql:1.0 .

# ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸
$ docker images | grep my_mysql
```

#### ë§Œì•½ ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤ë©´?
m1 Macì—ì„œ ì´ë¯¸ì§€ ë¹Œë“œ ì‹œ, ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
```
failed to solve with frontend dockerfile.v0: failed to create LLB definition: no match for platform in manifest sha256:94176d0ad4ed85767fc0d74b8071387109a0390e7c1afd39788269c96d2dad74: not found
```
ì´ ê²½ìš°ì—ëŠ”, `--platform` ì˜µì…˜ì„ ì¶”ê°€í•˜ì.
```bash
$ docker build --platform linux/x86_64 -t ln8847/my_mysql:1.0 .
```

<img width="1371" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 2 43 51" src="https://user-images.githubusercontent.com/59405576/196345416-b88678b5-b000-4ed9-9ba5-048df782c074.png"><br><br>


### 4) ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
ì‹¤í–‰ ì „ì— ê¸°ì¡´ì— ë¡œì»¬ì—ì„œ ê¸°ë™ ì¤‘ì¸ mysqlì´ ìˆë‹¤ë©´ ë¨¼ì € ì¤‘ì§€í•˜ì! (í¬íŠ¸ê°€ ê²¹ì¹˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.)
```bash
# mysql ê¸°ë™ ì¤‘ì¸ì§€ í™•ì¸
$ brew services list

# mysql ì •ì§€ (ê¸°ë™ ì¤‘ì´ë¼ë©´..)
$ brew services stop mysql
```

```bash
# ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ docker run -d -p 3306:3306 --network ecommerce-network \
--name mysql \
ln8847/my_mysql:1.0

# ë¡œê·¸ í™•ì¸
$ docker logs mysql
```
<img width="475" alt="196237367-6cb89f67-0e3a-4c4e-bf0e-c687b40fda0c" src="https://user-images.githubusercontent.com/59405576/196348740-8e4d1251-55bf-419c-a648-7b528aa5588b.png"><br><br>
<img width="1418" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 5 12 13" src="https://user-images.githubusercontent.com/59405576/196374383-5dc62870-8eb1-42b0-9c52-554eaa2fda52.png"><br><br>
ì •ìƒì ìœ¼ë¡œ ê¸°ë™ë˜ì—ˆì„ ë•Œ ë¡œê·¸ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.<br>
<img width="1425" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 5 18 20" src="https://user-images.githubusercontent.com/59405576/196375816-5e9caa30-a579-465f-af5e-6b3cba8ae2ff.png">

ì´ì „ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ë³´ì.
```bash
$ docker network inspect ecommerce-network
```
<img width="656" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 5 13 08" src="https://user-images.githubusercontent.com/59405576/196374611-1e9cca89-7cfd-498b-aa88-25f4896e7cb9.png">


#### ë§Œì•½ Dockerfileì„ ìˆ˜ì •í•˜ê³  ì‹¶ë‹¤ë©´?
Dockerfileì„ ìˆ˜ì •í•œ ë’¤ì—, <br>
ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë‹¤ì‹œ ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ê¸°ë™í•˜ì.

```bash
# ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
$ docker stop mysql

# ì‹¤í–‰ì¤‘ì´ì§€ ì•Šì€ ì»¨í…Œì´ë„ˆ ë° ë„¤íŠ¸ì›Œí¬, ìºì‹œ ì‚­ì œ
$ docker system prune

# ì´ë¯¸ì§€ ë¹Œë“œ
$ docker build -t ln8847/my_mysql:1.0 .

# ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ docker run -d -p 3306:3306 --network ecommerce-network \
--name mysql \
ln8847/my_mysql:1.0
```
ì‹¤í–‰ì„ í™•ì¸í•´ë³´ê³ , ì •ìƒì ìœ¼ë¡œ ê¸°ë™ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¡œê·¸ê¹Œì§€ í™•ì¸í•´ë³´ì.
```bash
$ docker ps -a

$ docker logs mysql
```

### 5) db ì ‘ì† í›„ í…Œì´ë¸” í™•ì¸ ë° ê¶Œí•œ ì„¤ì •
mysql ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— ì ‘ì†í•œ ë’¤,<br>
mydb ë¼ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•´ `users`ì™€ `orders` í…Œì´ë¸”ì´ ë§Œë“¤ì–´ì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì.<br>
ê·¸ë¦¬ê³  mysqlì˜ root ê³„ì •ì´ ì–´ë– í•œ IP Addressë¡œ ì ‘ì†í•œë‹¤ í•˜ë”ë¼ë„ ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ ê¶Œí•œì„ ì„¤ì •í•´ë³´ì.

```bash
$ docker exec -it mysql /bin/bash

bash-4.4# mysql -h127.0.0.1 -uroot -p
# íŒ¨ìŠ¤ì›Œë“œëŠ” ì•„ê¹Œ ì§€ì •í•œëŒ€ë¡œ 1234 ì…ë ¥

# ë°ì´í„° ë² ì´ìŠ¤ í™•ì¸
mysql> show databases;

mysql> use mydb;

# í…Œì´ë¸” í™•ì¸
mysql> show tables;
```
ì•„ë˜ì™€ ê°™ì´ ë‘ ê°œì˜ í…Œì´ë¸”ì´ ìƒì„±ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br>
<img width="567" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 5 35 55" src="https://user-images.githubusercontent.com/59405576/196380053-ec77a4e2-5272-4b12-ad9b-bf1f91ab018a.png">

ì´ì œ ê¶Œí•œì„ ì„¤ì •í•˜ì.
```bash
# ê¶Œí•œ ë¶€ì—¬
mysql> grant all privileges on *.* to 'root'@'%';

# ì ìš©
mysql> flush privileges;

# ê¶Œí•œ í™•ì¸
mysql> show grants for 'root'@'%';
```
root ë¼ëŠ” ê³„ì •ì˜ ì–´ë–¤ IP Addressë¡œ ì ‘ì†í•˜ë”ë¼ë„, ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ì»¤ë§¨ë“œì´ë‹¤.<br>
<img width="363" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 5 43 13" src="https://user-images.githubusercontent.com/59405576/196381755-6b0e7c9f-89fb-4ea1-8437-e8d47bc49ba3.png">





***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}