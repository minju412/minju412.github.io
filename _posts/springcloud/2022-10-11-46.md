---
title:  "[E-commerce App] `order-service` ìˆ˜ì • - Orders Kafka Topic "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-11 23:26:00
last_modified_at: 2022-10-11 23:26:03
---

í† í”½ì— ì •ë³´ë¥¼ ë„£ëŠ” ê²ƒ ë§Œìœ¼ë¡œ dbì— ë°ì´í„°ë¥¼ insert í•˜ê¸° ìœ„í•´ì„œëŠ”, ê¼­ ì•„ë˜ì™€ ê°™ì€ JSON í˜•íƒœë¡œ ë„£ì–´ì•¼ í–ˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 12 01 29](https://user-images.githubusercontent.com/59405576/195128020-d5377e1b-d73d-4abb-b55c-dc4287ca7f8b.png){: width="500" height="500"}<br>
ì´ë¥¼ java ì½”ë“œë¡œ ë°”ê¾¸ë©´ ì•„ë˜ì™€ ê°™ë‹¤.<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-11 á„‹á…©á„’á…® 11 45 17](https://user-images.githubusercontent.com/59405576/195123300-1c63944b-ea91-482d-b482-b4c00ea334e8.png){: width="800" height="800"}<br>
ìœ„ ì‚¬ì§„ì—ì„œì²˜ëŸ¼ `schema`ì™€ `payload`ë¥¼ ê°ê° ê°ì²´ë¡œ ë§Œë“¤ê³ ,<br>
ì´ë“¤ì„ ë‹´ê³  ìˆëŠ” `dto` ê°ì²´ë¥¼ í•˜ë‚˜ ë§Œë“¤ì.<br>
ì„¸ë¶€ì ìœ¼ë¡œëŠ”, `schema`ë¥¼ êµ¬ì„±í•˜ê³  ìˆëŠ” êµ¬ì„± ìš”ì†Œ ì¤‘ `fields`ëŠ” ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë˜ì–´ìˆê¸° ë•Œë¬¸ì—, `field` ê°ì²´ë„ ë”°ë¡œ ë§Œë“¤ì.<br><br>
ë”°ë¼ì„œ ì´ 4ê°œì˜ dto ë¥¼ ë§Œë“¤ ê²ƒì´ë‹¤.
- `KafkaOrderDto`
- `Schema`
- `Field`
- `Payload`

# `order-service`
## ğŸ—‚ `dto`
### `KafkaOrderDto.java`
```java
@Data
@AllArgsConstructor
public class KafkaOrderDto implements Serializable {

    private Schema schema;
    private Payload payload;
}
```

### `Schema.java`
```java
@Data
@Builder
public class Schema {

    private String type;
    private List<Field> fields;
    private boolean optional;
    private String name;
}
```

### `Field.java`
```java
@Data
@AllArgsConstructor
public class Field {

    private String type;
    private boolean optional;
    private String field;
}
```

### `Payload.java`
```java
@Data
@Builder
public class Payload {

    private String order_id;
    private String user_id;
    private String product_id;
    private int qty;
    private int unit_price;
    private int total_price;
}
```

ì´ì œ ì´ dto ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” message í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì.

## ğŸ—‚ `messagequeue`
### `OrderProducer.java`
```java
@Service
@Slf4j
public class OrderProducer {
    private KafkaTemplate<String, String> kafkaTemplate;

    List<Field> fields = Arrays.asList(
        new Field("string", true, "order_id"),
        new Field("string", true, "user_id"),
        new Field("string", true, "product_id"),
        new Field("int32", true, "qty"),
        new Field("int32", true, "unit_price"),
        new Field("int32", true, "total_price")
        );

    Schema schema = Schema.builder()
        .type("struct")
        .fields(fields)
        .optional(false)
        .name("orders")
        .build();

    @Autowired
    public OrderProducer(KafkaTemplate<String, String> kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;
    }

    public OrderDto send(String topic, OrderDto orderDto) {

        Payload payload = Payload.builder()
            .order_id(orderDto.getOrderId())
            .user_id(orderDto.getUserId())
            .product_id(orderDto.getProductId())
            .qty(orderDto.getQty())
            .unit_price(orderDto.getUnitPrice())
            .total_price(orderDto.getTotalPrice())
            .build();

        // í† í”½ì— ì „ë‹¬í•  ê°ì²´ ìƒì„±
        KafkaOrderDto kafkaOrderDto = new KafkaOrderDto(schema, payload);

        ObjectMapper mapper = new ObjectMapper();
        String jsonInString = "";
        try {
            jsonInString = mapper.writeValueAsString(kafkaOrderDto);
        } catch(JsonProcessingException ex) {
            ex.printStackTrace();
        }

        kafkaTemplate.send(topic, jsonInString);
        log.info("Order Producer sent data from the Order microservice: " + kafkaOrderDto);

        return orderDto;
    }
}
```

## ğŸ—‚ `controller`
### `OrderController.java`
```java
@RestController
@RequestMapping("/order-service")
public class OrderController {
    ...
    @PostMapping("/{userId}/orders")
    public ResponseEntity<ResponseOrder> createOrder(@PathVariable("userId") String userId, @RequestBody RequestOrder requestOrder) {
        ModelMapper mapper = new ModelMapper();
        mapper.getConfiguration().setMatchingStrategy(MatchingStrategies.STRICT);

        OrderDto orderDto = mapper.map(requestOrder, OrderDto.class);
        orderDto.setUserId(userId);

        /* jpa */
        // OrderDto createdOrder = orderService.createOrder(orderDto);
        // ResponseOrder responseOrder = mapper.map(createdOrder, ResponseOrder.class);

        /* ğŸŒŸ kafka */
        orderDto.setOrderId(UUID.randomUUID().toString());
        orderDto.setTotalPrice(requestOrder.getQty() * requestOrder.getUnitPrice());

        /* send this order to the kafka */
        kafkaProducer.send("example-catalog-topic", orderDto); // í† í”½ ì´ë¦„ì€ catalog-service ì˜ KafkaConsumer ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
        orderProducer.send("orders", orderDto); // ğŸŒŸ ì•„ë˜ì—ì„œ orders ë¼ëŠ” ì´ë¦„ì˜ sink connectorë¥¼ ìƒˆë¡œ ë“±ë¡í•  ê²ƒì´ë‹¤.

        ResponseOrder responseOrder = mapper.map(orderDto, ResponseOrder.class);

        return ResponseEntity.status(HttpStatus.CREATED).body(responseOrder);
    }
}

```

# Sink Connector ì¶”ê°€
## ì„œë²„ ê¸°ë™
ì•„ë˜ ì„œë²„ë“¤ì„ ë¨¼ì € ê¸°ë™í•˜ì.
- zookeeper ì„œë²„
- kafka ì„œë²„

ê·¸ë¦¬ê³  kafka connect ì„œë²„ë¥¼ ê¸°ë™í•œë‹¤.
```bash
# í˜„ì¬ ìœ„ì¹˜: /Users/minju/study/msa/kafka-demo/confluent-6.1.0
$ ./bin/connect-distributed ./etc/kafka/connect-distributed.properties
```

## í˜„ì¬ ë“±ë¡ë˜ì–´ì§„ Connector í™•ì¸
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 12 33 57](https://user-images.githubusercontent.com/59405576/195135586-58a96003-5105-4b37-8f03-b8e3fe30a80b.png)

## ìƒˆë¡œìš´ Sink Connector ë“±ë¡
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 12 35 56](https://user-images.githubusercontent.com/59405576/195136124-3a1de966-0635-42b2-9bb7-0ab9c1ef0dba.png)
```json
{
  "name":"my-order-sink-connect",
  "config":{
  "connector.class":"io.confluent.connect.jdbc.JdbcSinkConnector",
  "connection.url":"jdbc:mysql://localhost:3306/mydb",
  "connection.user":"***",
  "connection.password":"***",
  "auto.create":"true",
  "auto.evolve":"true",
  "delete.enabled":"false",
  "tasks.max":"1",
  "topics":"orders"
  }
}
```
ë“±ë¡ í›„, ë‹¤ì‹œ connector ëª©ë¡ì„ í™•ì¸í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-12 á„‹á…©á„Œá…¥á†« 12 40 02](https://user-images.githubusercontent.com/59405576/195137150-456b962e-13d7-4e60-b671-b4726fef0dd4.png)<br><br>
ì´ì œ ì—¬ëŸ¬ ê°œì˜ `order-service`ì—ì„œ ë°œìƒí–ˆë˜ ë©”ì‹œì§€ê°€ í† í”½ì— ì˜ ì „ë‹¬ë˜ëŠ”ì§€ì™€<br>
ì „ë‹¬ëœ ë°ì´í„°ê°€ í•˜ë‚˜ì˜ ë‹¨ì¼ ë°ì´í„°ë² ì´ìŠ¤ì— ë“¤ì–´ê°€ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•´ë³´ì.









***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}