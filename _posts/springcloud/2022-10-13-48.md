---
title:  "[E-commerce App] Spring Cloud Sleuth + Zipkinì„ ì´ìš©í•œ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì˜ ë¶„ì‚° ì¶”ì²™ "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-13 10:47:35
last_modified_at: 2022-10-13 10:47:38
---

ì´ì „ ê¸€ì—ì„œëŠ”, ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ, circuit breakerë¥¼ ì‚¬ìš©í•´ ì—°ì‡„ì ìœ¼ë¡œ ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë´¤ë‹¤.<br><br>
ì´ë²ˆì—ëŠ”, í•˜ë‚˜ì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ê¸°ë™ë  ë•Œ, ì—¬ëŸ¬ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í• í…ë°,<br>
ì´ ë•Œ í•´ë‹¹í•˜ëŠ” ìš”ì²­ ì •ë³´ê°€ ì–´ë–»ê²Œ ì‹¤í–‰ë˜ê³ , ì–´ëŠ ë‹¨ê³„ë¥¼ ê±°ì³ ì–´ë–¤ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¡œ ì´ë™í•˜ëŠ”ì§€ ì¶”ì í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì‚´í´ë³´ì.<br>
ì´ëŸ° ë‚´ìš©ì„ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì˜ "ë¶„ì‚° ì¶”ì " ì´ë¼ê³  í•œë‹¤.

# ê°œìš”
## Zipkin
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 10 54 33](https://user-images.githubusercontent.com/59405576/195480616-b0938f3d-ee63-42a1-8ac8-dea53337646b.png){: width="700" height="700"}

- [https://zipkin.io/](https://zipkin.io/)
- Twitterì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¶„ì‚° í™˜ê²½ì˜ Timing ë°ì´í„° ìˆ˜ì§‘, ì¶”ì  ì‹œìŠ¤í…œ (ì˜¤í”ˆì†ŒìŠ¤)
- Google Drapperì—ì„œ ë°œì „í•˜ì˜€ìœ¼ë©°, ë¶„ì‚° í™˜ê²½ì—ì„œì˜ ì‹œìŠ¤í…œ ë³‘ëª© í˜„ìƒ íŒŒì•…
- Collector, Query Service, Database, WebUIë¡œ êµ¬ì„±
- Span<br>- í•˜ë‚˜ì˜ ìš”ì²­ì— ì‚¬ìš©ë˜ëŠ” ì‘ì—…ì˜ ë‹¨ìœ„<br>- 64 bit unique ID
- Trace<br>- íŠ¸ë¦¬ êµ¬ì¡°ë¡œ ì´ë¤„ì§„ Span ì…‹<br>- í•˜ë‚˜ì˜ ìš”ì²­ì— ëŒ€í•œ ê°™ì€ Trace ID ë°œê¸‰

### Zipkin ì„¤ì¹˜ ë° ì‹¤í–‰
```bash
# ì„¤ì¹˜
$ curl -sSL https://zipkin.io/quickstart.sh | bash -s

# ì‹¤í–‰
$ java -jar zipkin.jar
```
ì„¤ì¹˜<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 11 06 29](https://user-images.githubusercontent.com/59405576/195482075-2222e37e-6200-4576-bee1-7a3e834ed5ca.png)<br><br>
ì‹¤í–‰<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 11 07 30](https://user-images.githubusercontent.com/59405576/195482202-ee41845f-968e-4520-838a-144198109b5b.png)<br>
zipkinì˜ default í¬íŠ¸ë²ˆí˜¸ëŠ” 9411ë²ˆì´ë‹¤.<br><br>
`http://127.0.0.1:9411`ì— ì ‘ì†í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 11 09 24](https://user-images.githubusercontent.com/59405576/195482417-722ea377-feb0-4067-801d-ca30b0b8a245.png)

## Spring Cloud Sleuth
<img width="869" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 11 00 45" src="https://user-images.githubusercontent.com/59405576/195481563-93715420-7603-466a-a784-b7ab01e76140.png">

- ìŠ¤í”„ë§ ë¶€íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ Zipkinê³¼ ì—°ë™ -> ê°€ì§€ê³  ìˆëŠ” ë¡œê·¸ íŒŒì¼ ë°ì´í„° í˜¹ì€ ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° ê°’ì„ Zipkinì— ì „ë‹¬í•˜ëŠ” ì—­í• 
- ìš”ì²­ ê°’ì— ë”°ë¥¸ Trace ID, Span ID ë¶€ì—¬
- Traceì™€ Span Idsë¥¼ ë¡œê·¸ì— ì¶”ê°€ ê¸°ëŠ¥<br>- servlet filter<br>- rest template<br>- scheduled actions<br>- message channels<br>- feign client


# Spring Cloud Sleuth + Zipkin
## `user-service`
### `pom.xml`
```xml
<!-- Zipkin -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-zipkin</artifactId>
    <version>2.2.3.RELEASE</version>
</dependency>
```

### `application.yml`
```yml
spring:
    zipkin:
        base-url: http://127.0.0.1:9411
        enabled: true
    sleuth:
        sampler:
            probability: 1.0
```

### `UserServiceImpl.java`
```java
@Service
@Slf4j
public class UserServiceImpl implements UserService {
    ...
    @Override
    public UserDto getUserByUserId(String userId) {

        UserEntity userEntity = userRepository.findByUserId(userId);
        UserDto userDto = new ModelMapper().map(userEntity, UserDto.class);

        log.info("Before call orders microservice"); // ğŸŒŸ ë¡œê·¸ ìƒì„±
        CircuitBreaker circuitbreaker = circuitBreakerFactory.create("circuitbreaker");
        List<ResponseOrder> orderList = circuitbreaker.run(() -> orderServiceClient.getOrders(userId),
            throwable -> new ArrayList<>());
        log.info("After called orders microservice"); // ğŸŒŸ ë¡œê·¸ ìƒì„±

        userDto.setOrders(orderList);

        return userDto;
    }
}
```

## `order-service`
### `pom.xml`
ì´ì „ì— `user-service`ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ë‘ ê°€ì§€ dependencyë¥¼ ì¶”ê°€í•œë‹¤.

### `application.yml`
ì´ì „ì— `user-service`ì™€ ë§ˆì°¬ê°€ì§€ë¡œ zipkinê³¼ sleuth ì„¤ì • ì •ë³´ë¥¼ ì¶”ê°€í•œë‹¤.

### `OrderController.java`
```java
@RestController
@RequestMapping("/order-service")
@Slf4j
public class OrderController {

    @PostMapping("/{userId}/orders")
    public ResponseEntity<ResponseOrder> createOrder(@PathVariable("userId") String userId, @RequestBody RequestOrder requestOrder) {
        log.info("Before add orders data"); // ğŸŒŸ ë¡œê·¸ ìƒì„±
        ...
        log.info("After added orders data"); // ğŸŒŸ ë¡œê·¸ ìƒì„±
        return ResponseEntity.status(HttpStatus.CREATED).body(responseOrder);
    }

    @GetMapping("/{userId}/orders")
    public ResponseEntity<List<ResponseOrder>> getOrder(@PathVariable("userId") String userId) {
        log.info("Before retrieve orders data"); // ğŸŒŸ ë¡œê·¸ ìƒì„±
        ...
        log.info("After retrieved orders data"); // ğŸŒŸ ë¡œê·¸ ìƒì„±
        return ResponseEntity.status(HttpStatus.OK).body(result);
    }
}
```

## í…ŒìŠ¤íŠ¸
ì´ì œ ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì„œë²„ë¥¼ ê¸°ë™í•˜ì.
- eureka ì„œë²„
- rabbitmq ì„œë²„
- configuration ì„œë²„ (`config-service`)
- gateway ì„œë²„ (`gateway-service`)
- zipkin ì„œë²„
- `user-service`
- `order-service`

ì´ì œ ìƒí’ˆì„ ë‘ ë²ˆ ì£¼ë¬¸í•œ ë’¤, `order-service`ì˜ ì¸í…”ë¦¬ì œì´ ì½˜ì†”ì„ í™•ì¸í•˜ì.<br>
<img width="932" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 11 54 54" src="https://user-images.githubusercontent.com/59405576/195488876-44f90499-ebf6-4bab-a07f-8fccc5867c42.png"><br>
ì´ ë•Œ, ì•ì— ìˆëŠ”ê²Œ `trace id`ì´ê³  ë’¤ì— ìˆëŠ”ê²Œ `order id`ì´ë‹¤.<br>

`trace id`ë¥¼ ë³µì‚¬í•´ ì›¹ ë¸Œë¼ìš°ì €(`http://localhost:9411`)ì—ì„œ í™•ì¸í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 11 49 37](https://user-images.githubusercontent.com/59405576/195487542-bcea77f7-e29a-43eb-8306-99beededa532.png){: width="700" height="700"}<br>
ê·¸ëŸ¼ ìœ„ì™€ ê°™ì€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.<br><br>
ì´ì œ ì‚¬ìš©ì ë‹¨ê±´ ì¡°íšŒë¥¼ í•´ë³´ì.<br>
ìš”ì²­ì„ í•œ ë’¤, `user-service`ì˜ ì¸í…”ë¦¬ì œì´ ì½˜ì†”ì„ í™•ì¸í•˜ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„Œá…¥á†« 11 56 35](https://user-images.githubusercontent.com/59405576/195488880-412dd786-5342-440d-975c-c9a97573291a.png)<br>
ì•„ê¹Œ `order-service`ì—ì„œ í™•ì¸í•œ `trace id`ì™€ `user-service`ì— ì°íŒ `trace id`ê°€ ê°™ìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br>
ê°™ì€ `trace id`ë¥¼ ê°€ì§„ë‹¤ëŠ” ê²ƒì€ ê°™ì€ ìš”ì²­ì´ë¼ëŠ” ì˜ë¯¸ì´ë‹¤.<br><br>
ì´ì œ ì´ ì •ë³´ë¥¼ ì•„ê¹Œì²˜ëŸ¼ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„’á…® 12 02 55](https://user-images.githubusercontent.com/59405576/195489396-173dc985-6e3d-4dde-9b5d-294fd05e23b9.png){: width="700" height="700"}<br>
`user-service`ì—ì„œ get ìš”ì²­ì„ í•œ ë’¤, `order-service`ë¥¼ í˜¸ì¶œí•œ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. (ì‚¬ìš©ì ì£¼ë¬¸ ë‚´ì—­ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´)<br><br>
ì´ë²ˆì—ëŠ” ë‹¤ë¥¸ ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì.<br>
ìƒë‹¨ì— ë³´ì´ëŠ” `Find a trace` ë²„íŠ¼ì„ í´ë¦­ -> `+` ë²„íŠ¼ í´ë¦­ -> `serviceName` íƒ­ì„ í´ë¦­ -> `user-service` ì„ íƒ -> `RUN QUERY`<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„’á…® 12 06 24](https://user-images.githubusercontent.com/59405576/195489839-3248c589-df5c-45f1-a1b4-d5fdfae48591.png)<br>
ì´ëŠ” ìœ ì € ì„œë¹„ìŠ¤ë¥¼ 3ë²ˆì— ê±¸ì³ í˜¸ì¶œë˜ì—ˆê³ , ì˜¤ë” ì„œë¹„ìŠ¤ë¥¼ 1ë²ˆ í˜¸ì¶œë˜ì—ˆë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.<br><br>
ì´ë²ˆì—ëŠ” `Find a trace` ì˜†ì— ìˆëŠ” `Dependencies`ë¥¼ í´ë¦­í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„’á…® 12 09 03](https://user-images.githubusercontent.com/59405576/195490168-2819327f-b39d-4b0a-82ec-8e1ff619980b.png){: width="700" height="700"}<br>
ì´ëŠ” ì—®ì—¬ìˆëŠ” ì„œë¹„ìŠ¤ë“¤ì„ ë‚˜íƒ€ë‚´ë©°, `order-service`ë¥¼ í´ë¦­í•˜ê²Œ ë˜ë©´, ëª‡ ë²ˆì˜ í˜¸ì¶œ ì¤‘ ëª‡ ë²ˆ ì—ëŸ¬ê°€ ë°œìƒí–ˆëŠ”ì§€ ë‚˜íƒ€ë‚œë‹¤.

## ì˜¤ë¥˜ í…ŒìŠ¤íŠ¸
ë§ˆì§€ë§‰ìœ¼ë¡œ, ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œë¥¼ ê°€ì •í•´ë³´ì.

### `order-service`
#### `OrderController.java`
```java
@RestController
@RequestMapping("/order-service")
@Slf4j
public class OrderController {
    ...
    @GetMapping("/{userId}/orders")
    public ResponseEntity<List<ResponseOrder>> getOrder(@PathVariable("userId") String userId) {
        ...
        /* ì˜¤ë¥˜ í…ŒìŠ¤íŠ¸ */
        try {
            Thread.sleep(1000);
            throw new Exception("ì¥ì•  ë°œìƒ");
        } catch(InterruptedException ex) {
            log.warn(ex.getMessage());
        }

        log.info("After retrieved orders data"); // ğŸŒŸ ë¡œê·¸ ìƒì„±
        return ResponseEntity.status(HttpStatus.OK).body(result);
    }
}
```

ì´ì œ `order-service` ì¬ê¸°ë™ í›„ ë‹¤ì‹œ ì£¼ë¬¸ì„ í•´ë³´ì.<br>
ê·¸ë¦¬ê³  ë‹¤ì‹œ ì‚¬ìš©ì ë‹¨ê±´ ì¡°íšŒë¥¼ í•˜ê²Œë˜ë©´, `order-service`ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí–ˆê¸° ë•Œë¬¸ì— ì£¼ë¬¸ ëª©ë¡ì´ ë¹„ì–´ìˆì„ ê²ƒì´ë‹¤.<br><br>
ì´ì œ ì›¹ ë¸Œë¼ìš°ì €ë¥¼ í™•ì¸í•´ë³´ì.<br>
`user-service`ì˜ ì½˜ì†”ì—ì„œ ê°€ì¥ ìµœê·¼ ìš”ì²­(ì‚¬ìš©ì ë‹¨ê±´ì¡°íšŒ)ì˜ `trace id`ë¥¼ ë³µì‚¬í•œ ë’¤ ê²€ìƒ‰í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„’á…® 12 39 07](https://user-images.githubusercontent.com/59405576/195493762-1aa9fc4e-1284-4d2d-8701-6ba6be977877.png)<br>
ê·¸ëŸ¼ ìœ„ ì‚¬ì§„ì²˜ëŸ¼ ë¶‰ì€ ìƒ‰ìœ¼ë¡œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŒì„ ì•Œ ìˆ˜ ìˆê³ , `ORDER-SERVICE`ë¥¼ í´ë¦­í•´ë³´ë©´, ì•„ê¹Œ `OrderContoller`ì— ì •ì˜í•œ "ì¥ì•  ë°œìƒ" ë¬¸êµ¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br><br>
ê·¸ë¦¬ê³  `Find a trace`ì—ì„œ `order-service`ë¥¼ ê²€ìƒ‰í•´ë³´ë©´,<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„’á…® 12 41 05](https://user-images.githubusercontent.com/59405576/195493907-90946b69-ad85-43e1-b2ce-2a28f5dc79fc.png)<br>
ì—­ì‹œ ë¶‰ì€ ìƒ‰ìœ¼ë¡œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.<br><br>
ì´ë²ˆì—” `Dependencies`ì—ì„œ í™•ì¸í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-13 á„‹á…©á„’á…® 12 41 58](https://user-images.githubusercontent.com/59405576/195493994-6905aa46-6d6e-48a7-b12d-d70af5294b65.png)<br>
ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê±´ ìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.






***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}