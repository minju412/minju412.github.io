---
title:  "[E-commerce App] Docker Containerë¥¼ ì´ìš©í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ - 7. Order Microservice "

categories:
  - SpringCloud
tags:
  - [SpringCloud]

toc: true
toc_sticky: true
 
date: 2022-10-18 22:03:59
last_modified_at: 2022-10-18 22:04:02
---

ì´ì „ ê¸€ì— ì´ì–´ì„œ ì§„í–‰í•´ë³´ì.<br>

# Docker Container
## 11. `order-service`
### 1) `application.yml`ì˜ datasource ë³€ê²½
ì´ì „ì— ì‚¬ìš©í•˜ë˜ h2 ë°ì´í„°ë² ì´ìŠ¤ê°€ ì•„ë‹ˆë¼ mysqlì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤.
```yml
spring:
    datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/mydb?serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
    username: root 
    password: 1234 # mysql docker ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œ ì„¤ì •í•œ íŒ¨ìŠ¤ì›Œë“œ
```

ë‚˜ì˜ ê²½ìš°ì—ëŠ” ê¸°ì¡´ì— MariaDBë¥¼ ì“°ë‹¤ê°€ MySQLë¡œ ë³€ê²½í•œ ê²ƒì´ê¸° ë•Œë¬¸ì— MySQL dependencyë„ ì¶”ê°€í–ˆë‹¤.
```xml
<!-- MySQL -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.30</version>
</dependency>
```

### 2) `KafkaProducerConfig.java` ë³€ê²½
`KafkaProducerConfig`ì—ëŠ” `order-service`ì—ì„œ Kafkaë¥¼ ì´ìš©í•´ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ë•Œì˜ ì„¤ì • ì •ë³´ê°€ ë‹´ê²¨ìˆë‹¤.<br><br>
ì´ì „ì— `127.0.0.1`ë¡œ ì§€ì •í•œ kafka brokerì˜ IP Addressë¥¼, <br>
kafka broker ì»¨í…Œì´ë„ˆì˜ IP Addressë¡œ ë³€ê²½í•˜ì.<br><br>
ì•„ë˜ ì»¤ë§¨ë“œë¡œ kafka broker ì»¨í…Œì´ë„ˆì˜ IP Addressë¥¼ í™•ì¸í•˜ì.
```bash
$ docker network inspect ecommerce-network
```
<img width="613" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 10 30 31" src="https://user-images.githubusercontent.com/59405576/196443574-e001501e-4009-402b-90ff-bba37fc8adb8.png"><br>
kafka ì»¨í…Œì´ë„ˆì˜ IP AddressëŠ” `172.18.0.101`ì´ë‹¤.

> ì°¸ê³ <br>
`KafkaProducerConfig.java`ì— ì •í™•í•œ IP Addressë¥¼ ëª…ì‹œí•´ì•¼ í•˜ê¸° ë•Œë¬¸ì—, <br>
ì´ì „ì— kafka ì»¨í…Œì´ë„ˆë¥¼ ê¸°ë™í•  ë•Œì— `docker-compose.yml`ë¥¼ ì´ìš©í•´ IP Addressë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì§€ì •í–ˆì—ˆë‹¤.

ë³€ê²½ ì „<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 10 31 57](https://user-images.githubusercontent.com/59405576/196443950-26d7b6f3-aa6f-4d1c-b09d-bfd03edb446a.png)<br><br>
ë³€ê²½ í›„<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-18 á„‹á…©á„’á…® 10 34 15](https://user-images.githubusercontent.com/59405576/196444525-33837513-81c7-4321-a382-a6236307e803.png)

### 3) `OrderController.java`
ì›ë˜ëŠ” ì£¼ë¬¸ ì •ë³´ë¥¼ `orderDto`ì— ì €ì¥í•˜ê³ , ì €ì¥ëœ ì •ë³´ê°€ ì»¨íŠ¸ë¡¤ëŸ¬ì— ë°˜ì˜ë  ìˆ˜ ìˆë„ë¡ kafkaë¼ëŠ” ë©”ì‹œì§€ íì‰ ì„œë²„ë¥¼ ì´ìš©í–ˆì—ˆë‹¤.
ê·¸ëŸ°ë° ì§€ê¸ˆì€ `orderProducer`ë¶€ë¶„ì€ ì£¼ì„ì²˜ë¦¬ í•˜ê³ , jpaë¥¼ ì´ìš©í•´ ì£¼ë¬¸ ì •ë³´ë¥¼ dbì— ì €ì¥í•  ê²ƒì´ë‹¤.<br><br>
ê·¸ ì´ìœ ëŠ”, ì§€ê¸ˆì€ ì—¬ëŸ¬ ê°œì˜ `order-service`ë¥¼ ê¸°ë™í•˜ì§€ ì•Šì„ ê²ƒì´ê¸° ë•Œë¬¸ì—, ì—¬ëŸ¬ db ì •ë³´ë¥¼ ë‹¨ì¼í™” í•  í•„ìš”ê°€ ì—†ê¸° ë•Œë¬¸ì´ë‹¤.<br>
(ì¶”í›„ì— kafka connectì™€ kafka sink connectë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ jpa ë¶€ë¶„ì„ ì£¼ì„ì²˜ë¦¬í•˜ê³ , ë‚˜ë¨¸ì§€ë¥¼ ì£¼ì„ í•´ì œí•˜ë©´ ëœë‹¤.)
```java
@RestController
@RequestMapping("/order-service")
@Slf4j
public class OrderController {
    ...
    @PostMapping("/{userId}/orders")
    public ResponseEntity<ResponseOrder> createOrder(@PathVariable("userId") String userId, @RequestBody RequestOrder requestOrder) {
        log.info("Before add orders data");
        ModelMapper mapper = new ModelMapper();
        mapper.getConfiguration().setMatchingStrategy(MatchingStrategies.STRICT);

        OrderDto orderDto = mapper.map(requestOrder, OrderDto.class);
        orderDto.setUserId(userId);

        /* jpa */
        OrderDto createdOrder = orderService.createOrder(orderDto);
        ResponseOrder responseOrder = mapper.map(createdOrder, ResponseOrder.class);

        /* kafka */
        // orderDto.setOrderId(UUID.randomUUID().toString());
        // orderDto.setTotalPrice(requestOrder.getQty() * requestOrder.getUnitPrice());

        /* send this order to the kafka */
        kafkaProducer.send("example-catalog-topic", orderDto); // í† í”½ ì´ë¦„ì€ catalog-service ì˜ KafkaConsumer ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
        // orderProducer.send("orders", orderDto);
        
        // ResponseOrder responseOrder = mapper.map(orderDto, ResponseOrder.class);

        log.info("After added orders data");
        return ResponseEntity.status(HttpStatus.CREATED).body(responseOrder);
    }
}
```

### 4) Dockerfileì„ í†µí•´ ì´ë¯¸ì§€ ë§Œë“¤ê¸°
```Dockerfile
FROM openjdk:17-ea-11-jdk-slim

VOLUME /tmp

COPY target/order-service-0.0.1-SNAPSHOT.jar OrderService.jar

ENTRYPOINT ["java","-jar","OrderService.jar"]
```

### 5) ì´ë¯¸ì§€ ë¹Œë“œ ë° ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
```bash
# ìµœì‹  ë²„ì „ìœ¼ë¡œ ì»´íŒŒì¼
$ mvn clean compile package -DskipTests=true
# cleanì€ ê¸°ì¡´ íŒŒì¼ì„ ì§€ìš´ë‹¤.
# package ì˜µì…˜ìœ¼ë¡œ jar íŒŒì¼ê¹Œì§€ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
# í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” skip

# ì´ë¯¸ì§€ íŒŒì¼ ë¹Œë“œ
$ docker build -t ln8847/order-service:1.0  .

# ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸
$ docker images | grep order-service

# ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
$ docker push ln8847/order-service:1.0
```

### 6) ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
ê¸°ì¡´ì˜ `application.yml`ì—ì„œ `127.0.0.1` í˜¹ì€ `localhost`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ë¶€ë¶„ì„ `-e` ì˜µì…˜ì„ í†µí•´ ë„ì»¤ ì»¨í…Œì´ë„ˆì˜ ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ì„œ ì‹¤í–‰í•˜ì.
```bash
$ docker run -d --network ecommerce-network \
-e "spring.zipkin.base-url=http://zipkin:9411" \
-e "eureka.client.serviceUrl.defaultZone=http://service-discovery:8761/eureka/" \
-e "spring.datasource.url=jdbc:mysql://mysql:3306/mydb?serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true" \
-e "logging.file=/api-logs/orders-ws.log" \
--name order-service \
ln8847/order-service:1.0
```
<img width="1421" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-19 á„‹á…©á„Œá…¥á†« 12 36 50" src="https://user-images.githubusercontent.com/59405576/196477158-7af1ad6f-7fec-4c35-a3e4-61b966f2de98.png">

ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ë³´ì.
```bash
$ docker network inspect ecommerce-network
```
<img width="608" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-19 á„‹á…©á„Œá…¥á†« 12 37 34" src="https://user-images.githubusercontent.com/59405576/196477343-3ac0367e-dbf8-420b-acf5-c49bee7785cb.png">

ë¡œê·¸ë¥¼ í™•ì¸í•´ë³´ì.
```bash
$ docker logs order-service
```
<img width="1425" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-19 á„‹á…©á„Œá…¥á†« 12 53 16" src="https://user-images.githubusercontent.com/59405576/196481131-37d2a6bb-c211-4f2c-aa67-cc2e184dca1a.png">

`http://127.0.0.1:8761`ì— ì ‘ì†í•´ order-serviceê°€ ì˜ ë“±ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ì.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-19 á„‹á…©á„Œá…¥á†« 12 41 02](https://user-images.githubusercontent.com/59405576/196478271-14368455-a308-4060-a498-940fde9233f0.png)<br>


> ì°¸ê³ <br>
ì§€ê¸ˆì€ configuration ì„œë²„ì™€ rabbitmqëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì¶”ê°€í•˜ì§€ ì•Šì•˜ì§€ë§Œ, <br>
ë‚˜ì¤‘ì— ì‚¬ìš©í•˜ê²Œ ëœë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ `-e` ì˜µì…˜ì„ ì´ìš©í•´ ì¶”ê°€í•˜ë©´ ëœë‹¤.
```bash
$ docker run -d --network ecommerce-network \
-e "spring.cloud.config.uri=http://config-service:8888" \
-e "spring.rabbitmq.host=rabbitmq" \
-e "spring.zipkin.base-url=http://zipkin:9411" \
-e "eureka.client.serviceUrl.defaultZone=http://service-discovery:8761/eureka/" \
-e "spring.datasource.url=jdbc:mysql://mysql:3306/mydb?serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true" \
-e "logging.file=/api-logs/orders-ws.log" \
--name order-service \
ln8847/order-service:1.0
```














***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}