---
title:  "[Docker] í”„ë¡œì íŠ¸ë¥¼ Dockerize í•˜ê¸°"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-03-17 18:03:00
last_modified_at: 2023-03-17 18:03:03
---

ê¸°ì¡´ì— ìš°ë¶„íˆ¬ ì„œë²„ ìì²´ì—ì„œ ì„¤ì¹˜í–ˆë˜ mysqlì„ ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì´ìš©í•˜ì—¬ ì„¤ì¹˜í•˜ê³  ë°°í¬í•  ì˜ˆì •ì´ë‹¤.<br>
ì´ì „ì— ì •ë¦¬í•´ë†¨ë˜ ê¸€ì„ ì°¸ê³ í•˜ì—¬
1. [Jenkinsë¥¼ í†µí•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ìë™ ë°°í¬](https://minju412.github.io/devlog/21/)
2. [ì  í‚¨ìŠ¤ì™€ ì†Œë‚˜íë¸Œ ì—°ë™í•˜ê¸°](https://minju412.github.io/devlog/32/)
3. [ìŠ¬ë™ìœ¼ë¡œ ì  í‚¨ìŠ¤ ì•Œë¦¼ ë°›ê¸°](https://minju412.github.io/devlog/33/)

ìˆœì„œë¡œ ì§„í–‰í•œë‹¤.

1. ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° EIP ì—°ê²°
2. swap file í• ë‹¹
3. ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ì— Docker Engine & Docker Compose ì„¤ì¹˜
4. ì  í‚¨ìŠ¤ ì„¤ì¹˜ (with. Docker Compose)
5. ì  í‚¨ìŠ¤ì™€ github webhookì„ í†µí•œ ìë™ ë¹Œë“œ & ìë™ ë°°í¬

1~4ë²ˆ ê³¼ì •ì€ ë¬´ë¦¬ì—†ì´ ì§„í–‰í•  ìˆ˜ ìˆì„ ê²ƒì´ê³ ,<br>
5ë²ˆ ê³¼ì •ì—ì„œ ì´ì „ê³¼ ë‹¬ë¼ì§„ ë¶€ë¶„ ìœ„ì£¼ë¡œ ê¸°ë¡í•  ì˜ˆì •ì´ë‹¤.

# 5-1. Jenkins ë¹Œë“œ í•  ë•Œ Parameterì‚¬ìš©í•˜ê¸°
`docker-compose.yml`ì— db íŒ¨ìŠ¤ì›Œë“œì™€ ë‹¤ë¥¸ ë¯¼ê° ì •ë³´ë“¤ì„ `.env` íŒŒì¼ì— ìˆ¨ê¸°ê³ , jenkins ë¹Œë“œí•  ë•Œ ì£¼ì…í•´ì£¼ì!

## 1) Spring Boot í”„ë¡œì íŠ¸ êµ¬ì„±
### docker-compose.yml
```yml
version: '3'
services:
  database:
    container_name: my_mysql
    image: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_HOST=%
    command: ['--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci']
    ports:
      - "${MYSQL_LOCAL_PORT}:${MYSQL_DOCKER_PORT}"
    volumes:
      - ./docker/data:/var/lib/mysql
    restart: always
    networks:
      - test_network

  application:
    container_name: my_app
    build:
      context: ./
      dockerfile: Dockerfile
    ports:
      - "${SPRING_LOCAL_PORT}:${SPRING_DOCKER_PORT}"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://database:${MYSQL_DOCKER_PORT}/${MYSQL_DATABASE}?serverTimezone=UTC&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
    restart: always
    depends_on:
      - database
    networks:
      - test_network

networks:
  test_network:
    driver: bridge
```

### .env íŒŒì¼ ì‘ì„±
```
MYSQL_ROOT_PASSWORD=****
MYSQL_DATABASE=****
MYSQL_USER=****

MYSQL_LOCAL_PORT=****
MYSQL_DOCKER_PORT=****

SPRING_LOCAL_PORT=****
SPRING_DOCKER_PORT=****
```
`.gitignore`ì— ë“±ë¡í•œë‹¤!

## 2) ì  í‚¨ìŠ¤ ì„¤ì •
### íŒŒë¼ë¯¸í„°ì™€ í•¨ê»˜ ë¹Œë“œ
<img width="690" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-20 á„‹á…©á„’á…® 1 40 55" src="https://user-images.githubusercontent.com/59405576/226248563-0ab7aea2-021b-40b6-ac52-63ac690b019c.png">

> ì¤‘ìš”ğŸŒŸ<br>
ë§Œì•½ì— String Parameterì˜ valueì— `/` ê¸°í˜¸ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´,<br>
`/` ê¸°í˜¸ ì•ì—ëŠ” escape ë¬¸ì(`\`)ë¥¼ ë„£ì–´ì£¼ì–´ì•¼ í•œë‹¤!<br><br>
ë§Œì•½ `abc/def` ë¼ëŠ” ê°’ì´ë©´ `abc\/def`ê°€ ë˜ëŠ” ê²ƒì´ê³ ,<br>
ë§Œì•½ `abc//def`ë¼ë©´ `abc\/\/def`ê°€ ë˜ëŠ” ê²ƒì´ë‹¤.

> ìœ„ì—ì„œëŠ” jenkins ëŒ€ì‹œë³´ë“œì—ì„œ ì§ì ‘ í™˜ê²½ë³€ìˆ˜ë¥¼ ë„£ì–´ì¤¬ì§€ë§Œ, <br>
[Jenkins ë¹Œë“œ ì‹œ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë„£ê¸°](https://nato-blog.tistory.com/138)ë„ ê°€ëŠ¥í•˜ë‹¤!

# 5-2. ì„¤ì • íŒŒì¼ ë³µì‚¬í•˜ê¸°
## 1) ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •
### ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì— í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ ëª¨ì•„ë‘˜ ë””ë ‰í† ë¦¬ ìƒì„±
Jenkins ì»¨í…Œì´ë„ˆê°€ ê°€ë™ë˜ê³  ìˆëŠ” ìš°ë¶„íˆ¬ì— ì ‘ì†í•˜ì—¬ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ ìƒì„±í•œë‹¤.<br>
í´ë” êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```
env
â¿ aws-s3.yml
```

<img width="414" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-20 á„‹á…©á„’á…® 2 59 52" src="https://user-images.githubusercontent.com/59405576/226259311-ccaede3e-b9ca-43bb-8b22-dd757be2224a.png">

### í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë‚´ìš© ì‘ì„±
`aws-s3.yml` ì—ëŠ” S3 ì™€ ì—°ê²°í•˜ê¸° ìœ„í•œ ì„¤ì • ì •ë³´ë¥¼ ì ëŠ”ë‹¤.

```yml
cloud:
  aws:
    credentials:
      access-key: ********
      secret-key: ********
    s3:
      bucket: ********
    region:
      static: ********
    stack:
      auto: false
```

### ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ì ‘ì† í›„ í´ë” ìƒì„±
í˜¸ìŠ¤íŠ¸ì— ìƒì„±í•œ `aws-s3.yml` íŒŒì¼ì„ ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬í•  ê²ƒì´ë‹¤.<br>
ë³µì‚¬í•  í´ë”ë¥¼ ìƒì„±í•´ì£¼ì.

```bash
$ docker exec -it jenkins /bin/bash
$ mkdir my-env
```
<img width="434" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-20 á„‹á…©á„’á…® 3 05 51" src="https://user-images.githubusercontent.com/59405576/226260172-f5cc721b-7bd3-42f2-aff5-91c330d4ee10.png">

### í˜¸ìŠ¤íŠ¸ -> ì»¨í…Œì´ë„ˆ íŒŒì¼ ë³µì‚¬
```bash
# docker cp [host íŒŒì¼ê²½ë¡œ] [container name]:[container ë‚´ë¶€ ê²½ë¡œ]
$ docker cp /home/ubuntu/env/aws-s3.yml jenkins:/my-env/aws-s3.yml
```

<img width="654" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-20 á„‹á…©á„’á…® 3 08 05" src="https://user-images.githubusercontent.com/59405576/226260462-33ef5f77-4075-4291-8ab0-784036910bf3.png">


ğŸš¨ ì»¨í…Œì´ë„ˆë¥¼ ì§€ì› ë‹¤ê°€ ë‹¤ì‹œ ìƒì„±í•˜ë©´ `my-env`ê°€ ì‚¬ë¼ì§€ê¸° ë•Œë¬¸ì— íŒŒì¼ ë³µì‚¬ë¥¼ ë‹¤ì‹œ í•´ì£¼ì–´ì•¼ í•¨..<br>
ë‚˜ì¤‘ì— ìŠ¤í¬ë¦½íŠ¸ë¡œ ë§Œë“¤ ìˆ˜ ìˆì„ë“¯

## 2) ì  í‚¨ìŠ¤ ì„¤ì •
### ì  í‚¨ìŠ¤ build Steps ë³€ê²½
ê¸°ì¡´ shell ì—ì„œ `"@@@@@ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì£¼ì… @@@@@"` ë‹¨ê³„ë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤!<br>
(í”„ë¡œì íŠ¸ì— `.gitignore`ì— ë“±ë¡ë˜ì–´ ìˆëŠ” `aws-s3.yml` íŒŒì¼ì„ ì£¼ì…í•˜ê¸° ìœ„í•´ì„œ)

```sh
echo "@@@@@ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì£¼ì… @@@@@"
cp /my-env/aws-s3.yml ./src/main/resources

echo "@@@@@ aws-s3.yml íŒŒì¼ ìœ„ì¹˜ í™•ì¸ @@@@@"
find -name aws-s3.yml

echo "@@@@@ jar íŒŒì¼ ìƒì„± @@@@@"
./gradlew build jar -x test

echo "@@@@@ jar íŒŒì¼ ìœ„ì¹˜ í™•ì¸ @@@@@"
find -name practice-0.0.1-SNAPSHOT.jar

echo "@@@@@ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ @@@@@"
docker-compose build --no-cache

echo "@@@@@ ë„ì»¤ ì»¨í…Œì´ë„ˆ ìƒì„± ë° ì‹¤í–‰ @@@@@"
docker-compose up --force-recreate -d

sleep 5s
docker ps -a
```






***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}