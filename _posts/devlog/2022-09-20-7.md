---
title:  "FCMìœ¼ë¡œ í‘¸ì‹œì•Œë¦¼ êµ¬í˜„í•˜ê¸° "
# excerpt: "sprintfì— ëŒ€í•´ ì•Œì•„ë³´ì"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2022-09-20 16:40:53
last_modified_at: 2022-09-20 16:40:56
---

# 1. firebase ì„¤ì •
## í´ë¼ì´ì–¸íŠ¸
í”„ë¡œì íŠ¸ ìƒì„±ì´ ì™„ë£Œë˜ë©´ í´ë¼ì´ì–¸íŠ¸ í”„ë¡œì íŠ¸ì— ë„£ì–´ì•¼ í•  ì„¤ì •íŒŒì¼ì„ ë°›ì•„ì•¼ í•œë‹¤.<br>
ì‚¬ì§„ì²˜ëŸ¼ ê° í´ë¼ì´ì–¸íŠ¸ì— ë§ëŠ” í”Œë«í¼ì„ ì„ íƒí•œë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-20 á„‹á…©á„’á…® 5 00 38](https://user-images.githubusercontent.com/59405576/191201587-3771fa66-3c02-4915-a592-4501dbe2031f.png)

- í”„ë¡œì íŠ¸ì˜ íŒ¨í‚¤ì§€ ì´ë¦„ì„ ì‘ì„±í•œë‹¤(íŒ¨í‚¤ì§€ ì´ë¦„ì€ build.gradleì˜ applicationId). ë‚˜ë¨¸ì§€ëŠ” ì„ íƒì ìœ¼ë¡œ ì‘ì„±í•˜ë©´ ëœë‹¤.
- google.service.json íŒŒì¼ì„ ë‹¤ìš´ë°›ê³ , ì‚¬ì§„ì˜ ê²½ë¡œì— ë„£ì–´ì¤€ë‹¤.

## ì„œë²„
ìŠ¤í”„ë§ë¶€íŠ¸ í”„ë¡œì íŠ¸ì— ë„£ì–´ì•¼ í•  ì„¤ì •íŒŒì¼ì„ ë°›ì•„ì•¼ í•œë‹¤.<br>
ì‚¬ì§„ì˜ ìˆœì„œëŒ€ë¡œ ì„ íƒ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œì˜ ë°©ë²•ê³¼ ë§ˆì°¬ê°€ì§€ë¼ .jsoníŒŒì¼ì„ ë‹¤ìš´ë°›ìœ¼ë©´ ëœë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-16 á„‹á…©á„’á…® 5 36 07](https://user-images.githubusercontent.com/59405576/190594929-3c433a66-4ab2-4ee6-af20-970ccec85d7e.png){: width="500" height="500"}

# 2. í´ë¼ì´ì–¸íŠ¸ (ì•ˆë“œë¡œì´ë“œ)
## ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
```
dependencies {
    ...
    classpath 'com.google.gms:google-services:4.3.5'
}
```
appë‹¨
```
dependencies {

    ...
    implementation 'com.google.firebase:firebase-messaging:21.1.0'
}
apply plugin: 'com.google.gms.google-services'
```
## Manifests
AndroidManifest.xmlíŒŒì¼ì— ë‹¤ìŒ êµ¬ë¬¸ì„ ì¶”ê°€í•œë‹¤.
```xml
// Internet permission ì¶”ê°€
<uses-permission android:name="android.permission.INTERNET"/>

// serviceì¶”ê°€ ë° intentí•„í„° ì¶”ê°€
<application>
<service android:name=".MyFirebaseMessagingService">
            <intent-filter>
                <action android:name="com.google.firebase.MESSAGING_EVENT"/>
            </intent-filter>
</service>
...
</application>
```
## MyFirebaseMessagingService
MainActivityëŠ” íŠ¹ë³„íˆ ì‘ì„±í•  ì½”ë“œëŠ” ì—†ë‹¤.
```java
// MyFirebaseMessagingService.class
public class MyFirebaseMessagingService extends FirebaseMessagingService {
    @Override
    public void onNewToken(String token){
        Log.d("FCM Log", "Refreshed token: "+token);
    }
}
```
ì´ë ‡ê²Œ í´ë¼ì´ì–¸íŠ¸(ì•ˆë“œë¡œì´ë“œ) ì„¤ì •ì€ ëë‚œë‹¤.

ì—¬ê¸°ê¹Œì§€ ë§ˆë¬´ë¦¬ëœ í›„ ì–´í”Œì„ ì‹¤í–‰í•˜ë©´, ë””ë°”ì´ìŠ¤ í† í°ì´ Logì— ë‚¨ê²¨ì§„ë‹¤.
ì˜ ë³´ê´€í•˜ì. ì´í›„ targetTokenìœ¼ë¡œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚¼ë•Œ ì‚¬ìš©ëœë‹¤.

# 3. ì„œë²„ (ìŠ¤í”„ë§ ë¶€íŠ¸)
ì´ë²ˆì—ëŠ” ì„œë²„ë‹¨ ì‘ì—…ì„ ì‹œì‘í•œë‹¤.<br>
FCM ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³ , ì´ë¥¼ í˜¸ì¶œí•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œë¥¼ ì‘ì„±í•˜ë©´ ëœë‹¤.

## ì„¤ì •íŒŒì¼
ì•„ê¹Œ ìœ„ì—ì„œ Firebase í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ë©´ì„œ ì„œë²„ì— ë„£ì„ ì„¤ì •íŒŒì¼ì„ ë‹¤ìš´ë°›ì•˜ë‹¤.<br>
ê·¸ íŒŒì¼ì„ ì•„ë˜ ì‚¬ì§„ì²˜ëŸ¼ ê²½ë¡œì— ë„£ì–´ì¤€ë‹¤.<br>
ë‚˜ëŠ” ì´ë¦„ì„ ì‚¬ì§„ì²˜ëŸ¼ ìˆ˜ì •í•˜ì˜€ë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-20 á„‹á…©á„’á…® 4 47 49](https://user-images.githubusercontent.com/59405576/191198664-622789b0-848a-440e-86cb-46e437c01d3f.png)

## build.gradle
ë‹¤ìŒê³¼ ê°™ì´ `Firebase sdk`, `okhttp` ì˜ì¡´ì„±ì„ ì¶”ê°€í•œë‹¤.
```
dependencies {
  ...

  // Firebase
    implementation 'com.google.firebase:firebase-admin:6.8.1'
    implementation group: 'com.squareup.okhttp3', name: 'okhttp', version: '4.2.2'
}
```

## êµ¬í˜„
### FecReqDto
```java
@AllArgsConstructor
@Getter
@Setter
public class FcmReqDto {

    private String targetToken;
    private String title;
    private String body;
}
```

### FcmMessage
ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ì„œ DTOì™€ ê°™ì€ ì—­í• ì„ í•˜ëŠ” ë…€ì„ì´ í•„ìš”í•˜ë‹¤.<br>
ì‚¬ì‹¤ Messageì™€ Notificationì€ ë§ì€ ì†ì„±ì„ ê°€ì§€ê³  ìˆì§€ë§Œ, <br>
ì´ë²ˆì—ëŠ” ê°„ë‹¨í•˜ê²Œ title, body ì •ë„ë§Œ ë‹¤ë£° ì˜ˆì •ì´ê¸° ë•Œë¬¸ì— ê°„ë‹¨í•˜ê²Œ ì§ì ‘ ìƒì„±í•˜ì˜€ë‹¤.
```java
@Builder
@AllArgsConstructor
@Getter
public class FcmMessage {
    private boolean validateOnly;
    private Message message;

    @Builder
    @AllArgsConstructor
    @Getter
    public static class Message {
        private Notification notification;
        private String token;
    }

    @Builder
    @AllArgsConstructor
    @Getter
    public static class Notification {
        private String title;
        private String body;
        private String image;
    }
}
```

### FirebaseCloudMessageService
ì´ì œ ì‹¤ì œ ë©”ì„¸ì§€ ìš”ì²­ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì‘ì„±í•œë‹¤.<br>
ì´ 3ê°œì˜ ë©”ì„œë“œë¡œ êµ¬ì„±ë˜ì–´ìˆë‹¤.<br>
- ë©”ì„¸ì§€ ì „ì†¡(`sendMessageTo()`)
- ë©”ì„¸ì§€ ìƒì„±(`makeMessage()`)
- ë©”ì„¸ì§€ ì „ì†¡ì„ ìœ„í•œ ì ‘ê·¼ í† í° ë°œê¸‰(`getAccessToken()`)

`API_URL`ì€ ë©”ì„¸ì§€ ì „ì†¡ì„ ìœ„í•´ ìš”ì²­í•˜ëŠ” ì£¼ì†Œì´ë‹¤.<br>
`https://fcm.googleapis.com/v1/projects/{í”„ë¡œì íŠ¸ ID}/messages:send`<br>
ì—¬ê¸°ì„œ í”„ë¡œì íŠ¸IDëŠ” ë‹¤ìŒ ì‚¬ì§„ì„ ë³´ë©´ ì•Œ ìˆ˜ ìˆë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-09-20 á„‹á…©á„’á…® 4 57 53](https://user-images.githubusercontent.com/59405576/191200965-0d1e54ff-8213-46ca-bf89-d14e3949975c.png)

```java
@Component
@RequiredArgsConstructor
public class FirebaseCloudMessageService {

    @Value("${fcm.api-url}")
    private final String API_URL;
    private final ObjectMapper objectMapper;

    public void sendMessageTo(String targetToken, String title, String body) throws IOException {
        String message = makeMessage(targetToken, title, body);

        OkHttpClient client = new OkHttpClient();
        RequestBody requestBody = RequestBody.create(message,
            MediaType.get("application/json; charset=utf-8"));
        Request request = new Request.Builder()
            .url(API_URL)
            .post(requestBody)
            .addHeader(HttpHeaders.AUTHORIZATION, "Bearer " + getAccessToken())
            .addHeader(HttpHeaders.CONTENT_TYPE, "application/json; UTF-8")
            .build();

        Response response = client.newCall(request).execute();
    }

    private String makeMessage(String targetToken, String title, String body) throws
        JsonParseException, JsonProcessingException {
        FcmMessage fcmMessage = FcmMessage.builder()
            .message(FcmMessage.Message.builder()
                .token(targetToken)
                .notification(FcmMessage.Notification.builder()
                    .title(title)
                    .body(body)
                    .image(null)
                    .build()
                ).build()).validateOnly(false).build();

        return objectMapper.writeValueAsString(fcmMessage);
    }

    private String getAccessToken() throws IOException {
        String firebaseConfigPath = "firebase/firebase-service-key.json";

        GoogleCredentials googleCredentials = GoogleCredentials
            .fromStream(new ClassPathResource(firebaseConfigPath).getInputStream())
            .createScoped(List.of("https://www.googleapis.com/auth/cloud-platform"));

        googleCredentials.refreshIfExpired();
        return googleCredentials.getAccessToken().getTokenValue();
    }
}
```

#### getAccessToken() ë©”ì†Œë“œ
Firebaseë¡œ ë¶€í„°, AccessTokenì„ ê°€ì ¸ì˜¨ ë’¤, ê·¸ê²ƒì„ Headerì— í¬í•¨í•˜ì—¬ Push ì•Œë¦¼ì„ ìš”ì²­í•  ê²ƒì´ë‹¤.<br>
ì´ë¥¼ ìœ„í•´ ìƒì„±í•˜ëŠ” ë©”ì†Œë“œê°€ `getAccessToken()`ì´ë‹¤.<br><br>
GoogleCredentialsëŠ” GoogleApië¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ oauth2ë¥¼ ì´ìš©í•´ ì¸ì¦í•œ ëŒ€ìƒì„ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ì´ë‹¤.<br>
GoogleCredentialsì˜ static ë©”ì†Œë“œì¸ fromStream()ì— ì•ì„œ ë‹¤ìš´ë°›ì€ `firebase-service-key.json`ì˜ inputStreamì„ ë„£ì–´ì£¼ë©´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.<br><br>
ì´ë•Œ, ì¸ì¦í•˜ëŠ” ì„œë²„ì—ì„œ í•„ìš”ë¡œ í•˜ëŠ” ê¶Œí•œì„ ì§€ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.<br>
ì´ëŠ” ë‹¤ì‹œ ë°˜í™˜ ëœ GoogleCredentials ì¸ìŠ¤í„´ìŠ¤ì˜ createScopedë¥¼ í†µí•´ ì„¤ì • ê°€ëŠ¥í•˜ë‹¤.<br><br>
```java
googleCredentials.refreshIfExpired();
return googleCredentials.getAccessToken().getTokenValue();
```
ì´ì œ ëª¨ë“  ì„¤ì •ì„ í†µí•´ ì–»ì–´ë‚¸ GoogleCredentialsì˜ ê°ì²´ë¥¼ í†µí•´ì„œ, FCMì„ ì´ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ë¶€ì—¬ëœ Oauth2ì˜ AccessTokenì„ ë°›ì„ ì°¨ë¡€ì´ë‹¤.<br>
ë¨¼ì € `refreshIfExpired()` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ accessTokenì„ ìƒì„±í•œ ë’¤,<br>
ë‹¤ì‹œ GoogleCredentials ê°ì²´ì˜ `getAccessToken()` ë©”ì†Œë“œë¥¼ ì´ìš©í•´ í† í°ì„ ë°›ì•„ì˜¨ë‹¤.<br>
ê·¸ë¦¬ê³  `getTokenValue()`ë¥¼ ì´ìš©í•´ í† í° ê°’ì„ ìµœì¢…ì ìœ¼ë¡œ ì–»ì–´ì˜¨ë‹¤.<br><br>
ì´ë ‡ê²Œ ì–»ì–´ì˜¨ `AccessToken`ì€, <br>
ì•„ë˜ì—ì„œ RestAPIë¥¼ ì´ìš©í•´ FCMì— Push ìš”ì²­ì„ ë³´ë‚¼ ë•Œ, Headerì— ì„¤ì •í•˜ì—¬ ì¸ì¦ì„ ìœ„í•´ ì‚¬ìš©í•  ê²ƒì´ë‹¤.

#### sendMessageTo() ë©”ì†Œë“œ
ì´ ë©”ì†Œë“œëŠ” ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ë°›ì€ `targetToken`ì— í•´ë‹¹í•˜ëŠ” deviceë¡œ FCM í‘¸ì‹œ ì•Œë¦¼ì„ ì „ì†¡ ìš”ì²­í•œë‹¤.<br>
`targetToken`ì˜ ê²½ìš° FCMì„ ì´ìš©í•´ frontë¥¼ êµ¬í˜„í•  ë•Œ ì–»ì–´ë‚¼ ìˆ˜ ìˆë‹¤.

- Request Body ì¶”ê°€<br>- `OkHttp3`ë¥¼ ì´ìš©í•´ Http Post Requestë¥¼ ìƒì„±í•œë‹¤.<br>- RequestBodyì—ëŠ” ìš°ì„ , ìš°ë¦¬ê°€ ì•ì„œ ìƒì„±í•œ `FcmMessage`ë¥¼ ë¬¸ìì—´ë¡œ ë³€ê²½í•œ ë°ì´í„°ë¥¼ ë„£ì–´ì£¼ë©´ ë˜ëŠ”ë°,<br>ì´ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ëŠ” `makeMessage()` ë©”ì†Œë“œëŠ” ì•„ë˜ì—ì„œ ì‚´í´ë³´ì

- header ì¶”ê°€<br>- headerì— `AccessToken`ì„ ì¶”ê°€í•œë‹¤.<br> - `Authorization`ì„ í‚¤ë¡œ í•˜ëŠ” í—¤ë”ì—, `Bearer <AccessToken>` í˜•íƒœë¡œ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.

#### makeMessage() ë©”ì†Œë“œ
FcmMessageë¥¼ ë§Œë“¤ê³ , ì´ë¥¼ ObjectMapperë¥¼ ì´ìš©í•´ Stringìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜í•œë‹¤.

### Controller
ë©”ì„¸ì§€ ë°œì†¡ ë°©ì‹ì€ ì—„ì²­ ë§ì§€ë§Œ, <br>
ì´ë²ˆì—ëŠ” ë°”ë¡œ í™•ì¸ì´ ê°€ëŠ¥í•˜ë„ë¡ controllerë¡œ ìš”ì²­ì„ ë°›ìœ¼ë©´ ë©”ì„¸ì§€ ìš”ì²­ì„ ìˆ˜í–‰í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œë¥¼ ì‘ì„±í•´ë³´ë ¤ í•œë‹¤.<br>
ê°„ë‹¨í•˜ê²Œ ì´ì „ì— ìƒì„±í•œ ì„œë¹„ìŠ¤ë¥¼ ì£¼ì…ë°›ì•„ í˜¸ì¶œí•˜ë©´ ëì´ë‹¤.<br>
ì¶”ê°€ë¡œ `FcmReqDto`ëŠ” ê°„ë‹¨í•˜ê²Œ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ì˜€ë‹¤.
```java
@RequiredArgsConstructor
@RestController
@RequestMapping
    ("/admin")
@Slf4j
public class AdminController {

    private final FirebaseCloudMessageService firebaseCloudMessageService;

    ...

    @ApiOperation(value = "ì¥ì• ì¸ ì¸ì¦ ìš”ì²­ ìˆ˜ë½", notes = "ì¥ì• ì¸ ì¸ì¦ ìš”ì²­ ìˆ˜ë½")
    @PostMapping("/disabled/approval/{id}")
    public Response grantDisabledReq(@PathVariable("id") long disabledMemberInfoId,
        @RequestBody FcmReqDto fcmReqDto) throws IOException {

        ...

        // í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
        firebaseCloudMessageService.sendMessageTo(
            fcmReqDto.getTargetToken(),
            fcmReqDto.getTitle(),
            fcmReqDto.getBody()
        );

        return new Response("OK", "ì¥ì• ì¸ ì¸ì¦ ìš”ì²­ ìˆ˜ë½ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤");
    }
}
```




# Ref.
- [https://sol-devlog.tistory.com/11](https://sol-devlog.tistory.com/11)
- [https://galid1.tistory.com/740](https://galid1.tistory.com/740)





***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}