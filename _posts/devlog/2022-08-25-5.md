---
title:  "[Naem] QueryDSLì„ ì´ìš©í•´ cursor-based-pagination êµ¬í˜„í•˜ê¸° + conditionì„ ì´ìš©í•œ filtering "
# excerpt: "sprintfì— ëŒ€í•´ ì•Œì•„ë³´ì"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2022-08-25 11:59:51
last_modified_at: 2022-08-25 12:00:01
---
# ê°œìš”
## Cursor-Based vs Offset-Based
paginationì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ ë°©ì‹ì—ëŠ” offset-basedì™€ cursor-basedê°€ ì¡´ì¬í•œë‹¤.
- ì˜¤í”„ì…‹ ê¸°ë°˜ ë°©ì‹<br>- 1ì–µë²ˆ~1ì–µ+10ë²ˆ ë°ì´í„° ì£¼ì„¸ìš”. ë¼ê³  í•œë‹¤ë©´ â†’ 1ì–µ+10ë²ˆê°œì˜ ë°ì´í„°ë¥¼ ì½ìŒ
- ì»¤ì„œ ê¸°ë°˜ ë°©ì‹<br>- ë§ˆì§€ë§‰ìœ¼ë¡œ ì½ì€ ë°ì´í„°(1ì–µë²ˆ)ì˜ ë‹¤ìŒ ë°ì´í„°(1ì–µ+1ë²ˆ) ë¶€í„° 10ê°œì˜ ë°ì´í„° ì£¼ì„¸ìš” â†’ 10ê°œì˜ ë°ì´í„°ë§Œ ì½ìŒ

ì´ ê¸€ì—ì„œëŠ” cursor-based-paginationì„ êµ¬í˜„í•œë‹¤.
## Cursor ê¸°ë°˜ paginationì´ë€?
Cursorë€ ì‚¬ìš©ìì—ê²Œ ì‘ë‹µí•´ì¤€ ë§ˆì§€ë§‰ì˜ ë°ì´í„°ì˜ ì‹ë³„ì ê°’ì´ `cursor`ê°€ ëœë‹¤.<br>
í•´ë‹¹ `cursor`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ nê°œì˜ ë°ì´í„°ë¥¼ ì‘ë‹µí•´ì£¼ëŠ” ë°©ì‹ì´ë‹¤.
- ì²« í˜ì´ì§€ì— ì§„ì…í–ˆì„ ë•Œì˜ ì¿¼ë¦¬ëŠ” ê·¸ëƒ¥ `limit`ìœ¼ë¡œ ì›í•˜ëŠ” ê°œìˆ˜ë§Œí¼ ì§¤ë¼ì„œ ì£¼ë©´ ëœë‹¤.
- ì´í›„ í˜ì´ì§€ì— ëŒ€í•œ ìš”ì²­ì€, ì‚¬ìš©ìì—ê²Œ ì‘ë‹µí•œ ë°ì´í„° ì¤‘ ë§ˆì§€ë§‰ ê²Œì‹œê¸€ì˜ IDê°€ `cursor`ê°€ ëœë‹¤.
- ë°ì´í„° ì¤‘ë³µì´ ë°œìƒí•˜ì§€ë„ ì•Šê³  ë”± í•„ìš”í•œ ë°ì´í„°ë§Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
- `condition`ì„ í†µí•´ í•„í„°ë§ë„ ê°€ëŠ¥í•˜ë‹¤.

ê·¸ëŸ¬ë¯€ë¡œ ì–´ë–¤ í˜ì´ì§€ë¥¼ ì¡°íšŒí•˜ë“  í•­ìƒ ì›í•˜ëŠ” ë°ì´í„° ê°œìˆ˜ë§Œí¼ë§Œ ì½ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ìƒ ì´ì ì´ ì¡´ì¬í•œë‹¤ëŠ” ê²ƒì´ë‹¤.<br>
cursor ê¸°ë°˜ paginationì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ QueryDSLì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤.

# QueryDSL ì„¤ì •
## 1. build.gradle
ì•„ë˜ í‘œì‹œí•œ ë¶€ë¶„ì˜ ì½”ë“œë¥¼ plugins ë¶€ë¶„ì— ì¶”ê°€í•œë‹¤.
```
plugins {
    id 'org.springframework.boot' version '2.4.7'
    id 'io.spring.dependency-management' version '1.0.11.RELEASE'
    id 'java'

    // ğŸŒŸ QueryDSL ì¶”ê°€
    id "com.ewerk.gradle.plugins.querydsl" version "1.0.10"
}
```

ì•„ë˜ í‘œì‹œí•œ ë¶€ë¶„ì˜ ì½”ë“œë¥¼ dependencies ë¶€ë¶„ì— ì¶”ê°€í•œë‹¤.
```
dependencies {
    ...

    // ğŸŒŸ QueryDSL ì¶”ê°€
    implementation 'com.querydsl:querydsl-jpa:5.0.0'
    implementation "com.querydsl:querydsl-apt:5.0.0"
    implementation "com.querydsl:querydsl-core:5.0.0"
}
```

ì•„ë˜ ì½”ë“œëŠ” `build.gradle` íŒŒì¼ ë§¨ ì•„ë˜ì— ë¶™ì—¬ë„£ëŠ”ë‹¤.
```
// ğŸŒŸ QueryDSL ì¶”ê°€ ì‹œì‘
def querydslDir = "$buildDir/generated/querydsl"

querydsl {
    jpa = true
    querydslSourcesDir = querydslDir
}
sourceSets {
    main.java.srcDir querydslDir
}
compileQuerydsl {
    options.annotationProcessorPath = configurations.querydsl
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
    querydsl.extendsFrom compileClasspath
}
// ğŸŒŸ QueryDSL ì¶”ê°€ ë
```

## 2. compileQuerydslë¡œ Q-type ê°ì²´ ìƒì„±
[Gradle > Tasks > other]ì—ì„œ "compileQuerydsl"ì„ ë”ë¸”í´ë¦­í•œë‹¤.<br>
<img width="348" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-25 á„‹á…©á„’á…® 12 27 08" src="https://user-images.githubusercontent.com/59405576/186569118-3af13e15-fe37-4caa-a329-6240266658d9.png"><br>

(ë˜ëŠ” `./gradlew clean compileQuerydsl` ëª…ë ¹ìœ¼ë¡œ ì§ì ‘ ìƒì„±í•œë‹¤.)

### ìƒì„± ì „
<img width="409" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-25 á„‹á…©á„’á…® 12 25 40" src="https://user-images.githubusercontent.com/59405576/186569105-359ccd5e-9609-41f3-a683-3e58ae1fb938.png"><br>

### ìƒì„± í›„
ì•„ë˜ ì‚¬ì§„ì²˜ëŸ¼ Q-type ê°ì²´ê°€ ìƒì„±ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br>
<img width="403" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-25 á„‹á…©á„’á…® 12 34 48" src="https://user-images.githubusercontent.com/59405576/186569127-68d25715-c689-4d15-84fe-089df0d44300.png"><br>

> ì£¼ì˜ ğŸš¨
Q-type ê°ì²´ëŠ” gitì— ë“±ë¡ë˜ë©´ ì•ˆëœë‹¤. .gitignoreì— ë“±ë¡ë˜ì–´ì•¼ í•œë‹¤. ë””í´íŠ¸ë¡œ ë“±ë¡ë˜ì–´ ìˆì„ ê²ƒ!<br>
ì•ì„œ ì„¤ì •ì—ì„œ ìƒì„± ìœ„ì¹˜ë¥¼ gradle build í´ë” ì•„ë˜ ìƒì„±ë˜ë„ë¡ í–ˆê¸° ë•Œë¬¸ì— ì´ ë¶€ë¶„ë„ ìì—°ìŠ¤ëŸ½ê²Œ í•´ê²°ëœë‹¤. (ëŒ€ë¶€ë¶„ gradle build í´ë”ë¥¼ gitì— í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.)

## 3. application.yml ì„¤ì •
```yml
spring:
  data:
    web:
      pageable:
        default-page-size: 20 # í˜ì´ì§• í•  ë•Œ ê¸°ë³¸ê°’, 20ê°œì”© ì¡°íšŒ
```

# ì½”ë“œ ì‘ì„±
## 1. QuerydslConfiguration ì½”ë“œ ì‘ì„±
`config/QuerydslConfiguration.java`
```java
@Configuration
public class QuerydslConfiguration {

    @PersistenceContext
    private EntityManager entityManager;

    @Bean
    public JPAQueryFactory jpaQueryFactory() {
        return new JPAQueryFactory(entityManager);
    }
}
```

## 2. CustomPostRepository ì¸í„°í˜ì´ìŠ¤ ì •ì˜
`repository/CustomPostRepository.java`
```java
public interface CustomPostRepository {
    Slice<BriefPostInfoDto> getBriefPostInfoScroll(Long cursorId, PostReadCondition condition, Pageable pageable);
}
```
ì¡°íšŒí•  ë•Œ, where ì ˆì— í•„í„°ë§ì„ ë„£ê¸° ìœ„í•´ `PostReadCondition`ì„ ì¶”ê°€í–ˆë‹¤. (`BriefPostInfoDto`ì™€ `PostReadCondition`ì€ ë’¤ì—ì„œ ë‹¤ë£¬ë‹¤.)

## 3. Custom ì¸í„°í˜ì´ìŠ¤ ìƒì†
`repository/PostRepository.java`
```java
public interface PostRepository extends JpaRepository<Post, Long>, CustomPostRepository {
}
```

## 4. CustomPostRepositoryImpl í´ë˜ìŠ¤ êµ¬í˜„
`repository/CustomPostRepositoryImpl.java`
```java
import static naem.server.domain.post.QPost.*; // Q-type ê°ì²´ import
...

@Repository
@RequiredArgsConstructor
public class CustomPostRepositoryImpl implements CustomPostRepository {

    private final JPAQueryFactory queryFactory;

    @Override
    public Slice<BriefPostInfoDto> getBriefPostInfoScroll(Long cursorId, PostReadCondition condition,
        Pageable pageable) {

        List<Post> postList = queryFactory
            .select(post)
            .from(post)
            .where(
                eqIsDeleted(condition.getIsDeleted()), // ì‚­ì œë˜ì§€ ì•Šì€ ê²Œì‹œê¸€ë§Œ ì¡°íšŒ
                eqTitle(condition.getKeyword()),
                eqContent(condition.getKeyword()),
                eqCursorId(cursorId)
            )
            .limit(pageable.getPageSize() + 1) // limit ë³´ë‹¤ ë°ì´í„°ë¥¼ 1ê°œ ë” ë“¤ê³ ì™€ì„œ, í•´ë‹¹ ë°ì´í„°ê°€ ìˆë‹¤ë©´ hasNext ë³€ìˆ˜ì— true ë¥¼ ë„£ì–´ ì•Œë¦¼
            .fetch();

        List<BriefPostInfoDto> briefPostInfos = new ArrayList<>();
        for (Post post : postList) {
            briefPostInfos.add(new BriefPostInfoDto(post));
        }

        boolean hasNext = false;
        if (briefPostInfos.size() > pageable.getPageSize()) {
            briefPostInfos.remove(pageable.getPageSize());
            hasNext = true;
        }
        return new SliceImpl<>(briefPostInfos, pageable, hasNext);
    }

    /*
    * ë™ì  ì¿¼ë¦¬ë¥¼ ìœ„í•œ BooleanExpression
    */
    private BooleanExpression eqCursorId(Long cursorId) {
        return (cursorId == null) ? null : post.id.gt(cursorId);
    }

    // ì‚­ì œëœ ê²Œì‹œê¸€ì¸ì§€ í•„í„°ë§
    private BooleanExpression eqIsDeleted(Boolean isDeleted) {
        return (isDeleted == null) ? null : post.isDeleted.eq(isDeleted);
    }

    // ì œëª©ì— keyword í¬í•¨ë˜ì–´ìˆëŠ”ì§€ í•„í„°ë§
    private BooleanExpression eqTitle(String keyword) {
        return (keyword == null) ? null : post.title.contains(keyword);
    }

    // ë‚´ìš©ì— keyword í¬í•¨ë˜ì–´ìˆëŠ”ì§€ í•„í„°ë§
    private BooleanExpression eqContent(String keyword) {
        return (keyword == null) ? null : post.content.contains(keyword);
    }
}
```

## 5. Dto ì‘ì„±
### 1) BriefPostReadDto í´ë˜ìŠ¤
`domain/post/dto/BriefPostReadDto.java`
```java
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class BriefPostInfoDto {

    private Long postId;
    private String title;
    private String content;
    private String writerName;
    private String createdDate;

    public BriefPostInfoDto(Post post) {
        this.postId = post.getId();
        this.title = post.getTitle();
        this.content = post.getContent();
        this.writerName = post.getMember().getNickname();
        this.createdDate = post.getCreateAt().toString();
    }
}
```
ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹œ ë‚˜íƒ€ë‚¼ ê°„ë‹¨í•œ ê²Œì‹œê¸€ ì •ë³´ë¡œ <br>
ê²Œì‹œê¸€ ì œëª©, ë‚´ìš©, ì‘ì„±ì, ìƒì„±ì¼ìë¡œ êµ¬ì„±í•´ë³´ì•˜ë‹¤.

### 2) PostReadCondition í´ë˜ìŠ¤
`domain/post/dto/PostReadCondition.java`
```java
@Data
public class PostReadCondition {

    private String keyword; // ê²€ìƒ‰ í‚¤ì›Œë“œ
    private Boolean isDeleted;

    public PostReadCondition() {
        this.isDeleted = false;
    }

    public PostReadCondition(String keyword) {
        this.keyword = keyword;
        this.isDeleted = false;
    }
}
```
`PostReadCondition`ì€ í•„í„°ë§í•˜ê¸° ìœ„í•´ ì‘ì„±í•œ í´ë˜ìŠ¤ì´ë‹¤.<br>
ë‚˜ëŠ” ê²Œì‹œê¸€ ì‚­ì œ ê¸°ëŠ¥ì„ soft delete ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆê¸° ë•Œë¬¸ì—, ì¡°íšŒë¥¼ í•  ë•Œ `isDelete`ê°€ `false`ì¸ ê²Œì‹œê¸€ë§Œ ì¡°íšŒí•œë‹¤.<br>
ë§Œì•½ ê²€ìƒ‰ì–´(`keyword`)ê°€ ìˆë‹¤ë©´ ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ ê²Œì‹œê¸€ë“¤ë§Œ ì¡°íšŒí•œë‹¤.

## 6. PostService ì¸í„°í˜ì´ìŠ¤
`service/PostService.java`
```java
public interface PostService {
    Slice<BriefPostInfoDto> getPostList(Long cursor, PostReadCondition condition, Pageable pageRequest);
}
```

## 7. PostServiceImpl í´ë˜ìŠ¤ êµ¬í˜„
`service/PostServiceImpl.java`
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class PostServiceImpl implements PostService {

    private final PostRepository postRepository;

    ...

    @Override
    @Transactional
    public Slice<BriefPostInfoDto> getPostList(Long cursor, PostReadCondition condition, Pageable pageRequest) {
        return postRepository.getBriefPostInfoScroll(cursor, condition, pageRequest);
    }
}
```

## 8. BoardController
`web/BoardController.java`
```java
@RequiredArgsConstructor
@RestController
@RequestMapping
    ("/board")
@Slf4j
public class BoardController {

    private final PostService postService;

    ...

    @ApiOperation(value = "ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (ë¬´í•œ ìŠ¤í¬ë¡¤)", notes = "ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (ë¬´í•œ ìŠ¤í¬ë¡¤)")
    @GetMapping("/list")
    public Slice<BriefPostInfoDto> list(Long cursor, String keyword, @PageableDefault(size = 5, sort = "createAt") Pageable pageRequest) {

        if (StringUtils.hasText(keyword)) {
            return postService.getPostList(cursor, new PostReadCondition(keyword), pageRequest); // keywordê°€ í¬í•¨ëœ ê²Œì‹œê¸€ ì¡°íšŒ
        }
        return postService.getPostList(cursor, new PostReadCondition(), pageRequest); // ì‚­ì œë˜ì§€ ì•Šì€ ëª¨ë“  ê²Œì‹œê¸€ ì¡°íšŒ
    }
}
```

# í¬ìŠ¤íŠ¸ë§¨ í…ŒìŠ¤íŠ¸






# Ref.
- [QueryDSLì´ë€? ì„¤ì •ë°©ë²•](https://velog.io/@mooh2jj/QueryDSL%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0) - compileQuerydslë¡œ Qê°ì²´ ìƒì„±
- [[Spring] querydslë¡œ ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„í•´ë³´ê¸°](https://velog.io/@ohjinseo/Spring-querydsl-%EC%BB%A4%EC%84%9C-%EA%B8%B0%EB%B0%98-%ED%8E%98%EC%9D%B4%EC%A7%80%EB%84%A4%EC%9D%B4%EC%85%98-%EA%B5%AC%ED%98%84%ED%95%B4%EB%B3%B4%EA%B8%B0)
- [Cursor based Pagination(ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜)ì´ë€? - Querydslë¡œ ë¬´í•œìŠ¤í¬ë¡¤ êµ¬í˜„í•˜ê¸°](https://velog.io/@znftm97/%EC%BB%A4%EC%84%9C-%EA%B8%B0%EB%B0%98-%ED%8E%98%EC%9D%B4%EC%A7%80%EB%84%A4%EC%9D%B4%EC%85%98Cursor-based-Pagination%EC%9D%B4%EB%9E%80-Querydsl%EB%A1%9C-%EA%B5%AC%ED%98%84%EA%B9%8C%EC%A7%80-so3v8mi2#span-stylecolor0b6e996-cursor-%EB%8D%B0%EC%9D%B4%ED%84%B0%EA%B0%80-%EC%9C%A0%EB%8B%88%ED%81%AC%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%80-%EA%B2%BD%EC%9A%B0---%ED%95%B4%EA%B2%B0span)


***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}