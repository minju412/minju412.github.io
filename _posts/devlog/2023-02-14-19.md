---
title:  "[AWS] Docker Compose + Jenkins + Sonarqube "

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-02-14 17:32:36
last_modified_at: 2023-02-14 17:32:39
---

# 1. Ubuntu에 Docker Engine 설치
> [공식 사이트](https://docs.docker.com/engine/install/ubuntu/)를 참고했다.

## Repository 설정
```bash
# apt-get 업데이트
$ sudo apt-get update

$ sudo apt-get install \
ca-certificates \
curl \
gnupg \
lsb-release

$ sudo mkdir -p /etc/apt/keyrings

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

$ echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

## Docker Engine 설치 및 실행
```bash
$ sudo apt-get update

# 설치
$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 도커 실행
$ sudo service docker start

# 상태 확인
$ sudo service docker status
```

## 권한 설정
linux에서 root 권한이 아닌 상태로 docker를 실행하면 권한 문제가 발생할 수 있다.
```
[linux@localhost ]$ docker ps
Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.40/containers/json: dial unix /var/run/docker.sock: connect: permi
ssion denied
```
이런 경우 매번 sudo로 커맨드를 실행해도 되지만, 번거롭기 때문에 docker group에 해당 유저를 추가해주면 해결할 수 있다.<br>
```bash
# 보통은 docker group이 생겼을테지만, 만약 없으면 생성해준다.
$ sudo groupadd docker

# docker group에 해당 유저를 추가
$ sudo usermod -aG docker $USER

# 로그아웃 후 다시 로그인하거나 다음 명령어를 실행시켜야 적용이 된다.
$ newgrp docker
```


# 2. 도커 컴포즈 설치

```bash
$ sudo apt  install docker-compose
$ docker-compose --version
```


# 3. 젠킨스 설치 (with.Docker Compose)
> [이 글](https://mrgamza.tistory.com/801)과 [이 글](https://hsik0225.github.io/jenkins/docker/2022/03/03/Jenkins-Docker%EB%A1%9C-Jenkins-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0/)을 참고했다.


## 1) 폴더 만들기
우분투 인스턴스에 접속해서 진행한다.<br>
docker 폴더 생성 후 그 안에 jenkins 폴더를 만들고, 그 안에 home 폴더까지 만들어주자.
```
docker
⎿ jenkins
 ⎿ home
```

이제 `home` 디렉터리에 권한을 부여해야 한다.
```bash
$ chmod -R 777 home
```

> 🚨 주의<br>
권한을 부여하지 않으면 아래 에러가 발생한다...
```
touch: cannot touch '/var/jenkins_home/copy_reference_file.log': Permission denied
Can not write to /var/jenkins_home/copy_reference_file.log. Wrong volume permissions?
```


## 2) `docker-compose.yml` 생성
jenkins 폴더 안에 `docker-compose.yml`을 생성할 것이다.<br>
이제 폴더 구조는 아래처럼 된다.
```
docker
⎿ jenkins
 ⎿ home
 ⎿ docker-compose.yml
```

`docker-compose.yml` 내용은 아래처럼 작성한다.
```yml
version: '3'
services:
  jenkins:
    container_name: 'jenkins'
    image: 'jenkins/jenkins:lts'
    restart: always
    ports:
      - 9090:8080
      - 50000:50000
    volumes:
      - /home/ubuntu/docker/jenkins/home:/var/jenkins_home
    environment:
      TZ: "Asiz/Seoul"
```

> 만약 Jenkins의 포트를 9090이 아닌 다른 포트를 쓰고 싶다면 "앞"의 포트를 9090이 아닌 다른 포트로 바꾼다. <br>
뒤의 포트까지 바꾸면 Jenkins에 접속할 수 없다. 왜냐하면 Jenkins 내부에서 포트를 8080과 50000만 열어두었기 때문이다.<br>
즉, `9090:8080`은 접속할 수 있지만 `9090:9090`은 접속할 수 없다.



## 3) 젠킨스 컨테이너 실행
jenkins 폴더 안에서 진행한다.
```bash
$ docker-compose up -d

# 만야 에러가 발생한다면 로그를 확인해보자
$ docker logs jenkins # 맨 마지막은 컨테이너 이름!
```

<img width="822" alt="스크린샷 2023-02-15 오후 2 42 53" src="https://user-images.githubusercontent.com/59405576/218943027-3fc3e597-f03f-4dec-b214-7389042f0edc.png"><br>

최종적으로 폴더 구조는 아래처럼 된다! (`jenkins` 폴더는 생성한적 없는데 자동으로 생겼다..) <br>
<img width="481" alt="스크린샷 2023-02-15 오후 2 43 30" src="https://user-images.githubusercontent.com/59405576/218943036-08f01e04-cbd3-41ef-a368-2ad0c9fd338a.png">

# 4. 젠킨스 설정 및 배포

## 1) 젠킨스 접속 및 설정
> [이 글](https://hsik0225.github.io/jenkins/docker/2022/03/03/Jenkins-Docker%EB%A1%9C-Jenkins-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0/)을 참고했다.

젠킨스 컨테이너를 실행한 후, `인스턴스의 public ip:9090`로 접속하면 다음과 같은 페이지가 나온다.

### 패스워드 입력
![스크린샷 2022-10-04 오후 11 43 59](https://user-images.githubusercontent.com/59405576/193850463-dde67826-8368-429d-81fd-bbfdde242bef.png){: width="500" height="500"}<br>
ec2 인스턴스에서 위 사진에 보이는 경로로 이동해 비밀번호를 확인한다.<br>
permission denied가 뜬다면 sudo를 붙이자!
```bash
$ cat /var/lib/jenkins/secrets/initialAdminPassword
```
<img width="588" alt="스크린샷 2022-10-04 오후 11 46 37" src="https://user-images.githubusercontent.com/59405576/193850996-783fc139-8c3c-4e1a-8cc4-3eaae082286a.png"><br>

위의 비밀번호를 접속한 인터넷 창의 Administrator password 에 입력합니다.<br>
비밀번호를 제대로 입력했다면 다음과 같은 어드민 설정페이지가 나옵니다.<br>
앞으로 사용되는 아이디와 비밀번호이므로 설정하시고 잊지 말아주세요.



### 플러그인 설치 화면
패스워드를 입력 후 아래와 같이 플러그인 설치화면이 나오는데 특별히 설치할 플러그인이 필요없다면 `install suggested plugins`를 선택한다.<br>
![스크린샷 2022-10-04 오후 11 48 09](https://user-images.githubusercontent.com/59405576/193851421-0bd60061-605b-41ad-bf58-cfc9478f317a.png){: width="500" height="500"}<br><br>
그럼 아래처럼 Getting Started 페이지가 나올 것이다. 잠시 기다리자.<br>
![스크린샷 2022-10-04 오후 11 48 52](https://user-images.githubusercontent.com/59405576/193851543-a33f7b7d-7888-4bdb-a74f-86bc0f1e9d4e.png){: width="500" height="500"}

### Admin 계정 생성
기다리면 이렇게 Admin 사용자를 생성하는 페이지가 나오는데, Admin 사용자를 생성하고 다음 화면을 누르면 Jenkins 화면이 보이는 것을 확인할 수 있다.<br>


### Instance Configuration
마지막으로 젠킨스의 TCP 포트를 앞으로도 계속 같은 포트를 쓸 것인지 물어본다.<br>


이제 설정이 끝났다. Start using Jenkins를 누르자.<br>
![스크린샷 2022-10-04 오후 8 51 42](https://user-images.githubusercontent.com/59405576/193812599-6d380d79-123e-4fcb-ad30-043c55eec549.png)<br>
그럼 아래와 같은 대시보드가 나온다.<br>
![스크린샷 2022-10-04 오후 8 52 56](https://user-images.githubusercontent.com/59405576/193812824-f32c2a1f-17e8-4b67-a223-3d50c82c80ed.png){: width="500" height="500"}


## 2) 젠킨스를 이용한 자동 배포
> [이 글](https://learnote-dev.com/java/Spring-%EC%A0%A0%ED%82%A8%EC%8A%A4-%EB%B0%B0%ED%8F%AC/#%EC%A0%A0%ED%82%A8%EC%8A%A4-%EB%B9%8C%EB%93%9C-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0)을 참고했다.

### 젠킨스 빌드 설정하기

### ssh 키 발급


### 깃 deploy key 등록


### jenkins credentials 추가


### sudoers 변경

### 깃 web hook 설정


# 5. 소나큐브 설치 (with.Docker Compose)

```yml


```

# 6. 젠킨스와 소나큐브 연동
































***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}