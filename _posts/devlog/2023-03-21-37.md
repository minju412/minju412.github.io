---
title:  "[Mockito] Mock ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± + Spring Rest Docs ì ìš©"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-03-21 17:28:43
last_modified_at: 2023-03-21 17:28:45
---
> âš ï¸ ì´ ê¸€ì€ Spring Rest Docs ì ìš© í›„ì— í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë°©ë²• ìœ„ì£¼ë¡œ ì„¤ëª…í•  ì˜ˆì •ì´ë‹¤. <br>
ì•„ì§ Spring Rest Docsê°€ ì ìš©ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´, [ì´ ê¸€](https://minju412.github.io/devlog/26/)ì„ ì°¸ê³ í•˜ì.

# ê°œìš”
## Mockitoë€?
í…ŒìŠ¤íŠ¸ë¥¼ í¸í•˜ê²Œ í•˜ë„ë¡ ëª¨ì˜ ê°ì²´(Mock)ë¥¼ ë§Œë“œëŠ” Mocking í”„ë ˆì„ì›Œí¬ì…ë‹ˆë‹¤.

## Mockì´ë€?
ëª¨ì˜ ê°ì²´(Mock)ëŠ” ì‹¤ì œ êµ¬í˜„ì²´ê°€ ì—†ê³ , ê»ë°ê¸°(ì¸í„°í˜ì´ìŠ¤, ë©”ì„œë“œ, í•„ë“œ)ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆëŠ” ê°ì²´ì…ë‹ˆë‹¤.<br>
ì™¸ë¶€ ê°ì²´ë¥¼ Mock í•¨ìœ¼ë¡œì¨ í…ŒìŠ¤íŠ¸í•  ê°ì²´ë¥¼ ì™¸ë¶€ ê°ì²´ì˜ ì‹¤ì œ êµ¬í˜„ ë‚´ìš©ê³¼ ë¶„ë¦¬í•´ì„œ ìƒê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# Mockito ì‚¬ìš©ë²•

## Mock ê°ì²´ ìƒì„±
### Service Test
```java
@ExtendWith(MockitoExtension.class)
class DiaryServiceTest {

    @Mock
    UserRepository userRepository;

    @InjectMocks
    DiaryServiceImpl diaryService;

    ...
}
```

### Controller Test
```java
@ExtendWith(RestDocumentationExtension.class)
@WebMvcTest(DiaryController.class)
@ActiveProfiles("test")
@MockBean(JpaMetamodelMappingContext.class)
class DiaryControllerTest {

    @MockBean // ì„œë¹„ìŠ¤ ì£¼ì… (í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ Mock ì²˜ë¦¬í•˜ê³  ìŠ¤í”„ë§ì—ì„œ beanìœ¼ë¡œ ë“±ë¡í•˜ì—¬ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì„ ì–¸)
    private DiaryService diaryService;

    @Autowired
    private MockMvc mockMvc;

    @BeforeEach
    public void setup(WebApplicationContext webApplicationContext, RestDocumentationContextProvider restDocumentation) {
        this.mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext)
//                .apply(springSecurity())    // springSecurityì„¤ì •ì´ ë˜ì–´ìˆì§€ ì•Šìœ¼ë©´ ìƒëµ
                .apply(documentationConfiguration(restDocumentation))
                .apply(sharedHttpSession())
                .build();
    }

    ...
}
```

> âš ï¸ JUnit5ì˜ ê²½ìš°Â `@AutoConfigureRestDocs` ì„¤ì •ì´ ì•ˆ ë¨¹íŒë‹¤..!!

## í…ŒìŠ¤íŠ¸ ì‘ì„±ë²•
> [ì´ ê¸€](https://greedy0110.tistory.com/57)ì„ ì°¸ê³ í–ˆë‹¤.

### Stub
#### `when().thenReturn()`
```java
when(userRepository.findByUsername("test")).thenReturn(Optional.of(user));
```
`thenReturn()`ìœ¼ë¡œ ë‹¨ìˆœí•œ ê°’ì„ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.

#### `when().thenThrow()`
```java
when(contestService.modify(anyLong(), any())).thenThrow(new AlreadyContestEndException());
```
`thenThrow()`ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§€ì.

#### `when().thenAnswer()`
```java
when(contestService.modify(anyLong(), any())).thenAnswer(invocation -> {
    doSomething();
    return Optional.of(user);
});
```
`thenAnswer()`ë¡œ ìœ ì—°í•˜ê²Œ Stub í•  ìˆ˜ ìˆë‹¤.

### ê²€ì¦í•˜ê¸°
verifyí•¨ìˆ˜ëŠ” ì¸ìë¡œ Mockê°ì²´ë¥¼ ë°›ìŠµë‹ˆë‹¤.<br>
ê·¸ë¦¬ê³  í•´ë‹¹ Mock ê°ì²´ì˜ ì›í•˜ëŠ” ìƒí˜¸ì‘ìš©ì´ ìˆì—ˆëŠ”ê°€ ê²€ì¦í•©ë‹ˆë‹¤. <br>
ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€, í•„ë“œë¥¼ ì°¸ì¡°í–ˆëŠ”ì§€ê°€ ì´ì— í•´ë‹¹í•©ë‹ˆë‹¤.

#### `verify(..., times())`
```java
verify(userRepository, times(2)).findByUsername("test");
```
í•¨ìˆ˜ê°€ ë‘ ë²ˆ í˜¸ì¶œë˜ì—ˆëŠ”ê°€ë¥¼ ê²€ì¦í•œë‹¤. ë‘ ë²ˆ í˜¸ì¶œí–ˆìœ¼ë©´ í†µê³¼í•œë‹¤.


#### `verify(..., never())`
```java
verify(userRepository, never()).findByUsername("test");
```
í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì§€ ì•ŠìŒì„ ê²€ì¦í•œë‹¤. í˜¸ì¶œë˜ì§€ ì•Šì•˜ìœ¼ë©´ í†µê³¼í•œë‹¤.

#### `verify(..., atLeast())`
```java
verify(userRepository, atLeast(3)).findByUsername("test");
```
í•¨ìˆ˜ê°€ ì ì–´ë„ në²ˆ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ ê²€ì‚¬í•œë‹¤. ë§Œì•½ 3ë²ˆë³´ë‹¤ ì ê²Œ í˜¸ì¶œí–ˆë‹¤ë©´ ì´ ê²€ì¦ì€ ì‹¤íŒ¨í•œë‹¤.

#### `verify(..., atMost())`
```java
verify(userRepository, atMost(3)).findByUsername("test");
```
í•¨ìˆ˜ê°€ ìµœëŒ€ në²ˆ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ ê²€ì‚¬í•œë‹¤. ë§Œì•½ 3ë²ˆë³´ë‹¤ ë§ì´ í˜¸ì¶œí–ˆë‹¤ë©´ ì´ ê²€ì¦ì€ ì‹¤íŒ¨í•œë‹¤.

#### `verify(..., only())`
```java
verify(userRepository, only()).findByUsername("test");
```
ì˜¤ì§ "í•œ ë²ˆ", `findByUsername()`ë§Œ í˜¸ì¶œí–ˆëŠ”ì§€ ê²€ì¦í•œë‹¤.<br>
ë§Œì•½, `userRepository`ê°€ `findById`ë¼ëŠ” ë‹¤ë¥¸ í•¨ìˆ˜ì™€ë„ ìƒí˜¸ì‘ìš©ì„ í–ˆë‹¤ë©´ ì´ ê²€ì¦ì€ ì‹¤íŒ¨í•œë‹¤.

### ì—¬ëŸ¬ê°€ì§€ Function ì‚¬ìš©í•´ë³´ê¸°
- í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•´ì•¼ ìŠ¤ë‹ˆí«ì´ ìƒì„±ëœë‹¤.
- `@MockBean`ìœ¼ë¡œ ì£¼ì…ëœ ì„œë¹„ìŠ¤ì— ëŒ€í•´ ì ì ˆí•œ ì²˜ë¦¬ë¥¼ í•´ì¤€ë‹¤.. -> `given().willReturn()`
- ìš”ì²­, ì‘ë‹µì— ëŒ€í•œ ë¬¸ì„œì— ì í ì„¤ëª…ë“¤ì„ ì‘ì„±
  - `requestParameters`ëŠ” queryStringìœ¼ë¡œ ìš”ì²­í•˜ëŠ” ê°’ì— ëŒ€í•´..
  - `responseFields`ëŠ” ì‘ë‹µ ê°’ì— ëŒ€í•´.. í˜•ì‹ì— ë§ê²Œ ì ì–´ì£¼ëŠ” ê²ƒì´ ì¤‘ìš” -> ê³µì‹ë¬¸ì„œ ì°¸ê³ 
  - `optional()`ì„ ë¶™ì—¬ì£¼ë©´ í•„ìˆ˜ ê°’ì´ ì•„ë‹ˆë¼ëŠ” ëœ» ë¶™ì´ì§€ ì•Šìœ¼ë©´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•˜ë‹ˆ ì£¼ì˜

```java
@Test
// @WithMockUser(...) // springSecurity ì„¤ì • ì—†ìœ¼ë©´ ìƒëµ
void getImages() throws Exception {

    List<HashMap<String, Object>> response = new ArrayList<>();
    HashMap<String, Object> data = new HashMap<>();
    data.put("name", "foo");
    data.put("img_url", "https://~~~");
    data.put("reg_date", "2021-06-03 10:00:00");
    response.add(data);

    given(imageService.findAllById(any(ParamDto.class))).willReturn(response);

    ResultActions perform = this.mockMvc.perform(
            RestDocumentationRequestBuilders.get("/images")
    );

    perform.andExpect(status().isOk())
            .andDo(print())
            .andDo(document("images-get",    // ì„¤ì •í•œ ê°’ìœ¼ë¡œ ìŠ¤ë‹ˆí« í´ë”ê°€ ìƒì„±ë¨
                requestParameters(
                    parameterWithName("user").description("ìœ ì € ì´ë¦„").optional()
                ),
                responseFields(
                    fieldWithPath("imgList").description("ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸"),
                    fieldWithPath("imgList[].name").description("ì´ë¯¸ì§€ ë“±ë¡ íšŒì› ì´ë¦„"),
                    fieldWithPath("imgList[].img_url").description("ì´ë¯¸ì§€ url"),
                    fieldWithPath("imgList[].reg_date").description("ì´ë¯¸ì§€ ë“±ë¡ì¼ì‹œ")
                })
            );

}
```

> ğŸ¤” `given().willReturn()`ê³¼ `when().thenReturn()`ì˜ ì°¨ì´ê°€ ê¶ê¸ˆí•˜ë‹¤ë©´ [ì´ ê¸€](https://velog.io/@lxxjn0/Mockito%EC%99%80-BDDMockito%EB%8A%94-%EB%AD%90%EA%B0%80-%EB%8B%A4%EB%A5%BC%EA%B9%8C)ì„ ì°¸ê³ í•˜ì.

#### fieldWithPath
- APIì˜ Request, Response Snippetì„ êµ¬ì„±í•˜ëŠ” ìš”ì†Œë¥¼ ì •ì˜í•˜ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ functionì…ë‹ˆë‹¤.
- `fieldWithPath(â€œkeyâ€)` í˜•íƒœë¡œ API Request, Response ë‚´ì˜ ìš”ì†Œë¥¼ ì •ì˜ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- Attributes
  - `description(â€œë‚´ìš©â€)` : Request, Response ë‚´ì˜ ìš”ì†Œì˜ ë‚´ìš©ì„ ì •ì˜í•©ë‹ˆë‹¤.
  - `type(JsonFieldType.TYPE)` : Request, Response ë‚´ì˜ ìš”ì†Œì˜ íƒ€ì…ì„ ì •ì˜í•©ë‹ˆë‹¤.
  - `optional()` : Request, Response ë‚´ì˜ ìš”ì†Œì˜ í•„ìˆ˜ê°’ ì—¬ë¶€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. (`optional()`ë¥¼ ì„ ì–¸í•˜ë©´ í•„ìˆ˜ê°’ ì•„ë‹˜)

```java
.andDo(document("getDetailedDiary",
                responseFields(
                        fieldWithPath("[].title").type(JsonFieldType.STRING).description("ì¼ê¸° ì œëª©"),
                        fieldWithPath("[].content").type(JsonFieldType.STRING).description("ì¼ê¸° ë‚´ìš©")
                )))
```  

#### requestHeader
- APIì˜ Request Headerì— ëŒ€í•œ Snippetì„ ìƒì„±í•©ë‹ˆë‹¤.
- `/build/generated-snippets/<document-name>/request-headers.adoc` ì¸ íŒŒì¼ëª…ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
- `requestHeader(headerWithName(â€œheader-keyëª…â€).description(â€œheader-keyê°€ ì˜ë¯¸í•˜ëŠ” ë‚´ìš©â€))`

```java
.andDo(document("getDetailedDiary",
                requestHeaders(
                  headerWithName("api-auth-key").description("API ì¸ì¦ í‚¤")
                )))
```

#### PathParameters
- APIì˜ Path Parameterì— ëŒ€í•œ Snippetì„ ìƒì„±í•©ë‹ˆë‹¤.
- `/build/generated-snippets/<document-name>/path-parameters.adoc` ì¸ íŒŒì¼ëª…ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
- `pathParameter(parameterWithName(â€œkey ëª…ì¹­â€).description(â€œkeyê°€ ì˜ë¯¸ í•˜ëŠ” ë‚´ìš©â€)) ìœ¼ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`

```java
.andDo(document("getDetailedDiary",
                pathParameters(
                        parameterWithName("diaryId").description("ì¡°íšŒí•  ì¼ê¸°ì˜ ID")
                )))
```

> ë” ë§ì€ Functionë“¤ì€ [ì´ ê¸€](https://jaehun2841.github.io/2019/08/04/2019-08-04-spring-rest-docs/#Spring-Rest-Docs%EB%9E%80)ì„ ì°¸ê³ íˆì.

# Spring Rest Docs 
## Architecture
> [ì´ ê¸€](https://jaehun2841.github.io/2019/08/04/2019-08-04-spring-rest-docs/#Spring-Rest-Docs%EB%9E%80)ì„ ì°¸ê³ í–ˆë‹¤.

![asciidoctor](https://user-images.githubusercontent.com/59405576/226567682-abf11273-2b3e-480d-b250-7ed127c21a77.png)
- Test Caseë¥¼ ìˆ˜í–‰í•˜ë©´ ì‚°ì¶œë¬¼ì´ `.adoc` íŒŒì¼ë¡œ `/build/generate-snippets` ë””ë ‰í† ë¦¬ì— ìƒì„±ë©ë‹ˆë‹¤. (default path)
- `/src/docs/asciidoc` ë””ë ‰í† ë¦¬ì— `/build/generate-snippets`ì— ìˆëŠ” adoc íŒŒì¼ì„ includeí•˜ì—¬ ë¬¸ì„œë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - `/build/generate-snippets/*.adoc` íŒŒì¼ë“¤ì€ API Request, Responseì— ëŒ€í•œ ëª…ì„¸ë“¤ë§Œ ìˆëŠ” íŒŒì¼ì´ê³ 
  - `/src/docs/asciidoc/*.adoc` íŒŒì¼ë“¤ì´ ì‹¤ì œ ì‚¬ìš©ìì—ê²Œ htmlíŒŒì¼ë¡œ ë³€í™˜ë˜ì–´ ì œê³µë˜ëŠ” API ë¬¸ì„œ íŒŒì¼ì…ë‹ˆë‹¤.
  - ë”°ë¼ì„œ `/src/docs/asciidoc/*.adoc` ì— API ë¬¸ì„œë¥¼ ì‘ì„±í•˜ê³ ,<br>
  í•„ìš”í•œ API Request, Response Specì€ ìë™ ìƒì„±ëœ `/build/generate-snippets/*.adoc` íŒŒì¼ë“¤ì„ ì´ìš©í•´ í‘œí˜„í•´ì¤ë‹ˆë‹¤.
  - ì´ë ‡ê²Œ í•˜ë©´ í–¥í›„ API Specì´ ë³€ê²½ë˜ë”ë¼ë„, ë¬¸ì„œë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.
- ì´ë ‡ê²Œ ìƒì„±ëœ asciidoc ë¬¸ì„œëŠ” AsciidoctorTaskë¥¼ í†µí•´ html ë¬¸ì„œë¡œ processing ë˜ì–´ `/build/asciidoc/html5` í•˜ìœ„ì— htmlë¬¸ì„œë¡œ ìƒì„±ë©ë‹ˆë‹¤.
  - html ë¬¸ì„œê°€ ìƒì„±ë˜ëŠ” ê¸°ì¤€ì€ `/src/docs/asciidoc/*.adoc` íŒŒì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.

## Spring Rest Docs ì ìš©
ìœ„ì²˜ëŸ¼ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•œ ë’¤, í…ŒìŠ¤íŠ¸ì— ì„±ê³µí•˜ë©´ `build/generated-snippets`ê²½ë¡œì— `.adoc`íŒŒì¼ë“¤ì´ ìƒì„±ëœë‹¤.<br>
ìƒì„±ëœ ìŠ¤ë‹ˆí«ë“¤ì„ ì‚¬ìš©í•´ë³´ì!
> [ì´ ê¸€](https://gaemi606.tistory.com/entry/Spring-Boot-REST-Docs-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0)ì„ ì°¸ê³ í–ˆë‹¤.

`.adoc`íŒŒì¼ì„ ìƒì„±í•´ì•¼ í•˜ëŠ”ë°, Gradleì˜ ê²½ìš° `src/docs/asciidoc/*.adoc` ê²½ë¡œë¡œ ìƒì„±í•´ì•¼ í•œë‹¤.<br>
íŒŒì¼ëª…ì€ ììœ ë¡­ê²Œ ì„¤ì •í•˜ë©´ ëœë‹¤. (`.adoc`ìœ¼ë¡œ ìƒì„±í•˜ê¸°ë§Œ í•˜ë©´ OK)<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-21 á„‹á…©á„’á…® 6 24 05](https://user-images.githubusercontent.com/59405576/226564568-1a478c23-c3c2-40c1-9118-e1f3c80a1def.png)<br><br>
ê·¸ë¦¬ê³  ìŠ¤ë‹ˆí«ë“¤ì„ ì‚¬ìš©í•˜ëŠ”.. ì§„ì§œ ë¬¸ì„œë¡œì„œì˜ ê¸°ëŠ¥ì„ í•˜ë„ë¡ ì¡°í•©í•˜ë©´ ë!
- `=`, `==` ... ë“¤ì€ ë§ˆí¬ë‹¤ìš´ì—ì„œì˜ `#`, `##` ê³¼ ë¹„ìŠ·í•˜ê²Œ ì‚¬ìš©.. ì œëª©ì´ ëœë‹¤
- `:toc: left` ì„¤ì •ì€ ì™¼ìª½ì— ì‚¬ì´ë“œë°”ê°€ ìƒì„±ë˜ê³ , ëª©ì°¨ë“¤ì— ë§í¬ê°€ ìë™ìœ¼ë¡œ ê±¸ë¦°ë‹¤!!
- `:toclevels: 2` ì„¤ì •ì€ ëª©ì°¨ë“¤ì˜ ë ˆë²¨ì„ ì–´ë””ê¹Œì§€ ë³´ì—¬ì¤„ ê²ƒì´ëƒ..

```
= REST API
:toc: left
:toclevels: 2
:source-highlighter: highlightjs

== 1. ê°œìš”

== 2. ì¸ì¦

== 3. ì´ë¯¸ì§€
```
ì´ì œ ìƒì„±ëœ ìŠ¤ë‹ˆí«ë“¤ì„ ì§„ì§œë¡œ í¬í•¨í•´ë³´ì!<br>
`includ::{snippets}/../~.adoc[]`ìœ¼ë¡œ ì‚¬ìš©í•  ìŠ¤ë‹ˆí«ì„ ì„ íƒí•´ì„œ ë¶ˆëŸ¬ì˜¤ë©´ ëœë‹¤!<br><br>
ì¸í…”ë¦¬ì œì´ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ í”ŒëŸ¬ê·¸ì¸ì„ ë‹¤ìš´ë°›ì•„ ì‘ì„±í•˜ì‹œê¸¸... ë¬¸ë²•ì´ ë°”ë¡œë°”ë¡œ ì´í•´ê°€ ì™ì™...<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-21 á„‹á…©á„’á…® 6 26 33](https://user-images.githubusercontent.com/59405576/226565009-cb4b0f45-a007-4905-b4d9-5996b52dec5a.png)

```
== 3. ì´ë¯¸ì§€
=== 3-1. ì´ë¯¸ì§€ ì¡°íšŒ
===== Request
include::{snippets}/images-get/request-parameters.adoc[]
===== Request Example
include::{snippets}/images-get/http-request.adoc[]

===== Response
include::{snippets}/images-get/response-fields.adoc[]

===== Response Example
include::{snippets}/images-get/response-body.adoc[]
```


## ìµœì í™”

> Spring Rest Docsë¥¼ ë”ìš± ìµœì í™” í•˜ê³  ì‹¶ë‹¤ë©´ [ì´ ê¸€](https://backtony.github.io/spring/2021-10-15-spring-test-3/)ì„ ì°¸ê³ í•˜ì.

























***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}