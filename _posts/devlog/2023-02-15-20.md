---
title:  "[AWS] Jenkinsë¥¼ í†µí•œ Docker Compose + mysql+ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ìë™ ë°°í¬ - ì„ì‹œ "

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-02-15 22:18:55
last_modified_at: 2023-02-15 22:18:58
---

# ì „ì²´ì ì¸ íë¦„

> [ì´ ê¸€](https://tape22.tistory.com/20?category=928488)ì„ ì°¸ê³ í–ˆë‹¤.

ì›ë˜ëŠ” `github ì˜¬ë¦¼` â†’ `Jenkinsì—ì„œ githubì— ì˜¬ë¼ì™€ìˆëŠ” springboot í”„ë¡œì íŠ¸ë¥¼ ê°€ì ¸ì™€ì„œ ë¹Œë“œ` â†’ `ë©”ì¸ ì„œë²„ì— .jar í˜•íƒœë¡œ íŒŒì¼ì„ ì „ì†¡` â†’ `ì‹¤í–‰` ì„ í•˜ê³  ì‹¶ë‹¤ë©´ [ë‹¤ìŒ](https://dbjh.tistory.com/68?category=839984)ê³¼ ê°™ì€ ë°©ë²•ì„ ì¨ì•¼í•˜ì§€ë§Œ,<br>
ë‚˜ëŠ” springboot ì„œë²„ë¥¼ docker ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰í•  ê²ƒì´ë¯€ë¡œ ì•„ë˜ê³¼ ê°™ì€ í”Œë¡œìš°ë¡œ ê°€ë ¤ê³  í•œë‹¤.

```
github ì˜¬ë¦¼ 
â†’ Jenkinsì—ì„œ githubì— ì˜¬ë¼ì™€ìˆëŠ” springboot í”„ë¡œì íŠ¸ë¥¼ ê°€ì ¸ì™€ì„œ ë¹Œë“œ
â†’ jenkins ì»¨í…Œì´ë„ˆì—ì„œ docker-compose ëª…ë ¹ì–´ë¡œ ë°°í¬ (ì»¨í…Œì´ë„ˆ ì‹¤í–‰)
```

<br>

# ì„¸íŒ…
ì•„ë˜ëŠ” ì˜ˆì „ì— ì´ë¯¸ ì§„í–‰í–ˆì—ˆê¸° ë•Œë¬¸ì— ë¹ ë¥´ê²Œ ì„¸íŒ…í•˜ê³  ë„˜ì–´ê°€ì.<br>
ì´ ê¸€ì—ì„œëŠ” ì €ë²ˆì— ì„±ê³µí•˜ì§€ ëª»í•œ ë¶€ë¶„ë¶€í„° ì§„í–‰í•œë‹¤.

> 1ë²ˆì€ [ì´ ê¸€](https://minju412.github.io/docker/8/#naem-server-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EA%B8%B0%EB%8F%99-%EC%8B%9C-mysql-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88%EA%B0%80-%EC%A2%85%EB%A3%8C%EB%90%98%EB%8A%94-%EB%AC%B8%EC%A0%9C)ì„ ì°¸ê³ í–ˆë‹¤.

> 2~4ë²ˆì€ [ì´ ê¸€](https://minju412.github.io/devlog/19/)ì„ ì°¸ê³ í–ˆë‹¤.

1. ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° swapfile í• ë‹¹
2. ë„ì»¤ ì—”ì§„ ì„¤ì¹˜
3. ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜
4. ì  í‚¨ìŠ¤ ì„¤ì¹˜ (with. docker compose) ë° ì´ˆê¸° ì„¤ì • (Item ìƒì„± ë° Git ì—°ë™)
5. ê¹ƒí—ˆë¸Œ ì„¤ì • (deploy key, webhook, ...)

<br>

# ì  í‚¨ìŠ¤ Build Execute Shell

> [ì´ ê¸€](https://tape22.tistory.com/20?category=928488)ì„ ì°¸ê³ í–ˆë‹¤.

```sh
#echo "docker hubì— push í•˜ê¸°ìœ„í•´ login"
#sudo docker login -u ë„ì»¤í—ˆë¸Œì•„ì´ë”” -p íŒ¨ìŠ¤ì›Œë“œ

#echo "ì´ë¯¸ì§€ ë¹Œë“œ"
#sudo docker build --no-cache=true -t ln8847/jenkins-test:1.0 .

#echo "ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸"
#sudo docker images | grep jenkins-test

#echo "ë„ì»¤í—ˆë¸Œì— push"
#sudo docker push ln8847/jenkins-test:1.0

echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ"
docker-compose stop

echo "ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
docker-compose up -d

sleep 5s
docker ps -a
```

## Trouble Shooting
> [ì´ ê¸€](https://blog.opendocs.co.kr/?p=704)ì„ ì°¸ê³ í–ˆë‹¤.

<img width="551" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-16 á„‹á…©á„Œá…¥á†« 10 31 59" src="https://user-images.githubusercontent.com/59405576/219248360-20e49ba7-2029-417c-b16a-2b96013a6310.png">

### ì‹œë„1 - docker-composeì— ì˜µì…˜ ì¶”ê°€
```yml
version: '3'
services:
  jenkins:
    container_name: 'jenkins'
    image: 'jenkins/jenkins:lts'
    restart: always
    ports:
      - 9090:8080
      - 50000:50000
    volumes:
      - /home/ubuntu/docker/jenkins/home:/var/jenkins_home
      - /var/run:/var/run:ro              # docker ì‹¤í–‰ í´ë” ê³µìœ 
      - /var/run/docker.sock:/var/run/docker.sock # docker ì†Œì¼“ íŒŒì¼ ë§ˆìš´íŠ¸
    environment:
      TZ: "Asiz/Seoul"
```
ì»¨í…Œì´ë„ˆ ìì²´ë¥¼ ì‚­ì œí•˜ì§€ ì•Šê³  `docker-compose stop` í›„ `docker-compose up -d` ë§Œ í•´ì„œ ê·¸ëŸ°ì§€ëŠ” ëª°ë¼ë„ ì‹¤íŒ¨í–ˆë‹¤..


### ì‹œë„2 - jenkins container ì ‘ì†í•˜ì—¬ docker-ce-cli ì„¤ì¹˜

> ğŸš¨ ì£¼ì˜<br>
ì•„ë˜ë¥¼ ë”°ë¼ ë„ì»¤ì™€ ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì„¤ì¹˜í–ˆëŠ”ë°, <br>
`docker-compose stop` í›„ `docker-compose up -d`ë¥¼ í•˜ë‹ˆ ë„ì»¤ì™€ ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜í–ˆë˜ê²Œ ë‹¤ ë‚ ë¼ê°„ë‹¤...<br>
ë‹¤ìŒë¶€í„°ëŠ” `docker-compose start` ë¥¼ í•´ì•¼ê² ë‹¤!!!

ìš°ë¶„íˆ¬ì— ì ‘ì†í•´ì„œ ì§„í–‰í•œë‹¤.
```bash
# jenkins container ì ‘ì†
$ docker exec -u 0 -it jenkins bash # root ë¡œ ì ‘ì† (jenkins ëŠ” ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ì´ë¦„)

# linux ë²„ì „ í™•ì¸
$ cat /etc/issue
# --------------- OS --------------------------------
# root@DESKTOP-R4P59B3:/home/opendocs# cat /etc/issue
# Ubuntu 20.04.4 LTS \n \l
# --------------- jenkins Container OS --------------------------------
# root@DESKTOP-R4P59B3:/home/opendocs# docker exec -it jenkins /bin/bash
# root@8fc963af71bb:/# cat /etc/issue
# Debian GNU/Linux 11 \n \l
 
# Docker ì„¤ì¹˜
## - Old Version Remove
$ apt-get remove docker docker-engine docker.io containerd runc
## - Setup Repo
$ apt-get update
$ apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
$ mkdir -p /etc/apt/keyrings
$ curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
$ echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

## - Install Docker Engine
$ apt-get update
$ apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# $ apt-get update
# $ apt-get install docker.io

# ë²„ì „ í™•ì¸
$ docker -v
```


ì´ì œ ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì„¤ì¹˜í•˜ì
> [ì´ ê¸€](https://velog.io/@dudu/Docker-Docker-compose-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0-Ubuntu-18.04)ì„ ì°¸ê³ í–ˆë‹¤.

ë²„ì „ í™•ì¸ì€ [ì—¬ê¸°](https://github.com/docker/compose/releases)ì—ì„œ!

```bash
$ apt-get update

# sudo apt install docker-compose ëŠ” êµ¬ë²„ì „
$ curl -L "https://github.com/docker/compose/releases/download/v2.16.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
$ chmod +x /usr/local/bin/docker-compose
$ ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

# ë²„ì „ í™•ì¸
$ docker-compose -v
```

<br>ì—¬ê¸°ê¹Œì§€í•˜ê³  ë¹Œë“œí•´ë³´ë‹ˆ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë°”ë€Œì—ˆë‹¤..!<br>
<img width="1249" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-16 á„‹á…©á„Œá…¥á†« 10 55 37" src="https://user-images.githubusercontent.com/59405576/219247675-fef7de43-6135-4229-9ef1-bfd193d769ed.png"><br>
ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆì— `root`ë¡œ ì ‘ì†í•´ì„œ ì§„í–‰í•œë‹¤. (`$ docker exec -u 0 -it jenkins bash`)

> [ì´ ê¸€](https://github.com/occidere/TIL/issues/116)ì„ ì°¸ê³ í–ˆë‹¤.

```bash
$ chmod 666 /var/run/docker.sock
```

<br>ë‹¤ì‹œ ë¹Œë“œí•´ë³´ë‹ˆ ì´ë²ˆì—” ì´ë ‡ê²Œ ì˜ ì‹¤í–‰ë˜ëŠ” ë“¯ í–ˆìœ¼ë‚˜...<br>
<img width="838" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-16 á„‹á…©á„Œá…¥á†« 10 59 28" src="https://user-images.githubusercontent.com/59405576/219248144-dc9518eb-d080-4756-acdc-97c9a5da8583.png"><br><br>
ë§ˆì§€ë§‰ì— ì´ëŸ° ì—ëŸ¬ë¥¼ ë¿œìœ¼ë©° ì‹¤íŒ¨í–ˆë‹¤...<br>
<img width="1230" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-16 á„‹á…©á„Œá…¥á†« 11 06 14" src="https://user-images.githubusercontent.com/59405576/219249092-b7c251f8-f5cc-4729-9474-58a1cbeaad18.png"><br><br>


ì´ë²ˆì—ëŠ” `Dockerfile`ì—ì„œ `COPY` ë¶€ë¶„ì˜ ë¬¸ì œì¸ ê²ƒ ê°™ë‹¤...<br>
ì¸í…”ë¦¬ì œì´ì—ì„œ `Dockerfile`ì˜ ë‚´ìš©ì„ ë³€ê²½í•´ë³´ì.

> [ì´ ê¸€](https://community.render.com/t/build-fails-spring-boot-docker/7362)ì„ ì°¸ê³ í–ˆë‹¤.

ë³€ê²½ ì „
```Dockerfile
FROM openjdk:17-ea-11-jdk-slim
VOLUME /tmp
ARG JAR_FILE=build/libs/jenkins-test-0.0.1-SNAPSHOT.jar
COPY ${JAR_FILE} jenkins-test.jar
ENTRYPOINT ["java","-jar","/jenkins-test.jar"]
EXPOSE 8080
```

ë³€ê²½ í›„
```Dockerfile
FROM openjdk:11-jdk
#VOLUME /tmp
ARG JAR_FILE=./build/libs/jenkins-test-0.0.1-SNAPSHOT.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
EXPOSE 8080
```

ì´ëŒ€ë¡œ git pushë¥¼ í•˜ë‹ˆ webhook ì„¤ì •ì„ í•´ë‘” ë•ë¶„ì— ì  í‚¨ìŠ¤ê°€ ìë™ìœ¼ë¡œ ë¹Œë“œí–ˆë‹¤.<br>
í•˜ì§€ë§Œ ì—ëŸ¬ëŠ” ê·¸ëŒ€ë¡œì˜€ë‹¤...

> [ì´ ê¸€](https://community.render.com/t/i-do-a-docker-file-in-a-spring-boots-proyect-local-worked-fine-but-when-render-use-dockers-file-its-cant-finde-compute-cache-key/8141)ì„ ë³´ê³  `.gitignore`ì˜ ë¬¸ì œì„ì„ ì•Œì•˜ë‹¤.

Dockerfileì—ì„œ `build/libs/jenkins-test-0.0.1-SNAPSHOT.jar` ì„ `app.jar` ë¡œ COPY í•´ì•¼í•˜ëŠ”ë° `build` ë””ë ‰í† ë¦¬ê°€ `.gitignore`ì— ë“±ë¡ë˜ì–´ìˆì—ˆë‹¤.<br>
ê·¸ë˜ì„œ `build/libs`ë¥¼ `.gitignore`ì—ì„œ ì œì™¸í–ˆë‹¤.<br><br>

ë³€ê²½ ì „ `gitignore`
```
...

build/

...
```

ë³€ê²½ í›„ `gitignore`
```
...

build/classes
build/generated
build/resources
build/tmp
build/bootJarMainClassName

...
```




# ì  í‚¨ìŠ¤ë¥¼ ì´ìš©í•œ ìë™ ë°°í¬
































***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}