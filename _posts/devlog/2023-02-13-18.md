---
title:  "[AWS] EC2ì— mysql ì„¤ì¹˜ ë° ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬í•˜ê¸° "

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-02-13 17:01:00
last_modified_at: 2023-02-13 17:01:03
---
> [ì´ ê¸€](https://bibi6666667.tistory.com/312)ì„ ì°¸ê³ í–ˆë‹¤.

# 1. EC2 ìš°ë¶„íˆ¬ì— mysql ì„¤ì¹˜
## mysql ì„¤ì¹˜

```bash
$ sudo apt update
$ sudo apt-get install mysql-server
```

## mysql ì ‘ì†

```bash
$ sudo /usr/bin/mysql -u root -p
```
íŒ¨ìŠ¤ì›Œë“œë¥¼ ì„¤ì •í–ˆìœ¼ë©´ ì…ë ¥í•˜ê³ , ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì—”í„°ë¥¼ ëˆ„ë¥¸ë‹¤.

> ERROR 1698 (28000)<br>
ì²˜ìŒì— $ sudo mysql -u root -p ë¡œ ì§„í–‰í–ˆë”ë‹ˆ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤.<br>
`ERROR 1698 (28000): Access denied for user 'root'@'localhost'`<br>
í•´ê²°ë°©ë²•: mysql ëŒ€ì‹  /usr/bin/mysql ê³¼ ê°™ì´ ê²½ë¡œë¥¼ ì •í™•í•˜ê²Œ ëª…ì‹œí•´ì£¼ë©´ ëœë‹¤.

> ì°¸ê³ <br>
[ì´ ë¸”ë¡œê·¸](https://velog.io/@seungsang00/Ubuntu-%EC%9A%B0%EB%B6%84%ED%88%AC%EC%97%90-MySQL-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0)ë¥¼ ì°¸ê³ í–ˆë‹¤.

## mysql ì‚¬ìš©ì ì„¤ì •

```bash
mysql> create user 'root'@'%' identified by 'ë¹„ë°€ë²ˆí˜¸';
mysql> flush privileges;
```
ì´í›„ `sudo mysql -u root -p` ì»¤ë§¨ë“œë¡œ ì ‘ì† ì‹œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼í•œë‹¤.

> íŠ¹ì • ip ì—ì„œë§Œ ì ‘ì†ì„ í—ˆìš©í•˜ê³  ì‹¶ë‹¤ë©´?<br>
`create user 'root'@'ipì£¼ì†Œ' identified by 'ë¹„ë°€ë²ˆí˜¸';` ë¡œ ì…ë ¥í•œë‹¤.

## mysql ì‚¬ìš©ì í™•ì¸

```bash
mysql> use mysql;
mysql> select user, host, authentication_string from user;
```

## mysql ì‚¬ìš©ìì— ê¶Œí•œ ë¶€ì—¬

```bash
mysql> grant all privileges on *.* to 'root'@'%';
```

> íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤, í…Œì´ë¸” ë° íŠ¹ì • ipì—ë§Œ ì ‘ì† ê°€ëŠ¥í•œ ì‚¬ìš©ìì¼ ê²½ìš°?<br>
`grant all privileges on ë°ì´í„°ë² ì´ìŠ¤ëª….í…Œì´ë¸”ëª… to 'ì‚¬ìš©ìëª…'@'ipì£¼ì†Œ';`

## mysql ì™¸ë¶€ì ‘ì† í—ˆìš©

`exit` ëª…ë ¹ì–´ë¡œ mysql ì—ì„œ ë‚˜ê°„ ë’¤ ìš°ë¶„íˆ¬ì—ì„œ ì•„ë˜ ì»¤ë§¨ë“œë¥¼ ì…ë ¥í•œë‹¤.

```bash
$ cd /etc/mysql/mysql.conf.d # ë””ë ‰í† ë¦¬ ì´ë™
$ ls # íŒŒì¼ í™•ì¸
$ sudo vi mysqld.cnf
```

ì—´ë¦° ë¬¸ì„œì—ì„œ `bind-address` ë¶€ë¶„ì„ `0.0.0.0`ìœ¼ë¡œ ë³€ê²½í•œë‹¤.<br>
`mysqlx-bind-address`ë„ `0.0.0.0`ìœ¼ë¡œ ë³€ê²½í•œë‹¤. <br>
(í˜¹ì€ ë§¨ ì•ì— `#`ì„ ë„£ì–´ ì£¼ì„ì²˜ë¦¬ í•œë‹¤.)<br>

### í™•ì¸í•˜ê¸°
```
netstat -p tcp -van | grep LISTEN | grep 3306
```
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-05-23 á„‹á…©á„’á…® 4 47 55](https://user-images.githubusercontent.com/59405576/169778601-a2730a26-860e-4a5a-9249-e272b81bf7a3.png)
<br>
ìœ„ ì‚¬ì§„ì²˜ëŸ¼ `0.0.0.0:3306`ì´ì–´ì•¼ í•œë‹¤. `127.0.0.1`ì´ ì•„ë‹Œì§€ í™•ì¸í•œë‹¤.


## mysql ì¬ì‹œì‘

```bash
$ sudo service mysql restart
```

# 2. EC2ì˜ mysqlê³¼ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì—°ê²°í•˜ê¸°

## mysqlì— ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±í•˜ê¸°

```bash
# default ì´ë¼ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  í•œê¸€ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” UTF8ë¡œ ë¬¸ìì—´ì„ ì €ì¥
mysql> create database naem default CHARACTER SET UTF8;
mysql> show databases; # ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
```

## `application.yml` íŒŒì¼ ì‘ì„±

```yml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://[EC2_IPì£¼ì†Œ]:3306/naem?serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
    username: root
    password: ì•„ê¹Œ ì„¤ì •í•œ íŒ¨ìŠ¤ì›Œë“œ
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        globally_quoted_identifiers: true
        format_sql: true
        dialect: org.hibernate.dialect.MySQL8Dialect
```

# 3. swapfile ìƒì„±í•˜ê¸° - ë‚´ê°€ ì¶”ê°€í•œ ê²ƒ

ë°°í¬ì‹œ ì¤‘ë‹¨ë˜ëŠ” ë¬¸ì œë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•´ swapfile ì„ í• ë‹¹í–ˆë‹¤.

> [ì´ ê¸€](https://minju412.github.io/docker/8/#naem-server-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EA%B8%B0%EB%8F%99-%EC%8B%9C-mysql-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88%EA%B0%80-%EC%A2%85%EB%A3%8C%EB%90%98%EB%8A%94-%EB%AC%B8%EC%A0%9C)ì„ ì°¸ê³ í–ˆë‹¤.


# 4. EC2 ì„œë²„ì— Spring Boot jar íŒŒì¼ ë°°í¬í•˜ê¸°

## ec2 ì¸ìŠ¤í„´ìŠ¤ë¡œ jar íŒŒì¼ ì „ì†¡
`scp` ì»¤ë§¨ë“œë¥¼ ì´ìš©í•´ì„œ `Local->Remote`ë¡œ jar íŒŒì¼ì„ ì „ì†¡í•  ê²ƒì´ë‹¤.<br>
ì¸í…”ë¦¬ì œì´ í„°ë¯¸ë„ë¡œ ì•„ë˜ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•œë‹¤.

```bash
$ ./gradlew build jar -x test # í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œì™¸í•˜ê³  ë¹Œë“œ

# scp -i "pemíŒŒì¼ê²½ë¡œ" jaríŒŒì¼ëª… ec2ì‚¬ìš©ìì´ë¦„@ec2í¼ë¸”ë¦­Ipv4DNS:~/ê²½ë¡œ
$ scp -i "/Users/minju/study/Naem/second-keypair.pem" build/libs/server-0.0.1-SNAPSHOT.jar ubuntu@ec2-**-***-**-***.ap-northeast-2.compute.amazonaws.com:~/ # ìƒì„±ëœ jar íŒŒì¼ì„ ec2 ì„œë²„ë¡œ ì „ì†¡
```

ì´ë•Œ `pemíŒŒì¼ê²½ë¡œ`ëŠ” `pwd` ì»¤ë§¨ë“œë¡œ ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤.<br>
<img width="178" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-13 á„‹á…©á„’á…® 7 40 27" src="https://user-images.githubusercontent.com/59405576/218436388-83623dc3-7682-45c6-960a-d492c692a812.png">

> í´ë”ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²•ì€ [ì—¬ê¸°](https://proimaginer.tistory.com/50)ë¥¼ ì°¸ê³ í•˜ì.

## ec2ì— ì ‘ì†í•´ ì „ì†¡ëœ jar íŒŒì¼ í™•ì¸
<img width="552" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-13 á„‹á…©á„’á…® 7 01 22" src="https://user-images.githubusercontent.com/59405576/218428187-611774b3-8d6a-4e45-9dbc-ed200f845876.png">

## ì „ì†¡ëœ jar íŒŒì¼ ì‹¤í–‰(=ë°°í¬)

```bash
$ java -jar server-0.0.1-SNAPSHOT.jar
```

### javaê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šì•„ì„œ ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤.
<img width="563" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-13 á„‹á…©á„’á…® 7 18 53" src="https://user-images.githubusercontent.com/59405576/218431793-02581d7e-62ec-426a-b07c-a2a20df3f378.png"><br>
java 11ì„ ì„¤ì¹˜í•´ë³´ì.

#### java 11 ì„¤ì¹˜
```bash
$ sudo apt-get install openjdk-11-jdk
```
#### í™˜ê²½ì„¤ì •
ìë°” ì„¤ì¹˜ê°€ ëë‚˜ë©´ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì•¼ í•œë‹¤. ë¨¼ì € java ìœ„ì¹˜ë¥¼ í™•ì¸í•œë‹¤.
```bash
$ which java
$ readlink -f /usr/bin/java
```
ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ, ë‚˜ëŠ” `/usr/lib/jvm/java-11-openjdk-amd64/bin/java` ì´ë ‡ê²Œ ë‚˜ì˜¤ëŠ”ë°,<br>
ë’¤ì— `/bin/java`ë§Œ ì œê±°í•˜ê³  ì•ë¶€ë¶„ê¹Œì§€ë§Œ ë³µì‚¬í•œë‹¤.<br><br>
ë³µì‚¬í•œ ë’¤ì—, ì•„ë˜ ëª…ë ¹ìœ¼ë¡œ í™˜ê²½ì„¤ì • íŒŒì¼ì¸ profileì„ ì—´ì–´ì¤€ë‹¤.
```bash
$ sudo vi /etc/profile
```
<img width="546" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-07-13 á„‹á…©á„’á…® 8 04 09" src="https://user-images.githubusercontent.com/59405576/178720554-c1c35127-81cc-468a-99e1-c03bbec91d6b.png"><br>
ê·¸ëŸ¼ ì´ëŸ° íŒŒì¼ì´ ë‚˜ì˜¤ëŠ”ë°, ìœ„ì™€ ê°™ì´ ë§¨ ì•„ë˜ 3ì¤„ì„ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤. <br><br>
í•´ë‹¹ ì‘ì—…ì´ ëë‚œ ë’¤, ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•œë‹¤.

```bash
$ source /etc/profile
```
ë§ˆì§€ë§‰ìœ¼ë¡œ í™˜ê²½ë³€ìˆ˜ê°€ ì˜ ì„¸íŒ… ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.
```bash
$ echo $JAVA_HOME
```
ì´ ëª…ë ¹ì–´ë¥¼ ì³¤ì„ ë•Œ, ì•„ê¹Œ ë³µì‚¬í•´ì¤€ ìœ„ì¹˜ê°€ ë‚˜íƒ€ë‚˜ê²Œ ëœë‹¤ë©´ ì„±ê³µì´ë‹¤.

> ì°¸ê³ <br>
- [https://chucoding.tistory.com/54](https://chucoding.tistory.com/54)


### Trouble Shooting

#### ì‹œë„1 - mysql user ìƒì„± í›„ ê¶Œí•œ ë¶€ì—¬

<img width="253" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-02-13 á„‹á…©á„’á…® 8 42 54" src="https://user-images.githubusercontent.com/59405576/218449141-58b819cf-e5ee-4158-8bf2-128353b8d8bb.png">

```bash
$ mysql -u root -p; // mysql ì ‘ì†

mysql> use mysql; // mysql db ì‚¬ìš©

mysql> select host, user from user; // user ì¡°íšŒ

mysql> create user root@***.**.*.* identified by 'ë¹„ë°€ë²ˆí˜¸'; // ê³„ì • ìƒì„±

mysql> GRANT ALL PRIVILEGES ON *.* TO 'root'@'***.**.*.*'; // ê¶Œí•œ ë¶€ì—¬

mysql> flush privileges; // ë©”ëª¨ë¦¬ì— ë°˜ì˜

mysql> show grants for root@***.**.*.*; // ê¶Œí•œ í™•ì¸
```

#### ì‹œë„2 - ë°©í™”ë²½ í™•ì¸
```bash
$ sudo ufw status
# inactive ë¡œ ë°©í™”ë²½ì€ êº¼ì ¸ìˆì—ˆë‹¤.
# ë§Œì•½ ì¼œì ¸ìˆì—ˆë‹¤ë©´ sudo ufw disable ë¡œ ëŒ ìˆ˜ ìˆë‹¤. (ì¼œëŠ”ê±´ enable)
```

#### ì‹œë„3 - ì—°ê²° urlì— í¼ë¸”ë¦­ IPv4 DNS ì‚¬ìš© [í•´ê²°!!!]
ê¸°ì¡´ì—ëŠ” `í¼ë¸”ë¦­ IPv4 ì£¼ì†Œ`ë¥¼ ì‚¬ìš©í–ˆëŠ”ë° ì´ë¥¼ `í¼ë¸”ë¦­ IPv4 DNS`ë¡œ ë°”ê¿¨ë”ë‹ˆ í•´ê²°ë˜ì—ˆë‹¤...
```yml
# ê¸°ì¡´
spring:
  datasource:
    url: jdbc:mysql://**.***.**.***:3306/naem?serverTimezone=UTC&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true

# ë³€ê²½
spring:
  datasource:
    url: jdbc:mysql://ec2-**-***-**-***.ap-northeast-2.compute.amazonaws.com:3306/naem?serverTimezone=UTC&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
```


# 5. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ë° ë¬´ì¤‘ë‹¨ ë°°í¬

> [ì´ ê¸€](https://kth990303.tistory.com/335)ì˜ 5ë²ˆ ë‚´ìš©ì„ ì°¸ê³ í–ˆë‹¤.

ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•´ ë°°í¬ ê³¼ì •ì„ ì¤„ì´ê³ , ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ í•´ë³´ì.

## ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
```bash
$ vi deploy.sh
```
```sh
echo "> ê¸°ì¡´ ì‹¤í–‰ë˜ë˜ íŒŒì¼ ì¢…ë£Œ"
kill $(lsof -t -i:8080)

echo "> ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬"
nohup java -jar \
-Dspring.profiles.active=prod \
-Dspring.datasource.url='jdbc:mysql://ec2-**-***-**-***.ap-northeast-2.compute.amazonaws.com:3306/naem?serverTimezone=UTC&characterEncoding=UTF-8' \
-Dspring.datasource.username='root' \
-Dspring.datasource.password='ë¹„ë°€ë²ˆí˜¸' \
server-0.0.1-SNAPSHOT.jar &
```

ì•„ê¹Œ ì‹¤í–‰ì‹œí‚¬ ë•Œ ìˆ˜í–‰í–ˆë˜ ëª…ë ¹ì–´ ì•ì— `nohup`ì„ ë¶™ì´ê³ , ë’¤ì— `&`ì„ ë¶™ì´ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ì´ ë˜ì–´, í„°ë¯¸ë„ì„ ì¢…ë£Œí•´ë„ ec2ìƒì—ì„œëŠ” ê³„ì† ëŒì•„ê°„ë‹¤. <br>
`nohup java -jar server-0.0.1-SNAPSHOT.jar & > /dev/null` ì²˜ëŸ¼ ë§¨ ë’¤ì— `> /dev/null`ì€ logë¥¼ ì €ì¥í•˜ì§€ ì•Šê² ë‹¤ëŠ” ëœ»ì´ê³ ,<br>
`nohup java -jar server-0.0.1-SNAPSHOT.jar &` ì²˜ëŸ¼ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ `nohup.out`ìœ¼ë¡œ ì €ì¥ëœë‹¤ê³  í•œë‹¤.

## ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
```bash
$ chmod +x ./deploy.sh # ê¶Œí•œ ë¶€ì—¬
$ ./deploy.sh
```

##  ì†ŒìŠ¤ì½”ë“œ ë³€ê²½ í›„ ë‹¤ì‹œ ë°°í¬í•  ë•ŒëŠ”!!
```bash
# ë¡œì»¬ í„°ë¯¸ë„ì—ì„œ
$ ./gradlew build jar -x test 
$ scp -i "/Users/minju/study/Naem/second-keypair.pem" build/libs/server-0.0.1-SNAPSHOT.jar ubuntu@ec2-**-***-**-***.ap-northeast-2.compute.amazonaws.com:~/

# ìš°ë¶„íˆ¬ì—ì„œ
$ ./deploy.sh
```

- ì´ ë°©ë²•ì€ application.ymlì„ gitignoreí•˜ì§€ ì•Šì•„ë„ ë˜ì§€ë§Œ, í™˜ê²½ë³€ìˆ˜ê°€ ë³€ê²½ë  ë•Œ ë°°í¬ì„œë²„ ì‹¤í–‰ ëª…ë ¹ì–´ë¥¼ ìˆ˜ì •í•´ì£¼ì–´ì•¼ í•œë‹¤ëŠ” ë‹¨ì ì´ ì¡´ì¬í•œë‹¤.
- ë§¤ë²ˆ ìˆ˜ì •í•´ì£¼ì§€ ì•Šì•„ë„ ë˜ëŠ” ë°©ë²• (ëŒ€ì‹  application.ymlì€ gitignore) ì—­ì‹œ ì¡´ì¬í•œë‹¤.

## í”„ë¡œì„¸ìŠ¤ë¥¼ ì¤‘ë‹¨í•˜ê³  ì‹¶ë‹¤ë©´?
```bash
# ì‹¤í–‰ì¤‘ì¸ ìë°” í”„ë¡œì„¸ìŠ¤ í™•ì¸
$ ps -ef | grep java # ì¡°íšŒëœ ë‚´ì—­ì—ì„œ ì²«ë²ˆì§¸ 5ìë¦¬ ìˆ«ìê°€ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ PIDì´ë‹¤.

# ì‹¤í–‰ì¤‘ì¸ ìë°” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
$ kill -9 PIDë²ˆí˜¸
```


***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}