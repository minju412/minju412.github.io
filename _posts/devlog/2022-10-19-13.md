---
title:  "Dockerfileì„ ì´ìš©í•œ spring boot ë°°í¬ "

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2022-10-19 21:36:43
last_modified_at: 2022-10-19 21:36:46
---

ë‚˜ì¤‘ì— mysqlê³¼ redisì— ë³¼ë¥¨ ì„¤ì •ì„ ì¶”ê°€ë¡œ í•´ì•¼í•œë‹¤!<br>
ì¼ë‹¨ ë°°í¬ë¶€í„° ì§„í–‰í•´ë³´ì.<br><br>
(ì›ë˜ aws ec2 ubuntuë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í–ˆëŠ”ë°, ìê¾¸ ì¤‘ë‹¨ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•´ gcp centos7ë¥¼ ì‚¬ìš©í–ˆë‹¤.<br>
ë”°ë¼ì„œ 0ë²ˆì€ í•„ìš” ì—†ì§€ë§Œ, ë‚˜ì¤‘ì— ì°¸ê³ í•˜ê¸° ìœ„í•´ ë‚¨ê²¨ë‘ì—ˆë‹¤.)

# 0. Ubuntuì— Docker Engine ì„¤ì¹˜
> [ê³µì‹ ì‚¬ì´íŠ¸](https://docs.docker.com/engine/install/ubuntu/)ë¥¼ ì°¸ê³ í–ˆë‹¤.

## Repository ì„¤ì •
```bash
# apt-get ì—…ë°ì´íŠ¸
$ sudo apt-get update

$ sudo apt-get install \
ca-certificates \
curl \
gnupg \
lsb-release

$ sudo mkdir -p /etc/apt/keyrings

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

$ echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

## Docker Engine ì„¤ì¹˜ ë° ì‹¤í–‰
```bash
$ sudo apt-get update

# ì„¤ì¹˜
$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# ë„ì»¤ ì‹¤í–‰
$ sudo service docker start

# ìƒíƒœ í™•ì¸
$ sudo service docker status
```

## ê¶Œí•œ ì„¤ì •
linuxì—ì„œ root ê¶Œí•œì´ ì•„ë‹Œ ìƒíƒœë¡œ dockerë¥¼ ì‹¤í–‰í•˜ë©´ ê¶Œí•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
```
[linux@localhost ]$ docker ps
Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.40/containers/json: dial unix /var/run/docker.sock: connect: permi
ssion denied
```
ì´ëŸ° ê²½ìš° ë§¤ë²ˆ sudoë¡œ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•´ë„ ë˜ì§€ë§Œ, ë²ˆê±°ë¡­ê¸° ë•Œë¬¸ì— docker groupì— í•´ë‹¹ ìœ ì €ë¥¼ ì¶”ê°€í•´ì£¼ë©´ í•´ê²°í•  ìˆ˜ ìˆë‹¤.<br>
```bash
# ë³´í†µì€ docker groupì´ ìƒê²¼ì„í…Œì§€ë§Œ, ë§Œì•½ ì—†ìœ¼ë©´ ìƒì„±í•´ì¤€ë‹¤.
$ sudo groupadd docker

# docker groupì— í•´ë‹¹ ìœ ì €ë¥¼ ì¶”ê°€
$ sudo usermod -aG docker $USER

# ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ì‹œì¼œì•¼ ì ìš©ì´ ëœë‹¤.
$ newgrp docker
```

# 1. ë„¤íŠ¸ì›Œí¬ ìƒì„±
```bash
# $ sudo docker system prune

$ docker network ls

# ë„¤íŠ¸ì›Œí¬ ìƒì„±
$ docker network create --gateway 172.18.0.1 --subnet 172.18.0.0/16 naem-network

# ë„¤íŠ¸ì›Œí¬ ëª©ë¡ í™•ì¸
$ docker network ls

# íŠ¹ì • ë„¤íŠ¸ì›Œí¬ ìƒì„¸ ë³´ê¸°
$ docker network inspect naem-network
```

# 2. mysql ê¸°ë™
## 1) init ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
mysqlì˜ Dockerfileì´ ìˆëŠ” ìœ„ì¹˜ì— `mysql-init-files` ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•œ ë’¤, ê·¸ ì•ˆì—ì„œ `create.sql` íŒŒì¼ì„ ìƒì„±í•˜ì.<br><br>
`create.sql`
```sql
CREATE DATABASE naem;

alter user 'root'@'localhost' identified with mysql_native_password by 'naem2524!';

create user 'root'@'%' identified by 'naem2524!';
grant all privileges on *.* to 'root'@'%';

flush privileges;

```
<img width="450" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„’á…® 6 09 40" src="https://user-images.githubusercontent.com/59405576/196907018-2dd13c34-9cb4-443b-a80b-b4865bbd90b5.png">

## 2) `Dockerfile` ì‘ì„±
ë¡œì»¬ì—ì„œ ì§„í–‰í•œë‹¤.<br>
ec2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‚¬ìš©í•  ë•Œì—ëŠ” ë„ì»¤ í—ˆë¸Œì—ì„œ pull ë°›ì•„ì„œ ì‚¬ìš©í•œë‹¤.
```Dockerfile
FROM mysql

ADD ./mysql-init-files /docker-entrypoint-initdb.d

ENV MYSQL_ROOT_PASSWORD naem2524!
ENV MYSQL_DATABASE naem

EXPOSE 3306
```

## 3) ì´ë¯¸ì§€ ë¹Œë“œ ë° ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
ë¡œì»¬ì—ì„œ ì§„í–‰í•œë‹¤.
```bash
# ì´ë¯¸ì§€ íŒŒì¼ ë¹Œë“œ
$ docker build \
--platform linux/x86_64 \
-t ln8847/naem_mysql:1.0 .

# ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸
$ docker images | grep naem_mysql

# ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
$ docker push ln8847/naem_mysql:1.0
```
<img width="793" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 12 25" src="https://user-images.githubusercontent.com/59405576/196833077-fd404e5d-e915-42ab-a6a2-3216edb88721.png">

## 4) ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
vm ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì§„í–‰í•œë‹¤.<br>
(ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ, m1 Macì´ ì•„ë‹ˆë¼ë©´ `--platform linux/x86_64` ì˜µì…˜ì€ ë¹¼ë„ ëœë‹¤.)
```bash
# ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ docker run --platform linux/x86_64 -d -p 3306:3306 --network naem-network \
--name mysql \
ln8847/naem_mysql:1.0

# ë§Œì•½ ì»¨í…Œì´ë„ˆê°€ ì—ëŸ¬ë¡œ ì¢…ë£Œë˜ì—ˆë‹¤ë©´
$ docker system prune # ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ëœ ì»¨í…Œì´ë„ˆê°€ ì—†ë‹¤ë©´ ë„¤íŠ¸ì›Œí¬ê°€ ì‚­ì œëœë‹¤!

# ì»¨í…Œì´ë„ˆ ëª©ë¡ í™•ì¸
$ docker ps -a

# ë„¤íŠ¸ì›Œí¬ í™•ì¸
$ docker network inspect naem-network

# ë¡œê·¸ í™•ì¸
$ docker logs mysql
```
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 22 58](https://user-images.githubusercontent.com/59405576/196834125-52959e45-b995-402c-9f50-628d4c8ac58d.png)<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 23 30](https://user-images.githubusercontent.com/59405576/196834183-0e86f97b-88e0-4db0-9f9d-7aec54262991.png)<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 23 19](https://user-images.githubusercontent.com/59405576/196834157-4e1e6d02-bf54-4685-8bfc-697876fd4979.png)

## 5) db ì ‘ì† í›„ í…Œì´ë¸” ìƒì„± ë° ê¶Œí•œ ì„¤ì •
redis ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹¤í–‰í•˜ë©´ ì•„ë˜ ì„¤ì •ì´ ì‚¬ë¼ì§€ê¸° ë•Œë¬¸ì— ë§¤ë²ˆ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ê¶Œí• ì„ ì„¤ì •í•˜ê¸° ë²ˆê±°ë¡­ë‹¤.<br>
-> 1) ì—ì„œ init ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ì—ˆìœ¼ë©´, 5) ë‚´ìš©ì€ í•„ìš”ì—†ë‹¤.<br><br>


mysql ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— ì ‘ì†í•œ ë’¤,<br>
mydb ë¼ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•´ `users`ì™€ `orders` í…Œì´ë¸”ì´ ë§Œë“¤ì–´ì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì.<br>
ê·¸ë¦¬ê³  mysqlì˜ root ê³„ì •ì´ ì–´ë– í•œ IP Addressë¡œ ì ‘ì†í•œë‹¤ í•˜ë”ë¼ë„ ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ ê¶Œí•œì„ ì„¤ì •í•´ë³´ì.

```bash
$ docker exec -it mysql /bin/bash

# ë§¨ ì²˜ìŒì—ëŠ” ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ê·¸ëƒ¥ ì—”í„°
bash-4.4# mysql -uroot -p

# ë°ì´í„° ë² ì´ìŠ¤ í™•ì¸
mysql> show databases;

# ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
mysql> CREATE DATABASE naem;
```
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„’á…® 5 05 55](https://user-images.githubusercontent.com/59405576/196892316-028fafe9-2fd9-4435-8402-c88fd148d921.png)

ì´ì œ ê¶Œí•œì„ ì„¤ì •í•˜ì.
```bash
mysql> use mysql;

# user ì¡°íšŒ
mysql> select host, user from user;

# 'root'@'%' ê°€ ì—†ëŠ” ê²½ìš°!
mysql> create user 'root'@'%' identified by 'password_you_want';

# ê¶Œí•œ ë¶€ì—¬
mysql> grant all privileges on *.* to 'root'@'%';

# ì ìš©
mysql> flush privileges;

# ê¶Œí•œ í™•ì¸
mysql> show grants for 'root'@'%';
```
root ë¼ëŠ” ê³„ì •ì˜ ì–´ë–¤ IP Addressë¡œ ì ‘ì†í•˜ë”ë¼ë„, ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì† ê°€ëŠ¥í•˜ë„ë¡ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ì»¤ë§¨ë“œì´ë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„’á…® 5 09 52](https://user-images.githubusercontent.com/59405576/196893138-befcc238-aba3-4c35-8d81-923c660b82a2.png)<br><br>
ë§Œì•½ íŒ¨ìŠ¤ì›Œë“œ ì—†ì´ëŠ” ì ‘ì†ì´ ë˜ëŠ”ë°, íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í–ˆì„ ë•Œ ì ‘ì†ì´ ì•ˆëœë‹¤ë©´?<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„’á…® 5 16 26](https://user-images.githubusercontent.com/59405576/196894559-b6fb7f4e-0601-4eec-8153-2eed1875d8a3.png)<br><br>
ìš°ì„  íŒ¨ìŠ¤ì›Œë“œ ì—†ì´ ì ‘ì†í•œ ë’¤ì— ì•„ë˜ ì»¤ë§¨ë“œë¥¼ ì§„í–‰í•˜ì.
```bash
mysql> use mysql;

mysql> alter user 'root'@'localhost' identified with mysql_native_password by 'new_password_you_want';

mysql> flush privileges;
```
ì´ì œ ì˜ ì ‘ì†ëœë‹¤.<br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„’á…® 5 18 56](https://user-images.githubusercontent.com/59405576/196895105-fffaa740-7dd4-4ca4-b012-b1f72e0ee2c7.png)

# 3. redis ê¸°ë™
## 1) `Dockerfile` ì‘ì„±
```Dockerfile
FROM redis

EXPOSE 6379
```

## 2) ì´ë¯¸ì§€ ë¹Œë“œ ë° ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
ë¡œì»¬ì—ì„œ ì§„í–‰í•œë‹¤.
```bash
# ì´ë¯¸ì§€ íŒŒì¼ ë¹Œë“œ
$ docker build \
--platform linux/x86_64 \
-t ln8847/naem_redis:1.0 .

# $ docker build -t ln8847/naem_redis:1.0 .

# ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸
$ docker images | grep naem_redis

# ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
$ docker push ln8847/naem_redis:1.0
```
<img width="789" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 20 40" src="https://user-images.githubusercontent.com/59405576/196833917-ef76d041-d4e7-4f51-abf8-423d6ada7689.png">

## 3) ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
vm ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì§„í–‰í•œë‹¤.<br>
(ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ, m1 Macì´ ì•„ë‹ˆë¼ë©´ `--platform linux/x86_64` ì˜µì…˜ì€ ë¹¼ë„ ëœë‹¤.)
```bash
# ì»¨í…Œì´ë„ˆ ì‹¤í–‰
$ docker run --platform linux/x86_64 -d -p 6379:6379 --network naem-network \
--name redis \
ln8847/naem_redis:1.0

# ì»¨í…Œì´ë„ˆ ëª©ë¡ í™•ì¸
$ docker ps -a

# ë„¤íŠ¸ì›Œí¬ í™•ì¸
$ docker network inspect naem-network

# ë¡œê·¸ í™•ì¸
$ docker logs redis
```
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 22 17](https://user-images.githubusercontent.com/59405576/196834047-a2ce5c9b-0a20-40a7-be09-6d772f5cb17e.png)<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 21 46](https://user-images.githubusercontent.com/59405576/196833985-703f4805-65cf-400d-afd8-1c71945dcfce.png)<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„Œá…¥á†« 10 21 57](https://user-images.githubusercontent.com/59405576/196834007-40083ce8-040f-4df4-a7cc-075b2ebce2ee.png)

# 4. spring boot ê¸°ë™
## 1) ë°©í™”ë²½ ì—´ê¸°
ì´ë”°ê°€ 8080 í¬íŠ¸ë¡œ ê¸°ë™í•  ê²ƒì´ê¸° ë•Œë¬¸ì— ë¯¸ë¦¬ 8080 í¬íŠ¸ë¥¼ ì—´ì–´ë‘ì.

## 2) `Dockerfile` ì‘ì„±
ì¸í…”ë¦¬ì œì´ í„°ë¯¸ë„ì—ì„œ ì§„í–‰í•œë‹¤.
```Dockerfile
FROM openjdk:11

# VOLUME /tmp

COPY build/libs/server-0.0.1-SNAPSHOT.jar Server.jar

ENTRYPOINT ["java","-jar","Server.jar"]

EXPOSE 8080
```

## 3) ì´ë¯¸ì§€ ë¹Œë“œ ë° ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
ë¡œì»¬ì—ì„œ ì§„í–‰í•œë‹¤.
```bash
# ìµœì‹  ë²„ì „ìœ¼ë¡œ ì»´íŒŒì¼
# $ mvn clean compile package -DskipTests=true
# $ ./gradlew build -x test
$ ./gradlew bootJar -x test

# í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” skip

# ì´ë¯¸ì§€ íŒŒì¼ ë¹Œë“œ
$ docker build \
--platform linux/x86_64 \
-t ln8847/naem-server:1.0  .

# ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸
$ docker images | grep naem-server

# ë„ì»¤ í—ˆë¸Œì— ì—…ë¡œë“œ
$ docker push ln8847/naem-server:1.0
```

## 4) ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
vm ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì§„í–‰í•œë‹¤.<br>
(ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ, m1 Macì´ ì•„ë‹ˆë¼ë©´ `--platform linux/x86_64` ì˜µì…˜ì€ ë¹¼ë„ ëœë‹¤.)
```bash
$ docker run --platform linux/x86_64 -d -p 8080:8080 --network naem-network \
-e "spring.datasource.url=jdbc:mysql://mysql:3306/naem?serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true" \
-e "spring.redis.host=redis" \
--name naem-server \
ln8847/naem-server:1.0

# ì»¨í…Œì´ë„ˆ ëª©ë¡ í™•ì¸
$ docker ps -a

# ë„¤íŠ¸ì›Œí¬ í™•ì¸
$ docker network inspect naem-network

# ë¡œê·¸ í™•ì¸
$ docker logs naem-server
```

ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´
```bash
$ docker logs -f naem-server
```

# Truble Shooting
## `naem-server` ì»¨í…Œì´ë„ˆ ê¸°ë™ ì‹œ, `mysql` ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ëŠ” ë¬¸ì œ
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-10-20 á„‹á…©á„’á…® 6 37 51](https://user-images.githubusercontent.com/59405576/196913594-fc1f0ed4-4112-4874-978c-856ba49b6ef4.png)<br>
ì´ ë•Œ, mysql ì»¨í…Œì´ë„ˆì˜ `STATUS`ë¥¼ ë³´ê²Œë˜ë©´, `Exited (137)`ì´ë¼ê³  ë‚˜ì™€ìˆëŠ”ë°,<br>
ì´ê²ƒì€ ì»¨í…Œì´ë„ˆì˜ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•˜ì—¬ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë¼ê³  í•œë‹¤.<br><br>













***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}