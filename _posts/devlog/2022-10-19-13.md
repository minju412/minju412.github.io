---
title:  "Dockerfile을 이용한 spring boot 배포 "

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2022-10-19 21:36:43
last_modified_at: 2022-10-19 21:36:46
---

나중에 mysql과 redis에 볼륨 설정을 추가로 해야한다!<br>
일단 배포부터 진행해보자.

# 0. Ubuntu에 Docker Engine 설치
> [공식 사이트](https://docs.docker.com/engine/install/ubuntu/)를 참고했다.

## Repository 설정
```bash
# apt-get 업데이트
$ sudo apt-get update

$ sudo apt-get install \
ca-certificates \
curl \
gnupg \
lsb-release

$ sudo mkdir -p /etc/apt/keyrings

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

$ echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

## Docker Engine 설치 및 실행
```bash
$ sudo apt-get update

# 설치
$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 도커 실행
$ sudo service docker start

# 상태 확인
$ sudo service docker status
```


# 1. 네트워크 생성
```bash
# $ sudo docker system prune

$ sudo docker network ls

# 네트워크 생성
$ sudo docker network create --gateway 172.18.0.1 --subnet 172.18.0.0/16 naem-network

# 네트워크 목록 확인
$ sudo docker network ls

# 특정 네트워크 상세 보기
$ sudo docker network inspect naem-network
```

# 2. mysql 기동
## 1) `Dockerfile` 작성
로컬에서 진행한다.<br>
ec2 인스턴스에서 사용할 때에는 도커 허브에서 pull 받아서 사용한다.
```Dockerfile
FROM mysql

# ADD ./mysql-init-files /docker-entrypoint-initdb.d

ENV MYSQL_ROOT_PASSWORD naem2524!
ENV MYSQL_DATABASE naem

EXPOSE 3306
```

## 2) 이미지 빌드 및 도커 허브에 업로드
로컬에서 진행한다.
```bash
# 이미지 파일 빌드
$ docker build \
--platform linux/x86_64 \
-t ln8847/naem_mysql:1.0 .

# $ docker build \
# --build-arg DEPENDENCY=build/dependency \
# -t ln8847/naem_mysql:1.0 .

# $ docker build -t ln8847/naem_mysql:1.0 .

# 생성된 이미지 확인
$ docker images | grep naem_mysql

# 도커 허브에 업로드
$ docker push ln8847/naem_mysql:1.0
```

## 3) 도커 컨테이너 실행
ec2 인스턴스에서 진행한다.
```bash
# 컨테이너 실행
$ sudo docker run --platform linux/x86_64 -d -p 3306:3306 --network naem-network \
--name mysql \
ln8847/naem_mysql:1.0

# 만약 컨테이너가 에러로 종료되었다면
$ sudo docker system prune # 네트워크에 연결된 컨테이너가 없다면 네트워크가 삭제된다!

# 컨테이너 목록 확인
$ sudo docker ps -a

# 로그 확인
$ sudo docker logs mysql
```


# 3. redis 기동
## 1) `Dockerfile` 작성
```Dockerfile
FROM redis

# ENV MYSQL_ROOT_PASSWORD naem2524!
# ENV MYSQL_DATABASE naem

EXPOSE 6379
```

## 2) 이미지 빌드 및 도커 허브에 업로드
```bash
# 이미지 파일 빌드
$ docker build -t ln8847/naem_redis:1.0 .

# 생성된 이미지 확인
$ docker images | grep naem_redis

# 도커 허브에 업로드
$ docker push ln8847/naem_redis:1.0
```

## 3) 도커 컨테이너 실행
```bash
# 컨테이너 실행
$ docker run -d -p 6379:6379 --network naem-network \
--name redis \
ln8847/naem_redis:1.0

# 로그 확인
$ docker logs redis
```


# 4. spring boot 기동
## 1) `Dockerfile` 작성
```Dockerfile
FROM openjdk:11

# VOLUME /tmp

COPY build/libs/server-0.0.1-SNAPSHOT.jar Server.jar

ENTRYPOINT ["java","-jar","Server.jar"]

EXPOSE 8080
```

## 2) 이미지 빌드 및 도커 허브에 업로드
```bash
# 최신 버전으로 컴파일
# $ mvn clean compile package -DskipTests=true
$ ./gradlew build -x test
# clean은 기존 파일을 지운다.
# package 옵션으로 jar 파일까지 생성할 수 있다.
# 테스트 코드는 skip

# 이미지 파일 빌드
$ docker build -t ln8847/naem-backend:1.0  .

# 생성된 이미지 확인
$ docker images | grep naem-backend

# 도커 허브에 업로드
$ docker push ln8847/naem-backend:1.0
```

## 3) 도커 컨테이너 실행
```bash
$ docker run -d --network naem-network \
-e "spring.datasource.url=jdbc:mysql://mysql:3306/naem?serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true" \
-e "spring.redis.host=redis" \
--name naem-backend \
ln8847/naem-backend:1.0
```















***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}