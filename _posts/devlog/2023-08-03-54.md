---
title:  "EC2, Docker Composeë¥¼ ì´ìš©í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ (with. Docker Hub)"
# excerpt: "sprintfì— ëŒ€í•´ ì•Œì•„ë³´ì"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-08-03 17:53:45
last_modified_at: 2023-08-03 17:53:47
---

ê²°ê³¼ì ìœ¼ë¡œ êµ¬ì¶•í•  í™˜ê²½ì€ ì•„ë˜ì™€ ê°™ë‹¤.<br>
<img width="761" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-08 á„‹á…©á„Œá…¥á†« 12 11 57" src="https://github.com/minju412/jenkins-test/assets/59405576/8ffe900f-fe7c-4f6d-a4a9-2d0db3b96475">

# ğŸ“Œ í”„ë¡œì íŠ¸ì—ì„œ
## 1) ë„ì»¤ ì»´í¬ì¦ˆ ì‘ì„±
ë„ì»¤ ì»´í¬ì¦ˆì— ì‚¬ìš©ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ëŠ” `.env` íŒŒì¼ì— ë‹´ì•„ë†“ì•˜ë‹¤.

```yml
version: '3'
services:
  database:
    container_name: wanted_mysql
    image: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_HOST=%
    command:
      - --character-set-server=utf8
      - --collation-server=utf8_general_ci
      - --default-authentication-plugin=caching_sha2_password
    ports:
      - "${MYSQL_LOCAL_PORT}:${MYSQL_DOCKER_PORT}"
    volumes:
      - ./db/conf.d:/etc/mysql/conf.d
      - ./db/data:/var/lib/mysql --user 1000
    restart: always
    networks:
      - test_network

  application:
    container_name: wanted_app
    image: ln8847/wanted-pre-onboarding-application  # ğŸŒŸ Docker Hubì— í‘¸ì‹œí•  ì´ë¯¸ì§€ ì´ë¦„ !!
    build:
      context: ./
      dockerfile: Dockerfile
    env_file: ./.env
    ports:
      - "${SPRING_LOCAL_PORT}:${SPRING_DOCKER_PORT}"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://database:${MYSQL_DOCKER_PORT}/${MYSQL_DATABASE}?serverTimezone=UTC&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD}
    restart: always
    depends_on:
      - database
    networks:
      - test_network

networks:
  test_network:
    driver: bridge
```


## 2) ë„ì»¤ì»´í¬ì¦ˆ ì‚¬ìš©í•´ì„œ ì´ë¯¸ì§€ ë¹Œë“œ 
```bash
$ ./gradlew build jar -x test # jar íŒŒì¼ ë¹Œë“œ

$ docker-compose -f docker-compose.yml build

$ docker images # ë„ì»¤ ì´ë¯¸ì§€ í™•ì¸ (ë„ì»¤ ì»´í¬ì¦ˆì— ì •ì˜ëœ ì„œë¹„ìŠ¤ì˜ ìˆ˜ë§Œí¼ ì´ë¯¸ì§€ê°€ ìƒì„±ëœë‹¤)
```

[ì°¸ê³ ](https://growupcoding.tistory.com/41)

## 3) ë„ì»¤í—ˆë¸Œ í‘¸ì‹œ
```bash
$ docker login -u ln8847 # í•´ë‹¹ ì»¤ë§¨ë“œ ì‹¤í–‰ í›„ Password ì…ë ¥

$ docker-compose push # ìœ„ì—ì²˜ëŸ¼ docker-compose.ymlì— image í•„ë“œê°€ ìˆì–´ì•¼ í•œë‹¤ !! ğŸŒŸ
```




# ğŸ“Œ Ubuntu ì¸ìŠ¤í„´ìŠ¤ì—ì„œ

## 1) ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í›„ ë³´ì•ˆê·¸ë£¹ ì—´ê¸°

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-03 á„‹á…©á„’á…® 7 09 44](https://github.com/minju412/jenkins-test/assets/59405576/58040441-783d-4448-99a1-4afefdeeaf3d)

## 2) Docker Engine ì„¤ì¹˜
> [ê³µì‹ ì‚¬ì´íŠ¸](https://docs.docker.com/engine/install/ubuntu/)ë¥¼ ì°¸ê³ í–ˆë‹¤.

### Repository ì„¤ì •
```bash
# apt-get ì—…ë°ì´íŠ¸
$ sudo apt-get update

$ sudo apt-get install \
ca-certificates \
curl \
gnupg \
lsb-release

$ sudo mkdir -p /etc/apt/keyrings

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

$ echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

### Docker Engine ì„¤ì¹˜ ë° ì‹¤í–‰
```bash
$ sudo apt-get update

# ì„¤ì¹˜
$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin

# ë„ì»¤ ì‹¤í–‰
$ sudo service docker start

# ìƒíƒœ í™•ì¸
$ sudo service docker status
```

### ê¶Œí•œ ì„¤ì •
linuxì—ì„œ root ê¶Œí•œì´ ì•„ë‹Œ ìƒíƒœë¡œ dockerë¥¼ ì‹¤í–‰í•˜ë©´ ê¶Œí•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
```
[linux@localhost ]$ docker ps
Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.40/containers/json: dial unix /var/run/docker.sock: connect: permi
ssion denied
```
ì´ëŸ° ê²½ìš° ë§¤ë²ˆ sudoë¡œ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•´ë„ ë˜ì§€ë§Œ, ë²ˆê±°ë¡­ê¸° ë•Œë¬¸ì— docker groupì— í•´ë‹¹ ìœ ì €ë¥¼ ì¶”ê°€í•´ì£¼ë©´ í•´ê²°í•  ìˆ˜ ìˆë‹¤.<br>
```bash
# ë³´í†µì€ docker groupì´ ìƒê²¼ì„í…Œì§€ë§Œ, ë§Œì•½ ì—†ìœ¼ë©´ ìƒì„±í•´ì¤€ë‹¤.
$ sudo groupadd docker

# docker groupì— í•´ë‹¹ ìœ ì €ë¥¼ ì¶”ê°€
$ sudo usermod -aG docker $USER

# ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ì‹œì¼œì•¼ ì ìš©ì´ ëœë‹¤.
$ newgrp docker
```


## 3) ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜

```bash
$ sudo apt  install docker-compose
$ docker-compose --version
```

### ğŸ’¥ ë§Œì•½ ìœ„ ë°©ë²•ìœ¼ë¡œ ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì„¤ì¹˜í•˜ê³  ë²„ì „ì„ í™•ì¸í–ˆì„ ë•Œ `build unknown`ì´ ë‚˜ì˜¨ë‹¤ë©´?
> [ì´ ê¸€](https://velog.io/@dailylifecoding/ubuntu-20.04-docker-and-dockercompose-install) ì°¸ê³ 

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-06-05 á„‹á…©á„’á…® 6 38 36](https://github.com/minju412/jenkins-test/assets/59405576/706400d2-1be3-4fce-8d07-c469c58128a7)

```bash
$ sudo apt remove docker-compose # ì´ì „ì— ì„¤ì¹˜í•œ docker-composeë¥¼ ì œê±°

$ sudo curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/bin/docker-compose
# ì´ ëª…ë ¹ì–´ëŠ” ì™¸ë¶€ì—ì„œ ê·¸ëŒ€ë¡œ íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ í˜„ì¬ì˜ ì‹œìŠ¤í…œì— ì˜¬ë ¤ ë†“ëŠ” ê²ƒì´ë‹¤.
# ê²°ê³¼ì ìœ¼ë¡œ "/usr/bin/" ê²½ë¡œì— "docker-compose" ë¼ëŠ” ì´ë¦„ì˜ íŒŒì¼ë¡œ ë‹¤ìš´ëœë‹¤.
# ì°¸ê³ ) https://github.com/docker/compose/releases ì—ì„œ ìµœì‹  ë²„ì „ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤.
# ìµœì‹  ë²„ì „ì„ ì„¤ì¹˜í•˜ê³  ì‹¶ë‹¤ë©´ ìœ„ ëª…ë ¹ì–´ì— ë³´ì´ëŠ” 1.28.5 ë¼ëŠ” ë²„ì „ ìˆ«ìë¥¼ ë°”ê¿”ì£¼ë©´ ëœë‹¤!

$ sudo chmod +x /usr/bin/docker-compose # chmod ë¥¼ í†µí•´ì„œ ì‹¤í–‰ì´ ê°€ëŠ¥í•˜ê²Œ ì„¸íŒ…

$ docker-compose --version
```
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-06-05 á„‹á…©á„’á…® 6 42 40](https://github.com/minju412/jenkins-test/assets/59405576/ad5fa9b1-c856-4e0d-927e-21664f91821c)




## 4) ë°°í¬ (=ì»¨í…Œì´ë„ˆ ì‹¤í–‰)

### docker-compose.yml íŒŒì¼ê³¼ .env íŒŒì¼ ìƒì„±
í™ˆ(/ubuntu/home)ì— docker-compose.yml íŒŒì¼ê³¼ .env íŒŒì¼ì„ ìƒì„±í•œë‹¤.
```bash
$ vi docker-compose.yml
$ vi .env
```
ë‚´ìš©ì€ ì¸í…”ë¦¬ì œì´ì—ì„œ ë³µë¶™í•˜ì.<br><br>
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-03 á„‹á…©á„’á…® 7 14 07](https://github.com/minju412/jenkins-test/assets/59405576/7bad0468-ec07-42f6-8af0-cd8b2c35ad18)


### ì´ë¯¸ì§€ pull & ì»¨í…Œì´ë„ˆ ì‹¤í–‰
```bash
$ docker login -u ln8847 # ë„ì»¤í—ˆë¸Œ ë¡œê·¸ì¸

$ docker-compose -f docker-compose.yml pull # ì´ë¯¸ì§€ pull

$ docker-compose -f docker-compose.yml up -d # ë°°í¬
```

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-03 á„‹á…©á„’á…® 7 18 56](https://github.com/minju412/jenkins-test/assets/59405576/7a13dbed-d03d-4d9e-a7d4-ee9db3172938)

# +) ì¶”ê°€
## ì½”ë“œë¥¼ ìˆ˜ì •í–ˆë‹¤ë©´?
```bash
# ì¸í…”ë¦¬ì œì´ì—ì„œ
$ ./gradlew build jar -x test # jar íŒŒì¼ ë¹Œë“œ
$ docker-compose -f docker-compose.yml build
$ docker login -u ln8847 # í•´ë‹¹ ì»¤ë§¨ë“œ ì‹¤í–‰ í›„ Password ì…ë ¥
$ docker-compose push

# ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ
$ docker login -u ln8847 # ë„ì»¤í—ˆë¸Œ ë¡œê·¸ì¸
$ docker-compose -f docker-compose.yml pull # ì´ë¯¸ì§€ pull
$ docker-compose -f docker-compose.yml up -d
```

ê·¸ëŸ°ë° ë°°í¬ ê³¼ì •ì´ ê·€ì°®ë‹¤.. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ ë°˜ë³µë˜ëŠ” ê³¼ì •ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤!

# ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ë° ì‹¤í–‰

## ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ë„ì»¤ í—ˆë¸Œ í‘¸ì‹œë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ (ì¸í…”ë¦¬ì œì´ì—ì„œ)
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-06 á„‹á…©á„’á…® 1 27 44](https://github.com/minju412/jenkins-test/assets/59405576/e1eb3092-ddf4-4a78-a437-34e90eb91cee)

### ì‘ì„±
```sh
echo "> jar íŒŒì¼ ë¹Œë“œ"
./gradlew build jar -x test

echo "> docker-compose.yml ì„ ì´ìš©í•´ ì´ë¯¸ì§€ ë¹Œë“œ"
docker-compose -f docker-compose.yml build

echo "> ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸"
docker login --username=${USERNAME} --password=${PASSWORD}

echo "> ë„ì»¤ í—ˆë¸Œ ì´ë¯¸ì§€ push"
docker-compose push
```
### ì‹¤í–‰
```bash
$ chmod +x ./script/docker-image-push.sh # ê¶Œí•œ ë¶€ì—¬ (ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± í›„ ì²˜ìŒ í•œ ë²ˆë§Œ í•˜ë©´ëœë‹¤!)
$ ./script/docker-image-push.sh # ì‹¤í–‰
```

## ë°°í¬ë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ (ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ)
![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-06 á„‹á…©á„’á…® 1 28 33](https://github.com/minju412/jenkins-test/assets/59405576/f476c277-d586-489f-b2b3-eb846c0f89b0)

### ì‘ì„±
```bash
$ vi deploy.sh
```
```sh
echo "> ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸"
docker login --username=${USERNAME} --password=${PASSWORD}

echo "> ì´ë¯¸ì§€ pull"
docker-compose -f docker-compose.yml pull

echo "> ë°°í¬"
docker-compose -f docker-compose.yml up -d
```

ì´ì œ ì½”ë“œ ìˆ˜ì • í›„ ë„ì»¤ í—ˆë¸Œì— í‘¸ì‹œí•œ ë’¤, ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œëŠ” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰í•˜ë©´ ëœë‹¤!


### ì‹¤í–‰
```bash
$ chmod +x ./deploy.sh # ê¶Œí•œ ë¶€ì—¬ (ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± í›„ ì²˜ìŒ í•œ ë²ˆë§Œ í•˜ë©´ëœë‹¤!)
$ ./deploy.sh # ì‹¤í–‰
```

# +) ì´ì œ ì½”ë“œë¥¼ ìˆ˜ì •í–ˆë‹¤ë©´ ì•„ë˜ì²˜ëŸ¼ í•˜ë©´ ëœë‹¤!
```bash
# ì¸í…”ë¦¬ì œì´ì—ì„œ
$ ./script/docker-image-push.sh

# ìš°ë¶„íˆ¬ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ
$ ./deploy.sh # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
```




***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}