---
title:  "젠킨스와 소나큐브 연동하기"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-03-16 18:00:48
last_modified_at: 2023-03-16 18:00:51
---


> [이 글](https://minju412.github.io/devlog/21/)에서 젠킨스를 도입해보았다. 이번에는 젠킨스와 소나큐브를 연동하여 정적 검사를 통해 코드 품질을 향상시켜보자.


# 1. SonarQube 설치하기 (with. Docker Compose)

> [이 글](https://gblee1987.tistory.com/105)을 참고했다.

설치 순서는 아래와 같다.
1. AWS EC2에 `docker-compose`를 먼저 설치한다.
2. 이후 `docker-compose.yml` 파일을 이용해 sonarqube를 구동한다. (docker는 미리 설치되어 있다고 가정)
3. sonar rule 세팅은 하지 않는다.
4. default ID/Password는 `admin`/`admin` 이다.

## 1) 폴더 만들기
우분투 인스턴스에 접속해서 진행한다.<br>
`docker` 폴더 생성 후(나는 젠킨스를 도커컴포즈를 통해 실행하고 있기 때문에 이미 만들어져 있었다) 그 안에 `sonarqube` 폴더를 만들자.<br><br>
그리고 `sonarqube` 폴더 안에 `docker-compose.yml`을 생성하자.<br>
폴더 구조는 아래와 같다.
```
docker
⎿ sonarqube
 ⎿ docker-compose.yml
```

## 2) docker compose 작성
```yml
version: "2"

services:
  sonarqube:
    image: sonarqube:lts
    container_name: sonarqube
    ports:
      - "9000:9000"
    ulimits:
      nofile:
        soft: "262144"
        hard: "262144"
    networks:
      - sonarnet
    environment:
      - sonar.jdbc.url=jdbc:postgresql://db:5432/sonar
    volumes:
      - sonarqube_conf:/opt/sonarqube/conf
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs

  db:
    image: postgres
    container_name: postgres_sonar
    ports:
      - "5432:5432"
    networks:
      - sonarnet
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
    volumes:
      - postgresql:/var/lib/postgresql
      - postgresql_data:/var/lib/postgresql/data

networks:
  sonarnet:
    driver: bridge

volumes:
  sonarqube_conf:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql:
  postgresql_data:
```

- sonarqube와 db라는 서비스 (도커 컨테이너)로 구성되고 이들간은 bridge모드로 네트워크를 서로 연결한다. (db:5432/sonar 로 요청가능한 이유가 이것임)
- ulimits 이하 부분이 없으면 기동시에 `max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]` 등과 같은 오류가 발생할 수 있다.
  - (호스트 서버) root로 해당 파일을 오픈한다.<br>(당장 적용은 CLI에서 sudo sysctl -w vm.max_map_count=262144 )
  ```
  vi /etc/sysctl.conf
  # 아래 내용 추가
  vm.max_map_count=262144
  ```

  - (docker-compose.yml) 아래 내용 추가
  ```
  ulimits:
    nofile:
      soft: "262144"
      hard: "262144"
  ```

- AWS EC2위에서 셋업했으므로 Security Group에서 `9000` 포트를 오픈한다.<br>
(DB 접속 필요시 `5432` 포트도 오픈)


## 3) SonarQube 실행
```bash
$ docker-compose up -d
```

## 4) 브라우저 접속
`http://[EC2_IP]:9000`으로 접속하면 아래와 같은 화면이 뜬다.<br>
<img width="727" alt="스크린샷 2023-03-16 오후 10 36 30" src="https://user-images.githubusercontent.com/59405576/225633966-14d1f6fe-c075-4722-9010-e2e0a3819bdd.png"><br>

초기에는 `ID`와 `Password` 모두 `admin`이다.<br>
비밀번호 변경 후 로그인하면 아래와 같은 화면이 나온다.<br>
<img width="1379" alt="스크린샷 2023-03-16 오후 10 40 14" src="https://user-images.githubusercontent.com/59405576/225634949-a525dd1c-a8ed-4c28-9710-d0696411727c.png">



# 2. Jenkins와 연동하기












***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}