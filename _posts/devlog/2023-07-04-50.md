---
title:  "[S3] s3ì— ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸(List) ì—…ë¡œë“œí•˜ê¸° "
# excerpt: "sprintfì— ëŒ€í•´ ì•Œì•„ë³´ì"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-07-04 17:30:13
last_modified_at: 2023-07-04 17:30:16
---

[ì´ì „ ê¸€](https://minju412.github.io/s3/2/)ì€ ì´ë¯¸ì§€ í•˜ë‚˜ë¥¼ ì—…ë¡œë“œ í•  ìˆ˜ ìˆëŠ” apië¥¼ êµ¬í˜„í–ˆë‹¤.<br>
ì´ë²ˆì—ëŠ” ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸(`List<MultipartFile>`)ë¥¼ ì—…ë¡œë“œ í•  ìˆ˜ ìˆë„ë¡ ë³€ê²½í•´ë³´ì.<br><br>
ìš°ì„ , ê¸°ì¡´ì— ì‘ì„±í•œ `ImageService.java`ì™€ `S3Uploader.java`ëŠ” ì‚­ì œí•˜ì˜€ë‹¤.

# ì½”ë“œ ìˆ˜ì •

## S3Service ì‘ì„±
```java
public class S3Service {
    List<String> uploadImage(List<MultipartFile> multipartFile, String dirName, Post post);
}
```

## S3ServiceImpl ì‘ì„±
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class S3ServiceImpl implements S3Service {

    private final AmazonS3Client amazonS3Client;
    private final ImageRepository imageRepository;

    @Value("${cloud.aws.s3.bucket}")
    public String bucket;

    // s3ì— íŒŒì¼ ì—…ë¡œë“œ
    public List<String> uploadImage(List<MultipartFile> multipartFile, String dirName, Post post) {

        List<String> fileNameList = new ArrayList<>();
        List<String> imageUrl = new ArrayList<>();

        // forEach êµ¬ë¬¸ì„ í†µí•´ multipartFile ë¡œ ë„˜ì–´ì˜¨ íŒŒì¼ë“¤ í•˜ë‚˜ì”© fileNameList ì— ì¶”ê°€
        multipartFile.forEach(file -> {

            String fileName = createFileName(file.getOriginalFilename(), dirName);

            ObjectMetadata objectMetadata = new ObjectMetadata();
            objectMetadata.setContentLength(file.getSize());
            objectMetadata.setContentType(file.getContentType());

            // S3ë¡œ ì—…ë¡œë“œ
            try (InputStream inputStream = file.getInputStream()) {
                amazonS3Client.putObject(new PutObjectRequest(bucket, fileName, inputStream, objectMetadata)
                    .withCannedAcl(CannedAccessControlList.PublicRead));

            } catch (IOException e) {
                throw new CustomException(FILE_CAN_NOT_UPLOAD);
            }

            imageUrl.add(amazonS3Client.getUrl(bucket, fileName).toString());
            fileNameList.add(fileName);
        });

        try {
            saveUrl(imageUrl, post);
        } catch (IOException e) {
            e.printStackTrace();
        }

        return fileNameList;
    }

    // dbì— uri ì €ì¥
    public void saveUrl(List<String> imageUrls, Post post) throws IOException {

        for (String imageUrl : imageUrls) {

            Image img = new Image();
            img.setImgurl(imageUrl);
            img.setPost(post);

            imageRepository.save(img);
        }
    }

    private String createFileName(String originalName, String dirName) {
        return dirName + "/" + UUID.randomUUID() + originalName;
    }
}
```

## BoardController ìˆ˜ì •
```java
@RequiredArgsConstructor
@RestController
@RequestMapping
    ("/board")
@Slf4j
public class BoardController {

    private final PostService postService;
    private final S3Service s3Service;

    @ApiOperation(value = "ê²Œì‹œê¸€ ë“±ë¡", notes = "Amazon S3ì— íŒŒì¼ ì—…ë¡œë“œ")
    @PostMapping(value = "/save", consumes = {MediaType.APPLICATION_JSON_VALUE, MediaType.MULTIPART_FORM_DATA_VALUE})
    public Response uploadFile(@RequestPart @Valid PostSaveReqDto requestDto,
        @ApiParam("íŒŒì¼ë“¤ (ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥)") @RequestPart(required = false) List<MultipartFile> multipartFile) {

        Post post = postService.save(requestDto);
        if (multipartFile != null) {
            s3Service.uploadImage(multipartFile, "test2", post);
        }

        return new Response("OK", "ê²Œì‹œê¸€ ë“±ë¡ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤");
    }
}
```
`uploadImage` ë©”ì†Œë“œì˜ ë‘ë²ˆì§¸ íŒŒë¼ë¯¸í„° (ìœ„ì˜ ì˜ˆì‹œì—ì„œëŠ” `test2`)ì˜ ì´ë¦„ì— ë”°ë¼ S3 bucket ë‚´ë¶€ì— ì´ë¯¸ì§€ë¥¼ ë‹´ì„ í•´ë‹¹ ì´ë¦„ì˜ directoryê°€ ìƒì„±ëœë‹¤.<br>

# í¬ìŠ¤íŠ¸ë§¨ í…ŒìŠ¤íŠ¸

<img width="1247" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-25 á„‹á…©á„Œá…¥á†« 12 08 01" src="https://user-images.githubusercontent.com/59405576/186454517-1ff8816f-efbd-48ba-af7d-4f0d314e484f.png"><br>

`KEY`ì—ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì˜ `uploadFile`ì˜ íŒŒë¼ë¯¸í„° ì´ë¦„(`requestDto`ì™€ `multipartFile`)ì„ ì‘ì„±í•´ì£¼ê³ ,<br> 
`VALUE`ì—ëŠ” ê²Œì‹œê¸€ ë‚´ìš©(`TEXT`)ê³¼ ì´ë¯¸ì§€ íŒŒì¼(`FILE`)ì„ ì²¨ë¶€í•˜ëŠ” ê²ƒê¹Œì§€ëŠ” ì´ì „ê³¼ ê°™ë‹¤.<br>
í•˜ì§€ë§Œ ì´ë¯¸ì§€(`multipartFile`)ì˜ `CONTENT TYPE`ì—ëŠ” ìœ„ ì‚¬ì§„ê³¼ ê°™ì´ ê°’ì„ ì§‘ì–´ë„£ì§€ ì•Šì•„ë„ ëœë‹¤.<br><br>
<img width="1354" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-25 á„‹á…©á„Œá…¥á†« 12 08 25" src="https://user-images.githubusercontent.com/59405576/186454983-92cbef28-d9d9-4271-97ae-a54652be8c21.png"><br>
AWS S3ì— ë‹¤ìŒê³¼ ê°™ì´ ë‘ ê°œì˜ íŒŒì¼ì´ ì˜¬ë¼ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br><br>
<img width="649" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-08-25 á„‹á…©á„Œá…¥á†« 12 09 28" src="https://user-images.githubusercontent.com/59405576/186455019-81c8cb68-a9d3-4835-9a4d-1f35281f70be.png"><br>

ë˜í•œ, mysql dbì˜ `Image` í…Œì´ë¸”ì—ë„ ë‘ ê°œì˜ ì»¬ëŸ¼ì´ ì¶”ê°€ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤!ğŸ˜ƒ




# Ref.
- [https://earth-95.tistory.com/117](https://earth-95.tistory.com/117)

***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}