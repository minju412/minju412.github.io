---
title:  "ì˜ˆì™¸ ì²˜ë¦¬ í•˜ê¸° (exception handling)"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-03-03 13:07:24
last_modified_at: 2023-03-03 13:07:30
---

# ê°œë…
> [ì´ ê¸€](https://www.woolog.dev/backend/spring-boot/spring-boot-exception-handling-basic/#exceptionhandler)ì„ ì°¸ê³ í–ˆë‹¤.

## `@ControllerAdvice` & `@RestControllerAdvice` ë€?
`@Controller`ë‚˜ `@RestController`ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ê³  ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ë‹¤. <br>
`@Advice` ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ í´ë˜ìŠ¤ëŠ”, Exceptionì´ ë‚˜ëŠ” ëª¨ë“  ê²½ìš°ì— ê±°ì³ê°„ë‹¤. 

## `@ExceptionHandler` ë€?
ëª¨ë“  ì—ëŸ¬ê°€ ê·¸ìª½ìœ¼ë¡œ Catchë  ìˆ˜ ìˆëŠ” ì²˜ë¦¬ë¥¼ í•´ ì£¼ëŠ” ê¸°ëŠ¥ì´ë‹¤<br>
<img width="935" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-03 á„‹á…©á„’á…® 4 33 05" src="https://user-images.githubusercontent.com/59405576/222659249-6bc68a31-9358-4641-9133-5fd70aa45524.png">


# í”„ë¡œì íŠ¸ì— ì ìš©
> [ì´ ê¸€](https://samtao.tistory.com/42)ì„ ì°¸ê³ í–ˆë‹¤.

ìœ„ì˜ `@RestControllerAdvice`ì™€ `@ExceptionHandler`ë¥¼ ì‚¬ìš©í•´ì„œ Exceptionì„ ì²˜ë¦¬ í•´ ë³´ë„ë¡ í•˜ì<br><br>
ì ìš©í•˜ëŠ” ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
1. ì—ëŸ¬ì½”ë“œ ì •ë¦¬ enum í´ë˜ìŠ¤ë¡œ ì‘ì„±
2. ì˜ˆì™¸ì— ëŒ€í•œ ì‘ë‹µ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” í´ë˜ìŠ¤ ì‘ì„±
3. ì‚¬ìš©ì ì •ì˜ Exception í´ë˜ìŠ¤ ì‘ì„±
4. Exception ë°œìƒì‹œ ì „ì—­ìœ¼ë¡œ ì²˜ë¦¬í•  exception handler ì‘ì„±
5. ì¼ê¸° ì¡°íšŒ ì„œë¹„ìŠ¤ì—ì„œ exception handling
6. api ì‹¤í–‰ ë° exception ê²°ê³¼ í™•ì¸

## 1. ì—ëŸ¬ì½”ë“œ ì •ë¦¬ enum í´ë˜ìŠ¤ë¡œ ì‘ì„±
`ErrorCode`
```java
@Getter
@AllArgsConstructor
public enum ErrorCode {

    /* 400 BAD_REQUEST : ì˜ëª»ëœ ìš”ì²­ */
    CONSTRAINT_VIOLATION(HttpStatus.BAD_REQUEST, "ì œì•½ ì¡°ê±´ì„ ìœ„ë°°í•œ ìš”ì²­ì…ë‹ˆë‹¤ (constraint violation)"),
    METHOD_ARG_NOT_VALID(HttpStatus.BAD_REQUEST, "ì œì•½ ì¡°ê±´ì„ ìœ„ë°°í•œ ìš”ì²­ì…ë‹ˆë‹¤ (method argument not valid)"),
    STAMP_LIST_SIZE_ERROR(HttpStatus.BAD_REQUEST, "ìµœëŒ€ 3ê°œì˜ ìŠ¤íƒ¬í”„ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"),
    INVALID_FILE_ERROR(HttpStatus.BAD_REQUEST, "í™•ì¥ìê°€ jpg, jpeg, png ì¸ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤."),

    /* 404 NOT_FOUND : Resource ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ */
    USER_NOT_FOUND(HttpStatus.NOT_FOUND, "íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    DIARY_NOT_FOUND(HttpStatus.NOT_FOUND, "ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    PET_NOT_FOUND(HttpStatus.NOT_FOUND, "ë°˜ë ¤ ë™ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),
    STAMP_NOT_FOUND(HttpStatus.NOT_FOUND, "ìŠ¤íƒ¬í”„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"),

    /* 500 INTERNAL_SERVER_ERROR : ì„œë²„ ì—ëŸ¬ */
    INTERNAL_SERVER_ERROR(HttpStatus.INTERNAL_SERVER_ERROR, "ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."),
    FILE_CAN_NOT_UPLOAD(HttpStatus.INTERNAL_SERVER_ERROR, "íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),
    FILE_CAN_NOT_DELETE(HttpStatus.INTERNAL_SERVER_ERROR, "íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),

    ;

    private final HttpStatus httpStatus;
    private final String message;

}
```

## 2. ì˜ˆì™¸ì— ëŒ€í•œ ì‘ë‹µ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” í´ë˜ìŠ¤ ì‘ì„±
`ErrorResponse`
```java
@Getter
@Builder
public class ErrorResponse {
    private final String error;
    private final String message;

    public static ResponseEntity<ErrorResponse> toResponseEntity(ErrorCode errorCode) {
        return ResponseEntity
            .status(errorCode.getHttpStatus())
            .body(ErrorResponse.builder()
                .error(errorCode.getHttpStatus().name())
                .message(errorCode.getMessage())
                .build()
            );
    }

    public static ResponseEntity<ErrorResponse> toResponseEntity(ErrorCode errorCode, String defaultMessage) {
        return ResponseEntity
            .status(errorCode.getHttpStatus())
            .body(ErrorResponse.builder()
                .error(errorCode.getHttpStatus().name())
                .message(defaultMessage)
                .build()
            );
    }
}
```

## 3. ì‚¬ìš©ì ì •ì˜ Exception í´ë˜ìŠ¤ ì‘ì„±
`CustomException`
```java
@Getter
@AllArgsConstructor
public class CustomException extends RuntimeException {
    private final ErrorCode errorCode;
}
```

## 4. Exception ë°œìƒì‹œ ì „ì—­ìœ¼ë¡œ ì²˜ë¦¬í•  exception handler ì‘ì„±
`GlobalExceptionHandler`
```java
@RestControllerAdvice
public class GlobalExceptionHandler {

  // ëª¨ë“  ì˜ˆì™¸ë¥¼ í•¸ë“¤ë§í•˜ì—¬ ErrorResponse í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•œë‹¤.
    @ExceptionHandler(Exception.class) // âœ…
    protected ResponseEntity<ErrorResponse> handleAllException(Exception ex) {
        log.error("handleAllException throw Exception : {}", ex.getClass().getName());
        return ErrorResponse.toResponseEntity(INTERNAL_SERVER_ERROR);
    }

    // @Valid ê²€ì¦ ì‹¤íŒ¨ ì‹œ Catch
    @ExceptionHandler(MethodArgumentNotValidException.class) // âœ…
    protected Object handleMethodArgumentNotValidException(MethodArgumentNotValidException ex) {
        String defaultMessage = Objects.requireNonNull(ex.getBindingResult().getFieldError()).getDefaultMessage();
        return ErrorResponse.toResponseEntity(METHOD_ARG_NOT_VALID, defaultMessage);
    }

    // ì œì•½ ì¡°ê±´ ìœ„ë°° ì‹œ Catch
    @ExceptionHandler(value = {ConstraintViolationException.class, DataIntegrityViolationException.class}) // âœ…
    protected ResponseEntity<ErrorResponse> handleDataException() {
        log.error("handleDataException throw Exception : {}", CONSTRAINT_VIOLATION);
        return ErrorResponse.toResponseEntity(CONSTRAINT_VIOLATION);
    }

    // CustomException ì„ ìƒì†ë°›ì€ í´ë˜ìŠ¤ê°€ ì˜ˆì™¸ë¥¼ ë°œìƒ ì‹œí‚¬ ì‹œ, Catch í•˜ì—¬ ErrorResponse ë¥¼ ë°˜í™˜í•œë‹¤.
    @ExceptionHandler(CustomException.class) // âœ…
    protected ResponseEntity<ErrorResponse> handleCustomException(CustomException ex) {
        log.error("handleCustomException throw CustomException : {}", ex.getErrorCode());
        return ErrorResponse.toResponseEntity(ex.getErrorCode());
    }
}
```
- REST APIì— ë§ê²Œ, `@RestControllerAdvice` ë¥¼ ì‚¬ìš©í–ˆê³ , `@ExceptionHandler` ë¥¼ ì ìš©í•˜ì—¬ Exceptionì„ ë°›ì„ ê°ì²´ë¼ëŠ”ê²ƒì„ ëª…ì‹œí–ˆë‹¤.
- í•¨ìˆ˜ ì¸ìë¡œ Exceptionì„ ë°›ì•„ í•´ë‹¹í•˜ëŠ” Exception ì²˜ë¦¬ë¥¼ ë‹¤ë£° ìˆ˜ ìˆë„ë¡ í–ˆë‹¤.
- ìœ„ ì½”ë“œëŠ” `MethodArgumentNotValidException`, `ConstraintViolationException`, `DataIntegrityViolationException`, `CustomException` ê¹Œì§€<br>ì´ ë„¤ ê°œì˜ exception ì— ëŒ€í•œ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•´ì£¼ì—ˆë‹¤.
  - `ex.getClass().getName()` ì„ ì¶œë ¥í•´ë³´ë©´ í˜„ì¬ì˜ Exceptionì´ ì–´ë–¤ Exceptionì¸ì§€ ì•Œ ìˆ˜ ìˆì–´ì„œ, í•´ë‹¹í•˜ëŠ” ë‚´ì—­ì— ë”°ë¼ ë”°ë¡œ ì²˜ë¦¬ í•´ ì¤„ ìˆ˜ ìˆë‹¤.

## 5. ì¼ê¸° ì¡°íšŒ ì„œë¹„ìŠ¤ì—ì„œ exception handling

`DiaryServiceImpl`ì—ì„œ ë‹¨ê±´ ì¼ê¸°ë¥¼ ì¡°íšŒí•  ë•Œ, <br>
ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì¼ê¸°ë¥¼ ì¡°íšŒí•˜ë ¤ê³  í•  ê²½ìš° `CustomException`ì„ ë°œìƒì‹œí‚¤ë©°,<br>
`GlobalExceptionHandler`ì—ì„œ í•´ë‹¹ exceptionì„ ìºì¹˜í•´ì„œ ì ì ˆí•œ ì—ëŸ¬ì‘ë‹µì„ ìƒì„±í•´ì„œ jsonê²°ê³¼ë¥¼ ë‚´ë ¤ì¤€ë‹¤.

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class DiaryServiceImpl implements DiaryService {
    @Override
    @Transactional
    public DiaryDetailResDto getDetailedDiary(Long diaryId) {
        Diary diary = diaryRepository.findById(diaryId)
                .orElseThrow(() -> new CustomException(DIARY_NOT_FOUND)); // âœ…
        return new DiaryDetailResDto(diary);
    }

    ...
}
```

## 6. api ì‹¤í–‰ ë° exception ê²°ê³¼ í™•ì¸
ë§Œì•½, ì¡´ì¬í•˜ì§€ ì•ŠëŠ” 100ë²ˆì§¸ ì¼ê¸°ë¥¼ ì¡°íšŒí•˜ë ¤ê³  ì‹œë„í•œë‹¤ë©´?<br>
<img width="700" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-03-03 á„‹á…©á„’á…® 1 56 34" src="https://user-images.githubusercontent.com/59405576/222634955-dbde9578-ea9c-4422-bfd5-cbab335b20f1.png"><br>
ìœ„ì™€ ê°™ì´ ì§ì ‘ ì •ì˜í•œ exceptionì´ ë°œìƒí•œë‹¤.







***
<br>


    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}