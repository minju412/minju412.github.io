---
title:  "예외 처리 하기 (exception handling)"

categories:
  - Devlog
tags:
  - [Devlog]

toc: true
toc_sticky: true
 
date: 2023-03-03 13:07:24
last_modified_at: 2023-03-03 13:07:30
---

> [이 글](https://samtao.tistory.com/42)을 참고했다.

스프링부트에서 exception을 처리하는 방법을 알아보자<br><br>
순서는 다음과 같다
1. 에러코드 정리 enum 클래스로 작성
2. Exception 발생시 응답하는 에러 정보 클래스 작성
3. 사용자 정의 Exception 클래스 작성
4. Exception 발생시 전역으로 처리할 exception handler 작성
5. 일기 조회 서비스에서 exception handling
6. api 실행 및 exception 결과 확인


## 1. 에러코드 정리 enum 클래스로 작성
`ErrorCode`
```java
@Getter
@AllArgsConstructor
public enum ErrorCode {

    /* 400 BAD_REQUEST : 잘못된 요청 */
    CONSTRAINT_VIOLATION(HttpStatus.BAD_REQUEST, "제약 조건을 위배한 요청입니다 (constraint violation)"),
    METHOD_ARG_NOT_VALID(HttpStatus.BAD_REQUEST, "제약 조건을 위배한 요청입니다 (method argument not valid)"),
    STAMP_LIST_SIZE_ERROR(HttpStatus.BAD_REQUEST, "최대 3개의 스탬프를 선택할 수 있습니다"),
    INVALID_FILE_ERROR(HttpStatus.BAD_REQUEST, "확장자가 jpg, jpeg, png 인 파일만 업로드 가능합니다."),

    /* 404 NOT_FOUND : Resource 를 찾을 수 없음 */
    USER_NOT_FOUND(HttpStatus.NOT_FOUND, "회원을 찾을 수 없습니다"),
    DIARY_NOT_FOUND(HttpStatus.NOT_FOUND, "일기를 찾을 수 없습니다"),
    PET_NOT_FOUND(HttpStatus.NOT_FOUND, "반려 동물을 찾을 수 없습니다"),
    STAMP_NOT_FOUND(HttpStatus.NOT_FOUND, "스탬프를 찾을 수 없습니다"),

    /* 500 INTERNAL_SERVER_ERROR : 서버 에러 */
    FILE_CAN_NOT_UPLOAD(HttpStatus.INTERNAL_SERVER_ERROR, "파일 업로드에 실패했습니다."),
    FILE_CAN_NOT_DELETE(HttpStatus.INTERNAL_SERVER_ERROR, "파일 삭제에 실패했습니다."),

    ;

    private final HttpStatus httpStatus;
    private final String message;

}
```

## 2. Exception 발생시 응답하는 에러 정보 클래스 작성
`ErrorResponse`
```java
@Getter
@Builder
public class ErrorResponse {
    private final String error;
    private final String message;

    public static ResponseEntity<ErrorResponse> toResponseEntity(ErrorCode errorCode) {
        return ResponseEntity
            .status(errorCode.getHttpStatus())
            .body(ErrorResponse.builder()
                .error(errorCode.getHttpStatus().name())
                .message(errorCode.getMessage())
                .build()
            );
    }

    public static ResponseEntity<ErrorResponse> toResponseEntity(ErrorCode errorCode, String defaultMessage) {
        return ResponseEntity
            .status(errorCode.getHttpStatus())
            .body(ErrorResponse.builder()
                .error(errorCode.getHttpStatus().name())
                .message(defaultMessage)
                .build()
            );
    }
}
```

## 3. 사용자 정의 Exception 클래스 작성
`CustomException`
```java
@Getter
@AllArgsConstructor
public class CustomException extends RuntimeException {
    private final ErrorCode errorCode;
}
```

## 4. Exception 발생시 전역으로 처리할 exception handler 작성
`GlobalExceptionHandler`
```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(MethodArgumentNotValidException.class)
    protected Object handleMethodArgumentNotValidException(MethodArgumentNotValidException ex,
        HttpServletRequest request) {
        String defaultMessage = Objects.requireNonNull(ex.getBindingResult().getFieldError()).getDefaultMessage();
        return ErrorResponse.toResponseEntity(METHOD_ARG_NOT_VALID, defaultMessage);
    }

    @ExceptionHandler(value = {ConstraintViolationException.class, DataIntegrityViolationException.class})
    protected ResponseEntity<ErrorResponse> handleDataException() {
        log.error("handleDataException throw Exception : {}", CONSTRAINT_VIOLATION);
        return ErrorResponse.toResponseEntity(CONSTRAINT_VIOLATION);
    }

    @ExceptionHandler(CustomException.class)
    protected ResponseEntity<ErrorResponse> handleCustomException(CustomException e) {
        log.error("handleCustomException throw CustomException : {}", e.getErrorCode());
        return ErrorResponse.toResponseEntity(e.getErrorCode());
    }
}
```

## 5. 일기 조회 서비스에서 exception handling

`DiaryServiceImpl`에서 단건 일기를 조회할 때, <br>
존재하지 않는 일기를 조회하려고 할 경우 `CustomException`을 발생시키며<br>
`GlobalExceptionHandler`에서 해당 exception을 캐치해서 적절한 에러응답을 생성해서 json결과를 내려준다.

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class DiaryServiceImpl implements DiaryService {
    @Override
    @Transactional
    public DiaryDetailResDto getDetailedDiary(Long diaryId) {
        Diary diary = diaryRepository.findById(diaryId)
                .orElseThrow(() -> new CustomException(DIARY_NOT_FOUND)); // ✅
        return new DiaryDetailResDto(diary);
    }

    ...
}
```

## 6. api 실행 및 exception 결과 확인
만약, 존재하지 않는 100번째 일기를 조회하려고 시도한다면?<br>
<img width="700" alt="스크린샷 2023-03-03 오후 1 56 34" src="https://user-images.githubusercontent.com/59405576/222634955-dbde9578-ea9c-4422-bfd5-cbab335b20f1.png"><br>
위와 같이 직접 정의한 exception이 발생한다.







***
<br>


    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}