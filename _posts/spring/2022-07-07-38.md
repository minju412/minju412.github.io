---
title:  "[SPRING] JDBC를 사용한 애플리케이션 "

categories:
  - Spring
tags:
  - [Framework, Spring, Java]

toc: true
toc_sticky: true
 
date: 2022-07-07 15:01:00
last_modified_at: 2022-07-07 15:01:03
---

# 1. 회원(Member) 등록
JDBC를 사용해서 회원( `Member` ) 데이터를 데이터베이스에 관리하는 기능을 개발해보자.

> 주의 🚨<br>
H2 데이터베이스 설정 마지막에 있는 테이블과 샘플 데이터 만들기를 통해서 member 테이블을 미리 만들어두어야 한다.

## 등록

### `Member`
`src/main/java/hello/jdbc/domain/Member.java`
```java
@Data
public class Member {

    private String memberId;
    private int money;

    public Member() {
    }

    public Member(String memberId, int money) {
        this.memberId = memberId;
        this.money = money;
    }
}
```
회원의 ID와 해당 회원이 소지한 금액을 표현하는 단순한 클래스이다. <br>
앞서 만들어둔 member 테이블에 데이터를 저장하고 조회할 때 사용한다.

### `MemberRepositoryV0` - 회원 등록
`src/main/java/hello/jdbc/repository/MemberRepositoryV0.java`<br>
JDBC를 사용해서 이렇게 만든 회원 객체를 데이터베이스에 저장해보자.
```java
/**
 * JDBC - DriverManager 사용
 */
@Slf4j
public class MemberRepositoryV0 {

    public Member save(Member member) throws SQLException {

        String sql = "insert into member(member_id, money) values(?, ?)";

        Connection con = null;
        PreparedStatement pstmt = null;

        try{
            con = getConnection();
            pstmt = con.prepareStatement(sql);

            pstmt.setString(1, member.getMemberId());
            pstmt.setInt(2, member.getMoney());
            pstmt.executeUpdate(); // 쿼리 실행

            return member;

        } catch (SQLException e){
            log.error("db error", e);
            throw e;
        } finally {
            close(con, pstmt, null);
        }

    }

    private void close(Connection con, Statement stmt, ResultSet rs){

        if(rs != null){
            try {
                rs.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }

        if(stmt != null){
            try {
                stmt.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }

        if(con != null){
            try {
                con.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }
    }

    private Connection getConnection() {
        return DBConnectionUtil.getConnection();
    }
}
```

#### 커넥션 획득
`getConnection()` : 이전에 만들어둔 `DBConnectionUtil` 를 통해서 데이터베이스 커넥션을 획득한다.

#### save() - SQL 전달
- `sql` : 데이터베이스에 전달할 SQL을 정의한다. 여기서는 데이터를 등록해야 하므로 `insert sql` 을 준비했다.
- `con.prepareStatement(sql)` : 데이터베이스에 전달할 SQL과 파라미터로 전달할 데이터들을 준비한다.<br>
• `sql` : `insert into member(member_id, money) values(?, ?)"`<br>
• `pstmt.setString(1, member.getMemberId())` : SQL의 첫번째 `?` 에 값을 지정한다. 문자이므로 `setString` 을 사용한다.<br>
• `pstmt.setInt(2, member.getMoney())` : SQL의 두번째 `?` 에 값을 지정한다. `Int` 형 숫자이므로 `setInt` 를 지정한다.
- `pstmt.executeUpdate()` : `Statement` 를 통해 준비된 SQL을 커넥션을 통해 실제 데이터베이스에 전달한다. <br>
참고로 `executeUpdate()` 은 `int` 를 반환하는데 영향받은 DB row 수를 반환한다. 여기서는 하나의 row를 등록했으므로 1을 반환한다.

#### executeUpdate()
```java
int executeUpdate() throws SQLException;
```

#### 리소스 정리
쿼리를 실행하고 나면 리소스를 정리해야 한다. <br>
여기서는 `Connection` , `PreparedStatement` 를 사용했다. 리소스를 정리할 때는 항상 역순으로 해야한다. <br>
`Connection` 을 먼저 획득하고 `Connection` 을 통해 `PreparedStatement` 를 만들었기 때문에 리소스를 반환할 때는 `PreparedStatement` 를 먼저 종료하고, 그 다음에 `Connection` 을 종료하면 된다. <br>
참고로 여기서 사용하지 않은 `ResultSet` 은 결과를 조회할 때 사용한다. 조금 뒤에 조회 부분에서 알아보자.

> 주의 🚨<br>
리소스 정리는 꼭! 해주어야 한다. 따라서 예외가 발생하든, 하지 않든 항상 수행되어야 하므로 `finally` 구문에 주의해서 작성해야한다. 

## 테스트
### MemberRepositoryV0Test - 회원 등록 테스트
`src/test/java/hello/jdbc/repository/MemberRepositoryV0Test.java`
```java
class MemberRepositoryV0Test {

    MemberRepositoryV0 repository = new MemberRepositoryV0();

    @Test
    void crud() throws SQLException {

        Member member = new Member("memberV0", 10000);
        repository.save(member);
    }
}
```

#### 실행 결과
데이터베이스에서 `select * from member` 쿼리를 실행하면 데이터가 저장된 것을 확인할 수 있다. <br>
<img width="176" alt="스크린샷 2022-07-07 오후 4 15 18" src="https://user-images.githubusercontent.com/59405576/177714272-8d2988d3-fde0-480c-a57b-291abb76b4ba.png">

> 참고<br>
이 테스트는 2번 실행하면 PK 중복 오류가 발생한다. 이 경우 `delete from member` 쿼리로 데이터를 삭제한 다음에 다시 실행하자.

# 2. 회원(Member) 조회
















***
<br>

    💛 개인 공부 기록용 블로그입니다. 👻

[맨 위로 이동하기](#){: .btn .btn--primary }{: .align-right}