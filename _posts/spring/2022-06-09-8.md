---
title:  "[SPRING] ìŠ¤ì½”í”„ì™€ Provider, í”„ë¡ì‹œ"

categories:
  - Spring
tags:
  - [Framework, Spring, Java]

toc: true
toc_sticky: true
 
date: 2022-06-09 01:42:46
last_modified_at: 2022-06-09 01:42:49
---

ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì•„ë˜ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤.
```
Error creating bean with name 'myLogger': Scope 'request' is not active for the current thread; 
consider defining a scoped proxy for this bean if you intend to refer to it from a singleton;
```
ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì‹œì ì— ì‹±ê¸€í†¤ ë¹ˆì€ ìƒì„±í•´ì„œ ì£¼ì…ì´ ê°€ëŠ¥í•˜ì§€ë§Œ, request ìŠ¤ì½”í”„ ë¹ˆì€ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠëŠ”ë‹¤.<br>
ì´ ë¹ˆì€ ì‹¤ì œ ê³ ê°ì˜ ìš”ì²­ì´ ì™€ì•¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤!<br><br>
Providerì™€ í”„ë¡ì‹œë¥¼ í†µí•´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ì.

# Provider
Providerë¥¼ í†µí•´ request scope ë¹ˆì˜ ìƒì„±ì„ ì§€ì—°í•  ìˆ˜ ìˆë‹¤.


## ì‚¬ìš© ì˜ˆì œ
`MyLogger.java`
```java
@Component
public class MyLogger {

    private String uuid;
    private String requestURL;

    public void setRequestURL(String requestURL) {
        this.requestURL = requestURL;
    }

    public void log(String message){
        System.out.println("[" + uuid + "]" + "[" + requestURL + "] " + message);
    }

    @PostConstruct // ì´ ë¹ˆì€ http ìš”ì²­ ë‹¹ í•˜ë‚˜ì”© ìƒì„±ë˜ë¯€ë¡œ, uuidë¥¼ ì €ì¥í•´ë‘ë©´ ë‹¤ë¥¸ http ìš”ì²­ê³¼ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.
    public void init(){
        uuid = UUID.randomUUID().toString(); // ìœ ë‹ˆí¬í•œ ëœë¤ uuid ìƒì„±
        System.out.println("[" + uuid + "] request scope bean create: " + this);
    }

    @PreDestroy
    public void close(){
        System.out.println("[" + uuid + "] request scope bean close: " + this);
    }
}
```

`LogDemoController.java`
```java
@Controller
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;
    private final ObjectProvider<MyLogger> myLoggerProvider; // ğŸŒŸ

    @RequestMapping("log-demo")
    @ResponseBody // view í™”ë©´ ì—†ì´ ë¬¸ì ë°˜í™˜
    public String logDemo(HttpServletRequest request){
        String requestURL = request.getRequestURL().toString(); // http request ì •ë³´ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.
         MyLogger myLogger = myLoggerProvider.getObject(); // ğŸŒŸ Provider -> http requestê°€ ë“¤ì–´ì™”ì„ ë•Œ í˜¸ì¶œ
        myLogger.setRequestURL(requestURL);

        myLogger.log("controller test");
        logDemoService.logic("testId");
        return "OK";
    }

}
```

`LogDemoService.java`
```java
@Service
@RequiredArgsConstructor
public class LogDemoService {

    private final ObjectProvider<MyLogger> myLoggerProvider; // ğŸŒŸ

    public void logic(String id) {
        MyLogger myLogger = myLoggerProvider.getObject(); // ğŸŒŸ Provider -> http requestê°€ ë“¤ì–´ì™”ì„ ë•Œ í˜¸ì¶œ
        myLogger.log("service id = " + id);
    }
}
```

- `ObjectProvider` ë•ë¶„ì— `ObjectProvider.getObject()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ê¹Œì§€ request scope ë¹ˆì˜ ìƒì„±ì„ ì§€ì—°í•  ìˆ˜ ìˆë‹¤.
- `ObjectProvider.getObject()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì—ëŠ” http ìš”ì²­ì´ ì§„í–‰ì¤‘ì´ë¯€ë¡œ request scope ë¹ˆì˜ ìƒì„±ì´ ì •ìƒ ì²˜ë¦¬ëœë‹¤.
- `ObjectProvider.getObject()`ë¥¼ `LogDemoController`, `LogDemoService`ì—ì„œ ê°ê° í•œë²ˆì”© ë”°ë¡œ í˜¸ì¶œí•´ë„ ê°™ì€ http ìš”ì²­ì´ë©´ ê°™ì€ ìŠ¤í”„ë§ ë¹ˆì´ ë°˜í™˜ëœë‹¤!

# í”„ë¡ì‹œ
ì´ë²ˆì—ëŠ” í”„ë¡ì‹œ ê°ì²´ë¥¼ ì‚¬ìš©í•´ë³´ì.

## ì‚¬ìš© ì˜ˆì œ
`MyLogger.java`
```java
@Component
@Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS) // ğŸŒŸ MyLoggerì˜ ê°€ì§œ í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ë‘ê³  http requestì™€ ìƒê´€ì—†ì´ ê°€ì§œ í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ë‹¤ë¥¸ ë¹ˆì— ë¯¸ë¦¬ ì£¼ì…í•´ ë‘˜ ìˆ˜ ìˆë‹¤.
public class MyLogger {

    private String uuid;
    private String requestURL;

    public void setRequestURL(String requestURL) {
        this.requestURL = requestURL;
    }

    public void log(String message){
        System.out.println("[" + uuid + "]" + "[" + requestURL + "] " + message);
    }

    @PostConstruct // ì´ ë¹ˆì€ http ìš”ì²­ ë‹¹ í•˜ë‚˜ì”© ìƒì„±ë˜ë¯€ë¡œ, uuidë¥¼ ì €ì¥í•´ë‘ë©´ ë‹¤ë¥¸ http ìš”ì²­ê³¼ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.
    public void init(){
        uuid = UUID.randomUUID().toString(); // ìœ ë‹ˆí¬í•œ ëœë¤ uuid ìƒì„±
        System.out.println("[" + uuid + "] request scope bean create: " + this);
    }

    @PreDestroy
    public void close(){
        System.out.println("[" + uuid + "] request scope bean close: " + this);
    }
}
```

`LogDemoController.java`
```java
@Controller
@RequiredArgsConstructor
public class LogDemoController {

    private final LogDemoService logDemoService;
    private final MyLogger myLogger;

    @RequestMapping("log-demo")
    @ResponseBody // view í™”ë©´ ì—†ì´ ë¬¸ì ë°˜í™˜
    public String logDemo(HttpServletRequest request){
        String requestURL = request.getRequestURL().toString(); // http request ì •ë³´ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.

        System.out.println("myLogger = " + myLogger.getClass()); // ê°€ì§œ í”„ë¡ì‹œ ê°ì²´(myLogger) ì¶œë ¥
        myLogger.setRequestURL(requestURL);

        myLogger.log("controller test");
        logDemoService.logic("testId");
        return "OK";
    }

}
```

`LogDemoService.java`
```java
@Service
@RequiredArgsConstructor
public class LogDemoService {

    private final MyLogger myLogger; // ì˜ì¡´ê´€ê³„ë¥¼ ì£¼ì…ë°›ëŠ”ë‹¤.

    public void logic(String id) {
        myLogger.log("service id = " + id);
    }
}
```

- ë‹¨ì§€ ì• ë…¸í…Œì´ì…˜ ì„¤ì • ë³€ê²½ë§Œìœ¼ë¡œ ì›ë³¸ ê°ì²´ë¥¼ í”„ë¡ì‹œ ê°ì²´ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤. ğŸ‘
- CGLIBë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë‚´ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì€ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ ì£¼ì…í•œë‹¤.
- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” ìš”ì²­ì´ ì˜¤ë©´ ê·¸ë•Œ ë‚´ë¶€ì—ì„œ ì§„ì§œ ë¹ˆì„ ìš”ì²­í•˜ëŠ” ìœ„ì„ ë¡œì§ì´ ë“¤ì–´ìˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ê°€ `myLogger.logic()`ì„ í˜¸ì¶œí•˜ë©´ ì‚¬ì‹¤ì€ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ì˜ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œ ê²ƒì´ë‹¤.
- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” request ìŠ¤ì½”í”„ì˜ ì§„ì§œ `myLogger.logic()`ì„ í˜¸ì¶œí•œë‹¤.
- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” ì›ë³¸ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì•„ì„œ ë§Œë“¤ì–´ì¡Œê¸° ë•Œë¬¸ì— ì´ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ ì…ì¥ì—ì„œëŠ” ì‚¬ì‹¤ ì›ë³¸ì¸ì§€ ì•„ë‹Œì§€ë„ ëª¨ë¥´ê²Œ, ë™ì¼í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.(ë‹¤í˜•ì„±)
- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ request scopeì™€ëŠ” ê´€ê³„ê°€ ì—†ë‹¤. ê·¸ëƒ¥ ê°€ì§œì´ê³ , ë‚´ë¶€ì— ë‹¨ìˆœí•œ ìœ„ì„ ë¡œì§ë§Œ ìˆê³  ì‹±ê¸€í†¤ì²˜ëŸ¼ ë™ì‘í•œë‹¤.

## ì£¼ì˜ì 
- ë§ˆì¹˜ ì‹±ê¸€í†¤ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ ê°™ì§€ë§Œ ë‹¤ë¥´ê²Œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ê²°êµ­ ì£¼ì˜í•´ì„œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- ì´ëŸ° íŠ¹ë³„í•œ scopeëŠ” ê¼­ í•„ìš”í•œ ê³³ì—ë§Œ ìµœì†Œí™”í•´ì„œ ì‚¬ìš©í•˜ì, ë¬´ë¶„ë³„í•˜ê²Œ ì‚¬ìš©í•˜ë©´ ìœ ì§€ë³´ìˆ˜í•˜ê¸° ì–´ë ¤ì›Œì§„ë‹¤. ğŸš¨

# ì •ë¦¬
- Providerë¥¼ ì‚¬ìš©í•˜ë“ , í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ë“  í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ì§„ì§œ ê°ì²´ ì¡°íšŒë¥¼ ê¼­ í•„ìš”í•œ ì‹œì ê¹Œì§€ ì§€ì—°ì²˜ë¦¬ í•œë‹¤ëŠ” ì ì´ë‹¤.

***
<br>

    ğŸ’› ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ğŸ‘»

[ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°](#){: .btn .btn--primary }{: .align-right}